<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jacpy&#39;s blog</title>
  <subtitle>enjoy mobile development</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.jacpy.com/"/>
  <updated>2017-08-07T05:16:41.000Z</updated>
  <id>http://www.jacpy.com/</id>
  
  <author>
    <name>jacpy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>android听云升级后编译报错</title>
    <link href="http://www.jacpy.com/2017/08/03/network-bench-update-compile-error-md.html"/>
    <id>http://www.jacpy.com/2017/08/03/network-bench-update-compile-error-md.html</id>
    <published>2017-08-03T01:00:09.000Z</published>
    <updated>2017-08-07T05:16:41.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;升级遇到的问题&quot;&gt;&lt;a href=&quot;#升级遇到的问题&quot; class=&quot;headerlink&quot; title=&quot;升级遇到的问题&quot;&gt;&lt;/a&gt;升级遇到的问题&lt;/h2&gt;&lt;p&gt;项目中由于需要，集成了听云的SDK，最近把听云的SDK版本从&lt;code&gt;2.4.4&lt;/code&gt;升级到&lt;code&gt;2.5.7&lt;/code&gt;，重新运行时，在编译过程中报了如下错误：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[NBSAgent.error] Error:com.networkbench.agent.compile.a: NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;java.lang.RuntimeException: com.networkbench.agent.compile.a: NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.a(SourceFile:517)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.a(SourceFile:296)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e$1$1.invoke(SourceFile:328)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.invoke(SourceFile:425)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processClass(Main.java)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processFileBytes(Main.java:723)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.access$1200(Main.java:85)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main$FileBytesConsumer.processFileBytes(Main.java:1653)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.cf.direct.ClassPathOpener.processArchive(ClassPathOpener.java:284)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:166)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.cf.direct.ClassPathOpener.process(ClassPathOpener.java:144)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processOne(Main.java:677)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processAllFiles(Main.java:569)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.runMultiDex(Main.java:366)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.run(Main.java:275)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.main(Main.java:245)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.Main.main(Main.java:106)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Caused by: com.networkbench.agent.compile.a: NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.a.e.a(SourceFile:91)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.a.h.a(SourceFile:43)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.b.f.a(SourceFile:644)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.b.f.a(SourceFile:439)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.a(SourceFile:479)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ... 16 more&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Dex: Error converting bytecode to dex:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Cause: java.lang.RuntimeException: Exception parsing classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    UNEXPECTED TOP-LEVEL EXCEPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    java.lang.RuntimeException: Exception parsing classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processClass(Main.java:760)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processFileBytes(Main.java:723)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.access$1200(Main.java:85)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main$FileBytesConsumer.processFileBytes(Main.java:1653)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.processArchive(ClassPathOpener.java:284)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:166)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.process(ClassPathOpener.java:144)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processOne(Main.java:677)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processAllFiles(Main.java:569)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.runMultiDex(Main.java:366)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.run(Main.java:275)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.main(Main.java:245)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.Main.main(Main.java:106)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Caused by: java.lang.NullPointerException&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.util.ByteArray.&amp;lt;init&amp;gt;(ByteArray.java:76)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.DirectClassFile.&amp;lt;init&amp;gt;(DirectClassFile.java:206)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.parseClass(Main.java:769)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.access$1500(Main.java:85)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main$ClassParserTask.call(Main.java:1700)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processClass(Main.java:755)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ... 12 more&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1 error; aborting&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:app:transformClassesWithDexForDebug FAILED&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:app:networkBenchNewLensDeinstrumentTask&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[NBSAgent.debug] NetworkBench begin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FAILURE: Build failed with an exception.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* What went wrong:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Execution failed for task &amp;apos;:app:transformClassesWithDexForDebug&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; com.android.build.api.transform.TransformException: com.android.ide.common.process.ProcessException: java.util.concurrent.ExecutionException: com.android.ide.common.process.ProcessException: Error while executing java process with main class com.android.dx.command.Main with arguments &amp;#123;--dex --num-threads=4 --multi-dex --main-dex-list /data/jenkins/workspace/app/build/intermediates/multi-dex/debug/maindexlist.txt --output /data/jenkins/workspace/app/build/intermediates/transforms/dex/debug/folders/1000/1f/main /data/jenkins/workspace/app/build/intermediates/transforms/jarMerging/debug/jars/1/1f/combined.jar&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* Try:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BUILD FAILED&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;解决问题&quot;&gt;&lt;a href=&quot;#解决问题&quot; class=&quot;headerlink&quot; title=&quot;解决问题&quot;&gt;&lt;/a&gt;解决问题&lt;/h2&gt;&lt;p&gt;遇到了上面的编译错误问题，先google了一下，没有人提出了这样的错误，也没有解决方案，而且从搜索的结果来看，用的人也不多。这问题只能是自己解决了，从上面的错误提示来看，这个错误是听云中抛出来的。也就是听云干预了编译过程。从这个&lt;code&gt;NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/code&gt;错误提示上来看，说是版本没有对应起来。的确，听云在&lt;code&gt;project&lt;/code&gt;下面的&lt;code&gt;build.gradle&lt;/code&gt;中的&lt;code&gt;dependencies&lt;/code&gt;块中的&lt;code&gt;classpath&lt;/code&gt;中和&lt;code&gt;module&lt;/code&gt;下面的&lt;code&gt;build.gradle&lt;/code&gt;中的&lt;code&gt;dependencies&lt;/code&gt;块中的&lt;code&gt;compile&lt;/code&gt;两个地方都要指定一个版本SDK。一个是用来干预编译过程，植入代码；一个则是要植入的代码。&lt;/p&gt;
&lt;p&gt;引入方式如下代码所示：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;project&lt;/code&gt;目录下面的&lt;code&gt;build.gradle&lt;/code&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    classpath &amp;apos;com.networkbench.newlens.agent.android:agent-gradle-plugin:2.5.7&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;app&lt;/code&gt;目录下面的&lt;code&gt;build.gradle&lt;/code&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   	compile &amp;apos;com.networkbench.newlens.agent.android:nbs.newlens.agent:2.5.7&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;那为什么会有上面有错误？按道理说两者都具备就可以了，猜是听云的版本兼容性问题，也就是&lt;code&gt;2.5.7&lt;/code&gt;不兼容&lt;code&gt;2.4.4&lt;/code&gt;版本。也就是上面说的&lt;code&gt;classpath&lt;/code&gt;与&lt;code&gt;compile&lt;/code&gt;版本要一一对应，版本号必须保持一致。但修改时的版本号是保持一致的呀？问题出在哪儿？缓存问题？&lt;/p&gt;
&lt;p&gt;于是先&lt;code&gt;clean&lt;/code&gt;，然后再重新&lt;code&gt;build了&lt;/code&gt;一下，再运行时，发现问题依旧。没折了，我把版本号改回去&lt;code&gt;2.4.4&lt;/code&gt;总行吧？结果还是编译报错，无语了，试了几次，还是这样，现在感觉到自己进入到进退两难的地步了。最后重新启动&lt;code&gt;AS&lt;/code&gt;，再重新运行了，问题解决了，编译时不报错了，真是太惊喜，太意外了。&lt;/p&gt;
&lt;p&gt;OK，本地问题解决了，服务器的自动构建上又出现问题。按照解决本地问题的思路，不可能重启服务器吧？仔细一想，还是缓存问题？问了运维，说每次构建都会自动清除&lt;code&gt;build&lt;/code&gt;目录中的内容。但心想，与&lt;code&gt;build&lt;/code&gt;目录的内容无关，自己解决问题时都删了好几次，问题依旧没有解决。突然想起平时经常被&lt;code&gt;kill&lt;/code&gt;的&lt;code&gt;java.exe&lt;/code&gt;进程，这个进程里面会缓存一些东西，编译时经常会看到&lt;code&gt;Starting a Gradle Daemon&lt;/code&gt;这样的提示，&lt;code&gt;AS&lt;/code&gt;要提高编译速度，肯定会在这个进程里面缓存一些东西，不然这个&lt;code&gt;java.exe&lt;/code&gt;进程内存占用会有几百M甚至超过1个G？&lt;/p&gt;
&lt;p&gt;跑去跟运维说，你把这个&lt;code&gt;java&lt;/code&gt;进程先&lt;code&gt;kill&lt;/code&gt;，然后再重新构建。果然，&lt;code&gt;kill&lt;/code&gt;进程之后再重新自动构建就OK了。后来想了一下，自己本地重启&lt;code&gt;AS&lt;/code&gt;也是重新启动这个&lt;code&gt;java&lt;/code&gt;进程。&lt;/p&gt;
&lt;h2 id=&quot;为什么要用听云&quot;&gt;&lt;a href=&quot;#为什么要用听云&quot; class=&quot;headerlink&quot; title=&quot;为什么要用听云&quot;&gt;&lt;/a&gt;为什么要用听云&lt;/h2&gt;&lt;p&gt;听云是收费的，但也有免费的版本，免费的版本最多只能看三天的数据。我看重听云的最大一个好处是可以监控网络情况，比如说哪些接口失败率比较高、请求耗时等，这样可以做一些优化。&lt;/p&gt;
&lt;p&gt;但听云有一个不好的地方是，对代码进行侵入，有时候在报错的堆栈中看到了听云的堆栈信息。如果项目结构设计不好，用的第三方库太多，估计听云的代码会插入的到处都是，这里没有整理出数据来。&lt;/p&gt;
&lt;p&gt;另外听去的另外一个ANR日志收集的功能没有做好，把&lt;code&gt;traces.txt&lt;/code&gt;日志文件中的有用的信息基本都过虑掉了，只留下一些堆栈信息。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;升级遇到的问题&quot;&gt;&lt;a href=&quot;#升级遇到的问题&quot; class=&quot;headerlink&quot; title=&quot;升级遇到的问题&quot;&gt;&lt;/a&gt;升级遇到的问题&lt;/h2&gt;&lt;p&gt;项目中由于需要，集成了听云的SDK，最近把听云的SDK版本从&lt;code&gt;2.4.4&lt;/code&gt;升级到&lt;code&gt;2.5.7&lt;/code&gt;，重新运行时，在编译过程中报了如下错误：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="听云" scheme="http://www.jacpy.com/tags/%E5%90%AC%E4%BA%91/"/>
    
  </entry>
  
  <entry>
    <title>sqlite cant open database exception unknow error code 14</title>
    <link href="http://www.jacpy.com/2017/08/03/sqlite-cant-open-database-exception-unknow-error-code-14-md.html"/>
    <id>http://www.jacpy.com/2017/08/03/sqlite-cant-open-database-exception-unknow-error-code-14-md.html</id>
    <published>2017-08-03T00:59:05.000Z</published>
    <updated>2017-08-07T07:44:03.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天在解决客户的一个问题，说用了发给我的sqlite的数据库文件会发生数据上传失败问题，于是结合发过来的数据库文件准备看一下。&lt;/p&gt;
&lt;p&gt;先是通过&lt;code&gt;adb push&lt;/code&gt;命令把文件copy到手机，然后cp到应用的缓存目录（需要root权限），覆盖原来的数据库文件。结果应用一运行就报了如下的错误：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;E/SQLiteLog: (14) cannot open file at line 30191 of [00bb9c9ce4]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;E/SQLiteLog: (14) os_unix.c:30191: (13) open(/data/data/com.xxx/databases/xxx) - &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;E/SQLiteDatabase: Failed to open database &amp;apos;/data/data/xxx/databases/xxxx&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.database.sqlite.SQLiteCantOpenDatabaseException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;unknown error (code 14): Could not open database&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看提示说是读了多少行后报错，第一反应是数据库文件有问题？在PC端用工具打开那个文件，发现能正常打开，而且执行了SQL都是正常看到数据。奇了怪了，那个&lt;code&gt;line&lt;/code&gt;是代码的行数？直接搜索上面的错误，在&lt;code&gt;stackoverflow&lt;/code&gt;上面看别人各种回答。有的说是权限问题，要先申请权限，有的说是6.0上面的问题，要动态权限等等。结合自己的情况，发现都不是。接着往下看，发现有人提到了&lt;code&gt;SELinux security&lt;/code&gt;，突然想到了是不是权限问题？马上命令一看，果然只有root权限，执行&lt;code&gt;chomd 777 xxxx&lt;/code&gt;，然后再一运行app，OK了。&lt;/p&gt;
&lt;p&gt;运气太好了，这样就解决问题了，还想说报那个&lt;code&gt;code 14&lt;/code&gt;是什么错误呢。后来到sqlite源码里面找了一下，找到这个的一个宏定义&lt;code&gt;#define SQLITE_CANTOPEN    14   /* Unable to open the database file */&lt;/code&gt;，这个提示对解决问题并没有什么帮助，很佩服自己当时的反应。网上也有人说这里有一个bug，没有去深究，问题已解决，后面的事情还没有做呢！&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天在解决客户的一个问题，说用了发给我的sqlite的数据库文件会发生数据上传失败问题，于是结合发过来的数据库文件准备看一下。&lt;/p&gt;
&lt;p&gt;先是通过&lt;code&gt;adb push&lt;/code&gt;命令把文件copy到手机，然后cp到应用的缓存目录（需要root权限），覆盖原来的数据库文件。结果应用一运行就报了如下的错误：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="sqlite error code 14" scheme="http://www.jacpy.com/tags/sqlite-error-code-14/"/>
    
  </entry>
  
  <entry>
    <title>android device or resource busy</title>
    <link href="http://www.jacpy.com/2017/05/03/android-device-or-resource-busy.html"/>
    <id>http://www.jacpy.com/2017/05/03/android-device-or-resource-busy.html</id>
    <published>2017-05-03T09:28:14.000Z</published>
    <updated>2017-08-02T05:12:12.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在项目开发中遇到一个很奇葩的问题，在应用中做了一个清除应用缓存功能，将缓存目录文件中所有的文件都删除，然后再重新初始化的时候，这个目录就不能创建文件和目录了。在红米手机和魅族手机上试了，都会出现这个问题，华为手机上却没有这个问题，我的MOTO手机上也有这个问题。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;于是在命令行进入&lt;code&gt;shell&lt;/code&gt;，然后&lt;code&gt;cd&lt;/code&gt;到这个目录提示&lt;code&gt;tmp-mksh:  Device or resource busy&lt;/code&gt;错误。用手机中的文件管理器删除这个目录提示删除失败。最后把应用卸载了，然后再删除，又可以删除这个目录。&lt;/p&gt;
&lt;p&gt;这就奇了怪了，到底是怎么回事？在这个目录用执行&lt;code&gt;new File(path).mkdirs()&lt;/code&gt;方法时，返回false，创建目录失败。导致应用没有办法在这个目录创建缓存数据，导致整个应用都没有办法正常进行，如果处理这种失败情况，很多地方都得改。但有些地方是分裂式的，这一个地方失败，会影响其他N多地方。但是之前用这个功能都没有问题，只是近期出现了这个问题。&lt;/p&gt;
&lt;p&gt;不行，得找出原因。于是把清除缓存目录下面的文件路径都用日志输出了一遍，结果突然发现一些个奇怪的文件–&lt;code&gt;mmap&lt;/code&gt;文件。这些文件是在使用腾讯&lt;code&gt;mars&lt;/code&gt;开源库中的&lt;code&gt;xlog&lt;/code&gt;组件产生的内核映射文件，用来同步缓存日志，防止日志因为应用出现意外而丢失。按照&lt;code&gt;xlog&lt;/code&gt;的官方demo中的使用方法，&lt;code&gt;xlog&lt;/code&gt;的初始化和关闭都是在&lt;code&gt;Application&lt;/code&gt;中。删除缓存目录下面的日志文件时并没有关闭&lt;code&gt;xlog&lt;/code&gt;，&lt;code&gt;mmap&lt;/code&gt;文件直接被删除，所以才导致上面说的奇葩问题。&lt;/p&gt;
&lt;p&gt;目测是原因找到了，于是在删除缓存时，日志目录下面的日志文件都不删除，最后问题解决。至于是什么原因导致删除&lt;code&gt;mmap&lt;/code&gt;文件出现上面的问题就不得而知，但是感觉整个目录被锁死了，直到删除应用才释放，强制停止应用都不起作用。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在项目开发中遇到一个很奇葩的问题，在应用中做了一个清除应用缓存功能，将缓存目录文件中所有的文件都删除，然后再重新初始化的时候，这个目录就不能创建文件和目录了。在红米手机和魅族手机上试了，都会出现这个问题，华为手机上却没有这个问题，我的MOTO手机上也有这个问题。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="Device or resource busy" scheme="http://www.jacpy.com/tags/Device-or-resource-busy/"/>
    
  </entry>
  
  <entry>
    <title>关于android fresco初始化的一个坑</title>
    <link href="http://www.jacpy.com/2017/05/02/android-fresco-init.html"/>
    <id>http://www.jacpy.com/2017/05/02/android-fresco-init.html</id>
    <published>2017-05-02T13:42:22.000Z</published>
    <updated>2017-08-02T05:21:45.000Z</updated>
    
    <content type="html">&lt;p&gt;之前有写文章说别人对网上文章的看法，这次写的是我对网上文章的看法。一直以来对网上的文章的说法都抱有怀疑态度，一般都是把网上的东西作为参考，找准关键的地方，他的说法与自己写的有什么区别？一对比就知道哪些地方有欠缺，是什么原因。而不是直接copy过来使用。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;blockquote&gt;
&lt;p&gt;以下这段内容可以选择忽略。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;举个前几天在项目中遇到的例子。在&lt;code&gt;android中捕获崩溃日志&lt;/code&gt;看到了将Throwable对象转换成字符串，写了很大一串。心想这段代码肯定来自网络，写这篇文章的时候去搜索了一下，果然。因为系统已经提供了将Throwable对象转换为字符串的方法，只需要调用就行，一行代码就可以搞定，有的甚至把&lt;code&gt;android.util.Log&lt;/code&gt;输出Throwable对象的方式重新再写了一遍，解决问题的思路很赞。但如果再多看一眼，&lt;code&gt;Log&lt;/code&gt;类中提供了&lt;code&gt;getStackTraceString(Throwable)&lt;/code&gt;静态方法，方便处理这种事情，而且这个方法是从&lt;code&gt;API Level 1&lt;/code&gt;开始就有。&lt;/p&gt;
&lt;p&gt;OK，回到主题上来。事情的起因是项目中的一个bug。&lt;/p&gt;
&lt;p&gt;项目中有一个滚动的Gallery查看大图，还有一个将图片保存到本地功能。但保存图片时会概率性失败，这个问题是测试反馈的，而且概率很高。自己测试发现进这个界面保存当前看到的这张图片能成功，后面每次保存都失败。&lt;/p&gt;
&lt;p&gt;跟踪代码发现失败的原因是从SD卡中&lt;code&gt;Fresco&lt;/code&gt;库缓存取图片时，图片不存在，所以保存失败。那为什么保存当前图片成功？&lt;/p&gt;
&lt;p&gt;于是将缓存目录下面的内容都用日志打了出来。以下代码在每次图片加载完后就会把缓存内容都以LOG方式输出。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PhotoDraweeView photoDraweeView = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; PhotoDraweeView(context);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PipelineDraweeControllerBuilder controller = Fresco.newDraweeControllerBuilder();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller.setUri(uri); &lt;span class=&quot;comment&quot;&gt;// 图片请求的URL地址&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller.setAutoPlayAnimations(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller.setOldController(photoDraweeView.getController());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller.setControllerListener(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BaseControllerListener&amp;lt;ImageInfo&amp;gt;() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFinalImageSet&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, ImageInfo imageInfo, Animatable animatable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onFinalImageSet(id, imageInfo, animatable);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (imageInfo == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        FileBinaryResource resource = (FileBinaryResource) ImagePipelineFactory.getInstance().getMainFileCache().getResource(DefaultCacheKeyFactory.getInstance().getEncodedCacheKey(controller.getImageRequest(), &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;resource: &quot;&lt;/span&gt; + resource);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            List&amp;lt;DiskStorage.DiskDumpInfoEntry&amp;gt; list = Fresco.getImagePipelineFactory().getMainFileCache().getDumpInfo().entries;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (list != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !list.isEmpty()) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (DiskStorage.DiskDumpInfoEntry info : list) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;size: &quot;&lt;/span&gt; + info.size + &lt;span class=&quot;string&quot;&gt;&quot;, type: &quot;&lt;/span&gt; + info.type + &lt;span class=&quot;string&quot;&gt;&quot;, path: &quot;&lt;/span&gt; + info.path + &lt;span class=&quot;string&quot;&gt;&quot;, fb: &quot;&lt;/span&gt; + info.firstBits);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IOException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onIntermediateImageSet&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, ImageInfo imageInfo)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFailure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, Throwable throwable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以下是输出的LOG，&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@2f8cf0a9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1580616.0, type: jpg, path: imgcache/v2.ols100.1/3/3qC9ts9ad_tJcsN1ot7Ort5YQ9A.cnt, fb: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@411bafa9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1.0461388E7, type: jpg, path: imgcache/v2.ols100.1/24/r0c37nN9TT6P-HU0hoYwm_ZU5K4.cnt, fb: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@6d7fddcf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1622679.0, type: jpg, path: imgcache/v2.ols100.1/1/BYrt44bfrnqXpdkx5x4p1W_RsTY.cnt, fb: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@bfbbc062&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1127054.0, type: jpg, path: imgcache/v2.ols100.1/96/mhZk2iyqbM0iKt2RmDV0aKT0o5Q.cnt, fb:&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从上面的日志中看出图片都缓存到了指定的路径，但是从文件管理器中去查看&lt;code&gt;v2.ols100.1&lt;/code&gt;目录下面的对应目录基本都为空，只有一个目录中有缓存图片，整个目录大小只有几百KB。感觉图片只缓存了一张，其它的都没有缓存到外部存储空间上来。&lt;/p&gt;
&lt;p&gt;看了一下存储空间，还有几个G，不存在空间不足。与图片大小有关系？换了大图试试，也还是这样。开始怀疑与Fresco相关的代码，于是找到了Fresco初始化代码，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DiskCacheConfig.Builder builder = DiskCacheConfig.newBuilder(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSize(&lt;span class=&quot;number&quot;&gt;150&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnLowDiskSpace(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnVeryLowDiskSpace(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * ByteConstants.MB);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setVersion(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setBaseDirectoryName(&lt;span class=&quot;string&quot;&gt;&quot;imgcache&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setBaseDirectoryPath(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; File(FileUtils.getUserWorkingFolder()));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DiskCacheConfig diskCacheConfig = builder.build();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ImagePipelineConfig config = ImagePipelineConfig.newBuilder(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        .setMainDiskCacheConfig(diskCacheConfig)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        .build();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Fresco.initialize(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt; , config);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;想知道这几个参数值表示的是什么意思，是怎么使用的。于是就查看了源码，发现这个参数初始化代码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; mMaxCacheSize = &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt; * ByteConstants.MB;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; mMaxCacheSizeOnLowDiskSpace = &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; * ByteConstants.MB;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; mMaxCacheSizeOnVeryLowDiskSpace = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; * ByteConstants.MB;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Builder &lt;span class=&quot;title&quot;&gt;setMaxCacheSize&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; maxCacheSize)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mMaxCacheSize = maxCacheSize;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Builder &lt;span class=&quot;title&quot;&gt;setMaxCacheSizeOnLowDiskSpace&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; maxCacheSizeOnLowDiskSpace)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mMaxCacheSizeOnLowDiskSpace = maxCacheSizeOnLowDiskSpace;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Builder &lt;span class=&quot;title&quot;&gt;setMaxCacheSizeOnVeryLowDiskSpace&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; maxCacheSizeOnVeryLowDiskSpace)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mMaxCacheSizeOnVeryLowDiskSpace = maxCacheSizeOnVeryLowDiskSpace;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看到这个代码就立马反应过来了，少了一个常量&lt;code&gt;ByteConstants.MB&lt;/code&gt;？把项目中的初始化代码修改了一下，加上了这个常量，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DiskCacheConfig.Builder builder = DiskCacheConfig.newBuilder(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSize(&lt;span class=&quot;number&quot;&gt;150&lt;/span&gt; * ByteConstants.MB);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnLowDiskSpace(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt; * ByteConstants.MB);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnVeryLowDiskSpace(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * ByteConstants.MB);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再来测试时，发现问题解决了，不会出现保存失败的情况。&lt;code&gt;v2.ols100.1&lt;/code&gt;这个目录下缓存了很多文件，文件大小一下子就几M了。&lt;/p&gt;
&lt;p&gt;然后用上面代码中的关键字在google上搜索了一下，发现代码是copy过来的，参数值全部都一样。好吧，我认栽。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;之前有写文章说别人对网上文章的看法，这次写的是我对网上文章的看法。一直以来对网上的文章的说法都抱有怀疑态度，一般都是把网上的东西作为参考，找准关键的地方，他的说法与自己写的有什么区别？一对比就知道哪些地方有欠缺，是什么原因。而不是直接copy过来使用。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="fresco初始化设置" scheme="http://www.jacpy.com/tags/fresco%E5%88%9D%E5%A7%8B%E5%8C%96%E8%AE%BE%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>windows 7 驱动安装成功后无法启动</title>
    <link href="http://www.jacpy.com/2017/04/28/windows-driver-donot-install.html"/>
    <id>http://www.jacpy.com/2017/04/28/windows-driver-donot-install.html</id>
    <published>2017-04-28T00:27:57.000Z</published>
    <updated>2017-08-02T05:16:26.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在PC上安装无线网卡，可以将PC的网络通用Wi-Fi的形式让手机可以连接。由于系统限制，驱动安装成功，但是加载驱动却失败，于是开始找原因，就有了下文。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;首先驱动可以安装成功，但不能被系统加载，出现的情况下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/device.png&quot; alt=&quot;驱动未被加载&quot;&gt;&lt;/p&gt;
&lt;p&gt;然后选中黄色警告项，右键选择“更新驱动”，然后选择驱动安装目录，然后下一步，结果提示&lt;code&gt;系统策略禁止安装此设备，请与系统管理员联系&lt;/code&gt;，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/system_forbidden_install_driver_call_admin.jpg&quot; alt=&quot;系统策略禁止安装此设备，请与系统管理员联系&quot;&gt;&lt;/p&gt;
&lt;p&gt;于是打开组策略，开始找是哪项设置的。&lt;/p&gt;
&lt;p&gt;打开组策略后，先选中其中一个模板，比如&lt;code&gt;管理模板&lt;/code&gt;，然后点击&lt;code&gt;操作&lt;/code&gt;菜单中的&lt;code&gt;筛选器选项...&lt;/code&gt;项，如图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/gpedit_msc_drive_menu.png&quot; alt=&quot;筛选器选项菜单&quot;&gt;&lt;/p&gt;
&lt;p&gt;在弹出的窗口中什么都不用选，如下图所示，然后单击确定按钮：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/gpedit_msc_drive_dialog.png&quot; alt=&quot;筛选器选项&quot;&gt;&lt;/p&gt;
&lt;p&gt;最后发现什么都没有搜索出来，因为这些项都是未配置。心想，这里没有被人修改过，全都是系统默认的，现在怎么知道是哪项产生的影响？&lt;/p&gt;
&lt;p&gt;最后没办法，只得挨个找，最后还是被找到设置的位置。在&lt;code&gt;计算机配置&lt;/code&gt;-&amp;gt;&lt;code&gt;管理模板&lt;/code&gt;-&amp;gt;&lt;code&gt;系统&lt;/code&gt;-&amp;gt;&lt;code&gt;设备安装&lt;/code&gt;-&amp;gt;&lt;code&gt;设备安装限制&lt;/code&gt;的右侧面板中，分别修改&lt;code&gt;允许管理员忽略设备安装限制策略&lt;/code&gt;和&lt;code&gt;禁止安装未由其他策略设备描述的设备&lt;/code&gt;，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/gpedit_msc_drive.png&quot; alt=&quot;设备安装限制&quot;&gt;&lt;/p&gt;
&lt;p&gt;设置后，再去更新驱动，OK了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在PC上安装无线网卡，可以将PC的网络通用Wi-Fi的形式让手机可以连接。由于系统限制，驱动安装成功，但是加载驱动却失败，于是开始找原因，就有了下文。&lt;/p&gt;
    
    </summary>
    
      <category term="windows" scheme="http://www.jacpy.com/categories/windows/"/>
    
    
      <category term="windows 7 驱动安装成功后无法启动" scheme="http://www.jacpy.com/tags/windows-7-%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F%E5%90%8E%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8/"/>
    
  </entry>
  
  <entry>
    <title>android ANR——线程死锁分析</title>
    <link href="http://www.jacpy.com/2017/04/24/android-anr-thread-lock-analysis.html"/>
    <id>http://www.jacpy.com/2017/04/24/android-anr-thread-lock-analysis.html</id>
    <published>2017-04-24T01:55:18.000Z</published>
    <updated>2017-08-08T05:29:03.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天遇到了线程死锁问题，导致系统&lt;code&gt;ANR&lt;/code&gt;。然后拿到系统&lt;code&gt;/data/anr/traces.txt&lt;/code&gt;日志文件后，进行分析，然后找到原因，并解决了问题。&lt;/p&gt;
&lt;p&gt;java线程产生死锁的原因，要么同时满足死锁的四个条件，要么是android系统机制的原因，认为发生了类似死锁的情况而导致系统&lt;code&gt;ANR&lt;/code&gt;。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;很明显，既然导致了系统&lt;code&gt;ANR&lt;/code&gt;，那么肯定与UI线程有关。首先看下面出现死锁的代码：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * HTTP请求处理&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HttpRequest&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     * 请求次数计数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; mRequestCount;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Object mSyncObject = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Object();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PushRequestParams params, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; RequestCallback callback)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Thread(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Runnable() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                android.os.Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (mSyncObject) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    mRequestCount = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; RequestCallback cb = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RequestCallback() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onRequestCallback&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; state, String s)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (state == STATE_SUCCESS) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;comment&quot;&gt;// 请求成功&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    callback.onRequestCallback(state, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;comment&quot;&gt;// 这个必须放到while循环前面&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mRequestCount &amp;gt;= &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; &amp;amp;&amp;amp; callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    &lt;span class=&quot;comment&quot;&gt;// 请求失败&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    callback.onRequestCallback(state, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;comment&quot;&gt;// 失败后重试三次&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (mRequestCount &amp;lt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    ++mRequestCount;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    request(params.toString(), params.sessionId, &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    request(params.toString(), params.sessionId, cb);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;).start();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String host, String sessionId, RequestCallback callback)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; isSuccess = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String s = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            URL url = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; URL(host);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            HttpURLConnection conn = (HttpURLConnection) url.openConnection();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setRequestMethod(&lt;span class=&quot;string&quot;&gt;&quot;GET&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setConnectTimeout(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setReadTimeout(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setRequestProperty(&lt;span class=&quot;string&quot;&gt;&quot;Cookie&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;JSESSIONID=&quot;&lt;/span&gt; + sessionId);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.connect();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; state = conn.getResponseCode();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;request state: &quot;&lt;/span&gt; + state);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (state == HttpURLConnection.HTTP_OK) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                s = streamToString(conn.getInputStream());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;result: &quot;&lt;/span&gt; + s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    JSONObject jobj = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; JSONObject(s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; code = jobj.optInt(&lt;span class=&quot;string&quot;&gt;&quot;code&quot;&lt;/span&gt;, -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (code == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        isSuccess = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (JSONException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (MalformedURLException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            s = e.toString();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IOException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            s = e.toString();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                callback.onRequestCallback(isSuccess ? RequestCallback.STATE_SUCCESS : RequestCallback.STATE_ERROR, s == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt; : s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面代码是为了保证请求次数&lt;code&gt;mRequestCount&lt;/code&gt;的值不超过3次，同时也考虑多线程的情况，所以对这个值进行修改时时行了同步。&lt;/p&gt;
&lt;p&gt;接着看出现&lt;code&gt;ANR&lt;/code&gt;的提示，以下是错误日志：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;main&amp;quot; prio=5 tid=1 Blocked&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | group=&amp;quot;main&amp;quot; sCount=1 dsCount=0 obj=0x750d06e8 self=0xe7685400&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | sysTid=29016 nice=-10 cgrp=default sched=0/0 handle=0xea2f5534&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | state=S schedstat=( 83840100682 22307763410 181443 ) utm=6702 stm=1680 core=1 HZ=100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | stack=0xff53a000-0xff53c000 stackSize=8MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | held mutexes=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at *.*.HttpRequest.request(HttpRequest.java:33)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - waiting to lock &amp;lt;0x08483a94&amp;gt; (a java.lang.Class&amp;lt;*.*.HttpRequest&amp;gt;) held by thread 24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.app.LoadedApk$ReceiverDispatcher$Args.run(LoadedApk.java:1122)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.os.Handler.handleCallback(Handler.java:751)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.os.Looper.loop(Looper.java:154)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.app.ActivityThread.main(ActivityThread.java:6119)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.lang.reflect.Method.invoke!(Native method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:886)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:776)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面的日志要耐着性子在&lt;code&gt;traces.txt&lt;/code&gt;文件中慢慢找，因为这个文件非常大，刚开始的内容不一定就是异常日志。如果运气好，打开就可以看到。所以可以试着找类似&lt;code&gt;&amp;quot;main&amp;quot; prio=5 tid=1 Blocked&lt;/code&gt;这样的字眼，或者查找自己的代码中类文件的主包名，这样来得更快（也有可能找不到:)    ）。&lt;/p&gt;
&lt;p&gt;从上面日志大概可以读出一些信息。比如&lt;code&gt;&amp;quot;main&amp;quot; prio=5 tid=1 Blocked&lt;/code&gt;表示当前线程被Blocked，即阻塞，线程的名称是&lt;code&gt;main&lt;/code&gt;，即UI主线程，&lt;code&gt;prio=5&lt;/code&gt;是线程的优先级，&lt;code&gt;tid=1&lt;/code&gt;是线程的ID。`held mutexes=&lt;br&gt;  at &lt;em&gt;.&lt;/em&gt;.HttpRequest.request(HttpRequest.java:33)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;waiting to lock &lt;0x08483a94&gt; (a java.lang.Class&amp;lt;&lt;em&gt;.&lt;/em&gt;.HttpRequest&amp;gt;) held by thread 24&lt;code&gt;这段日志中已经告诉了具体发生问题的原因。在&lt;/code&gt;HttpRequest.java:33&lt;code&gt;这个位置发生了阻塞，&lt;/code&gt;waiting to lock &lt;0x08483a94&gt;&lt;code&gt;等待&lt;/code&gt;0x08483a94&lt;code&gt;这个锁被释放，这个锁&lt;/code&gt;java.lang.Class&amp;lt;&lt;em&gt;.&lt;/em&gt;.HttpRequest&amp;gt;) &lt;code&gt;是一个Class锁，被&lt;/code&gt;held by thread 24 `线程ID为24的线程持有。&lt;/0x08483a94&gt;&lt;/0x08483a94&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;于是搜索关键字&lt;code&gt;&amp;lt;0x08483a94&amp;gt;&lt;/code&gt;，又可以找到下面一段日志。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;Thread-173&amp;quot; prio=5 tid=24 Native&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | group=&amp;quot;main&amp;quot; sCount=1 dsCount=0 obj=0x33824e50 self=0xb6cf2800&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | sysTid=11277 nice=10 cgrp=bg_non_interactive sched=0/0 handle=0xc4453920&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | state=S schedstat=( 8781561 3715104 14 ) utm=0 stm=0 core=2 HZ=100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | stack=0xc4351000-0xc4353000 stackSize=1038KB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | held mutexes=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: __switch_to+0x8c/0x98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: poll_schedule_timeout+0x54/0xbc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: do_sys_poll+0x2c4/0x384&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: compat_sys_ppoll+0x134/0x1e8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: cpu_switch_to+0x48/0x4c&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #00 pc 00048684  /system/lib/libc.so (__ppoll+20)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #01 pc 0001cf67  /system/lib/libc.so (poll+46)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #02 pc 0000e6bd  /system/lib/libopenjdk.so (NET_Poll+52)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #03 pc 0001888f  /system/lib/libopenjdk.so (PlainSocketImpl_socketConnect+286)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #04 pc 000b2cb7  /system/framework/arm/boot.oat (Java_java_net_PlainSocketImpl_socketConnect__Ljava_net_InetAddress_2II+114)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.PlainSocketImpl.socketConnect(Native method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:334)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - locked &amp;lt;0x09ddcdde&amp;gt; (a java.net.SocksSocketImpl)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:196)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:178)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:356)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.Socket.connect(Socket.java:605)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.Platform.connectSocket(Platform.java:113)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.Connection.connectSocket(Connection.java:196)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.Connection.connect(Connection.java:172)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.Connection.connectAndSetOwner(Connection.java:367)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.OkHttpClient$1.connectAndSetOwner(OkHttpClient.java:130)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.http.HttpEngine.connect(HttpEngine.java:329)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.http.HttpEngine.sendRequest(HttpEngine.java:246)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.huc.HttpURLConnectionImpl.execute(HttpURLConnectionImpl.java:457)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.huc.HttpURLConnectionImpl.connect(HttpURLConnectionImpl.java:126)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at *.*.HttpRequest.request(PushRequest.java:79)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - locked &amp;lt;0x08483a94&amp;gt; (a java.lang.Class&amp;lt;*.*.HttpRequest&amp;gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at *.*.HttpRequest.access$200(PushRequest.java:23)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at *.*.HttpRequest$1.run(PushRequest.java:63)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - locked &amp;lt;0x0fde7bbf&amp;gt; (a java.lang.Object)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.lang.Thread.run(Thread.java:761)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;搜索上面的关键字会找到这里&lt;code&gt;locked &amp;lt;0x08483a94&amp;gt; (a java.lang.Class&amp;lt;*.*.HttpRequest&amp;gt;)&lt;/code&gt;，是在这个位置产生问题&lt;code&gt;at *.*.HttpRequest.request(PushRequest.java:79)&lt;/code&gt;。到这里问题就容易理解了，因为执行了&lt;code&gt;conn.connect();&lt;/code&gt;这行代码，这行代码所在的&lt;code&gt;request&lt;/code&gt;方法是同步方法，所以持有Class锁。而这行代码执行需要的时间是不确定的，这个得看网络情况，如果网络不好，需要等待30秒。&lt;/p&gt;
&lt;p&gt;当在主线程中调用这个类的&lt;code&gt;public synchronized static void request(final PushRequestParams params, final RequestCallback callback)&lt;/code&gt;这个方法时，由于这个方法也是同步的，因为是静态方法，所以这个同步的是Class，即持有Class锁。因为这个锁已经被执行&lt;code&gt;private synchronized static void request(String host, String sessionId, RequestCallback callback)&lt;/code&gt;方法所在的线程持有，而这个方法在做一个执行时间不确定的http请求，从而导致了互斥条件的产生。&lt;/p&gt;
&lt;p&gt;这种互斥不很严格意义上互斥，因为这个http请求最长时间是30秒，也就是30秒后释放锁，其他线程可以获得锁，但是违反了系统规则，因为在这个类的外部是在主线程中调用这个&lt;code&gt;request&lt;/code&gt;方法，导致主线程等待。由于android系统的机制，等待的时间超过了允许的时间限制，导致其他事件不能处理，所以直接就&lt;code&gt;ANR&lt;/code&gt;了。&lt;/p&gt;
&lt;p&gt;知道了原因，就开始改代码了，代码修改后如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * HTTP请求处理&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HttpRequest&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; ThreadPoolExecutor mThreadPool = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ThreadPoolExecutor(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, TimeUnit.SECONDS, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; LinkedBlockingQueue&amp;lt;Runnable&amp;gt;(), Executors.defaultThreadFactory(), &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ThreadPoolExecutor.DiscardOldestPolicy());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PushRequestParams params, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; RequestCallback callback)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mThreadPool.execute(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Runnable() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; requestCount = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                android.os.Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                requestCount = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; RequestCallback cb = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RequestCallback() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onRequestCallback&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; state, String s)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (state == STATE_SUCCESS) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;comment&quot;&gt;// 请求成功&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                callback.onRequestCallback(state, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;comment&quot;&gt;// 这个必须放到while循环前面&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (requestCount &amp;gt;= &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; &amp;amp;&amp;amp; callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;comment&quot;&gt;// 请求失败&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                callback.onRequestCallback(state, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;comment&quot;&gt;// 失败后重试三次&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (requestCount &amp;lt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                ++requestCount;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                request(params.toString(), params.sessionId, &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                request(params.toString(), params.sessionId, cb);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String host, String sessionId, RequestCallback callback)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; isSuccess = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String s = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            URL url = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; URL(host);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            HttpURLConnection conn = (HttpURLConnection) url.openConnection();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setRequestMethod(&lt;span class=&quot;string&quot;&gt;&quot;GET&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setConnectTimeout(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setReadTimeout(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setRequestProperty(&lt;span class=&quot;string&quot;&gt;&quot;Cookie&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;JSESSIONID=&quot;&lt;/span&gt; + sessionId);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.connect();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; state = conn.getResponseCode();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;request state: &quot;&lt;/span&gt; + state);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (state == HttpURLConnection.HTTP_OK) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                s = streamToString(conn.getInputStream());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;result: &quot;&lt;/span&gt; + s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    JSONObject jobj = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; JSONObject(s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; code = jobj.optInt(&lt;span class=&quot;string&quot;&gt;&quot;code&quot;&lt;/span&gt;, -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (code == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        isSuccess = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (JSONException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (MalformedURLException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            s = e.toString();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IOException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            s = e.toString();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                callback.onRequestCallback(isSuccess ? RequestCallback.STATE_SUCCESS : RequestCallback.STATE_ERROR, s == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt; : s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用线程池，并且只有一个线程，在外部多次调用&lt;code&gt;request&lt;/code&gt;方法，让其进入队列等待。把请求次数的计数器&lt;code&gt;requestCount&lt;/code&gt;放在新建的&lt;code&gt;Runnable&lt;/code&gt;对象中，这样就不用担心多线程同步的问题。&lt;/p&gt;
&lt;p&gt;中间有个插曲。&lt;/p&gt;
&lt;p&gt;使用&lt;code&gt;adb pull /data/anr/traces.txt D:\&lt;/code&gt;命令获取ANR日志时，会提示&lt;code&gt;adb: error: cannot create file/directory &amp;#39;D:\&amp;#39;: No such file or directory&lt;/code&gt;错误，立马反应是修改目录为&lt;code&gt;D:\temp&lt;/code&gt;目录，PC的D盘是有这个目录的，然后就再执行&lt;code&gt;adb pull /data/anr/traces.txt D:\temp&lt;/code&gt;，OK了。后来在群里也有人遇到这个错误，然后问这个问题怎么解决，然后就是各种骂网上各种文章不靠谱，照着做都出问题。我想说的是，出现问题，自己先思考一下，看错误提示，不要急着找搜索引擎，答案就在错误提示中。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天遇到了线程死锁问题，导致系统&lt;code&gt;ANR&lt;/code&gt;。然后拿到系统&lt;code&gt;/data/anr/traces.txt&lt;/code&gt;日志文件后，进行分析，然后找到原因，并解决了问题。&lt;/p&gt;
&lt;p&gt;java线程产生死锁的原因，要么同时满足死锁的四个条件，要么是android系统机制的原因，认为发生了类似死锁的情况而导致系统&lt;code&gt;ANR&lt;/code&gt;。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="android死锁分析" scheme="http://www.jacpy.com/tags/android%E6%AD%BB%E9%94%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>android gradle常用配置总结</title>
    <link href="http://www.jacpy.com/2017/02/28/android-gradle-config-summary.html"/>
    <id>http://www.jacpy.com/2017/02/28/android-gradle-config-summary.html</id>
    <published>2017-02-28T07:40:50.000Z</published>
    <updated>2017-03-07T02:43:27.000Z</updated>
    
    <content type="html">&lt;h1 id=&quot;基本介绍&quot;&gt;&lt;a href=&quot;#基本介绍&quot; class=&quot;headerlink&quot; title=&quot;基本介绍&quot;&gt;&lt;/a&gt;基本介绍&lt;/h1&gt;&lt;p&gt;本文是针对android开发中的&lt;code&gt;build.gradle&lt;/code&gt;文件中的常用配置总结，一些配置是在特定的场景下才使用，一些是为了解决一些问题才加上。所以默认还是使用在Android Studio工具中新建项目时生成的默认的&lt;code&gt;build.gradle&lt;/code&gt;文件中的配置，等遇到了问题，再来加一些配置。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;101&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;102&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;103&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;104&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;105&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;106&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;107&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;108&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;109&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;110&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;111&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;112&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;113&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;114&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;115&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;116&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;117&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;118&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;119&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;120&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;121&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;122&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;123&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;124&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;125&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;126&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;127&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;128&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;129&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;130&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;131&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;132&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;133&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;134&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;135&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;136&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;137&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;138&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;139&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;140&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;141&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;142&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;143&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;144&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// apply plugin: &#39;com.android.library&#39; // 库配置&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apply &lt;span class=&quot;string&quot;&gt;plugin:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;com.android.application&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 应用程序配置&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;repositories &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 引入AAR文件时，需要配置这个，AAR文件放在libs目录中&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    flatDir &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        dirs &lt;span class=&quot;string&quot;&gt;&#39;libs&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compileSdkVersion &lt;span class=&quot;number&quot;&gt;25&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// android编译SDK的版本，即4.0SDK、5.0SDK等的android.jar文件&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    buildToolsVersion &lt;span class=&quot;string&quot;&gt;&quot;25.0.2&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 使用SDK中编译工具的版本&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    useLibrary &lt;span class=&quot;string&quot;&gt;&quot;org.apache.http.legacy&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 在6.0上使用apache的httpClient包，原因是google在6.0上去掉了这个http请求库&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    defaultConfig &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        applicationId &lt;span class=&quot;string&quot;&gt;&quot;com.xxx&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 应用的包名可以在AndroidMainfest.xml中使用$&amp;#123;applicationId&amp;#125;的方式引用这个包名&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        minSdkVersion &lt;span class=&quot;number&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 最小兼容版本&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        targetSdkVersion &lt;span class=&quot;number&quot;&gt;25&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 目标版本&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        versionCode &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 应用的版本号&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        versionName SDK_VERSION &lt;span class=&quot;comment&quot;&gt;// 应用的版本名称&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        multiDexEnabled &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 启用多dex，如果app中的代码方法数超过65535&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        testInstrumentationRunner &lt;span class=&quot;string&quot;&gt;&quot;android.support.test.runner.AndroidJUnitRunner&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// android单元测试配置&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   sourceSets &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 指定代码及资源的路径，具体可以参考这里http://google.github.io/android-gradle-dsl/2.3/com.android.build.gradle.api.AndroidSourceSet.html&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        main &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            manifest.srcFile &lt;span class=&quot;string&quot;&gt;&#39;AndroidManifest.xml&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 指定manifest.xml路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            java.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;src&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// java文件的路径，包名的上一层，多个目录使用逗号分隔，如[&#39;src&#39;, &#39;core&#39;]&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resources.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;src&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// resource资源所有的目录，注意这里是指jar文件中包含的一些资源，如properties文件，而不是APK中的res资源&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            aidl.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;src&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// aidl文件的目录&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            renderscript.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;src&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// renderscript文件的路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            res.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;res&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// android APK中的资源路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            assets.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;assets&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// android app中的asset目录&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            jniLibs.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;libs&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// SO库的路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lintOptions &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        checkReleaseBuilds &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// release编译时禁用lint检查&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        abortOnError &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 报错不会停止打包，除非很严重的很影响&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        disable &lt;span class=&quot;string&quot;&gt;&#39;MissingTranslation&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;ExtraTranslation&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 禁用lint检查中的一些选项&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    dexOptions &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        javaMaxHeapSize &lt;span class=&quot;string&quot;&gt;&quot;4g&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 设置编译项目代码时最在的堆内存大小，否则项目过大时，编译内存溢出&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compileOptions &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 具体参考这里http://google.github.io/android-gradle-dsl/2.3/com.android.build.gradle.internal.CompileOptions.html&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        sourceCompatibility JavaVersion.VERSION_1_7 &lt;span class=&quot;comment&quot;&gt;// 设置代码编译的版本，一般是在使用JDK1.8时，配置这个，使编译出来的jar包让别人使用时更通用&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        targetCompatibility JavaVersion.VERSION_1_7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    packagingOptions &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/DEPENDENCIES.txt&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 排除这些第三方jar中的声明文件，否则编译时容易导致报错&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/LICENSE.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/NOTICE.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/NOTICE&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/LICENSE&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/DEPENDENCIES&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/notice.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/license.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/dependencies.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/LGPL2.1&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    buildTypes &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         debug &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    		 storeFile file(&lt;span class=&quot;string&quot;&gt;&quot;debug.keystore&quot;&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// 签名文件相对路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           storePassword &lt;span class=&quot;string&quot;&gt;&quot;android&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 签名的密码&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           keyAlias &lt;span class=&quot;string&quot;&gt;&quot;androiddebugkey&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 别名&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           keyPassword &lt;span class=&quot;string&quot;&gt;&quot;android&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 别名密码&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           buildConfigField &lt;span class=&quot;string&quot;&gt;&quot;boolean&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;FLAG_DEBUG&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;true&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 在BuildConfig.的类中自动生成public static final boolean FLAG_DEBUG = true;代码&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           buildConfigField &lt;span class=&quot;string&quot;&gt;&quot;String&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;API_VERSION&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;\&quot;1\&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           ndk &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           	abiFilters &lt;span class=&quot;string&quot;&gt;&quot;armeabi&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;armeabi-v7a&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 只保留这几种CPU架构的SO库，需要高版本的gradle才支持&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &lt;span class=&quot;comment&quot;&gt;// jniDebuggable true // 启用JNI debug，一般很少使用，不建议开这个选项，会影响java代码的debug速度&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        release &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            buildConfigField &lt;span class=&quot;string&quot;&gt;&quot;boolean&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;FLAG_DEBUG&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;false&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            buildConfigField &lt;span class=&quot;string&quot;&gt;&quot;String&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;API_VERSION&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;\&quot;1\&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            minifyEnabled &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 在混淆时去除代码中无用的内容&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            shrinkResources &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 在混淆时去除无用的资源，针对res/目录中的内容，不会压缩图片的大小&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            proguardFiles getDefaultProguardFile(&lt;span class=&quot;string&quot;&gt;&#39;proguard-android.txt&#39;&lt;/span&gt;), &lt;span class=&quot;string&quot;&gt;&#39;proguard-rules.pro&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 配置混淆文件&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            ndk &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            	abiFilters &lt;span class=&quot;string&quot;&gt;&quot;armeabi&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;armeabi-v7a&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 只保留这几种CPU架构的SO库，需要高版本的gradle才支持&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile fileTree(&lt;span class=&quot;string&quot;&gt;include:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;*.jar&#39;&lt;/span&gt;], &lt;span class=&quot;string&quot;&gt;dir:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;libs&#39;&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// 导入libs目录中的所有jar包&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    androidTestCompile(&lt;span class=&quot;string&quot;&gt;&#39;com.android.support.test.espresso:espresso-core:2.2.2&#39;&lt;/span&gt;, &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 排除group中的modle，注意group和module名称com.android.support:support-annotations&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;group:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;com.android.support&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;module:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;support-annotations&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile &lt;span class=&quot;string&quot;&gt;&#39;com.android.support:appcompat-v7:25.1.0&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 使用google的appcompat-v7包&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    testCompile &lt;span class=&quot;string&quot;&gt;&#39;junit:junit:4.12&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 引入junit单元测试&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile &lt;span class=&quot;string&quot;&gt;&#39;com.android.support:multidex:1.0.0&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 加入加载多dex库&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile files(&lt;span class=&quot;string&quot;&gt;&#39;libs/gson.jar&#39;&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// 引用libs目录中的gson.jar包&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile(&lt;span class=&quot;string&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;HMS-SDK-2.4.0.300&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;ext:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;aar&#39;&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// 引入HMS-SDK-2.4.0.300.aar文件，同时还需要参考文件头部分的配置&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile(&lt;span class=&quot;string&quot;&gt;&#39;com.facebook.fresco:fresco:1.0.0&#39;&lt;/span&gt;) &amp;#123; exclude &lt;span class=&quot;string&quot;&gt;module:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;support-v4&#39;&lt;/span&gt; &amp;#125; &lt;span class=&quot;comment&quot;&gt;// 引入fresco库，但不使用其中引用的support-v4库，否则导致重复引入，编译报错duplicate&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    provided fileTree(&lt;span class=&quot;string&quot;&gt;dir:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;compilelibs&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;include:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;*.jar&#39;&lt;/span&gt;]) &lt;span class=&quot;comment&quot;&gt;// 引入compilelibs目录下面的jar文件参与编译，但不将这些包的代码打入APK、jar或AAR中。&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 使用jar任务生成jar文件，依赖assembleRelease的task&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;task buildJar(&lt;span class=&quot;string&quot;&gt;type:&lt;/span&gt; Jar, &lt;span class=&quot;string&quot;&gt;dependsOn:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;assembleRelease&#39;&lt;/span&gt;]) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    destinationDir = file(&lt;span class=&quot;string&quot;&gt;&#39;build/outputs/jar/&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    appendix = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    baseName = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    version = SDK_VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// manifest信息&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; map = [&lt;span class=&quot;string&quot;&gt;&#39;Version&#39;&lt;/span&gt;: SDK_VERSION,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Gradle&#39;&lt;/span&gt;: project.gradle.gradleVersion,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Vendor&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;szcomtop.com&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Date&#39;&lt;/span&gt;: &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Date().getDateTimeString()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    manifest.attributes(map)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//    from( &#39;build/intermediates/classes/release/&#39;)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    from(project.zipTree( &lt;span class=&quot;string&quot;&gt;&#39;build/intermediates/transforms/proguard/release/jars/3/3/main.jar&#39;&lt;/span&gt;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/BuildConfig.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/BuildConfig\$*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/R.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/R\$*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    include(&lt;span class=&quot;string&quot;&gt;&#39;**/*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 使用Copy任务复制内容&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;task copySDK(&lt;span class=&quot;string&quot;&gt;type:&lt;/span&gt; Copy, &lt;span class=&quot;string&quot;&gt;dependsOn:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;buildJar&#39;&lt;/span&gt;]) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    from(&lt;span class=&quot;string&quot;&gt;&#39;build/outputs/jar&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    into(&lt;span class=&quot;string&quot;&gt;&#39;../app/libs/&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    include(&lt;span class=&quot;string&quot;&gt;&quot;*.jar&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;hr&gt;
&lt;h1 id=&quot;使用方法&quot;&gt;&lt;a href=&quot;#使用方法&quot; class=&quot;headerlink&quot; title=&quot;使用方法&quot;&gt;&lt;/a&gt;使用方法&lt;/h1&gt;&lt;p&gt;本方会持续更新，随着android的gradle工具的升级，可能有些配置会发生变化。比如&lt;code&gt;ndk.abiFilters&lt;/code&gt;需要在高版本的gradle工具中才能使用，如何升级gradle版本，也可能会带来编译不通过等问题，需要耗费较长时间去解决，所以请慎重。&lt;/p&gt;
&lt;p&gt;关于一些配置的用法，下面举其中一个例子，其他雷同。&lt;/p&gt;
&lt;p&gt;比如怎么知道有这个&lt;code&gt;compileOptions&lt;/code&gt;配置？这个配置下面的又有哪些可以设置？这些设置怎么去使用？能给哪些值？&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;compileOptions &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sourceCompatibility JavaVersion.VERSION_1_7 // 设置代码编译的版本，一般是在使用JDK1.8时，配置这个，使编译出来的jar包让别人使用时更通用&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    targetCompatibility JavaVersion.VERSION_1_7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;从官网入手&quot;&gt;&lt;a href=&quot;#从官网入手&quot; class=&quot;headerlink&quot; title=&quot;从官网入手&quot;&gt;&lt;/a&gt;从官网入手&lt;/h2&gt;&lt;p&gt;android官方定义的gradle工具的使用说明文档点&lt;a href=&quot;http://google.github.io/android-gradle-dsl/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;，gradle官方的说明文档点&lt;a href=&quot;https://docs.gradle.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;点开链接中有个&lt;code&gt;DSL&lt;/code&gt;，这个&lt;code&gt;DSL&lt;/code&gt;是啥？&lt;code&gt;DSL&lt;/code&gt;就是&lt;code&gt;Gradle Build Language&lt;/code&gt;的缩写。哈哈，开个玩笑，是&lt;code&gt;Domain Specific Language&lt;/code&gt;的缩写，&lt;code&gt;Domain&lt;/code&gt;可以理解为&lt;code&gt;Project&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;跑题了，继续。&lt;/p&gt;
&lt;h2 id=&quot;compileOptions示例&quot;&gt;&lt;a href=&quot;#compileOptions示例&quot; class=&quot;headerlink&quot; title=&quot;compileOptions示例&quot;&gt;&lt;/a&gt;compileOptions示例&lt;/h2&gt;&lt;p&gt;打开android gradle工具的官方说明文档页面会看到如下图所示的版本选择页面：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/android-gradle-plugin-version.png&quot; alt=&quot;android gradle工具版本&quot;&gt;&lt;/p&gt;
&lt;p&gt;这个版本是与&lt;code&gt;android studio&lt;/code&gt;项目根目录下的&lt;code&gt;build.gradle&lt;/code&gt;文件中的gradle版本是对应起来的。同时发现，这个版本会与&lt;code&gt;android studio&lt;/code&gt;的版本对应。如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/android-studio-build-gradle-location.png&quot; alt=&quot;android studio build.gradle文件中的版本&quot;&gt;&lt;/p&gt;
&lt;p&gt;点击当前的2.2版本的链接，进入到如下界面，如下图所示，在左侧找到&lt;code&gt;compileOptions&lt;/code&gt;，并点击这个链接（熟悉这个官方文档可以从左侧的Home项开始）：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/compile-options-location.png&quot; alt=&quot;compileOptions的位置&quot;&gt;&lt;/p&gt;
&lt;p&gt;再点击上图中红色框框标记的链接，就会跳转到如下图所示位置的配置说明，这种跳转的方式有点类似Java的API，只不过这个时候看到的应该是详细，结果却没有：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/compile-options-detail.png&quot; alt=&quot;compileOptions详细说明&quot;&gt;&lt;/p&gt;
&lt;p&gt;需要进一步查看详细，只能是点击上图红色框框标记的链接，进去之后就会发现熟悉的内容了，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/compile-options-detail-page.png&quot; alt=&quot;compileOptions详细配置说明页面&quot;&gt;&lt;/p&gt;
&lt;p&gt;有没有一种久违的感觉，终于快看到真相了吧？还差一步。compileOptions中可用的选项及含义已经在上面写的很清楚了。再点击&lt;code&gt;sourceCompatibility&lt;/code&gt;会跳到如下图所示内容：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/source-compatibility-values.png&quot; alt=&quot;sourceCompatibility可配置的参数&quot;&gt;&lt;/p&gt;
&lt;p&gt;可以从上面看到&lt;code&gt;sourceCompatibility&lt;/code&gt;可以取哪些值，终于找到结果了。&lt;/p&gt;
&lt;p&gt;OK，&lt;code&gt;compileOptions&lt;/code&gt;示例就到这里，其它的配置使用也可以使用相同的方法，gradle官方使用文档也是类似，剩下的只是熟悉的问题了。&lt;/p&gt;
&lt;h1 id=&quot;注意事项：&quot;&gt;&lt;a href=&quot;#注意事项：&quot; class=&quot;headerlink&quot; title=&quot;注意事项：&quot;&gt;&lt;/a&gt;注意事项：&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;ol&gt;
&lt;li&gt;如果&lt;code&gt;shrinkResources&lt;/code&gt;设置为true，在高版本的gradle中打release APK时会出现如下错误：&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;build\intermediates\res\resources-release-stripped.ap_&amp;apos; specified for property &amp;apos;resourceFile&amp;apos; does not exist.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;导致的原因不明，解决方法是将其设置为false。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;更新日志：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;2017-03-07 增加&lt;code&gt;注意事项&lt;/code&gt;中的1说明。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;基本介绍&quot;&gt;&lt;a href=&quot;#基本介绍&quot; class=&quot;headerlink&quot; title=&quot;基本介绍&quot;&gt;&lt;/a&gt;基本介绍&lt;/h1&gt;&lt;p&gt;本文是针对android开发中的&lt;code&gt;build.gradle&lt;/code&gt;文件中的常用配置总结，一些配置是在特定的场景下才使用，一些是为了解决一些问题才加上。所以默认还是使用在Android Studio工具中新建项目时生成的默认的&lt;code&gt;build.gradle&lt;/code&gt;文件中的配置，等遇到了问题，再来加一些配置。&lt;/p&gt;
    
    </summary>
    
      <category term="gradle" scheme="http://www.jacpy.com/categories/gradle/"/>
    
    
      <category term="gradle配置" scheme="http://www.jacpy.com/tags/gradle%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>android studio 使用gradle打jar包并混淆</title>
    <link href="http://www.jacpy.com/2017/02/28/android-studio-gradle-make-jar-and-proguard.html"/>
    <id>http://www.jacpy.com/2017/02/28/android-studio-gradle-make-jar-and-proguard.html</id>
    <published>2017-02-28T01:11:22.000Z</published>
    <updated>2017-03-05T14:00:14.000Z</updated>
    
    <content type="html">&lt;p&gt;昨天准备把写好的代码使用gradle打jar包出来，并打算加混淆。打jar包容易，结果在混淆上走了弯路。&lt;/p&gt;
&lt;p&gt;首先打jar包的配置很简单，使用jar的task，可以参考&lt;a href=&quot;https://docs.gradle.org/3.3/dsl/org.gradle.api.tasks.bundling.Jar.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gradle官方文档&lt;/a&gt;，具体代码如下：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;task buildJar(&lt;span class=&quot;string&quot;&gt;type:&lt;/span&gt; Jar, &lt;span class=&quot;string&quot;&gt;dependsOn:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;assembleRelease&#39;&lt;/span&gt;]) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    destinationDir = file(&lt;span class=&quot;string&quot;&gt;&#39;build/outputs/jar/&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    appendix = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    baseName = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    version = SDK_VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// manifest信息&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; map = [&lt;span class=&quot;string&quot;&gt;&#39;Version&#39;&lt;/span&gt;: SDK_VERSION,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Gradle&#39;&lt;/span&gt;: project.gradle.gradleVersion,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Vendor&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Date&#39;&lt;/span&gt;: &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Date().getDateTimeString()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    manifest.attributes(map)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    from(&lt;span class=&quot;string&quot;&gt;&#39;build/intermediates/classes/release/&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/BuildConfig.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/BuildConfig\$*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/R.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/R\$*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    include(&lt;span class=&quot;string&quot;&gt;&#39;**/*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是发现上面打出来的jar包中的代码没有被混淆，于是加混淆。使用混淆的proguard.gradle.ProGuardTask task时，发现总是报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;java.io.IOException: The output jar [....jar] must be specified after an input jar, or it will be empty.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;按照上面的提示，&lt;code&gt;outjars&lt;/code&gt;是写在&lt;code&gt;injars&lt;/code&gt;后面啊，&lt;code&gt;it will be empty&lt;/code&gt;是提示哪里有问题？以为是&lt;code&gt;proguard-rules.pro&lt;/code&gt;文件中的配置有问题，结果把文件清空，还是报上面的错误，错误原因不得而知了。在这个问题上耗了很长时间，最终还是没有解决。&lt;/p&gt;
&lt;p&gt;突然看到上面的&lt;code&gt;assembleRelease&lt;/code&gt; task想起了平常打APK时，会使用到这个task，打出来的APK会自动混淆。那这个&lt;code&gt;assembleRelease&lt;/code&gt; task就会依赖处理混淆的task，于是查看了输出日志：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;101&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;102&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;103&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;104&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;105&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;106&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;107&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;108&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;109&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;110&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;111&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;112&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;To honour the JVM settings for this build a new JVM will be forked. Please consider using the daemon: https://docs.gradle.org/2.14.1/userguide/gradle_daemon.html.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Observed package id &amp;apos;system-images;android-22;google_apis;x86&amp;apos; in inconsistent location &amp;apos;android-sdk-windows-studio\system-images\addon-google_apis-google-22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;\x86&amp;apos; (Expected &amp;apos;android-sdk-windows-studio\system-images\android-22\google_apis\x86&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Observed package id &amp;apos;system-images;android-22;google_apis;x86&amp;apos; in inconsistent location &amp;apos;android-sdk-windows-studio\system-images\addon-google_apis-google-22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;\x86&amp;apos; (Expected &amp;apos;android-sdk-windows-studio\system-images\android-22\google_apis\x86&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Incremental java compilation is an incubating feature.                &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preBuild UP-TO-DATE                                                                                                                                                &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:extractProguardFiles&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preReleaseBuild&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:checkReleaseManifest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preDebugAndroidTestBuild UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preDebugBuild UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preDebugUnitTestBuild UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preReleaseUnitTestBuild UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportAnimatedVectorDrawable2510Library UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportAppcompatV72510Library UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportCompat2510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportCoreUi2510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportCoreUtils2510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportFragment2510Library UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportMediaCompat2510Library UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportV42510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportVectorDrawable2510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareReleaseDependencies&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseAidl UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseNdk UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileLint UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:copyReleaseLint UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseRenderscript UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseBuildConfig                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseResValues UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseResources UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseResources UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:processReleaseManifest UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:processReleaseResources UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseSources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:incrementalReleaseJavaCompilationSafeguard                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseJavaWithJavac                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseJavaWithJavac - is not incremental (e.g. outputs have changed, no previous execution, etc.).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;注: 某些输入文件使用或覆盖了已过时的 API。                                                                                                                               &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;注: 有关详细信息, 请使用 -Xlint:deprecation 重新编译。                                                                                                                   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:extractReleaseAnnotations                   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseShaders UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseShaders UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseAssets UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseAssets UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseProguardFiles UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:packageReleaseRenderscript UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:packageReleaseResources UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:processReleaseJavaRes UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformResourcesWithMergeJavaResForRelease UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformClassesAndResourcesWithProguardForRelease                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ProGuard, version 5.2.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading input...                                                        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading program directory [sdk\build\intermediates\classes\release] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-media-compat\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-compat\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-fragment\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-core-ui\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\animated-vector-drawable\25.1.0\jars\classes.jar] (filte&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;red)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [android-sdk-windows-studio\extras\android\m2repository\com\android\support\support-annotations\25.1.0\support-annotations-25.1.0.jar] (f&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;iltered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-v4\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-vector-drawable\25.1.0\jars\classes.jar] (filter&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ed)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\appcompat-v7\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-core-utils\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [\android-sdk-windows-studio\platforms\android-25\android.jar]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [\android-sdk-windows-studio\platforms\android-25\optional\org.apache.http.legacy.jar]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [android.net.http.HttpResponseCache]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [android.net.http.SslCertificate$DName]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [android.net.http.SslError]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [android.net.http.SslCertificate]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.params.CoreConnectionPNames]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.params.HttpConnectionParams]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.params.HttpParams]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.conn.scheme.SocketFactory]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.conn.scheme.LayeredSocketFactory]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.conn.scheme.HostNameResolver]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.conn.ConnectTimeoutException]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: there were 11 duplicate class definitions.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      (http://proguard.sourceforge.net/manual/troubleshooting.html#duplicateclass)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Initializing...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: you&amp;apos;re ignoring all warnings!                                     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Ignoring unused library classes...                                      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Original number of library classes: 5857&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Final number of library classes:    383&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Printing kept classes, fields, and methods...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Shrinking...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Printing usage to [sdk\build\outputs\mapping\release\usage.txt]...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Removing unused program classes and class elements...                   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Original number of program classes: 52                                &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Final number of program classes:    48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Obfuscating...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Printing mapping to [sdk\build\outputs\mapping\release\mapping.txt]...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Writing output...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Preparing output jar [sdk\build\intermediates\transforms\proguard\release\jars\3\3\main.jar]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Copying resources from program directory [sdk\build\intermediates\classes\release] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Printing classes to [sdk\build\outputs\mapping\release\dump.txt]...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformClassesAndResourcesWithSyncLibJarsForRelease                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseJniLibFolders UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformNative_libsWithMergeJniLibsForRelease UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformNative_libsWithSyncJniLibsForRelease UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:bundleRelease                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseSources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:assembleRelease&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:buildJar                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;              &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BUILD SUCCESSFUL.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;好家伙，被我发现了。其中从&lt;code&gt;:sdk:transformClassesAndResourcesWithProguardForRelease&lt;/code&gt;这个task就可以看到，下面一堆日志是关于&lt;code&gt;ProGuard&lt;/code&gt;混淆工具的，最后可以看到：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Preparing output jar [sdk\build\intermediates\transforms\proguard\release\jars\3\3\main.jar]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个&lt;code&gt;main.jar&lt;/code&gt;就是混淆后的jar包，只不过这个jar还包含了&lt;code&gt;R&lt;/code&gt;类和&lt;code&gt;BuildConfig&lt;/code&gt;类的信息，所以将这个信息过滤掉就可以。但问题也来了，jar包都已经打好了，怎么配置混淆？解决方法是只要把jar包当输入就行了，最终配置如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;task buildJar(type: Jar, dependsOn: [&amp;apos;assembleRelease&amp;apos;]) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    destinationDir = file(&amp;apos;build/outputs/jar/&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    appendix = &amp;quot;&amp;quot; // SDK的后缀名称&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    baseName = &amp;quot;&amp;quot; // SDK名称&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    version = SDK_VERSION // 这个常量是在gradle.properties中配置的&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    // manifest信息&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def map = [&amp;apos;Version&amp;apos;: SDK_VERSION,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &amp;apos;Gradle&amp;apos;: project.gradle.gradleVersion,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &amp;apos;Vendor&amp;apos;: &amp;apos;&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &amp;apos;Date&amp;apos;: new Date().getDateTimeString()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    manifest.attributes(map)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    from(project.zipTree(&amp;apos;build/intermediates/transforms/proguard/release/jars/3/3/main.jar&amp;apos;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&amp;apos;**/BuildConfig.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&amp;apos;**/BuildConfig\$*.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&amp;apos;**/R.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&amp;apos;**/R\$*.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    include(&amp;apos;**/*.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;OK，任务搞定。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;昨天准备把写好的代码使用gradle打jar包出来，并打算加混淆。打jar包容易，结果在混淆上走了弯路。&lt;/p&gt;
&lt;p&gt;首先打jar包的配置很简单，使用jar的task，可以参考&lt;a href=&quot;https://docs.gradle.org/3.3/dsl/org.gradle.api.tasks.bundling.Jar.html&quot;&gt;gradle官方文档&lt;/a&gt;，具体代码如下：&lt;/p&gt;
    
    </summary>
    
      <category term="gradle" scheme="http://www.jacpy.com/categories/gradle/"/>
    
    
      <category term="gradle打jar包 混淆" scheme="http://www.jacpy.com/tags/gradle%E6%89%93jar%E5%8C%85-%E6%B7%B7%E6%B7%86/"/>
    
  </entry>
  
  <entry>
    <title>golang抓取html转换成pdf</title>
    <link href="http://www.jacpy.com/2017/02/19/go-html-to-pdf.html"/>
    <id>http://www.jacpy.com/2017/02/19/go-html-to-pdf.html</id>
    <published>2017-02-19T14:39:21.000Z</published>
    <updated>2017-03-05T14:01:34.000Z</updated>
    
    <content type="html">&lt;p&gt;总结一下学习十来天go语言的成果，看了一遍语法之后，写了一个抓取HTML然后转换成PDF文件的程序，分享一下，代码点&lt;a href=&quot;https://github.com/jacpy/GoDemo/blob/master/html2pdf/html2pdf.go&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;。代码在目前go的1.7.5版本和1.8版本上运行没有问题，据说go向下兼容，而不像swift。但发现有些比较老的资料上的代码，在新的go版本上看不到效果，比如打印地址&lt;code&gt;%p&lt;/code&gt;，在新版本中必须得使用&lt;code&gt;unsafe.Pointer(p)&lt;/code&gt;转换一下，否则格式化输出指针变量不会打印出内存地址。&lt;/p&gt;
&lt;p&gt;其中使用了两个第三方库：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;html操作使用了&lt;a href=&quot;https://github.com/PuerkitoBio/goquery&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;goquery&lt;/a&gt;的第三方库，对html操作很方便；&lt;/li&gt;
&lt;li&gt;html转PDF使用了&lt;a href=&quot;http://wkhtmltopdf.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;wkhtmltopdf&lt;/a&gt;库，到官方网站上选择相应的平台下载安装，然后在go语言中执行相应的命令即可。使用说明点&lt;a href=&quot;http://wkhtmltopdf.org/usage/wkhtmltopdf.txt&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另外还有一个去水印的功能，想具体了解请参考代码。&lt;/p&gt;
&lt;p&gt;通过这个功能的练手，发现go语言还是相关操作都很方便。比如文件读写：不像java那样，不同的流嵌套，然后就是try-catch。go里面写起来，相比而言简单好多。goquery这个库操作HTML很方便，唯一感觉不好用的地方是修改HTML标签的属性值，没有找到类似这种&lt;code&gt;p.Find(&amp;quot;div.Part div a img&amp;quot;).RemoveAttr(&amp;quot;alt&amp;quot;)&lt;/code&gt;好用的函数。&lt;/p&gt;
&lt;p&gt;后面希望能更深入的了解go语言。&lt;/p&gt;
&lt;p&gt;附已经转换OK的PDF的下载地址：&lt;a href=&quot;https://github.com/jacpy/GoDemo/blob/master/html2pdf/TCP:IP%E8%AF%A6%E8%A7%A3%20%E5%8D%B71%EF%BC%9A%E5%8D%8F%E8%AE%AE.pdf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;TCP:IP详解 卷1：协议.pdf&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;总结一下学习十来天go语言的成果，看了一遍语法之后，写了一个抓取HTML然后转换成PDF文件的程序，分享一下，代码点&lt;a href=&quot;https://github.com/jacpy/GoDemo/blob/master/html2pdf/html2pdf.go&quot;&gt;这里&lt;/a&gt;。代码在目前go的1.7.5版本和1.8版本上运行没有问题，据说go向下兼容，而不像swift。但发现有些比较老的资料上的代码，在新的go版本上看不到效果，比如打印地址&lt;code&gt;%p&lt;/code&gt;，在新版本中必须得使用&lt;code&gt;unsafe.Pointer(p)&lt;/code&gt;转换一下，否则格式化输出指针变量不会打印出内存地址。&lt;/p&gt;
&lt;p&gt;其中使用了两个第三方库：&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://www.jacpy.com/categories/go/"/>
    
    
      <category term="go html to pdf" scheme="http://www.jacpy.com/tags/go-html-to-pdf/"/>
    
  </entry>
  
  <entry>
    <title>android集成华为推送总结</title>
    <link href="http://www.jacpy.com/2017/01/20/huawei-push-summary.html"/>
    <id>http://www.jacpy.com/2017/01/20/huawei-push-summary.html</id>
    <published>2017-01-20T08:01:07.000Z</published>
    <updated>2017-03-05T14:02:43.000Z</updated>
    
    <content type="html">&lt;p&gt;前段时间在应用中集成了华为推送，现在终于告一段落了，回首起来，发现一路踩的坑，都是泪啊。&lt;/p&gt;
&lt;p&gt;先交待下集成华为推送的背景：由于android手机上的google官方的推送GCM在中国大陆基本是残废，而大陆有些手机厂商可能会干掉这部分，造成GCM推送基本不可用。而像小米、华为等手机厂商对android系统的ROM进行了深度定制，用户可以手机桌面直接将应用程序kill，即使有后台服务，都被会一起干掉，同时android新的版本为了改善手机续行，在6.0开始增加了Doze机制，无疑对推送又是一大打击。综合这些因素，决定选几种推送一起集成进来，其中就有针对华为手机的华为推送。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;去华为开发者官网发现，华为推送有两种，不细心还真发现不了。一种是已经明确标识的&lt;code&gt;PUSH服务&lt;/code&gt;，另一种是&lt;code&gt;华为移动服务（HMS）&lt;/code&gt;。&lt;code&gt;PUSH服务&lt;/code&gt;仅是提供推送服务，所以一般推送使用这种。如果华为手机没有打开&lt;code&gt;应用自启动&lt;/code&gt;也可以使用这种推送，但使用这种推送如果推送多条消息，会在通知栏显示多条通知，不会自动合并成一条，如果是用在IM中作为消息推送，N条消息一过来，用户体验可想而知。而相反，小米的推送就好很多，通知栏通知会自动合并，只显示一条。另外&lt;code&gt;HMS&lt;/code&gt;中不仅集成了推送，还包括支付等服务，使用&lt;code&gt;HMS&lt;/code&gt;中的推送可以自定义消息通知栏，还可以自定义数据格式，官方称这种方式为透传。&lt;code&gt;PUSH服务&lt;/code&gt;只能是系统弹出通知栏，应用没有控制权限，也不能额外的再传递数据，所以使用&lt;code&gt;HMS&lt;/code&gt;自定义通知栏通知可以解决通知栏弹出N多通知的问题。&lt;code&gt;PUSH服务&lt;/code&gt;与&lt;code&gt;HMS&lt;/code&gt;在华为手机上相比，前者的通用性更强些。目前在几台华为手机上测试发现，&lt;code&gt;PUSH服务&lt;/code&gt;都能注册成功，而&lt;code&gt;HMS&lt;/code&gt;在有些手机上不能注册成功，需要打开应用的&lt;code&gt;应用自启动&lt;/code&gt;开关，甚至有的手机上根本注册不成功，不管怎么折腾。&lt;/p&gt;
&lt;p&gt;那么想要好的推送效果，又想要好的推送体验，唯一解决办法是两种都集成，先通过&lt;code&gt;HMS&lt;/code&gt;注册，如果注册不成功，则使用使用&lt;code&gt;PUSH服务&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;写这篇记录的时候去官网看了一下，官方已经将&lt;code&gt;PUSH服务&lt;/code&gt;与&lt;code&gt;HMS&lt;/code&gt;中的推送合并，下图是官方的文档说明：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/01/22/hw_push_merge.png&quot; alt=&quot;PUSH服务与HMS推送合并&quot;&gt;&lt;/p&gt;
&lt;p&gt;另外还有一些坑：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;1.华为联盟后台的账号登录后会在浏览器缓存cookie，如果切换账号，发现后台的信息还是上一个账号的，需要清除浏览器cookie缓存才OK。这是同事在使用公司的账号和个人的账号测试时发现的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;2.如果在推送中已经填写了Debug Key的SHA256证书指纹，再改成Release Key的指纹时，发现手机一直获取不到token，解决办法是把手机中相关华为的服务的应用缓存清除掉，特别是华为移动服务。如果还是不行，把华为商城应用升级到最新版本。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;添加指纹的位置：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://developer.huawei.com/consumer/cn/wiki/images/3/3b/x04.HMS,PE5,PBC,P80,PE5,P8F,P91,PE6,P8C,P87,PE5,PAF,PBC,PE4,PB9,PA6-PUSH,PE6,P9C,P8D,PE5,P8A,PA1,PE6,P8E,PA5,PE5,P8F,PA3-,PE7,P8E,PB0,PE6,P9C,P89,PE4,PB8,P9A,PE5,P8A,PA1,PE8,PBF,P81,PE7,PA7,PBB.png.pagespeed.ic.AU0p7gImxO.webp&quot; alt=&quot;华为联盟后台推送添加SHA256指纹的官网截图&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;3.如果一直能正常获取到token，突然又不能，解决办法是重启手机再试。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;4.如果注册成功，发现收到消息，首先排查服务器端调用华为SDK是否OK，如果服务器端调用OK，没有出现报错之类的问题，然后就是等，可能是10分钟后或者20分钟后，甚至是第二天，你就&lt;code&gt;基本&lt;/code&gt;能收到消息了。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;自己集成SDK测试时，出现了几次消息没收到的情况，也就是推送丢失了。但使用华为联盟后台推送比使用SDK推送，消息的到达率和准时性要好。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面这张截图是华为官方的服务介绍：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/01/22/hw_push_msg_arrived_ratio.png&quot; alt=&quot;基本100%送到，远远高于其他推送平台&quot;&gt;&lt;/p&gt;
&lt;p&gt;还有一些问题的解决方案参考这里：&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.jacpy.com/2017/01/19/huawei-hms-push-timepicker-inflate-error.html&quot;&gt;使用HMS推送定义了EMUI的样式导致TimePicker初始化失败&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;如果还遇到其他问题解决不了，通过QQ找他们技术支持。&lt;/p&gt;
&lt;p&gt;希望能帮到一些人，以上。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前段时间在应用中集成了华为推送，现在终于告一段落了，回首起来，发现一路踩的坑，都是泪啊。&lt;/p&gt;
&lt;p&gt;先交待下集成华为推送的背景：由于android手机上的google官方的推送GCM在中国大陆基本是残废，而大陆有些手机厂商可能会干掉这部分，造成GCM推送基本不可用。而像小米、华为等手机厂商对android系统的ROM进行了深度定制，用户可以手机桌面直接将应用程序kill，即使有后台服务，都被会一起干掉，同时android新的版本为了改善手机续行，在6.0开始增加了Doze机制，无疑对推送又是一大打击。综合这些因素，决定选几种推送一起集成进来，其中就有针对华为手机的华为推送。&lt;/p&gt;
    
    </summary>
    
    
      <category term="HMS 华为透传 华为推送" scheme="http://www.jacpy.com/tags/HMS-%E5%8D%8E%E4%B8%BA%E9%80%8F%E4%BC%A0-%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>使用HMS推送定义了EMUI的样式导致TimePicker初始化失败</title>
    <link href="http://www.jacpy.com/2017/01/19/huawei-hms-push-timepicker-inflate-error.html"/>
    <id>http://www.jacpy.com/2017/01/19/huawei-hms-push-timepicker-inflate-error.html</id>
    <published>2017-01-19T07:46:24.000Z</published>
    <updated>2017-01-19T09:34:59.000Z</updated>
    
    <content type="html">&lt;p&gt;昨天遇到一个很奇葩的问题，使用了华为HMS SDK中的推送功能，然后插件布局文件中的TimePicker初始化时，会报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.view.InflateException: Binary XML file line #47: Error inflating class huawei.android.widget.TimePicker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;很奇怪，&lt;code&gt;TimePicker&lt;/code&gt;在布局文件中使用&lt;code&gt;&amp;lt;TimePicker/&amp;gt;&lt;/code&gt;标签，当布局文件被inflate后，在&lt;code&gt;android.widget.TimePicker&lt;/code&gt;前面加了一个&lt;code&gt;huawei.&lt;/code&gt;。如果使用&lt;code&gt;&amp;lt;android.widget.TimePicker/&amp;gt;&lt;/code&gt;标签，则不会有问题；而其他有地方会出现这个新的错误：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.view.InflateException: Binary XML file line #20: Error inflating class &amp;lt;unknown&amp;gt;at android.view.LayoutInflater.createView(LayoutInflater.java:620)at com.android.internal.policy.impl.PhoneLayoutInflater.onCreateView(PhoneLayoutInflater.java:56)at android.view.LayoutInflater.onCreateView(LayoutInflater.java:669)at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:694)at android.view.LayoutInflater.inflate(LayoutInflater.java:469)at android.view.LayoutInflater.inflate(LayoutInflater.java:397)at android.view.LayoutInflater.inflate(LayoutInflater.java:353)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:103)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:74)at android.view.View.performClick(View.java:4447)at android.view.View$PerformClick.run(View.java:18457)at android.os.Handler.handleCallback(Handler.java:733)at android.os.Handler.dispatchMessage(Handler.java:95)at android.os.Looper.loop(Looper.java:136)at android.app.ActivityThread.main(ActivityThread.java:5119)at java.lang.reflect.Method.invokeNative(Native Method)at java.lang.reflect.Method.invoke(Method.java:515)at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:789)at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:605)at dalvik.system.NativeStart.main(Native Method)Caused by: java.lang.reflect.InvocationTargetExceptionat java.lang.reflect.Constructor.constructNative(Native Method)at java.lang.reflect.Constructor.newInstance(Constructor.java:423)at android.view.LayoutInflater.createView(LayoutInflater.java:594)... 20 moreCaused by: java.lang.NullPointerExceptionat android.view.ViewGroup.addView(ViewGroup.java:3353)at com.huawei.android.hwcontrol.TimePickerFactory.updateAmPmStart(TimePickerFactory.java:92)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:265)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:139)... 23 morejava.lang.reflect.InvocationTargetExceptionat java.lang.reflect.Constructor.constructNative(Native Method)at java.lang.reflect.Constructor.newInstance(Constructor.java:423)at android.view.LayoutInflater.createView(LayoutInflater.java:594)at com.android.internal.policy.impl.PhoneLayoutInflater.onCreateView(PhoneLayoutInflater.java:56)at android.view.LayoutInflater.onCreateView(LayoutInflater.java:669)at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:694)at android.view.LayoutInflater.inflate(LayoutInflater.java:469)at android.view.LayoutInflater.inflate(LayoutInflater.java:397)at android.view.LayoutInflater.inflate(LayoutInflater.java:353)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:103)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:74)at android.view.View.performClick(View.java:4447)at android.view.View$PerformClick.run(View.java:18457)at android.os.Handler.handleCallback(Handler.java:733)at android.os.Handler.dispatchMessage(Handler.java:95)at android.os.Looper.loop(Looper.java:136)at android.app.ActivityThread.main(ActivityThread.java:5119)at java.lang.reflect.Method.invokeNative(Native Method)at java.lang.reflect.Method.invoke(Method.java:515)at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:789)at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:605)at dalvik.system.NativeStart.main(Native Method)Caused by: java.lang.NullPointerExceptionat android.view.ViewGroup.addView(ViewGroup.java:3353)at com.huawei.android.hwcontrol.TimePickerFactory.updateAmPmStart(TimePickerFactory.java:92)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:265)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:139)... 23 more&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但如果不使用插件，在主应用中使用TimePicker之类的组件，就一切OK。&lt;/p&gt;
&lt;p&gt;好吧，问题很严重，已经定位到是集成了推送的功能之后出现的。但很难定位为什么出现这种问题，注册Token后，跨进程通讯问题？后台推送服务导致的？&lt;/p&gt;
&lt;p&gt;看到这个&lt;code&gt;huawei.android.widget.TimePicker&lt;/code&gt;在想，华为又调皮了，又改了系统的源码。因为google官方的android系统源中有这样一个逻辑，发现布局文件中的View没有包名，会自动加上&lt;code&gt;android.widget.&lt;/code&gt;前缀。&lt;/p&gt;
&lt;p&gt;已经在怀疑是在AndroidManifest.xml文件中配置了什么导致了问题，所以一行一行的排查。果然，在去掉下面这行后，就正常了。&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;application&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;meta-data android:name=&quot;hwc-theme&quot;            android:value=&quot;androidhwext:style/Theme.Emui.NoActionBar&quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/application&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个&lt;code&gt;meta-data&lt;/code&gt;定义是放在&lt;code&gt;applicaton&lt;/code&gt;标签中，所以会针对整个App。把这行干掉之后，问题解决。&lt;/p&gt;
&lt;p&gt;这种问题也只能是在这种特定场景中被遇到，一般还真遇不到。三生有幸！&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;昨天遇到一个很奇葩的问题，使用了华为HMS SDK中的推送功能，然后插件布局文件中的TimePicker初始化时，会报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.view.InflateException: Binary XML file line #47: Error inflating class huawei.android.widget.TimePicker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="android push" scheme="http://www.jacpy.com/categories/android-push/"/>
    
    
      <category term="推送" scheme="http://www.jacpy.com/tags/%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>android点击通知栏通知启动Activity问题</title>
    <link href="http://www.jacpy.com/2016/12/28/android-notification-launch-activity.html"/>
    <id>http://www.jacpy.com/2016/12/28/android-notification-launch-activity.html</id>
    <published>2016-12-28T08:36:40.000Z</published>
    <updated>2017-01-19T09:36:41.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天遇到一个很奇葩的问题，终于解决了，记录一下。&lt;/p&gt;
&lt;p&gt;问题场景是：用小米手机使用小米推送一条消息，然后点击通知栏中的消息启动应用，然后进入会话的Activity。应用启动后，如果当前界面不是会话界面，那么新消息会在通知栏显示消息提醒，然后点击会话消息后却进不了会话的Activity，即点击了通知栏通知后，系统都没有启动指定Activity的意思，没有看到系统启动Activity的Log，到是会看到系统处理这个Activity的影子。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;这个指定的Activity不是会话的Activity，而是在AndroidManifest.xml文件中指定&lt;code&gt;android.intent.category.LAUNCHER&lt;/code&gt;的Activity A。也就是说有会话消息都是先从这个A开始，然后把数据往后面的Activity传。&lt;/p&gt;
&lt;p&gt;这里显示通知有两种方式，一种是由手机系统在通知栏弹出，比如小米手机上使用小米推送，华为手机上使用华为推送，另外一种是由应用的远程进程弹出。&lt;/p&gt;
&lt;p&gt;启动应用的第一个Activity A也有两种方式，一种是直接通过new来构造一个Intent，然后传入Activity A的class；另外一种是通过&lt;code&gt;context.getPackageManager().getLaunchIntentForPackage(context.getPackageName())&lt;/code&gt;来获取启动的Activity A的Intent。然后调用PendingIntent.getActivity()方法，将得到的intent传入。&lt;/p&gt;
&lt;p&gt;那么问题来了，如果是点击系统弹出的通知栏或者远程进程弹出的通知栏，如果只是使用其中一种启动方式启动应用，那么在应用启动后，点击通知栏中由后台远程进程弹出的新消息通知，这个时候就不能进入会话的Activity。从系统的日志来看，没有启动Activity，只是对Activity做了处理。&lt;/p&gt;
&lt;p&gt;可能有人会想到是不是要加一个&lt;code&gt;Intent.FLAG_ACTIVITY_NEW_TASK&lt;/code&gt;标识，因为在&lt;code&gt;getLaunchIntentForPackage()&lt;/code&gt;方法中加了这个标识。&lt;/p&gt;
&lt;p&gt;最后测试发现，只要应用没有被启动，不管是点击系统弹出的通知栏还是远程进程弹出的通知栏，如果再收到新消息通知，再点击通知栏，就能进入会话Activity了。那只要判断应用中是否有Activity被启动就OK了，貌似问题可以解决了。&lt;/p&gt;
&lt;p&gt;于是用了下面的逻辑来判断是否有前台Activity在运行。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/** * 判断UI进程是否正在运行 * &lt;span class=&quot;doctag&quot;&gt;@return&lt;/span&gt; 返回true表示正在运行，否则没有运行 */&lt;/span&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isForegroundRunning&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;    ActivityManager am = (ActivityManager) EimCloud.getContext().getSystemService(Context.ACTIVITY_SERVICE);    List&amp;lt;ActivityManager.RunningAppProcessInfo&amp;gt; list = am.getRunningAppProcesses();    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (list != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (ActivityManager.RunningAppProcessInfo info : list) &amp;#123;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (info.importance == ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND						&amp;amp;&amp;amp; EimCloud.getContext().getPackageName().equals(info.processName)) &amp;#123;					&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;            &amp;#125;        &amp;#125;    &amp;#125;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是上面的方法在小米手机上凑效了，但在华为手机上还是有问题，即使同样的场景。华为又坑爹了！&lt;/p&gt;
&lt;p&gt;于是开始从上面的&lt;code&gt;ActivityManager.RunningAppProcessInfo&lt;/code&gt;类中的&lt;code&gt;importance&lt;/code&gt;变量的状态入手，然后测试各种场景可能出现的变量值，结果发现效果不尽人意，有些场景问题依旧。&lt;/p&gt;
&lt;p&gt;最后，又换种思路：不从Activity A开始启动应用，换个Activity B，也就是在调用&lt;code&gt;PendingIntent.getActivity()&lt;/code&gt;方法传入Intent对象使用B的class。启动B会发现应用没有被初始化，则跳转到A执行初始化，然后再走正常流程。&lt;/p&gt;
&lt;p&gt;再针对各种场景以及各种机型测试，发现问题解决。从上面可以看出，虽然不懂背后原理，但解决问题的思路一定要广，特别是在急着发版本的时候，不要在一棵树上吊死。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天遇到一个很奇葩的问题，终于解决了，记录一下。&lt;/p&gt;
&lt;p&gt;问题场景是：用小米手机使用小米推送一条消息，然后点击通知栏中的消息启动应用，然后进入会话的Activity。应用启动后，如果当前界面不是会话界面，那么新消息会在通知栏显示消息提醒，然后点击会话消息后却进不了会话的Activity，即点击了通知栏通知后，系统都没有启动指定Activity的意思，没有看到系统启动Activity的Log，到是会看到系统处理这个Activity的影子。&lt;/p&gt;
    
    </summary>
    
      <category term="android push" scheme="http://www.jacpy.com/categories/android-push/"/>
    
    
      <category term="notification" scheme="http://www.jacpy.com/tags/notification/"/>
    
  </entry>
  
  <entry>
    <title>android布局中的EXACTLY、AT_MOST、UNSPECIFIED详解</title>
    <link href="http://www.jacpy.com/2016/12/18/android-exactly-atmost-unspecified-detailed-explaintion.html"/>
    <id>http://www.jacpy.com/2016/12/18/android-exactly-atmost-unspecified-detailed-explaintion.html</id>
    <published>2016-12-18T09:55:42.000Z</published>
    <updated>2016-12-18T09:55:52.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;前几天在给一个同事讲&amp;amp;运算取变量的状态写法，原因是我看到他代码中这样写会产生问题，所以想纠正他一下，于是就跟他说你可以参考下android系统中View在measure时使用的状态是怎么通过&amp;amp;运算获取的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;他也说这几个状态是与View在布局文件中设置width或height时，有个对应关系。就这个机会，深入的了解了下View的宽高的measure是怎么与&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#EXACTLY&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.view.View.MeasureSpec.EXACTLY&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#AT_MOST&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.view.View.MeasureSpec.AT_MOST&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#UNSPECIFIED&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.view.View.MeasureSpec.UNSPECIFIED&lt;/a&gt;这三种状态一一对应的。于是就有了下文。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;在布局文件中设置View的&lt;code&gt;layout_width&lt;/code&gt;或&lt;code&gt;layout_height&lt;/code&gt;时，可以设置三种值&lt;code&gt;match_parent&lt;/code&gt;、&lt;code&gt;wrap_content&lt;/code&gt;和具体的长度值，下面看下android系统源码中是怎么处理这几种值的。&lt;/p&gt;
&lt;p&gt;做过android开发都知道，如果在Activity的&lt;code&gt;onCreate()&lt;/code&gt;方法中通过调用View的&lt;code&gt;getWidth()&lt;/code&gt;方法是获取不到View的宽高的，此时返回的是0，因为View还没有初始化完成。那么查看View的&lt;code&gt;getWidth()&lt;/code&gt;方法发现，返回的值是通过&lt;code&gt;mRight - mLeft&lt;/code&gt;返回的值，也就是说如果调用&lt;code&gt;getWidth()&lt;/code&gt;返回值，那么一定是&lt;code&gt;mRight&lt;/code&gt;和&lt;code&gt;mLeft&lt;/code&gt;这两个变量被赋值了。View的&lt;code&gt;getHeight()&lt;/code&gt;方法返回高度同理。在View中&lt;code&gt;mLeft&lt;/code&gt;个成员被初始化值在两个方法中，一个是&lt;code&gt;setLeft(int)&lt;/code&gt;方法中，一个是&lt;code&gt;setFrame(int,int,int,int)&lt;/code&gt;中，实际上这两个方法都是由系统来调用的，尤其是&lt;code&gt;setFrame()&lt;/code&gt;方法被标记为隐藏。通过查看源码发现，&lt;code&gt;setLeft(int)&lt;/code&gt;这个方法很少被使用，倒是跟踪&lt;code&gt;setFrame(int,int,int,int)&lt;/code&gt;方法时，发现一些眉目，最后发现这个这个&lt;code&gt;setFrame()&lt;/code&gt;方法是在View的&lt;code&gt;layout()&lt;/code&gt;方法中一直调用过来的。OK，那么这个layout()方法的调用轨迹是怎样的呢？可以自定义一个View，然后重写这个View的&lt;code&gt;layout()&lt;/code&gt;方法，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;layout&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; l, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; t, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; r, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; b)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.layout(l, t, r, b);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Throwable th = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Throwable();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    th.printStackTrace(); &lt;span class=&quot;comment&quot;&gt;// 打印被调用的栈信息&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出的LOG如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;W/System.err: java.lang.Throwable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at com.jacpy.busline.widget.BusLineView.layout(BusLineView.java:243)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.RelativeLayout.onLayout(RelativeLayout.java:1055)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.layoutChildren(FrameLayout.java:453)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.onLayout(FrameLayout.java:388)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.LinearLayout.setChildFrame(LinearLayout.java:1671)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.LinearLayout.layoutVertical(LinearLayout.java:1525)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.LinearLayout.onLayout(LinearLayout.java:1434)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.layoutChildren(FrameLayout.java:453)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.onLayout(FrameLayout.java:388)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl.performLayout(ViewRootImpl.java:2013)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:1770)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:1019)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:5725)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer$CallbackRecord.run(Choreographer.java:761)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer.doCallbacks(Choreographer.java:574)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer.doFrame(Choreographer.java:544)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer$FrameDisplayEventReceiver.run(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.os.Handler.handleCallback(Handler.java:733)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.os.Looper.loop(Looper.java:136)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.app.ActivityThread.main(ActivityThread.java:5086)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at java.lang.reflect.Method.invokeNative(Native Method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at java.lang.reflect.Method.invoke(Method.java:515)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:601)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at dalvik.system.NativeStart.main(Native Method)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这段LOG从下往上看，首先是ZygoteInit启动，也就是手机系统的启动，这部分忽略，只看与应用相关的，从&lt;code&gt;ActivityThread.main()&lt;/code&gt;开始。在&lt;code&gt;ActivityThread&lt;/code&gt;中启动的Looper主线程用来执行了一个Runnable实例，这个实例是&lt;code&gt;android.view.Choreographer$FrameDisplayEventReceiver&lt;/code&gt;类的实例，在这个类的&lt;code&gt;run()&lt;/code&gt;方法中执行了Choreographer的&lt;code&gt;doFrame()&lt;/code&gt;方法，在这个方法中看到熟悉的日志输出：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Log.i(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Skipped &quot;&lt;/span&gt; + skippedFrames + &lt;span class=&quot;string&quot;&gt;&quot; frames!  &quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            + &lt;span class=&quot;string&quot;&gt;&quot;The application may be doing too much work on its main thread.&quot;&lt;/span&gt;);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当View初始化时在主线程中做的操作过多导致卡帧时，这个LOG就会输出。&lt;/p&gt;
&lt;p&gt;OK，跑题了，继续看日志。在&lt;code&gt;doCallbacks()&lt;/code&gt;方法中从&lt;code&gt;mCallbackQueues&lt;/code&gt;这个回调队列中根据回调的类型取出要执行的CallbackRecord对象，并调用其&lt;code&gt;run()&lt;/code&gt;方法。而ViewRootImpl的TraversalRunnable对象是通过在ViewRootImpl的&lt;code&gt;scheduleTraversals()&lt;/code&gt;方法中设置的。代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;scheduleTraversals&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mTraversalScheduled) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mTraversalScheduled = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mTraversalBarrier = mHandler.getLooper().postSyncBarrier();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mChoreographer.postCallback(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// 将mTranversalRunnable加入到mChoreographer的mCallbackQueues的队列中&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mUnbufferedInputDispatch) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            scheduleConsumeBatchedInput();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        notifyRendererOfFramePending();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最后在&lt;code&gt;performLayout()&lt;/code&gt;方法中看到具体调用View的&lt;code&gt;layout()&lt;/code&gt;方法的代码：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;host.layout(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, host.getMeasuredWidth(), host.getMeasuredHeight());&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里的host是ViewRootImpl的&lt;code&gt;mView&lt;/code&gt;对象，这个对象是一个PhoneWindow.DecorView对象，后面会有文章分析。&lt;/p&gt;
&lt;p&gt;OK，这里可以看到&lt;code&gt;mLeft&lt;/code&gt;赋值是0，&lt;code&gt;mRight&lt;/code&gt;就是&lt;code&gt;getMeasureWidth()&lt;/code&gt;方法的返回值。&lt;code&gt;getMeasureWidth()&lt;/code&gt;这个方法代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; MEASURED_SIZE_MASK = &lt;span class=&quot;number&quot;&gt;0x00ffffff&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getMeasuredWidth&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; mMeasuredWidth &amp;amp; MEASURED_SIZE_MASK;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面的代码可以看出，&lt;code&gt;mMeasureWidth&lt;/code&gt;取了后三个字节，也就是本来是int类型的&lt;code&gt;mMeasureWidth&lt;/code&gt;实际目前只使用了低位三个字节，对于目前的显示的分辨率来说足够。&lt;/p&gt;
&lt;p&gt;OK，重点来了，这个&lt;code&gt;mMeasureWidth&lt;/code&gt;的值是怎么来的？继续跟代码发现这个变量在View的&lt;code&gt;setMeasuredDimensionRaw()&lt;/code&gt;方法中被赋值，使用方法中的参数赋值。接着发现这个方法在&lt;code&gt;setMeasuredDimension()&lt;/code&gt;和&lt;code&gt;measure()&lt;/code&gt;方法中被调用。而在&lt;code&gt;measure()&lt;/code&gt;方法中&lt;code&gt;cacheIndex&lt;/code&gt;这个变量可能是-1，因为&lt;code&gt;mMeasureCache&lt;/code&gt;变量中的键值对只在&lt;code&gt;measure()&lt;/code&gt;方法最后才放进去的，而最后是调用了&lt;code&gt;onMeasure()&lt;/code&gt;方法。代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;measure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightMeasureSpec)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;// Suppress sign extension for the low bytes&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; key = (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) widthMeasureSpec &amp;lt;&amp;lt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt; | (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) heightMeasureSpec &amp;amp; &lt;span class=&quot;number&quot;&gt;0xffffffffL&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;// 用一个64位的long类型保存两个32位的值，高32位是宽，低32位是高&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mMeasureCache == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) mMeasureCache = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; LongSparseLongArray(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((mPrivateFlags &amp;amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            widthMeasureSpec != mOldWidthMeasureSpec ||&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            heightMeasureSpec != mOldHeightMeasureSpec) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// first clears the measured dimension flag&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mPrivateFlags &amp;amp;= ~PFLAG_MEASURED_DIMENSION_SET;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		 &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; cacheIndex = (mPrivateFlags &amp;amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; :&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                mMeasureCache.indexOfKey(key); &lt;span class=&quot;comment&quot;&gt;// 如果没有找到这个Key也是返回-1&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (cacheIndex &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || sIgnoreMeasureCache) &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 极有可能是走这个判断&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// measure ourselves, this should set the measured dimension flag back&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            onMeasure(widthMeasureSpec, heightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPrivateFlags3 &amp;amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; value = mMeasureCache.valueAt(cacheIndex);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Casting a long to int drops the high 32 bits, no mask needed&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            setMeasuredDimensionRaw((&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) (value &amp;gt;&amp;gt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;), (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) value);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		 &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	 &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	 &lt;span class=&quot;comment&quot;&gt;// 保存键值对&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mMeasureCache.put(key, ((&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) mMeasuredWidth) &amp;lt;&amp;lt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt; |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) mMeasuredHeight &amp;amp; &lt;span class=&quot;number&quot;&gt;0xffffffffL&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// suppress sign extension&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;而&lt;code&gt;setMeasuredDimension()&lt;/code&gt;方法是在&lt;code&gt;onMeasure()&lt;/code&gt;方法中有调用。因此，上面的代码不管是走&lt;code&gt;if&lt;/code&gt;流程还是&lt;code&gt;else&lt;/code&gt;流程，最终都会调用&lt;code&gt;setMeasuredDimensionRaw()&lt;/code&gt;这个方法。不管流程怎样，这个值是从&lt;code&gt;measure()&lt;/code&gt;这个方法中的参数传进来的。以同样的方法重写View的&lt;code&gt;onMeasure()&lt;/code&gt;方法，如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onMeasure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightMeasureSpec)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onMeasure(widthMeasureSpec, heightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Throwable t = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Throwable();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    t.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出的LOG如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;java.lang.Throwable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.jacpy.busline.widget.BusLineView.onMeasure(BusLineView.java:442)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.RelativeLayout.measureChildHorizontal(RelativeLayout.java:719)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.RelativeLayout.onMeasure(RelativeLayout.java:455)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:5137)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.FrameLayout.onMeasure(FrameLayout.java:310)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:5137)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.LinearLayout.measureChildBeforeLayout(LinearLayout.java:1404)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.LinearLayout.measureVertical(LinearLayout.java:695)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.LinearLayout.onMeasure(LinearLayout.java:588)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:5137)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.FrameLayout.onMeasure(FrameLayout.java:310)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.internal.policy.impl.PhoneWindow$DecorView.onMeasure(PhoneWindow.java:2291)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.performMeasure(ViewRootImpl.java:1942)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.measureHierarchy(ViewRootImpl.java:1132)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:1321)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:1019)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:5725)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer$CallbackRecord.run(Choreographer.java:761)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer.doCallbacks(Choreographer.java:574)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer.doFrame(Choreographer.java:544)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:747)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.os.Handler.handleCallback(Handler.java:733)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.os.Looper.loop(Looper.java:136)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.app.ActivityThread.main(ActivityThread.java:5086)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at java.lang.reflect.Method.invokeNative(Native Method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at java.lang.reflect.Method.invoke(Method.java:515)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:785)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:601)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at dalvik.system.NativeStart.main(Native Method)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从上面的LOG可以看出来，最终是在&lt;code&gt;measure()&lt;/code&gt;方法中调到&lt;code&gt;onMeasure()&lt;/code&gt;方法，也就是上面分析的流程。&lt;/p&gt;
&lt;p&gt;通过上面两段LOG发现，最终都指向了同一个地方，那就是ViewRootImpl的&lt;code&gt;performTraversals()&lt;/code&gt;。也就是说，在这个方法中先measure，然后再layout。&lt;/p&gt;
&lt;p&gt;从&lt;code&gt;measureHierarchy()&lt;/code&gt;方法中可以看出来在调用&lt;code&gt;performMeasure(int,int)&lt;/code&gt;方法时，传了两个参数&lt;code&gt;childWidthMeasureSpec&lt;/code&gt;和&lt;code&gt;childHeightMeasureSpec&lt;/code&gt;，而这两个变量是通过&lt;code&gt;getRootMeasureSpec()&lt;/code&gt;方法返回的，如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;measureHierarchy&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; View host, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; WindowManager.LayoutParams lp,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Resources res, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; desiredWindowWidth, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; desiredWindowHeight) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childWidthMeasureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childHeightMeasureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; windowSizeMayChange = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; goodMeasure = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// On large screens, we don&#39;t want to allow dialogs to just&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// stretch to fill the entire width of the screen to display&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// one line of text.  First try doing the layout at a smaller&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// size to see if it will fit.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; DisplayMetrics packageMetrics = res.getDisplayMetrics();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        res.getValue(com.android.internal.R.dimen.config_prefDialogWidth, mTmpValue, &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; baseSize = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mTmpValue.type == TypedValue.TYPE_DIMENSION) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            baseSize = (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)mTmpValue.getDimension(packageMetrics);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: baseSize=&quot;&lt;/span&gt; + baseSize);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (baseSize != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; desiredWindowWidth &amp;gt; baseSize) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: measured (&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    + host.getMeasuredWidth() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + host.getMeasuredHeight() + &lt;span class=&quot;string&quot;&gt;&quot;)&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((host.getMeasuredWidthAndState()&amp;amp;View.MEASURED_STATE_TOO_SMALL) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                goodMeasure = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// Didn&#39;t fit in that size... try expanding a bit.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                baseSize = (baseSize+desiredWindowWidth)/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: next baseSize=&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        + baseSize);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: measured (&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        + host.getMeasuredWidth() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + host.getMeasuredHeight() + &lt;span class=&quot;string&quot;&gt;&quot;)&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((host.getMeasuredWidthAndState()&amp;amp;View.MEASURED_STATE_TOO_SMALL) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Good!&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    goodMeasure = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!goodMeasure) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight()) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            windowSizeMayChange = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; windowSizeMayChange;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;本文的重点来了，&lt;code&gt;getRootMeasureSpec()&lt;/code&gt;方法的代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getRootMeasureSpec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; windowSize, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; rootDimension)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; measureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (rootDimension) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; ViewGroup.LayoutParams.MATCH_PARENT:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Window can&#39;t resize. Force root view to be windowSize.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; ViewGroup.LayoutParams.WRAP_CONTENT:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Window can resize. Set max size for root view.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Window wants to be an exact size. Force root view to be that size.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; measureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;从方法中的switch可以看到，&lt;code&gt;MATCH_PARENT&lt;/code&gt;对应&lt;code&gt;MeasureSpec.EXACTLY&lt;/code&gt;、&lt;code&gt;WRAP_CONTENT&lt;/code&gt;对应&lt;code&gt;MeasureSpec.AT_MOST&lt;/code&gt;，默认的可以认为是设置了具体的值对应的是&lt;code&gt;MeasureSpec.EXACTLY&lt;/code&gt;。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;为了确定一下，可以看下MeasureSpc的&lt;code&gt;makeMeasureSpec()&lt;/code&gt;方法的代码，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; MODE_SHIFT = &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; MODE_MASK  = &lt;span class=&quot;number&quot;&gt;0x3&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; UNSPECIFIED = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; EXACTLY     = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; AT_MOST     = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;makeMeasureSpec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; size, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; mode)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (sUseBrokenMakeMeasureSpec) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; size + mode;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; (size &amp;amp; ~MODE_MASK) | (mode &amp;amp; MODE_MASK);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前面说尺寸值是由低三个字节表示，这里可以看到高位第一个字节的前两个位用来表示mode。也就是说int类型的第31、32位表示的是mode值，低30位表示是具体的长度值。&lt;/p&gt;
&lt;p&gt;OK，最后是在ViewGroup的&lt;code&gt;measureChildWithMargins()&lt;/code&gt;方法中调用每个child的&lt;code&gt;measure()&lt;/code&gt;方法去具体测量每个子View的长度，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;measureChildWithMargins&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(View child,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; parentWidthMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthUsed,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; parentHeightMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightUsed) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    + widthUsed, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    + heightUsed, lp.height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;而其中被调用的&lt;code&gt;getChildMeasureSpec()&lt;/code&gt;方法中子View的大小是根据父View的大小及模式来决定的，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getChildMeasureSpec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; spec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; padding, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childDimension)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; specMode = MeasureSpec.getMode(spec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; specSize = MeasureSpec.getSize(spec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; size = Math.max(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, specSize - padding);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; resultSize = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; resultMode = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (specMode) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Parent has imposed an exact size on us&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MeasureSpec.EXACTLY:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = childDimension;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.MATCH_PARENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to be our size. So be it.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to determine its own size. It can&#39;t be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// bigger than us.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.AT_MOST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Parent has imposed a maximum size on us&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MeasureSpec.AT_MOST:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants a specific size... so be it&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = childDimension;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.MATCH_PARENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to be our size, but our size is not fixed.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Constrain child to not be bigger than us.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.AT_MOST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to determine its own size. It can&#39;t be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// bigger than us.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.AT_MOST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Parent asked to see how big we want to be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MeasureSpec.UNSPECIFIED:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants a specific size... let him have it&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = childDimension;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.MATCH_PARENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to be our size... find out how big it should&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; : size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.UNSPECIFIED;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to determine its own size.... find out how&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// big it should be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; : size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.UNSPECIFIED;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; MeasureSpec.makeMeasureSpec(resultSize, resultMode);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;OK，以上就是整个分析过程。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;前几天在给一个同事讲&amp;amp;运算取变量的状态写法，原因是我看到他代码中这样写会产生问题，所以想纠正他一下，于是就跟他说你可以参考下android系统中View在measure时使用的状态是怎么通过&amp;amp;运算获取的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;他也说这几个状态是与View在布局文件中设置width或height时，有个对应关系。就这个机会，深入的了解了下View的宽高的measure是怎么与&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#EXACTLY&quot;&gt;android.view.View.MeasureSpec.EXACTLY&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#AT_MOST&quot;&gt;android.view.View.MeasureSpec.AT_MOST&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#UNSPECIFIED&quot;&gt;android.view.View.MeasureSpec.UNSPECIFIED&lt;/a&gt;这三种状态一一对应的。于是就有了下文。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="view" scheme="http://www.jacpy.com/categories/view/"/>
    
    
      <category term="EXACTLY AT_MOST UNSPECIFIED" scheme="http://www.jacpy.com/tags/EXACTLY-AT-MOST-UNSPECIFIED/"/>
    
  </entry>
  
  <entry>
    <title>android中View创建过程详解</title>
    <link href="http://www.jacpy.com/2016/12/13/android-view-create-detail.html"/>
    <id>http://www.jacpy.com/2016/12/13/android-view-create-detail.html</id>
    <published>2016-12-13T01:46:45.000Z</published>
    <updated>2016-12-17T11:12:01.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天在看View的尺寸是怎样计算出来的，于是看了整个View被初始化的过程，结合系统源码总结了一下。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;从布局文件到LayoutParams&quot;&gt;&lt;a href=&quot;#从布局文件到LayoutParams&quot; class=&quot;headerlink&quot; title=&quot;从布局文件到LayoutParams&quot;&gt;&lt;/a&gt;从布局文件到LayoutParams&lt;/h2&gt;&lt;p&gt;首先从Activity的&lt;code&gt;setContentView(int)&lt;/code&gt;方法开始，只要设置了R.layout的布局文件，那么界面上就会显示出来对应的内容。所以以这个方法为初发点，然后往后跟踪代码。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;setContentView&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(@LayoutRes &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; layoutResID)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    getWindow().setContentView(layoutResID);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    initWindowDecorActionBar();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过以上代码发现调用了Window类的&lt;code&gt;setContentView&lt;/code&gt;方法，那么这个Window对象&lt;code&gt;mWindow&lt;/code&gt;又是怎么初始化的？在Activity中搜索发现是在Activity的&lt;code&gt;attach&lt;/code&gt;方法中初始化的，构造了一个PhoneWindow对象。如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;attach&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Context context, ActivityThread aThread,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Instrumentation instr, IBinder token, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; ident,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Application application, Intent intent, ActivityInfo info,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        CharSequence title, Activity parent, String id,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        NonConfigurationInstances lastNonConfigurationInstances,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Configuration config, String referrer, IVoiceInteractor voiceInteractor) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    attachBaseContext(context);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mFragments.attachHost(&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;/*parent*/&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; PhoneWindow(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// 这里创建了Window对象&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow.setCallback(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow.setOnWindowDismissedCallback(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow.getLayoutInflater().setPrivateFactory(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ... 中间部分代码省略&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow.setWindowManager(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mToken, mComponent.flattenToString(),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            (info.flags &amp;amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mParent != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mWindow.setContainer(mParent.getWindow());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindowManager = mWindow.getWindowManager();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mCurrentConfig = config;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在PhoneWindow的&lt;code&gt;setContentView(int)&lt;/code&gt;方法中，发现是调用了LayoutInflater的&lt;code&gt;inflate(int, View)&lt;/code&gt;方法，对这个布局文件进行转换成View，并添加到后面View这个参数中。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;setContentView&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; layoutResID)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// decor, when theme attributes and the like are crystalized. Do not check the feature&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// before this happens.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mContentParent == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        installDecor();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mContentParent.removeAllViews();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    	&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mLayoutInflater.inflate(layoutResID, mContentParent);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;这里面顺带穿插说一下View的根节点是怎样初始化出来的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这里有一个关键的地方是这个&lt;code&gt;installDecor()&lt;/code&gt;方法，在这个方法中通过调用&lt;code&gt;generateDecor()&lt;/code&gt;方法创建了这个mDecor的对象，通过调用&lt;code&gt;generateLayout(DecorView)&lt;/code&gt;方法初始化出来了mContentParent对象。其中，mDecor是&lt;code&gt;PhoneWindow.DecorView&lt;/code&gt;的类实例，mContentParent是展示所有内容的，是通过&lt;code&gt;com.android.internal.R.id.content&lt;/code&gt;ID来找到这个View。具体代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; ViewGroup &lt;span class=&quot;title&quot;&gt;generateLayout&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(DecorView decor)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	View in = mLayoutInflater.inflate(layoutResource, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// layoutResource是根据对当前显示View的Activity的theme属性值来决定由系统加载对应的布局文件&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	decor.addView(in, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	mContentRoot = (ViewGroup) in;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (contentParent == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	   &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;string&quot;&gt;&quot;Window couldn&#39;t find content container view&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; contentParent;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;那么在哪里面可以看到这个DecorView呢？看下面图。&lt;/p&gt;
&lt;p&gt;下面这张图是在debug模式下连接手机调试App，使用Layout Inspector工具查看得到的图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/12/13/phonewindow_decorview.png&quot; alt=&quot;PhoneWindow.DecorView&quot;&gt;&lt;/p&gt;
&lt;p&gt;其中从&lt;code&gt;1&lt;/code&gt;位置可以看出，整个View的根节点的View是PhoneWindow.DecorView实例；从&lt;code&gt;2&lt;/code&gt;位置和&lt;code&gt;3&lt;/code&gt;位置的mId可以推断出来，上面的mContentParent就是ContentFrameLayout类的实例；位置&lt;code&gt;4&lt;/code&gt;中的蓝色区域是mContentParent所表示的位置和大小。&lt;/p&gt;
&lt;p&gt;以上图是在AS 2.2.3版本上使用Android Monitor Tab页中的Layout Inspector工具（参考位置&lt;code&gt;5&lt;/code&gt;）生成。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;紧接着跟踪上面LayoutInflater中的&lt;code&gt;inflate()&lt;/code&gt;方法中调用，发现最后调用到了&lt;br&gt;&lt;code&gt;inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot)&lt;/code&gt;方法中，在这个方法中构造了&lt;code&gt;XmlResourceParser&lt;/code&gt;对象，而这个parser对象构造代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;XmlResourceParser &lt;span class=&quot;title&quot;&gt;loadXmlResourceParser&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; id, String type)&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; NotFoundException &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (mAccessLock) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        TypedValue value = mTmpValue;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (value == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mTmpValue = value = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; TypedValue();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        getValue(id, value, &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (value.type == TypedValue.TYPE_STRING) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; loadXmlResourceParser(value.string.toString(), id,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    value.assetCookie, type);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; NotFoundException(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;string&quot;&gt;&quot;Resource ID #0x&quot;&lt;/span&gt; + Integer.toHexString(id) + &lt;span class=&quot;string&quot;&gt;&quot; type #0x&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                + Integer.toHexString(value.type) + &lt;span class=&quot;string&quot;&gt;&quot; is not valid&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;XmlResourceParser &lt;span class=&quot;title&quot;&gt;loadXmlResourceParser&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String file, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; id,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; assetCookie, String type) &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; NotFoundException &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (id != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// These may be compiled...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (mCachedXmlBlockIds) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// First see if this block is in our cache.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; num = mCachedXmlBlockIds.length;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i=&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i&amp;lt;num; i++) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mCachedXmlBlockIds[i] == id) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;//System.out.println(&quot;**** REUSING XML BLOCK!  id=&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;//                   + id + &quot;, index=&quot; + i);&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; mCachedXmlBlocks[i].newParser();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Not in the cache, create a new block and put it at&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// the next slot in the cache.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            XmlBlock block = mAssets.openXmlBlockAsset(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    assetCookie, file);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (block != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; pos = mLastCachedXmlBlockIndex+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (pos &amp;gt;= num) pos = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                mLastCachedXmlBlockIndex = pos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                XmlBlock oldBlock = mCachedXmlBlocks[pos];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (oldBlock != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    oldBlock.close();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                mCachedXmlBlockIds[pos] = id;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                mCachedXmlBlocks[pos] = block;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//System.out.println(&quot;**** CACHING NEW XML BLOCK!  id=&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//                   + id + &quot;, index=&quot; + pos);&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; block.newParser();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中&lt;code&gt;getValue()&lt;/code&gt;方法调用到本地&lt;code&gt;frameworks/base/core/jni/android_util_AssetManager.cpp&lt;/code&gt;文件中的&lt;code&gt;static jint android_content_AssetManager_loadResourceValue&lt;/code&gt;函数，而在这个函数中java层的&lt;code&gt;TypeValue&lt;/code&gt;的类对象value对象属性通过JNI形式被赋值。&lt;/p&gt;
&lt;p&gt;在构建这个parser时，经历了很复杂的过程，从TypeValue中的&lt;code&gt;assetCookie&lt;/code&gt;属性，到XmlBlock中的&lt;code&gt;xmlBlock&lt;/code&gt;属性，再到XmlBlock.Parser中的&lt;code&gt;mParseState&lt;/code&gt;属性，都是用来保存JNI层的数据，因为最终操作这些资源数据是在native层，所以必不可少通过JNI这种方式，在java层和native层周旋。这里没有深入到native层去分析资源是如何被加载解析的，后面有机会再说。&lt;/p&gt;
&lt;p&gt;最后跟到了这个&lt;code&gt;public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot)&lt;/code&gt;方法中，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; View &lt;span class=&quot;title&quot;&gt;inflate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(XmlPullParser parser, @Nullable ViewGroup root, &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; attachToRoot)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (mConstructorArgs) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Context inflaterContext = mContext;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; AttributeSet attrs = Xml.asAttributeSet(parser);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Context lastContext = (Context) mConstructorArgs[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    View result = root;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// Temp is the root view that was found in the xml&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; View temp = createViewFromTag(root, name, inflaterContext, attrs); &lt;span class=&quot;comment&quot;&gt;// 这里将布局文件中的名称反射成具体的View类对象&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ViewGroup.LayoutParams params = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (root != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Create layout params that match root, if supplied&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        params = root.generateLayoutParams(attrs); &lt;span class=&quot;comment&quot;&gt;// 这里将尺寸转换成了LayoutParams&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!attachToRoot) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Set the layout params for temp if we are not&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// attaching. (If we are, we use addView, below)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            temp.setLayoutParams(params);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Inflate all children under temp against its context.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    rInflateChildren(parser, temp, attrs, &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// We are supposed to attach all the views we found (int temp)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// to root. Do that now.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (root != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; attachToRoot) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        root.addView(temp, params); &lt;span class=&quot;comment&quot;&gt;// 将布局文件中根的View添加到mContentParent中&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; result;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;接着看View的&lt;code&gt;generateLayoutParams(AttributeSet)&lt;/code&gt;方法，因为这里返回了params。查看代码最后发现LayoutParams的&lt;code&gt;width&lt;/code&gt;和&lt;code&gt;height&lt;/code&gt;属性赋值的代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;LayoutParams&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Context c, AttributeSet attrs)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    TypedArray a = c.obtainStyledAttributes(attrs, R.styleable.ViewGroup_Layout);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    setBaseAttributes(a,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            R.styleable.ViewGroup_Layout_layout_width,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            R.styleable.ViewGroup_Layout_layout_height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    a.recycle();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;setBaseAttributes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(TypedArray a, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthAttr, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightAttr)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    width = a.getLayoutDimension(widthAttr, &lt;span class=&quot;string&quot;&gt;&quot;layout_width&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    height = a.getLayoutDimension(heightAttr, &lt;span class=&quot;string&quot;&gt;&quot;layout_height&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过查看TypedArray类中的&lt;code&gt;getLayoutDimension()&lt;/code&gt;方法发现，获取的值是通过index在&lt;code&gt;mData&lt;/code&gt;这个成员数组中获取的。这个&lt;code&gt;mData&lt;/code&gt;的值是在创建TypedArray对象时被赋的值，具体参见TypedArray的&lt;code&gt;obtain&lt;/code&gt;方法。这个数组是在Resources的&lt;code&gt;obtainStyledAttributes()&lt;/code&gt;方法中通过调用&lt;code&gt;AssetManager.applyStyle()&lt;/code&gt;方法被初始化值的。&lt;code&gt;applyStyle()&lt;/code&gt;方法是一个native方法，对应&lt;code&gt;frameworks/base/core/jni/android_util_AssetManager.cpp&lt;/code&gt;文件中的&lt;code&gt;android_content_AssetManager_applyStyle&lt;/code&gt;函数。在这个函数中发现，传入的Resrouces类中的&lt;code&gt;mTheme&lt;/code&gt;成员以及XmlBlock.Parse类的&lt;code&gt;mParseState&lt;/code&gt;成员都是一个C++对象的指针，在java类中以整型或长整型值保存。&lt;/p&gt;
&lt;p&gt;至此，布局文件中的尺寸值已经被转换成了具体的int类型值。&lt;/p&gt;
&lt;h2 id=&quot;从布局文件到View&quot;&gt;&lt;a href=&quot;#从布局文件到View&quot; class=&quot;headerlink&quot; title=&quot;从布局文件到View&quot;&gt;&lt;/a&gt;从布局文件到View&lt;/h2&gt;&lt;p&gt;从上面的&lt;code&gt;public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot)&lt;/code&gt;方法中看到View是通过这行代码&lt;code&gt;final View temp = createViewFromTag(root, name, inflaterContext, attrs);&lt;/code&gt;创建出来的，而这个&lt;code&gt;name&lt;/code&gt;就是XML文件在解析时遇到的标签名称，比如&lt;code&gt;TextView&lt;/code&gt;。此时的&lt;code&gt;attrs&lt;/code&gt;也就是上面分析的&lt;code&gt;XmlBlock.Parser&lt;/code&gt;的对象。最后发现View是在&lt;code&gt;createViewFromTag()&lt;/code&gt;方法中创建的，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;View &lt;span class=&quot;title&quot;&gt;createViewFromTag&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(View parent, String name, Context context, AttributeSet attrs,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; ignoreThemeAttr) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (name.equals(&lt;span class=&quot;string&quot;&gt;&quot;view&quot;&lt;/span&gt;)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        name = attrs.getAttributeValue(&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;class&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Apply a theme wrapper, if allowed and one is specified.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!ignoreThemeAttr) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; themeResId = ta.getResourceId(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (themeResId != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            context = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ContextThemeWrapper(context, themeResId);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ta.recycle();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    View view;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mFactory2 != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        view = mFactory2.onCreateView(parent, name, context, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mFactory != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        view = mFactory.onCreateView(name, context, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        view = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (view == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; mPrivateFactory != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        view = mPrivateFactory.onCreateView(parent, name, context, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (view == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Object lastContext = mConstructorArgs[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mConstructorArgs[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] = context;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; == name.indexOf(&lt;span class=&quot;string&quot;&gt;&#39;.&#39;&lt;/span&gt;)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                view = onCreateView(parent, name, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                view = createView(name, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mConstructorArgs[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] = lastContext;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; view;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里要注意一下，&lt;code&gt;mConstructorArgs&lt;/code&gt;的第一个值是一个Context，而这个Context有可能已经不是当前Activity的Context。&lt;/p&gt;
&lt;p&gt;看到这里，下面这样的代码片段是不是很熟悉？&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (name.equals(&lt;span class=&quot;string&quot;&gt;&quot;view&quot;&lt;/span&gt;)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name = attrs.getAttributeValue(&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;class&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面Factory这个接口对象在LayoutInflater类中就有三个属性，分别对应：&lt;code&gt;factory&lt;/code&gt;、&lt;code&gt;factory2&lt;/code&gt;、&lt;code&gt;mPrivateFactory&lt;/code&gt;。很明显，弄清了这三个对象，也就知道了View的初始化流程。下面代码是对这三个属性的值的输出：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MainActivity&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;AppCompatActivity&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Bundle savedInstanceState)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onCreate(savedInstanceState);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        setContentView(R.layout.activity_main);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        LayoutInflater inflater = getLayoutInflater();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        LayoutInflater inflater1 = LayoutInflater.from(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Field f = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            f = LayoutInflater.class.getDeclaredField(&lt;span class=&quot;string&quot;&gt;&quot;mPrivateFactory&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            f.setAccessible(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (NoSuchFieldException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		  Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;the same object: &quot;&lt;/span&gt; + (inflater == inflater1));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;inflater factory: &quot;&lt;/span&gt; + inflater.getFactory() + &lt;span class=&quot;string&quot;&gt;&quot;, factory2: &quot;&lt;/span&gt; + inflater.getFactory2());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;inflater1 factory: &quot;&lt;/span&gt; + inflater1.getFactory() + &lt;span class=&quot;string&quot;&gt;&quot;, factory2: &quot;&lt;/span&gt; + inflater1.getFactory2());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (f != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;inflater mPrivateFactory: &quot;&lt;/span&gt; + f.get(inflater));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;inflater1 mPrivateFactory: &quot;&lt;/span&gt; + f.get(inflater1));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IllegalAccessException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出的LOG如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;// 当前Activiy继承的是android.support.v7.app.AppCompatActivity&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the same object: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater factory: android.support.v4.view.LayoutInflaterCompatHC$FactoryWrapperHC&amp;#123;android.support.v7.app.AppCompatDelegateImplV14@41fdf0b0&amp;#125;, factory2: android.support.v4.view.LayoutInflaterCompatHC$FactoryWrapperHC&amp;#123;android.support.v7.app.AppCompatDelegateImplV14@41fdf0b0&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater1 factory: android.support.v4.view.LayoutInflaterCompatHC$FactoryWrapperHC&amp;#123;android.support.v7.app.AppCompatDelegateImplV14@41fdf0b0&amp;#125;, factory2: android.support.v4.view.LayoutInflaterCompatHC$FactoryWrapperHC&amp;#123;android.support.v7.app.AppCompatDelegateImplV14@41fdf0b0&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater mPrivateFactory: com.jacpy.sb.MainActivity@41fd9e70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater1 mPrivateFactory: com.jacpy.sb.MainActivity@41fd9e70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;// 当前Activity继承的是android.app.Activity&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the same object: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater factory: null, factory2: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater1 factory: null, factory2: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater mPrivateFactory: com.jacpy.sb.MainActivity@41fd9a28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater1 mPrivateFactory: com.jacpy.sb.MainActivity@41fd9a28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;首先看到&lt;code&gt;mPrivateFactory&lt;/code&gt;是当前的Activity实例，因为Activity也实现的Factory2接口。首先看LayoutInflater的创建过程，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/12/13/layoutinflater_init.png&quot; alt=&quot;LayoutInflater初始化流程&quot;&gt;&lt;/p&gt;
&lt;p&gt;而生成的PhoneLayoutInflater对象是缓存在ContextImpl类的属性&lt;code&gt;SYSTEM_SERVICE_MAP&lt;/code&gt;中，所以通过&lt;code&gt;Context.LAYOUT_INFLATER_SERVIC&lt;/code&gt;去取，始终是同一个对象，当然仅限于当前Context中。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;mPrivateFactory&lt;/code&gt;属性的赋值是在Activity的&lt;code&gt;attach()&lt;/code&gt;方法中，通过调用&lt;code&gt;mWindow.getLayoutInflater().setPrivateFactory(this);&lt;/code&gt;，因此调用Factory2的&lt;code&gt;onCreateView()&lt;/code&gt;方法时，实际是调用Activity中的&lt;code&gt;onCreateView()&lt;/code&gt;方法。而Activity中的&lt;code&gt;onCreateView()&lt;/code&gt;实际返回的是null，所以最后创建View的是&lt;code&gt;if&lt;/code&gt;判断中的&lt;code&gt;onCreateView(parent, name, attrs)&lt;/code&gt;方法，最后View是在LayoutInflater类中的&lt;code&gt;public final View createView(String name, String prefix, AttributeSet attrs)
            throws ClassNotFoundException, InflateException&lt;/code&gt;方法中创建：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; View &lt;span class=&quot;title&quot;&gt;createView&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String name, String prefix, AttributeSet attrs)&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; ClassNotFoundException, InflateException &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Constructor&amp;lt;? extends View&amp;gt; constructor = sConstructorMap.get(name);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Class&amp;lt;? extends View&amp;gt; clazz = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Class not found in the cache, see if it&#39;s real, and try to add it&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    clazz = mContext.getClassLoader().loadClass(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            prefix != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; ? (prefix + name) : name).asSubclass(View.class); &lt;span class=&quot;comment&quot;&gt;// prefix传的值是android.view.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    constructor = clazz.getConstructor(mConstructorSignature); &lt;span class=&quot;comment&quot;&gt;// Class&amp;lt;?&amp;gt;[] mConstructorSignature = new Class[] &amp;#123;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Context.class, AttributeSet.class&amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    constructor.setAccessible(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sConstructorMap.put(name, constructor);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Object[] args = mConstructorArgs;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    args[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] = attrs; &lt;span class=&quot;comment&quot;&gt;// 这个值是XmlBlock.Parser对象&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; View view = constructor.newInstance(args);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (view &lt;span class=&quot;keyword&quot;&gt;instanceof&lt;/span&gt; ViewStub) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Use the same context when inflating ViewStub later.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; ViewStub viewStub = (ViewStub) view;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        viewStub.setLayoutInflater(cloneInContext((Context) args[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; view;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里有没有发现&lt;code&gt;mConstructorSignature&lt;/code&gt;数组的长度决定了调用了View的哪个构造方法？&lt;/p&gt;
&lt;p&gt;至此，View已经创建成功。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天在看View的尺寸是怎样计算出来的，于是看了整个View被初始化的过程，结合系统源码总结了一下。&lt;/p&gt;
    
    </summary>
    
      <category term="view" scheme="http://www.jacpy.com/categories/view/"/>
    
    
      <category term="view create detail" scheme="http://www.jacpy.com/tags/view-create-detail/"/>
    
  </entry>
  
  <entry>
    <title>android Activity设置为SingleTop值时的生命周期在7.0以上系统中的变化</title>
    <link href="http://www.jacpy.com/2016/12/11/android-single-top-activity-lifecycle-changed-by-android-7.html"/>
    <id>http://www.jacpy.com/2016/12/11/android-single-top-activity-lifecycle-changed-by-android-7.html</id>
    <published>2016-12-11T04:13:15.000Z</published>
    <updated>2016-12-11T08:41:18.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;前几天在解决应用中一个问题，现象是在nexus 7.0以上系统的手机上创建群组会话时，消息发送超时。然后测试了一上，发现是必现的，而4.4系统的手机上却一切正常，于是一路分析了别人写的代码。最后找到原因并解决，于是就有了本文。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;最后找到原因是在Android系统7.0以上，当把Activity的&lt;code&gt;launchMode&lt;/code&gt;属性值设置为&lt;code&gt;singleTop&lt;/code&gt;时，Activity的生命周期与以前的系统版本对应的生命周期有所不同。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;我们都知道从Activity A启动了个Activity B，并在A中调用&lt;code&gt;finish()&lt;/code&gt;方法关闭A时，整个过程的生命周期的方法调用顺序是：先调用B的&lt;code&gt;onCreate()&lt;/code&gt;，然后再调用A的&lt;code&gt;onDestroy()&lt;/code&gt;。android系统这样做可能是为了提高系统的响应的速度，让应用以最快的速度看到UI发生变化，而不是从系统的角度考虑，先回收资源，资源回收OK了，再创建新的资源，所以就有了上面的这样生命周期方法的调用顺序。但在android 7.0系统以前有个例外情况：&lt;/p&gt;
&lt;p&gt;假如Activity A的&lt;code&gt;launchMode&lt;/code&gt;属性值被设置为&lt;code&gt;singleTop&lt;/code&gt;时，如果Activity A启动Activity B，在B中又启动了A，同时关闭B，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/12/11/activity_single_top_flow.png&quot; alt=&quot;singleTop流程图&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;此时A的生命周期方法的调用是：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;先调用A的&lt;code&gt;onDestroy&lt;/code&gt;方法，用来关闭以前被启动的旧的Activity A，然后再调用在B中新startActivity的A的&lt;code&gt;onCreate&lt;/code&gt;方法。&lt;/p&gt;
&lt;p&gt;那么这里所说的生命周期与前面所说的情况不一样，就因为设置了一个&lt;code&gt;singleTop&lt;/code&gt;值。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;这个是android系统7.0以前的，那么7.0以后的系统上走上述同样的流程，生命周期的方法调用顺序是：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;先调用新的Activity A的&lt;code&gt;onCreate&lt;/code&gt;方法，然后再调用旧A的&lt;code&gt;onDestroy&lt;/code&gt;方法。&lt;/p&gt;
&lt;p&gt;发现这里与没有设置&lt;code&gt;singleTop&lt;/code&gt;值时的生命周期一致，形成了统一。&lt;/p&gt;
&lt;p&gt;以上就是问题的原因，因为系统的差异造成的。由于使用的是google官方出的nexus系列手机测试，而又是使用原生的系统，可以认为是android官方系统这块的逻辑处理发生了变化。&lt;/p&gt;
&lt;p&gt;好了，下面就说实际遇到的场景：&lt;/p&gt;
&lt;p&gt;因为在Activity A中的&lt;code&gt;onDestroy&lt;/code&gt;方法中调用了关闭会话，并将一个全局的状态值修改为非法值，而在&lt;code&gt;onCreate&lt;/code&gt;方法中是重新初始化这个状态值。因为生命周期方法调用顺序在不同的系统上实现的差异，而导致这个状态值设置OK后，又被修改成非法值，从而使发送消息出去的报名格式发生变化，而服务器端在接收这个程序性错误后没有异常反馈，而终端则认为是服务器端没有响应而当作超时处理，所以发送失败。&lt;/p&gt;
&lt;p&gt;从上面现象可以看出系统后台设计人员并没有对这些程序性非业务逻辑性错误作出错误反馈，而后台有没有Log记录呢？&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;前几天在解决应用中一个问题，现象是在nexus 7.0以上系统的手机上创建群组会话时，消息发送超时。然后测试了一上，发现是必现的，而4.4系统的手机上却一切正常，于是一路分析了别人写的代码。最后找到原因并解决，于是就有了本文。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;最后找到原因是在Android系统7.0以上，当把Activity的&lt;code&gt;launchMode&lt;/code&gt;属性值设置为&lt;code&gt;singleTop&lt;/code&gt;时，Activity的生命周期与以前的系统版本对应的生命周期有所不同。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="singleTop android7.0" scheme="http://www.jacpy.com/tags/singleTop-android7-0/"/>
    
  </entry>
  
  <entry>
    <title>公交站点线路自定义View分享</title>
    <link href="http://www.jacpy.com/2016/09/17/share-bus-line-custom-view.html"/>
    <id>http://www.jacpy.com/2016/09/17/share-bus-line-custom-view.html</id>
    <published>2016-09-17T04:23:19.000Z</published>
    <updated>2016-09-17T05:18:07.000Z</updated>
    
    <content type="html">&lt;p&gt;分享一个仿《车来了》公交线路提示的自定义组件。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;先上效果图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/jacpy/BusLine/blob/master/captures/bus_line.gif?raw=true&quot; alt=&quot;效果图&quot;&gt;&lt;/p&gt;
&lt;p&gt;github地址：&lt;a href=&quot;https://github.com/jacpy/BusLine&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/jacpy/BusLine&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;用工具分析了官方的实现，使用的是google提供的v4包中的RecycleView来实现的，所以会看到各种View叠加。&lt;/p&gt;
&lt;p&gt;上面View实现方式是使用自定义View的方式，使用了绘图方面的API和滑动手势控制，还实现了站点点击事件控制。所以整个就一个View，也就不存在View回收的问题。另外要注意在View中调用次数比较频繁的方法中要注意性能，比如onDraw()方法中，刷的次数非常频繁，特别是在滑动的时候，而这个方法又是一个关键的处理方法，计算特别多，所以这里要注意，否则方法运行时间超过16ms就会造成卡顿。&lt;/p&gt;
&lt;p&gt;经过测试：在2013年的机型MOTO G XT1032机子上运行，同时刷新96个公交站点数据，onDraw()方法耗时平均7ms左右。&lt;/p&gt;
&lt;p&gt;后面会写文章分析下实现方式及遇到的坑和解决方案。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;分享一个仿《车来了》公交线路提示的自定义组件。&lt;/p&gt;
    
    </summary>
    
      <category term="android view" scheme="http://www.jacpy.com/categories/android-view/"/>
    
    
      <category term="自定义View 公交线路" scheme="http://www.jacpy.com/tags/%E8%87%AA%E5%AE%9A%E4%B9%89View-%E5%85%AC%E4%BA%A4%E7%BA%BF%E8%B7%AF/"/>
    
  </entry>
  
  <entry>
    <title>React Native iOS集成说明</title>
    <link href="http://www.jacpy.com/2016/09/06/react-native-ios-integrated.html"/>
    <id>http://www.jacpy.com/2016/09/06/react-native-ios-integrated.html</id>
    <published>2016-09-06T03:52:54.000Z</published>
    <updated>2016-09-06T08:57:47.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;本文主要是记录将React Native集成到现有项目的说明步骤及中间遇到的一些坑的记录。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;一、模板生成&quot;&gt;&lt;a href=&quot;#一、模板生成&quot; class=&quot;headerlink&quot; title=&quot;一、模板生成&quot;&gt;&lt;/a&gt;一、模板生成&lt;/h3&gt;&lt;p&gt;假如你的PC已经安装好了React Native环境，只需要在命令行执行以下命令即可以生成模板：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$react-native init RNDemo&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中RNDemo是项目名称，这里确保与你现在的项目名称一致。&lt;/p&gt;
&lt;p&gt;生成好模板后，cd到RNDemo/ios/目录中，将该目录下的所有文件都删除，然后将现有项目所有文件复制到ios目录中。&lt;/p&gt;
&lt;hr&gt;
&lt;h3 id=&quot;二、环境配置&quot;&gt;&lt;a href=&quot;#二、环境配置&quot; class=&quot;headerlink&quot; title=&quot;二、环境配置&quot;&gt;&lt;/a&gt;二、环境配置&lt;/h3&gt;&lt;h4 id=&quot;2-1-添加项目库&quot;&gt;&lt;a href=&quot;#2-1-添加项目库&quot; class=&quot;headerlink&quot; title=&quot;2.1 添加项目库&quot;&gt;&lt;/a&gt;2.1 添加项目库&lt;/h4&gt;&lt;p&gt;使用xcode打开现有项目，将以下库添加到项目中：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;react-native/React/React.xcodeproj&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;react-native/Libraries/Network/RCTNetwork.xcodeproj&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;react-native/Libraries/Text/RCTText.xcodeproj&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;react-native/Libraries/WebSocket/RCTWebSocket.xcodeproj&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;react-native/Libraries/ActionSheetIOS/RCTActionSheet.xcodeproj&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;添加方法如下图所示：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/xcode_config_project_library.png&quot; alt=&quot;xcode配置&quot;&gt;&lt;br&gt;在弹出的窗口的右下角点击&lt;code&gt;Add Others...&lt;/code&gt;按钮，在弹出的窗口中选择上面相应目录下的&lt;code&gt;.xcodeproj&lt;/code&gt;文件，将项目库包含进来。操作完成后，需要再次点击&lt;code&gt;+&lt;/code&gt;号，将静态库都包含进来，如下图所示：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/xcode_config_add_static_library.png&quot; alt=&quot;xcode添加静态库&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h4 id=&quot;2-2-添加配置&quot;&gt;&lt;a href=&quot;#2-2-添加配置&quot; class=&quot;headerlink&quot; title=&quot;2.2 添加配置&quot;&gt;&lt;/a&gt;2.2 添加配置&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;如下配置如果已经配置过，则可以跳过。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;1）搜索头文件地址配置&lt;br&gt;头文件搜索路径配置如下所示：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/xcode_config_head_search_path.png&quot; alt=&quot;头文件目录搜索路径配置&quot;&gt;&lt;br&gt;双击&lt;code&gt;Header Search Path&lt;/code&gt;右侧区域即可显示弹出的层，双击其中的行，则进入编辑模式。&lt;/p&gt;
&lt;p&gt;其中&lt;code&gt;$(SRCROOT)&lt;/code&gt;为当前项目路径，可以理解为&lt;code&gt;.xcodeproj&lt;/code&gt;文件所在的路径，&lt;code&gt;../node_modules&lt;/code&gt;表示的是与ios同级目录的node_moduels目录。&lt;/p&gt;
&lt;p&gt;2）启用HTTP配置&lt;br&gt;点击项目中的info.plist文件（注意是项目的plist文件，不是Tests中的），在右侧增加如下图所示的配置：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/plist_add_http.png&quot; alt=&quot;启用HTTP配置&quot;&gt;&lt;br&gt;如果没有启用，运行时会提示如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;App Transport Security has blocked a cleartext HTTP (http://) resource load since it is insecure. &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Temporary exceptions can be configured via your app&amp;apos;s Info.plist file.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3）支持C++编译&lt;br&gt;添加C++编译支持如下图所示：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/other_linker_flag_support_cpp.png&quot; alt=&quot;添加C++编译支持&quot;&gt;&lt;br&gt;添加方法与上面添加&lt;code&gt;Header Search Path&lt;/code&gt;类似。&lt;br&gt;如果没有添加&lt;code&gt;-lc++&lt;/code&gt;，编译会报如下所示错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Undefined symbols for architecture x86_64:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;std::terminate()&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      ___clang_call_terminate in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;operator delete[](void*)&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJSCExecutor dealloc] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      executeRandomAccessModule(RCTJSCExecutor*, unsigned int, unsigned long, unsigned long) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      readRAMBundle(std::__1::unique_ptr&amp;lt;__sFILE, int (*)(__sFILE*)&amp;gt;, RandomAccessBundleData&amp;amp;) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      RandomAccessBundleData::~RandomAccessBundleData() in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;operator new[](unsigned long)&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      executeRandomAccessModule(RCTJSCExecutor*, unsigned int, unsigned long, unsigned long) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      readRAMBundle(std::__1::unique_ptr&amp;lt;__sFILE, int (*)(__sFILE*)&amp;gt;, RandomAccessBundleData&amp;amp;) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;___cxa_begin_catch&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      ___clang_call_terminate in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;___gxx_personality_v0&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJavaScriptContext initWithJSContext:onThread:] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJavaScriptContext init] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJavaScriptContext invalidate] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      RCTNSErrorFromJSError(RCTJSCWrapper*, OpaqueJSContext const*, OpaqueJSValue const*) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      +[RCTJSCExecutor runRunLoopThread] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJSCExecutor init] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJSCExecutor initWithUseCustomJSCLibrary:] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ld: symbol(s) not found for architecture x86_64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clang: error: linker command failed with exit code 1 (use -v to see invocation)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果没有添加&lt;code&gt;-ObjC&lt;/code&gt;，运行则会报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[error][tid:com.facebook.react.JavaScript] Native module cannot be null.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[error][tid:com.facebook.react.JavaScript] Requiring module &amp;quot;193&amp;quot;, name:InitializeJavaScriptAppEngine, which threw an exception.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RNDemo[13446:1473714] -[RCTRootView reactTag]: unrecognized selector sent to instance 0x7ff670d14de0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RNDemo[13446:1473714] *** Terminating app due to uncaught exception &amp;apos;NSInvalidArgumentException&amp;apos;, reason: &amp;apos;-[RCTRootView reactTag]: unrecognized selector sent to instance 0x7ff670d14de0&amp;apos;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可能提示的module Id不一样，导致的原因是一样的。在这里卡了很久:(。&lt;/p&gt;
&lt;hr&gt;
&lt;h3 id=&quot;三、增加代码&quot;&gt;&lt;a href=&quot;#三、增加代码&quot; class=&quot;headerlink&quot; title=&quot;三、增加代码&quot;&gt;&lt;/a&gt;三、增加代码&lt;/h3&gt;&lt;p&gt;在已有项目的启动配置位置，如&lt;code&gt;AppDelegate.m&lt;/code&gt;文件中增加上面没有删除的&lt;code&gt;AppDelegate.m&lt;/code&gt;文件中的代码，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#import &amp;quot;AppDelegate.h&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#import &amp;quot;RCTBundleURLProvider.h&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#import &amp;quot;RCTRootView.h&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;@implementation AppDelegate&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  NSURL *jsCodeLocation;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  [[RCTBundleURLProvider sharedSettings] setDefaults];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  jsCodeLocation = [[RCTBundleURLProvider sharedSettings] jsBundleURLForBundleRoot:@&amp;quot;index.ios&amp;quot; fallbackResource:nil];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  RCTRootView *rootView = [[RCTRootView alloc] initWithBundleURL:jsCodeLocation&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                                      moduleName:@&amp;quot;RNDemo&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                               initialProperties:nil&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                                   launchOptions:launchOptions];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  rootView.backgroundColor = [[UIColor alloc] initWithRed:1.0f green:1.0f blue:1.0f alpha:1];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  self.window = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  UIViewController *rootViewController = [UIViewController new];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  rootViewController.view = rootView;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  self.window.rootViewController = rootViewController;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  [self.window makeKeyAndVisible];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  return YES;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;@end&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意：&lt;code&gt;index.ios&lt;/code&gt;就是模板在RNDemo目录下生成的&lt;code&gt;index.ios.js&lt;/code&gt;文件，moduleName&lt;code&gt;RNDemo&lt;/code&gt;是项目的名称，这里要替换成刚开始初始化模板的命令的项目名称。&lt;/p&gt;
&lt;p&gt;最后，按cmd + r后，会自动启动React Native服务，可以看到运行效果。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;本文主要是记录将React Native集成到现有项目的说明步骤及中间遇到的一些坑的记录。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.jacpy.com/categories/iOS/"/>
    
    
      <category term="React Native" scheme="http://www.jacpy.com/tags/React-Native/"/>
    
  </entry>
  
  <entry>
    <title>chrome浏览器启动android应用并传递参数</title>
    <link href="http://www.jacpy.com/2016/06/27/chrome_open_android_app.html"/>
    <id>http://www.jacpy.com/2016/06/27/chrome_open_android_app.html</id>
    <published>2016-06-27T04:56:08.000Z</published>
    <updated>2016-06-27T05:05:31.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;本文档主要介绍如何在android手机的chrome浏览器中点击一个链接，然后启动一个本地的App，并使用App中的具有浏览器功能的界面，如包信有WebView的Activity，打开一个链接。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;协议介绍&quot;&gt;&lt;a href=&quot;#协议介绍&quot; class=&quot;headerlink&quot; title=&quot;协议介绍&quot;&gt;&lt;/a&gt;协议介绍&lt;/h2&gt;&lt;p&gt;这种打开方式要浏览器支持这种协议，比如chrome浏览器，然后浏览器根据协议来做指定的事情。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;协议格式如下所示：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;intent:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   HOST/URI-path // Optional host &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   #Intent; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      package=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      action=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      category=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      component=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      scheme=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   end;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;参数说明：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;HOST: 对应intent-filter标签中的data标签中的&lt;code&gt;android:host&lt;/code&gt;属性说明；&lt;/li&gt;
&lt;li&gt;scheme：对应intent-filter标签中的data标签中的&lt;code&gt;android:scheme&lt;/code&gt;属性说明；&lt;/li&gt;
&lt;li&gt;package：打开的App的包名；&lt;/li&gt;
&lt;li&gt;action：接收处理这个Intent的action，可选；&lt;/li&gt;
&lt;li&gt;category：接收处理Intnet的category，可选；&lt;/li&gt;
&lt;li&gt;component：接收处理Intent的component，可选；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上面这些参数对应java的代码如下所示：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Intent intent = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Intent(&lt;span class=&quot;string&quot;&gt;&quot;action&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;intent.setData(Uri.pase(&lt;span class=&quot;string&quot;&gt;&quot;host&quot;&lt;/span&gt;));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;intent.addCategory(&lt;span class=&quot;string&quot;&gt;&quot;category&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;intent.setComponent(&lt;span class=&quot;string&quot;&gt;&quot;component&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;context.startActivity(intent);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;上面部分参数对应的在AndroidManifest.xml文件中的Activity中的配置如下所示：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;activity&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;com.jacpy.app.ui.WebViewActivity&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:screenOrientation&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;portrait&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:theme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;@android:style/Theme.Black.NoTitleBar&quot;&lt;/span&gt;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;intent-filter&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.action.VIEW&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.category.DEFAULT&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.category.BROWSABLE&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:scheme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;scheme&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:host&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;host&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;intent-filter&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;activity&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;上面的这些说明只是说要如何利用这些参数启动这个指定的App的Activity，接下来是说明如何将一些参数信息传递给这个指定的Activity，由这个Activity来处理一些指定的操作，比如打开一个链接。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;传递的参数类型在java中有9种类型，分别是String(S)、Boolean(B)、Byte(b)、Character(c)、Double(d)、Float(f)、Integer(i)、Long(l)、Short(s)，注意后面括号中的字母及大小写。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;比如要传一个字符串，可以写成如下所示：&lt;/p&gt;
&lt;p&gt;S.url=&lt;a href=&quot;http://www.baidu.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.baidu.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;键是&lt;code&gt;url&lt;/code&gt;，值是&lt;code&gt;http://www.baidu.com&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;传一个int值，可以写成这样：&lt;/p&gt;
&lt;p&gt;i.age=30&lt;/p&gt;
&lt;p&gt;键是&lt;code&gt;age&lt;/code&gt;，值是&lt;code&gt;30&lt;/code&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;这种传递方式对应的java代码如下所示：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;intent.putExtra(&lt;span class=&quot;string&quot;&gt;&quot;url&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;http://www.baidu.com&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;intnet.putExtra(&lt;span class=&quot;string&quot;&gt;&quot;age&quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;注意：&lt;code&gt;S.browser_fallback_url&lt;/code&gt;是chrome保留的内容，在手机安装了chrome 25以上版本，启动了包含有&lt;code&gt;S.browser_fallback_url&lt;/code&gt;信息的协议，如果手机中没有安装指定包名的App那么，就会跳转到&lt;code&gt;S.browser_fallback_url&lt;/code&gt;指定的链接，这个链接一般是放App的下载地址。在实际测试是，手机中不能安装Google Play，否则会打开google Play。而不会执行&lt;code&gt;S.browser_fallback_url&lt;/code&gt;这个跳转。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;实现&quot;&gt;&lt;a href=&quot;#实现&quot; class=&quot;headerlink&quot; title=&quot;实现&quot;&gt;&lt;/a&gt;实现&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;按照上面的协议说明可以自定义协议，如下所示：&lt;br&gt;intent://msp.url/#Intent;scheme=msp;package=com.jacpy.app;S.browser_fallback_url=&lt;a href=&quot;http://www.taobao.com/app/download;S.url=http://www.baidu.com;S.title=chrome启动应用测试;end&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.taobao.com/app/download;S.url=http://www.baidu.com;S.title=chrome启动应用测试;end&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;上面示例协议中，如果手机上没有安装包名为&lt;code&gt;com.jacpy.app&lt;/code&gt;的应用，并且手机上没有安装google play，那么最后页面会跳转到&lt;code&gt;http://wwww.taobao.com/app/download&lt;/code&gt;。&lt;br&gt;协议可以写在a标签中，如：&lt;/p&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;href&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&quot;&lt;span class=&quot;attr&quot;&gt;intent:&lt;/span&gt;//&lt;span class=&quot;attr&quot;&gt;msp.url&lt;/span&gt;/#&lt;span class=&quot;attr&quot;&gt;Intent&lt;/span&gt;;&lt;span class=&quot;attr&quot;&gt;scheme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;msp;package&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;com.jacpy.app;S.browser_fallback_url&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;http://www.taobao.com/app/download;S.url&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;http://www.baidu.com;S.title&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;chrome启动应用测试;end\&lt;/span&gt;&quot;&amp;gt;&lt;/span&gt;chrome启动应用测试&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;a&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;对应的Activity配置代码如下所示：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;manifest&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;xmlns:android&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;http://schemas.android.com/apk/res/android&quot;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;package&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;com.jacpy.app&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:versionCode&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:versionName&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;2.0.0.0&quot;&lt;/span&gt; &amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;application&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;com.jacpy.app.app.App&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;android:allowBackup&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;android:icon&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;@drawable/logo&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;android:label&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;@string/app_name&quot;&lt;/span&gt; &amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;activity&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;com.jacpy.app.ui.WebViewActivity&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;attr&quot;&gt;android:screenOrientation&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;portrait&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;attr&quot;&gt;android:theme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;@android:style/Theme.Black.NoTitleBar&quot;&lt;/span&gt;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;intent-filter&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.action.VIEW&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.category.DEFAULT&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.category.BROWSABLE&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:scheme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;msp&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:host&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;msp.url&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;intent-filter&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;activity&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;application&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;manifest&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;这里要注意，如果当前应用已经启动，点击跳转链接，浏览器是不会启动相应的界面打开链接，可以对当前Activity设置&lt;code&gt;android:launchMode=&amp;quot;singleInstance&amp;quot;&lt;/code&gt;试试。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;协议传递数据解析处理&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; com.jacpy.app.ui;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;WebViewActivity&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Activity&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Bundle b)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onCreate(b);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Intent data = getIntent();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String url = data.getStringExtra(&lt;span class=&quot;string&quot;&gt;&quot;url&quot;&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// 要跳转的链接&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String title = data.getStringExtra(&lt;span class=&quot;string&quot;&gt;&quot;title&quot;&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// 标题内容&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最后，这种通过浏览器打开应用的方式只在实现了类似机制的浏览器上使用，如chrome浏览器。通过测试其他如QQ浏览器的6.6版本也支持该方式，但UC、Opera、海豚浏览器均不支持该操作。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.&lt;a href=&quot;https://developer.chrome.com/multidevice/android/intents&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://developer.chrome.com/multidevice/android/intents&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2.&lt;a href=&quot;http://drops.wooyun.org/papers/2893&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://drops.wooyun.org/papers/2893&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;– EOF –&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;本文档主要介绍如何在android手机的chrome浏览器中点击一个链接，然后启动一个本地的App，并使用App中的具有浏览器功能的界面，如包信有WebView的Activity，打开一个链接。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="chrome" scheme="http://www.jacpy.com/tags/chrome/"/>
    
  </entry>
  
  <entry>
    <title>android应用开发常见的坑</title>
    <link href="http://www.jacpy.com/2016/05/10/android-app-develop-familiar-trap.html"/>
    <id>http://www.jacpy.com/2016/05/10/android-app-develop-familiar-trap.html</id>
    <published>2016-05-10T13:32:56.000Z</published>
    <updated>2016-07-15T06:44:15.000Z</updated>
    
    <content type="html">&lt;p&gt;android应用开发过程中，总会遇到一些坑。当遇到这些坑马上反应过来时，会很快解决。而没有反应过来时，估计是要折腾半天，下面记录一些这样的坑，防止自己遗忘再犯同样的错，自己以后再遇到类似的问题，也在这里记录下来。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;1.&lt;code&gt;context.startActivityForResult(intent, int)&lt;/code&gt;第二个参数int值要为大于0，并且不大于65535。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果为不大于0，则不会回调到Activity的&lt;code&gt;onActivityResult()&lt;/code&gt;方法。如果大于&lt;code&gt;65535&lt;/code&gt;为提示如下错误：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Caused by: java.lang.IllegalArgumentException: Can only use lower 16 bits for requestCode&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.support.v4.app.FragmentActivity.startActivityForResult(FragmentActivity.java:840)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;出现这种问题只有在Activity继承了&lt;code&gt;android.support.v4.app.FragmentActivity&lt;/code&gt;的时候才会出现，而继承&lt;code&gt;android.app.Activity&lt;/code&gt;的时候不会。所以为了不必要的麻烦，还是建议使用requestCode的值要不大于&lt;code&gt;65535&lt;/code&gt;。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;因为在同一个Activity和其中的Fragment都使用到了&lt;code&gt;onActivityResult()&lt;/code&gt;方法，为了避免Activity的requestCode不与Fragment冲突，所以就使用了&lt;code&gt;Integer.MAX_VALUE&lt;/code&gt;，结果就导致了上面的异常。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;2.重写Activity的&lt;code&gt;onActivityResult()&lt;/code&gt;方法时，如果在该Activity中使用了Fragment，并且重写了Fragment的&lt;code&gt;onActivityResult()&lt;/code&gt;方法，此时一定要在Activity的&lt;code&gt;onActivityResult()&lt;/code&gt;方法中调用&lt;code&gt;super.onActivityResult()&lt;/code&gt;，否则Fragment的&lt;code&gt;onActivityResult()&lt;/code&gt;方法不会被回调。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;3.在Fragment切换的布局中使用了FrameLayout后，为了能切换更快，使用了&lt;code&gt;FragmentTransaction.hide()&lt;/code&gt;方法，将已经初始化的Fragment隐藏，而没有使用&lt;code&gt;FragmentTransaction.replace()&lt;/code&gt;方法。其中有一个Fragment中的布局文件中的内容没有超过一屏，在点击底部空白的地方，会点击之前已经隐藏的Fragment的中布局文件中的组件。归根倒底是由于FrameLayout布局影响的，最快的解决办法是在内容没有超过一屏的布局文件中的根ViewGroup中设置`android:clickable=”false”即可，当然网上说重写onTouchEvent()方法，可以试试。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;4.在给ListView调用&lt;code&gt;addHeader()&lt;/code&gt;方法添加头部时，一定要在调用&lt;code&gt;setAdapter()&lt;/code&gt;方法之前调用，否则会出现如下错误， 这个错误&lt;code&gt;在android 4.4以前的系统会存在，4.4及以后的系统中修复了这个问题&lt;/code&gt;。错误提示也很明显：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;java.lang.IllegalStateException: Cannot add header view to list -- setAdapter has already been called.at android.widget.ListView.addHeaderView(ListView.java:&lt;span class=&quot;number&quot;&gt;261&lt;/span&gt;)at android.widget.ListView.addHeaderView(ListView.java:&lt;span class=&quot;number&quot;&gt;290&lt;/span&gt;)&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;at android.support.v4.app.Fragment.performCreateView(Fragment.java:&lt;span class=&quot;number&quot;&gt;1962&lt;/span&gt;)at android.support.v4.app.FragmentManagerImpl.moveToState(FragmentManager.java:&lt;span class=&quot;number&quot;&gt;1026&lt;/span&gt;)at android.support.v4.app.FragmentManagerImpl.moveToState(FragmentManager.java:&lt;span class=&quot;number&quot;&gt;1207&lt;/span&gt;)at android.support.v4.app.BackStackRecord.run(BackStackRecord.java:&lt;span class=&quot;number&quot;&gt;738&lt;/span&gt;)at android.support.v4.app.FragmentManagerImpl.execPendingActions(FragmentManager.java:&lt;span class=&quot;number&quot;&gt;1572&lt;/span&gt;)at android.support.v4.app.FragmentManagerImpl$&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;.run(FragmentManager.java:&lt;span class=&quot;number&quot;&gt;493&lt;/span&gt;)at android.os.Handler.handleCallback(Handler.java:&lt;span class=&quot;number&quot;&gt;800&lt;/span&gt;)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;android应用开发过程中，总会遇到一些坑。当遇到这些坑马上反应过来时，会很快解决。而没有反应过来时，估计是要折腾半天，下面记录一些这样的坑，防止自己遗忘再犯同样的错，自己以后再遇到类似的问题，也在这里记录下来。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="android" scheme="http://www.jacpy.com/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>微信支付返回code为-1解决方法之一</title>
    <link href="http://www.jacpy.com/2016/05/10/weixin-pay-return-code-1.html"/>
    <id>http://www.jacpy.com/2016/05/10/weixin-pay-return-code-1.html</id>
    <published>2016-05-10T13:28:57.000Z</published>
    <updated>2016-05-10T13:38:50.000Z</updated>
    
    <content type="html">&lt;p&gt;这两天在集成微信支付的功能，先是客户在插件中集成支付功能，后来发现回调不起来，于是将支付功能集成到了主应用，然后暴露接口给插件使用。费劲几个小时的折腾，于是乎就有下文。&lt;/p&gt;
&lt;p&gt;我们先来看下官网对于code为-1的说明（官网说明地址&lt;a href=&quot;http://kf.qq.com/faq/140225MveaUz150413VNj6nm.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;点这里&lt;/a&gt;）：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;开放平台配置的报名和应用签名是否一致：（android）；确认是否使用正式的keystore打包apk并安装调试；（android）；提交订单部分需要在服务器端完成。&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;先请仔细阅读，你遇到的问题就在这段描述中。其中注意，中间还错别字&lt;code&gt;报名&lt;/code&gt;应为&lt;code&gt;包名&lt;/code&gt;（鹅厂果然不一样）。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;下面开始说说事情的经过和结果：&lt;/p&gt;
&lt;p&gt;公司这里给客户做了一个应用，客户那边的业务扩展使用插件的方式开发，然后集成到主应用中来。由于客户业务中需要支付功能，而且在插件中支付功能不能正常运行，于是我这边就将插件中的支付集成到主应用中，然后给接口让插件调用。使用这种方式集成完后，我测试了一遍，支付宝支付OK，微信支付也OK。于是跟他们说集成好了，可以用了。&lt;/p&gt;
&lt;p&gt;客户那边测试使用的时候反馈，微信支付只能支付成功一次，第二次就不行了。于是乎，我这边也试了下，果然，第二次支付不成功。一看输出的LOG，回调的code返回-1。&lt;/p&gt;
&lt;p&gt;为了解决这个问题与客户进行了沟通，客户说是我集成的问题，说他们写了一个测试的demo，连续支付两次都没有问题。好吧，我自己寻找问题的解决方案。我很确信自己的代码集成没有问题，那部分代码也是来自客户写的支付代码。如果客户写的代码有问题，就不可能连续支付两次都OK。&lt;/p&gt;
&lt;p&gt;于是找到了前面的官方回调后返回code为-1的说明，当时也只是读了一遍，没深究，因为我觉得问题原因都不是，毕竟还支付成功过一次。&lt;/p&gt;
&lt;p&gt;最后去反编译看微信SDK的代码，支寻找为什么会返回-1，突然看到代码里面的getPackageName()时，想到了包名，回忆起之前集成微信第三方登录时绑定的包名和签名信息，突然大悟，是不是和包名有关？客户测试的demo包名和主应用的包名是不一样的。于是跟客户沟通，看了一下支付微信的后台配置，叫对方把包名改成主应用的包名，结果测试，支付两次OK。好吧，问题找到了。&lt;/p&gt;
&lt;p&gt;回想起整个问题解决过程，还是插件开发惹的祸。但中间种种不正常让人生疑，如果包名不对，为什么还能在清除应用缓存之后能支付成功？其实当时我应该就要反应过来，有谁会做成这种支付的时候还要清除缓存就能支付成功的？体验做成这样，还叫BAT？可能这个提示是官方支付demo里面的提示，集成的时候直接拿过来用了吧。&lt;/p&gt;
&lt;p&gt;中间客户也有叫我检查一下是不是服务器的问题，用工具抓一下微信请求的包，如果返回的code为0，就是请求成功，返回其他值就是不正常，服务器端就有问题。让我先排除一下，结果是code返回0，服务器端OK，没有问题。也就是问题还是在客户端。&lt;/p&gt;
&lt;p&gt;刚开始是怀疑签名有问题，于是用官方的工具检测了下，发现签名最后生成的信息是一样的。这个疑问就排除了。只是当时没想到去排除包名的问题。唉，支付宝怎么就没有这样坑人的问题呢？&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这两天在集成微信支付的功能，先是客户在插件中集成支付功能，后来发现回调不起来，于是将支付功能集成到了主应用，然后暴露接口给插件使用。费劲几个小时的折腾，于是乎就有下文。&lt;/p&gt;
&lt;p&gt;我们先来看下官网对于code为-1的说明（官网说明地址&lt;a href=&quot;http://kf.qq.com/faq/140225MveaUz150413VNj6nm.html&quot;&gt;点这里&lt;/a&gt;）：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;开放平台配置的报名和应用签名是否一致：（android）；确认是否使用正式的keystore打包apk并安装调试；（android）；提交订单部分需要在服务器端完成。&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;先请仔细阅读，你遇到的问题就在这段描述中。其中注意，中间还错别字&lt;code&gt;报名&lt;/code&gt;应为&lt;code&gt;包名&lt;/code&gt;（鹅厂果然不一样）。&lt;/p&gt;
    
    </summary>
    
      <category term="pay" scheme="http://www.jacpy.com/categories/pay/"/>
    
    
      <category term="微信支付返回code为-1" scheme="http://www.jacpy.com/tags/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E8%BF%94%E5%9B%9Ecode%E4%B8%BA-1/"/>
    
  </entry>
  
</feed>
