<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jacpy&#39;s blog</title>
  <subtitle>enjoy mobile development</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.jacpy.com/"/>
  <updated>2016-03-24T06:50:50.000Z</updated>
  <id>http://www.jacpy.com/</id>
  
  <author>
    <name>jacpy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>AndFix加载补丁包过程分析</title>
    <link href="http://www.jacpy.com/2016/03/24/andfix-load-patch-analysis.html"/>
    <id>http://www.jacpy.com/2016/03/24/andfix-load-patch-analysis.html</id>
    <published>2016-03-24T06:42:58.000Z</published>
    <updated>2016-03-24T06:50:50.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;AndFix加载补丁包过程分析&quot;&gt;&lt;a href=&quot;#AndFix加载补丁包过程分析&quot; class=&quot;headerlink&quot; title=&quot;AndFix加载补丁包过程分析&quot;&gt;&lt;/a&gt;AndFix加载补丁包过程分析&lt;/h3&gt;&lt;p&gt;andfix提供了一套可以热替换java中原有方法的工具，在实际应用中可以用来热替换修复出现bug的方法，从而使用应用不需要升级应用就能解决部分问题。&lt;/p&gt;
&lt;p&gt;本文主要是分析运行在android应用中的一套工具环境，从java层到native层分析andfix框架热替换方法的过程。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h4 id=&quot;一、解析补丁包&quot;&gt;&lt;a href=&quot;#一、解析补丁包&quot; class=&quot;headerlink&quot; title=&quot;一、解析补丁包&quot;&gt;&lt;/a&gt;一、解析补丁包&lt;/h4&gt;&lt;p&gt;首先来看andfix初始化代码：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.alipay.euler.andfix.patch.PatchManager;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;App&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Application&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onCreate();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String patchPath = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        PatchManager patchManager = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; PatchManager(getApplicationContext());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        patchManager.init(&lt;span class=&quot;string&quot;&gt;&quot;1.0&quot;&lt;/span&gt;);&lt;span class=&quot;comment&quot;&gt;//current version&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        patchManager.addPatch(patchPath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        patchManager.loadPatch();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;一般这段初始化代码是放在Application的onCreate()方法中，原因是应用启动时，尽早替换出现问题的方法，等到方法执行时再替换就无意义了。&lt;/p&gt;
&lt;p&gt;在PatchManager对象调用init(String)方法时，传入的版本号值很关键。如果是初次初始化或者版本号发生变化，那么会清空原来已经缓存的patch包，同时会缓存新的版本号；如果不是，则会加载已经缓存过的patch包并解析成Patch对象缓存到集合中。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * initialize&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; *&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt; appVersion&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; *            App version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String appVersion)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mPatchDir.exists() &amp;amp;&amp;amp; !mPatchDir.mkdirs()) &amp;#123;&lt;span class=&quot;comment&quot;&gt;// make directory fail&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Log.e(TAG, &lt;span class=&quot;string&quot;&gt;&quot;patch dir create error.&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mPatchDir.isDirectory()) &amp;#123;&lt;span class=&quot;comment&quot;&gt;// not directory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		mPatchDir.delete();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	SharedPreferences sp = mContext.getSharedPreferences(SP_NAME,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			Context.MODE_PRIVATE);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	String ver = sp.getString(SP_VERSION, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ver == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; || !ver.equalsIgnoreCase(appVersion)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		cleanPatch();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		sp.edit().putString(SP_VERSION, appVersion).commit();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		initPatchs();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;addPatch(String)的功能是加载patch包，并将patch包缓存到应用的/data/data/packageName/files/apatch/目录下。如果该缓存目录下已存在，则不会重复缓存。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * add patch at runtime&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; *&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt; path&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; *            patch path&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@throws&lt;/span&gt; IOException&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;addPatch&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String path)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	File src = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; File(path);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	File dest = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; File(mPatchDir, src.getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(!src.exists())&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; FileNotFoundException(path);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (dest.exists()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Log.d(TAG, &lt;span class=&quot;string&quot;&gt;&quot;patch [&quot;&lt;/span&gt; + path + &lt;span class=&quot;string&quot;&gt;&quot;] has be loaded.&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	FileUtil.copyFile(src, dest);&lt;span class=&quot;comment&quot;&gt;// copy to patch&#39;s directory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Patch patch = addPatch(dest);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (patch != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		loadPatch(patch);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;patch包解析构造成Patch类对象时，主要是解析patch包中的META-INF/PATCH.MF文件，将该文件中的Patch-Classes项对应的值解析出来，在前面 &lt;a href=&quot;/2016/03/24/apkpatch-tool-analysis.html&quot;&gt;apkpatch工具实现分析&lt;/a&gt; 一文中有介绍，这个字段对应的值是将修复的Class以英文逗号分隔组成。&lt;/p&gt;
&lt;h4 id=&quot;二、加载补丁包中的类&quot;&gt;&lt;a href=&quot;#二、加载补丁包中的类&quot; class=&quot;headerlink&quot; title=&quot;二、加载补丁包中的类&quot;&gt;&lt;/a&gt;二、加载补丁包中的类&lt;/h4&gt;&lt;p&gt;加载补丁包中的类并替换相应的方法是通过调用PatchManager的loadPatch()方法完成的。该方法是将缓存的patch中的Class名称，通过调用AndFixManager类的fix(File, ClassLoader, List&lt;string&gt;)方法转换成对应的Class类。&lt;/string&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; DexFile dexFile = DexFile.loadDex(&lt;span class=&quot;keyword&quot;&gt;file&lt;/span&gt;.getAbsolutePath(),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					optfile.getAbsolutePath(), Context.MODE_PRIVATE);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (saveFingerprint) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	mSecurityChecker.saveOptSig(optfile);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ClassLoader patchClassLoader = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ClassLoader(classLoader) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; findClass(String className)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; ClassNotFoundException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; clazz = dexFile.loadClass(className, &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (clazz == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&amp;amp;&amp;amp; className.startsWith(&lt;span class=&quot;string&quot;&gt;&quot;com.alipay.euler.andfix&quot;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;Class&lt;/span&gt;.forName(className);&lt;span class=&quot;comment&quot;&gt;// annotation’s class not found&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (clazz == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ClassNotFoundException(className);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; clazz;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在fix()方法中会进行patch包的版本支持校验和安全校验，如果不支持或者校验不通过，则不会继续执行。在这个方法中以Patch包的路径为参数创建了DexFile类对象，并构造了ClassLoader类，并重写了其findClass(String)方法，ClassLoader去查找Class的时候，实际上是调用DexFile.loadClass(String, ClassLoader)方法来完成的。&lt;/p&gt;
&lt;p&gt;最后是调用DexFile.entries()方法该patch包中所有的类名，将这些已经在Patch-Classes中的类名通过调用DexFile.loadClass(String, ClassLoader)获取对应的Class。&lt;/p&gt;
&lt;p&gt;方法替换是通过调用AndFixManager的fixClass(Class, ClassLoader)方法实现，该方法中先找出该Class中的有MethodReplace注解的方法，然后拿出该注解的clz(原方法对应的类名)和meth(原方法名称)字段的值，获取到原方法的Method对象，最后通过执行AndFix.addReplaceMethod(Method, Method)方法调用replaceMethod(Method, Method)方法进而转入native层进行方法替换操作。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * fix class&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; *&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt; clazz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; *            class&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;fixClass&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Class&amp;lt;?&amp;gt; clazz, ClassLoader classLoader)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Method[] methods = clazz.getDeclaredMethods();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	MethodReplace methodReplace;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	String clz;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	String meth;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (Method method : methods) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		methodReplace = method.getAnnotation(MethodReplace.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (methodReplace == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		clz = methodReplace.clazz();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		meth = methodReplace.method();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!isEmpty(clz) &amp;amp;&amp;amp; !isEmpty(meth)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			replaceMethod(classLoader, clz, meth, method);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;三、安全校验&quot;&gt;&lt;a href=&quot;#三、安全校验&quot; class=&quot;headerlink&quot; title=&quot;三、安全校验&quot;&gt;&lt;/a&gt;三、安全校验&lt;/h4&gt;&lt;p&gt;是否支持方法热替换操作的是通过AndFixManager的mSupport属性判断。该属性是通过调用Compact.isSupport()方法返回的值，在该方法中会判断是否不是阿里云OS系统、调用native中的setup根据不同虚拟机初始化是否成功、判断android系统版本是否是在2.3 ~ 6.0之间。&lt;/p&gt;
&lt;p&gt;安全校验分两步：第一是校验patch包的签名是否与主应用的签名一致，如果主应用是调试的签名，也给予通过，这样做是为了调试方便。该过程是在SecurityChecker的verifyApk(File)方法中实现。&lt;/p&gt;
&lt;p&gt;第二步验证的是验证patch包中优化过的classes.dex文件，即odex或oat文件，只不过andfix将该生成的文件名修改为与patch包名称相同，放在了apatch_opt目录。该验证过程是通过比较优化后的odex文件的MD5值与上次获取优化后的odex文件缓存的MD5值，如果不相同，则会删除odex文件，重新调用SecurityChecker类的saveOptSig(File)方法缓存新生成的odex文件的MD5值。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt; file&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; *            Dex file&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@return&lt;/span&gt; true if verify fingerprint success&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;verifyOpt&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(File file)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	String fingerprint = getFileMD5(file);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	String saved = getFingerprint(file.getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (fingerprint != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; TextUtils.equals(fingerprint, saved)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;四、Dalvik虚拟机方法替换&quot;&gt;&lt;a href=&quot;#四、Dalvik虚拟机方法替换&quot; class=&quot;headerlink&quot; title=&quot;四、Dalvik虚拟机方法替换&quot;&gt;&lt;/a&gt;四、Dalvik虚拟机方法替换&lt;/h4&gt;&lt;p&gt;java层在调用AndFix类的replaceMethod()方法时，就转入了native层，在native层，该本地方法对应的函数是static void replaceMethod(JNIEnv* env, jclass clazz, jobject src,&lt;br&gt;        jobject dest)，中间使用了JNI中的主动注册的方式进行关联。如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * JNI registration.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; JNINativeMethod gMethods[] = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* name, signature, funcPtr */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123; &lt;span class=&quot;string&quot;&gt;&quot;setup&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;(ZI)Z&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;*) setup &amp;#125;, &amp;#123; &lt;span class=&quot;string&quot;&gt;&quot;replaceMethod&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;string&quot;&gt;&quot;(Ljava/lang/reflect/Method;Ljava/lang/reflect/Method;)V&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;*) replaceMethod &amp;#125;, &amp;#123; &lt;span class=&quot;string&quot;&gt;&quot;setFieldFlag&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;string&quot;&gt;&quot;(Ljava/lang/reflect/Field;)V&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;*) setFieldFlag &amp;#125;, &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在replaceMethod函数中根据当前是DVM还是ART虚拟机，分别调用dalvik_replaceMethod()和art_replaceMethod()函数。&lt;/p&gt;
&lt;p&gt;dalvik_replaceMethod()函数的定义是在jni/dalvik/dalvik_method_replace.cpp文件中。其中通过调用JNIEnv的FromReflectedMethod()函数获取java层Method类对象对应native层的Method结构体，然后修改该结构体中的accessFlags和jniArgInfo属性值，使这个java层的普通方法变成一个native方法。同时还修改了insns和nativeFunc属性，insns缓存的是已经修复bug的函数的Method结构体指针；nativeFunc属性值是dalvik_dispatcher函数地址，虚拟机在执行方法时，如果该方法是本地方法就会执行nativeFunc所指向的函数地址，也就是会执行dalvik_dispatcher函数。&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Method* meth = (Method*) env-&amp;gt;FromReflectedMethod(src);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Method* target = (Method*) env-&amp;gt;FromReflectedMethod(dest);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LOGD(&lt;span class=&quot;string&quot;&gt;&quot;dalvikMethod: %s&quot;&lt;/span&gt;, meth-&amp;gt;name);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;meth-&amp;gt;jniArgInfo = &lt;span class=&quot;number&quot;&gt;0x80000000&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;meth-&amp;gt;accessFlags |= ACC_NATIVE;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; argsSize = dvmComputeMethodArgsSize_fnPtr(meth);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!dvmIsStaticMethod(meth))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	argsSize++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;meth-&amp;gt;registersSize = meth-&amp;gt;insSize = argsSize;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;meth-&amp;gt;insns = (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;*) target;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;meth-&amp;gt;nativeFunc = dalvik_dispatcher;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在dalvik_dispatcher()函数中，会根据当前替换方法，即修复bug的方法是否是静态方法而分别做处理。这个与java语法相同，如果调用的是非静态方法，则会需要当前方法所在类的对象来调用，如果是静态方法，则只需要类即可。不管是处理哪种类型的方法，都会调用到dvmCallMethod_fnPtr()函数。这个函数是通过使用NDK中的&lt;dlfcn.h&gt;头文件中的相关函数打开android系统中的/system/lib/libdvm.so文件，使用dvmCallMethod名称获取到的函数地址，也就是说调用dvmCallMethod_fnPtr()函数，实际上是调用dvm虚拟机中的dvmCallMethod()函数，这个函数是在android系统源码中的dalvik/vm/interp/Stack.cpp文件中定义。上面获取函数地址的方法可以参见dalvik_setup()函数定义。通过dvmCallMethod()函数名称也能明白，该函数是虚拟机用来执行java层方法的。&lt;/dlfcn.h&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!dvmIsStaticMethod(meth)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// 中间代码省略 ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	dvmCallMethod_fnPtr(self, (Method*) jInvokeMethod,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			dvmCreateReflectMethodObject_fnPtr(meth), &amp;amp;result, thisObj,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			argArray);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	thisObj-&amp;gt;clazz = tmp;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// 中间代码省略 ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	dvmCallMethod_fnPtr(self, (Method*) jInvokeMethod,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			dvmCreateReflectMethodObject_fnPtr(meth), &amp;amp;result, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			argArray);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意，dvmCallMethod()函数传入的第二个参数是一个Method结构体指针，也就是当需要被执行的方法，但这个方法jInvokeMethod是一个java层的java.lang.reflect.Method的invoke()方法，是通过使用JNI的GetMethodID()函数获取到其对应ID作为一个参数，具体是在dalvik_setup()函数中获取；第三个参数才是替换方法，这个参数在dvmCallMethod()函数中作为被执行方法的调用对象。到这里应该能明白，实际上对应java层的调用是执行java.lang.reflect.Method对象的invoke()方法。&lt;/p&gt;
&lt;p&gt;在dalvik_dispatcher()函数的最后是处理异常和返回结果。&lt;/p&gt;
&lt;h4 id=&quot;五、ART虚拟机方法替换&quot;&gt;&lt;a href=&quot;#五、ART虚拟机方法替换&quot; class=&quot;headerlink&quot; title=&quot;五、ART虚拟机方法替换&quot;&gt;&lt;/a&gt;五、ART虚拟机方法替换&lt;/h4&gt;&lt;p&gt;art_replaceMethod()函数是在jni/art/art_method_replace.cpp文件中定义，该函数主要内容是根据ART虚拟机不同的版本，调用不同的函数。下面是具体代码：&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; __attribute__ ((visibility (&lt;span class=&quot;string&quot;&gt;&quot;hidden&quot;&lt;/span&gt;))) art_replaceMethod(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		JNIEnv* env, jobject src, jobject dest) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (apilevel &amp;gt; &lt;span class=&quot;number&quot;&gt;22&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		replace_6_0(env, src, dest);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (apilevel &amp;gt; &lt;span class=&quot;number&quot;&gt;21&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		replace_5_1(env, src, dest);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		replace_5_0(env, src, dest);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这几个函数分别是在对应的jni/art/art_method_replace_x_x.cpp文件中定义。因为ART虚拟机还不太成熟，google还在改进中，所以不同版本有些代码会不一样，才会针对不同的版本进行处理。&lt;/p&gt;
&lt;p&gt;这里从java层过来的Method对象，被转换成ART虚拟机中能识别的ArtMethod类指针。这些函数中处理都是相同的，将被替换方法和替换方法两个方法的属性值进行互相替换。这里的处理方式与DVM有很大不同，ART中只需要替换相应的属性，不需要进行方法调用，这与ART虚拟机原理有关。其中下面两个属性替换很关键：&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;smeth-&amp;gt;entry_point_from_compiled_code_ =&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			dmeth-&amp;gt;entry_point_from_compiled_code_;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;smeth-&amp;gt;entry_point_from_interpreter_ = dmeth-&amp;gt;entry_point_from_interpreter_;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;entry_point_from&lt;em&gt;interpreter&lt;/em&gt;可以认为是ART虚拟机执行方法的起点，这个指针实际上是一个函数指针，这个函数指针是由汇编实现，这个指针是在art/runtime/class_linker.cc文件中赋值，再往下找，就会找到汇编代码。&lt;br&gt;entry_point_from_compiled&lt;em&gt;code&lt;/em&gt;这个指针同理，当ART虚拟机执行代码，如果需要Interpreter，就会执行entry_point_from&lt;em&gt;interpreter&lt;/em&gt;指向的函数；如果不需要，则会执行entry_point_from_compiled&lt;em&gt;code&lt;/em&gt;指向的函数。两个函数之间又可以相互调用，这部分都是用汇编代码执行的。具体原理参见CSDN老罗的博客。&lt;/p&gt;
&lt;p&gt;– EOF –&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;AndFix加载补丁包过程分析&quot;&gt;&lt;a href=&quot;#AndFix加载补丁包过程分析&quot; class=&quot;headerlink&quot; title=&quot;AndFix加载补丁包过程分析&quot;&gt;&lt;/a&gt;AndFix加载补丁包过程分析&lt;/h3&gt;&lt;p&gt;andfix提供了一套可以热替换java中原有方法的工具，在实际应用中可以用来热替换修复出现bug的方法，从而使用应用不需要升级应用就能解决部分问题。&lt;/p&gt;
&lt;p&gt;本文主要是分析运行在android应用中的一套工具环境，从java层到native层分析andfix框架热替换方法的过程。&lt;/p&gt;
    
    </summary>
    
    
      <category term="andfix" scheme="http://www.jacpy.com/tags/andfix/"/>
    
  </entry>
  
  <entry>
    <title>apkpatch工具实现分析</title>
    <link href="http://www.jacpy.com/2016/03/24/apkpatch-tool-analysis.html"/>
    <id>http://www.jacpy.com/2016/03/24/apkpatch-tool-analysis.html</id>
    <published>2016-03-24T05:27:17.000Z</published>
    <updated>2016-03-24T06:49:22.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;apkpatch工具实现分析&quot;&gt;&lt;a href=&quot;#apkpatch工具实现分析&quot; class=&quot;headerlink&quot; title=&quot;apkpatch工具实现分析&quot;&gt;&lt;/a&gt;apkpatch工具实现分析&lt;/h3&gt;&lt;p&gt;apkpatch工具是配套阿里AndFix框架的一个生成aptach补丁包的工具，链接地址是：&lt;a href=&quot;https://github.com/alibaba/AndFix/tree/master/tools&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/alibaba/AndFix/tree/master/tools&lt;/a&gt; 。主要包含反编译对比两个APK的类和方法、修改类名写入PACTH.MF文件、生成补丁apatch包。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;由于没有从网上找到对应的源码，以下分析过程均通过jd-gui工具反编译jar包阅读反编译代码完成。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h4 id=&quot;一、工具入口&quot;&gt;&lt;a href=&quot;#一、工具入口&quot; class=&quot;headerlink&quot; title=&quot;一、工具入口&quot;&gt;&lt;/a&gt;一、工具入口&lt;/h4&gt;&lt;p&gt;从命令行执行apkpatch命令时，调用的是com.euler.patch.Main类中的静态main()方法。通过对参数的解析，解析出两个APK的路径及签名文件相关信息。根据命令参数的不同，主要分为两个过程，第一个过程是如果参数中有&lt;strong&gt;-m&lt;/strong&gt;参数，那么会执行补丁包的合并过程，即将&lt;strong&gt;-m&lt;/strong&gt;参数指定的文件合并到一个merge.aptach文件中；另外一个过程是通过构造com.euler.patch.ApkPatch类对象，调用其doPatch()方法，启动生成补丁包。&lt;/p&gt;
&lt;p&gt;解析&lt;strong&gt;-m&lt;/strong&gt;参数为合并代码逻辑反编译代码如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/03/24/merge_patch.jpg&quot; alt=&quot;解析参数为合并&quot;&gt;&lt;/p&gt;
&lt;p&gt;生成补丁包的逻辑反编译代码如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/03/24/make_patch.jpg&quot; alt=&quot;生成补丁包&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;二、补丁包合并&quot;&gt;&lt;a href=&quot;#二、补丁包合并&quot; class=&quot;headerlink&quot; title=&quot;二、补丁包合并&quot;&gt;&lt;/a&gt;二、补丁包合并&lt;/h3&gt;&lt;p&gt;合并操作是调用com.euler.patch.MergePatch类中的doMerge()方法，其中会调用mergeCode(File)方法，将需要的合并的patch包中的classes.dex合并到一个dex文件中。合并过程是通过调用调用com.android.dx.merge.DexMerger类merge()方法完成。&lt;/p&gt;
&lt;h3 id=&quot;三、生成补丁包&quot;&gt;&lt;a href=&quot;#三、生成补丁包&quot; class=&quot;headerlink&quot; title=&quot;三、生成补丁包&quot;&gt;&lt;/a&gt;三、生成补丁包&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/2016/03/24/do_patch.jpg&quot; alt=&quot;生成补丁包&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-1、对比两个APK的类和方法&quot;&gt;&lt;a href=&quot;#3-1、对比两个APK的类和方法&quot; class=&quot;headerlink&quot; title=&quot;3.1、对比两个APK的类和方法&quot;&gt;&lt;/a&gt;3.1、对比两个APK的类和方法&lt;/h4&gt;&lt;p&gt;在执行apkpatch工具时，命令参数&lt;strong&gt;-f&lt;/strong&gt;表示的是新生成的APK，&lt;strong&gt;-t&lt;/strong&gt;参数表示的是原APK包，两个APK不同的信息保存在com.euler.patch.diff.DiffInfo类实例中，其中包括，不同的类信息、方法信息以及属性信息。这些不同的信息是通过调用com.euler.patch.diff.DexDiffer类的diff()方法获取。&lt;/p&gt;
&lt;p&gt;这里有个关键的地方是将修改的方法，也可以说是出现bug的方法会增加一个&lt;strong&gt;Lcom/alipay/euler/andfix/annotation/MethodReplace;&lt;/strong&gt;注解，在android加载补丁包的环境中，方法替换是根据方法是否有@MethodReplace注解而进行替换的。&lt;/p&gt;
&lt;p&gt;通过调用ApkPatch类的buildCode(File, File, DiffInfo)方法，将所有新增的类或发生修改的类根据类名将类的信息转换成smali格式的文件，修改类名信息后，即加上_CF后缀，重新生成新的新的dex文件。&lt;/p&gt;
&lt;h4 id=&quot;3-2、写入PACTH-MF文件&quot;&gt;&lt;a href=&quot;#3-2、写入PACTH-MF文件&quot; class=&quot;headerlink&quot; title=&quot;3.2、写入PACTH.MF文件&quot;&gt;&lt;/a&gt;3.2、写入PACTH.MF文件&lt;/h4&gt;&lt;p&gt;紧接着调用ApkPatch的父类，即Build类的build(File, File)方法打成APK包，同时调用getMeta()方法写入PATCH.MF文件补丁包信息。getMeta()方法具体实现是在ApkPatch类中，注意PATCH.MF文件中的Patch-Classes字段对应的内容是带_CF后缀的类名。这个在android运行环境中解析的时候会用到这个字段。&lt;/p&gt;
&lt;p&gt;getMeta()方法反编译代码如下所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/03/24/get_meta.jpg&quot; alt=&quot;写入MF信息&quot;&gt;&lt;/p&gt;
&lt;p&gt;最后是调用Build类中的release()方法对打包的APK文件进行签名，生成包含签名信息的patch包。&lt;/p&gt;
&lt;p&gt;– EOF –&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;apkpatch工具实现分析&quot;&gt;&lt;a href=&quot;#apkpatch工具实现分析&quot; class=&quot;headerlink&quot; title=&quot;apkpatch工具实现分析&quot;&gt;&lt;/a&gt;apkpatch工具实现分析&lt;/h3&gt;&lt;p&gt;apkpatch工具是配套阿里AndFix框架的一个生成aptach补丁包的工具，链接地址是：&lt;a href=&quot;https://github.com/alibaba/AndFix/tree/master/tools&quot;&gt;https://github.com/alibaba/AndFix/tree/master/tools&lt;/a&gt; 。主要包含反编译对比两个APK的类和方法、修改类名写入PACTH.MF文件、生成补丁apatch包。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;由于没有从网上找到对应的源码，以下分析过程均通过jd-gui工具反编译jar包阅读反编译代码完成。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="andfix" scheme="http://www.jacpy.com/categories/andfix/"/>
    
    
      <category term="andfix apkpatch" scheme="http://www.jacpy.com/tags/andfix-apkpatch/"/>
    
  </entry>
  
  <entry>
    <title>Genymotion模拟器长期使用占用大量磁盘空间解决方案</title>
    <link href="http://www.jacpy.com/2015/10/30/clear-genymotion-virturebox-cache-md.html"/>
    <id>http://www.jacpy.com/2015/10/30/clear-genymotion-virturebox-cache-md.html</id>
    <published>2015-10-30T12:54:28.000Z</published>
    <updated>2015-10-30T15:34:48.000Z</updated>
    
    <content type="html">&lt;p&gt;今天下午在调应用，突然Android Studio弹出&lt;code&gt;Low disk space on a Android Studio system directory partition&lt;/code&gt;提示，磁盘空间不够了？赶紧跑去看了磁盘用量。傻眼了，早上来还有几百M的C盘，现在只剩下几十M了。早在之前就已经注意到了C盘容量会莫名的减少，但是没有注意是哪个程序占用了更多的空间，今天决定要找找，于是就有了下文。&lt;/p&gt;
&lt;h3 id=&quot;1-二分法找出磁盘占用空间最大的目录&quot;&gt;&lt;a href=&quot;#1-二分法找出磁盘占用空间最大的目录&quot; class=&quot;headerlink&quot; title=&quot;1.二分法找出磁盘占用空间最大的目录&quot;&gt;&lt;/a&gt;1.二分法找出磁盘占用空间最大的目录&lt;/h3&gt;&lt;p&gt;Win 7的应用程序缓存目录是在&lt;code&gt;C:\Users\jacpy\AppData&lt;/code&gt;目录中，&lt;code&gt;jacpy&lt;/code&gt;为当前系统用户名。&lt;code&gt;AppData&lt;/code&gt;为隐藏目录，要在目录菜单的“组织”中找到“文件夹和搜索选项”的弹出框的“查看”Tab页中修改，不会修改也没关系，打开一个目录，把上面的路径直接copy到路径框里面，把用户名换成自己的电脑用户名，回车就行了。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;code&gt;AppData&lt;/code&gt;目录下面只有几个目录，所以挨个看下属性就知道，找占用空间最大的目录进去，无疑是&lt;code&gt;Local&lt;/code&gt;目录，实际上应用程序的缓存大部分在这个目录中。&lt;code&gt;Local&lt;/code&gt;目录中有N多目录，如果你装了很多的应用程序的话，OK，现在二分法表现的时候了。先选中目录中一半的目录，看一下属性，统计这些目录的磁盘占用的空间，也不用选择一半，差不多就行。然后在占用空间大的那部分目录里再进行同样的处理方式，传说中的logn级别的查找效率体现出来了有没有啊。很意外，找到的是Genymobile目录，通过观察其他子目录发现，也在意料之中。&lt;/p&gt;
&lt;h3 id=&quot;2-删除Genymotion的Snapshots文件目录&quot;&gt;&lt;a href=&quot;#2-删除Genymotion的Snapshots文件目录&quot; class=&quot;headerlink&quot; title=&quot;2.删除Genymotion的Snapshots文件目录&quot;&gt;&lt;/a&gt;2.删除Genymotion的Snapshots文件目录&lt;/h3&gt;&lt;p&gt;通过上面的二分法在Genymobile目录中找到空间占用最多的文件，最后是在&lt;code&gt;Google Nexus 4 - 4.2.2 - API 17 - 768x1280&lt;/code&gt;中的Snapshots目录中找到了一个有6个G的vdi文件，好家伙，这是什么鬼，这么大！立马删除。然后再去启动模拟器，启动不了。好吧，估计是组成的文件缺一不可吧，最后把&lt;code&gt;Google Nexus 4 - 4.2.2 - API 17 - 768x1280&lt;/code&gt;整个文件夹都删除了，打算重新再下载这个模拟器。&lt;/p&gt;
&lt;h3 id=&quot;3-重新部署Genymotion模拟器&quot;&gt;&lt;a href=&quot;#3-重新部署Genymotion模拟器&quot; class=&quot;headerlink&quot; title=&quot;3.重新部署Genymotion模拟器&quot;&gt;&lt;/a&gt;3.重新部署Genymotion模拟器&lt;/h3&gt;&lt;p&gt;打开Genymotion的PC端，选择还是那个模拟器镜像，然后下载，结果瞬间完成。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jacpy/jacpy.github.io/master/images/2015/10/30/genymotion_pc.png&quot; alt=&quot;Genymotion PC端截图&quot;&gt;&lt;br&gt;难道本地有缓存？又在目录里面找了一圈，发现在&lt;code&gt;ova&lt;/code&gt;目录中有ova缓存文件。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jacpy/jacpy.github.io/master/images/2015/10/30/genymotion_cache_file.jpg&quot; alt=&quot;缓存文件截图&quot;&gt;&lt;/p&gt;
&lt;p&gt;究其原理肯定是VirtureBox虚拟机文件越用越大，因为最近用模拟器调试应用（既然免费用别人的工具，打一下广告，Genymotion模拟器速度确实很快，比我的物理机速度还快，尤其是调试时安装应用的速度），时间长了，用的多了，虚拟机文件就会变得很大，跟vmare一个德性。&lt;/p&gt;
&lt;p&gt;干掉那么大一个文件，C盘又空出来很多空间，心里很爽。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;今天下午在调应用，突然Android Studio弹出&lt;code&gt;Low disk space on a Android Studio system directory partition&lt;/code&gt;提示，磁盘空间不够了？赶紧跑去看了磁盘用量。傻眼了，早上来还有几百M的C盘，现在只剩下几十M了。早在之前就已经注意到了C盘容量会莫名的减少，但是没有注意是哪个程序占用了更多的空间，今天决定要找找，于是就有了下文。&lt;/p&gt;
&lt;h3 id=&quot;1-二分法找出磁盘占用空间最大的目录&quot;&gt;&lt;a href=&quot;#1-二分法找出磁盘占用空间最大的目录&quot; class=&quot;headerlink&quot; title=&quot;1.二分法找出磁盘占用空间最大的目录&quot;&gt;&lt;/a&gt;1.二分法找出磁盘占用空间最大的目录&lt;/h3&gt;&lt;p&gt;Win 7的应用程序缓存目录是在&lt;code&gt;C:\Users\jacpy\AppData&lt;/code&gt;目录中，&lt;code&gt;jacpy&lt;/code&gt;为当前系统用户名。&lt;code&gt;AppData&lt;/code&gt;为隐藏目录，要在目录菜单的“组织”中找到“文件夹和搜索选项”的弹出框的“查看”Tab页中修改，不会修改也没关系，打开一个目录，把上面的路径直接copy到路径框里面，把用户名换成自己的电脑用户名，回车就行了。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="genymotion" scheme="http://www.jacpy.com/tags/genymotion/"/>
    
  </entry>
  
  <entry>
    <title>使用Gradle编译报错：Execution failed for task &#39;:packageAllDebugClassesForMultiDex&#39;  java.util.zip.ZipException duplicate entry解决方法</title>
    <link href="http://www.jacpy.com/2015/10/30/Error-Execution-failed-for-task-packageAllDebugClassesForMultiDex-duplicate-entry.html"/>
    <id>http://www.jacpy.com/2015/10/30/Error-Execution-failed-for-task-packageAllDebugClassesForMultiDex-duplicate-entry.html</id>
    <published>2015-10-30T04:42:40.000Z</published>
    <updated>2015-10-30T15:38:48.000Z</updated>
    
    <content type="html">&lt;p&gt;今天用Gradle编译Android项目时，报了一个错：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Error:Execution failed &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; task &lt;span class=&quot;string&quot;&gt;&#39;:packageAllDebugClassesForMultiDex&#39;&lt;/span&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;gt; java.util.zip.ZipException: duplicate entry: com/taobao/tae/sdk/openim/OpenWXUiApiImpl$&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;$&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;.class&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;由于第一次遇到这种错，看提示信息以为是项目的方法数超过65535的限制，于是google一下，看别人有没有遇到这个问题。结果在&lt;code&gt;stackoverflow&lt;/code&gt;上好多人遇到这个问题，有人说是bug，有人说要求各种组合的jar包版本要一致，按上面说的修改方法在build.gradle配置文件中改了一下，编译后还是报这个错。&lt;/p&gt;
&lt;p&gt;这时心里开始犯嘀咕了，难道是新用的阿里的jar包方法数太多了？于是到libs目录看一下，这一看不要紧，发现问题了&lt;strong&gt;同一个jar包存在两个版本&lt;/strong&gt;，删除老的版本。重新编译，OK了。&lt;/p&gt;
&lt;p&gt;出现这样问题的原因是自己在Android Studio、Eclipse、SVN之间倒腾代码时没注意到jar包重复，出现重复包时Gradle编译出现的错误与Eclipse提示错误不一致。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;今天用Gradle编译Android项目时，报了一个错：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Error:Execution failed &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; task &lt;span class=&quot;string&quot;&gt;&#39;:packageAllDebugClassesForMultiDex&#39;&lt;/span&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;gt; java.util.zip.ZipException: duplicate entry: com/taobao/tae/sdk/openim/OpenWXUiApiImpl$&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;$&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;.class&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="packageAllDebugClassesForMultiDex" scheme="http://www.jacpy.com/tags/packageAllDebugClassesForMultiDex/"/>
    
  </entry>
  
  <entry>
    <title>使用BaseAdapter的getItemViewType()报错解决方案</title>
    <link href="http://www.jacpy.com/2015/10/22/android-BaseAdapter-getItemViewType-must-be-in-the-range-0-to-getViewTypeCount-1.html"/>
    <id>http://www.jacpy.com/2015/10/22/android-BaseAdapter-getItemViewType-must-be-in-the-range-0-to-getViewTypeCount-1.html</id>
    <published>2015-10-22T13:13:40.000Z</published>
    <updated>2015-10-30T15:55:46.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天开发一个类似微信搜索显示搜索结果分类展示的功能，很自然的联想到了使用ListView去展示最后搜索的结果。每个分类最前面要显示一个分类的标题，就想使用&lt;code&gt;getItemViewType()&lt;/code&gt;、&lt;code&gt;getViewTypeCount()&lt;/code&gt;这两个方法做展示效果，结果在搜索过滤条件刷新Adapter的列表时，发生了以下错误：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java.lang.ArrayIndexOutOfBoundsException: length=&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;; index=&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.AbsListView$RecycleBin.addScrapView(AbsListView.java:&lt;span class=&quot;number&quot;&gt;6355&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.ListView.layoutChildren(ListView.java:&lt;span class=&quot;number&quot;&gt;1565&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.AbsListView.onLayout(AbsListView.java:&lt;span class=&quot;number&quot;&gt;1994&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.LinearLayout.setChildFrame(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1663&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.LinearLayout.layoutVertical(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1521&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.LinearLayout.onLayout(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1434&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.FrameLayout.onLayout(FrameLayout.java:&lt;span class=&quot;number&quot;&gt;448&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.LinearLayout.setChildFrame(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1663&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.LinearLayout.layoutVertical(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1521&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.LinearLayout.onLayout(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1434&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.widget.FrameLayout.onLayout(FrameLayout.java:&lt;span class=&quot;number&quot;&gt;448&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.ViewRootImpl.performLayout(ViewRootImpl.java:&lt;span class=&quot;number&quot;&gt;1892&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:&lt;span class=&quot;number&quot;&gt;1711&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:&lt;span class=&quot;number&quot;&gt;989&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:&lt;span class=&quot;number&quot;&gt;4351&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.Choreographer$CallbackRecord.run(Choreographer.java:&lt;span class=&quot;number&quot;&gt;749&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.Choreographer.doCallbacks(Choreographer.java:&lt;span class=&quot;number&quot;&gt;562&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.Choreographer.doFrame(Choreographer.java:&lt;span class=&quot;number&quot;&gt;532&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:&lt;span class=&quot;number&quot;&gt;735&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.os.Handler.handleCallback(Handler.java:&lt;span class=&quot;number&quot;&gt;725&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.os.Handler.dispatchMessage(Handler.java:&lt;span class=&quot;number&quot;&gt;92&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.os.Looper.loop(Looper.java:&lt;span class=&quot;number&quot;&gt;137&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.app.ActivityThread.main(ActivityThread.java:&lt;span class=&quot;number&quot;&gt;5041&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at java.lang.reflect.Method.invokeNative(Native Method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at java.lang.reflect.Method.invoke(Method.java:&lt;span class=&quot;number&quot;&gt;511&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:&lt;span class=&quot;number&quot;&gt;793&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:&lt;span class=&quot;number&quot;&gt;560&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at dalvik.system.NativeStart.main(Native Method)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个错误是系统内容代码报错，感觉原因就出在这两个方法上，因为没有加这两个方法，列表展示刷新OK。&lt;br&gt;最后通过查找官方文档说明发现，&lt;strong&gt;&lt;code&gt;getItemViewType()&lt;/code&gt;方法返回的值必须在0 ~ &lt;code&gt;getViewTypeCount()&lt;/code&gt; - 1&lt;/strong&gt;这个范围内。记录一个这个问题。下面是文档说明：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;public int getItemViewType (int position)&lt;/p&gt;
&lt;p&gt;Get the type of View that will be created by getView(int, View, ViewGroup) for the specified item.&lt;br&gt;Parameters&lt;br&gt;position    The position of the item within the adapter’s data set whose view type we want.&lt;br&gt;Returns&lt;br&gt;An integer representing the type of View. Two views should share the same type if one can be converted to the other in getView(int, View, ViewGroup). &lt;strong&gt;Note: Integers must be in the range 0 to getViewTypeCount() - 1&lt;/strong&gt;. IGNORE_ITEM_VIEW_TYPE can also be returned.&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天开发一个类似微信搜索显示搜索结果分类展示的功能，很自然的联想到了使用ListView去展示最后搜索的结果。每个分类最前面要显示一个分类的标题，就想使用&lt;code&gt;getItemViewType()&lt;/code&gt;、&lt;code&gt;getViewTypeCount()&lt;/code&gt;这两个方法做展示效果，结果在搜索过滤条件刷新Adapter的列表时，发生了以下错误：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="getItemViewType" scheme="http://www.jacpy.com/tags/getItemViewType/"/>
    
      <category term="getViewTypeCount" scheme="http://www.jacpy.com/tags/getViewTypeCount/"/>
    
  </entry>
  
  <entry>
    <title>hexo-deploy-No-such-device-or-address</title>
    <link href="http://www.jacpy.com/2015/10/08/hexo-deploy-No-such-device-or-address.html"/>
    <id>http://www.jacpy.com/2015/10/08/hexo-deploy-No-such-device-or-address.html</id>
    <published>2015-10-08T13:32:00.000Z</published>
    <updated>2015-10-30T15:39:00.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天给博客增加评论功能，测试OK后准备将生成的文件提交到github，执行&lt;code&gt;hexo deploy&lt;/code&gt;命令时报如下错：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;bash: /dev/tty: No such device or address&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;error: &lt;span class=&quot;function&quot;&gt;failed to execute prompt &lt;span class=&quot;title&quot;&gt;script&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(exit code &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fatal: could not read Username &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &#39;https:&lt;span class=&quot;comment&quot;&gt;//jacpy.github.com&#39;: No error&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;查看了一下LOG，HTML文件生成OK，然后错误就出现了，再试了一次，还是出错这个错误。回想之前提交文件时如果没出错应该是提示输入用户名和密码，突然想起前几天升级了git到2.5.3，是不是版本不兼容？创建这个博客时使用的git的版本是1.9.5，于是打算装回老版本，排查一下问题。&lt;/p&gt;
&lt;p&gt;等装了老版本重新提交时，发现OK了。果真是版本的问题？猜测出现问题的原因是git版本兼容性，但具体没有深究。&lt;/p&gt;
&lt;p&gt;通过以上遇到以上问题得到的教训是不要追求新版本，能满足需求即可，切记，切记。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天给博客增加评论功能，测试OK后准备将生成的文件提交到github，执行&lt;code&gt;hexo deploy&lt;/code&gt;命令时报如下错：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;bash: /dev/tty: No such device or address&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;error: &lt;span class=&quot;function&quot;&gt;failed to execute prompt &lt;span class=&quot;title&quot;&gt;script&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(exit code &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fatal: could not read Username &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &#39;https:&lt;span class=&quot;comment&quot;&gt;//jacpy.github.com&#39;: No error&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="No such device or address" scheme="http://www.jacpy.com/tags/No-such-device-or-address/"/>
    
  </entry>
  
  <entry>
    <title>使用hexo在github上搭建自己的博客</title>
    <link href="http://www.jacpy.com/2015/08/29/blog-width-hexo-in-github.html"/>
    <id>http://www.jacpy.com/2015/08/29/blog-width-hexo-in-github.html</id>
    <published>2015-08-29T10:43:50.000Z</published>
    <updated>2015-10-30T15:35:56.000Z</updated>
    
    <content type="html">&lt;p&gt;本文主要是介绍自己在github上搭建blog，把自己在wordpress中的博客迁移过来的过程，以及这过程中遇到的坑。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;github上建站&quot;&gt;&lt;a href=&quot;#github上建站&quot; class=&quot;headerlink&quot; title=&quot;github上建站&quot;&gt;&lt;/a&gt;github上建站&lt;/h2&gt;&lt;h3 id=&quot;1-注册账号&quot;&gt;&lt;a href=&quot;#1-注册账号&quot; class=&quot;headerlink&quot; title=&quot;1.注册账号&quot;&gt;&lt;/a&gt;1.注册账号&lt;/h3&gt;&lt;p&gt;在&lt;a href=&quot;https://github.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;github&lt;/a&gt;上注册账号过程就不详说了，没啥难度。&lt;/p&gt;
&lt;h3 id=&quot;2-创建仓库&quot;&gt;&lt;a href=&quot;#2-创建仓库&quot; class=&quot;headerlink&quot; title=&quot;2.创建仓库&quot;&gt;&lt;/a&gt;2.创建仓库&lt;/h3&gt;&lt;p&gt;注册在完成后登录，在自己的首页，即&lt;a href=&quot;https://github.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com&lt;/a&gt;  页面的右下角会有一个&lt;strong&gt;You repositories&lt;/strong&gt;栏，点击右边绿色的&lt;strong&gt;New respository&lt;/strong&gt;按钮，创建一个&lt;strong&gt;Repository name&lt;/strong&gt;为与注册账户名称相同的并且带上&lt;strong&gt;.github.io&lt;/strong&gt;后缀，如jacpy.github.io（将jacpy替换成你自己注册的名称，下同 ），注意这里是&lt;strong&gt;github.io&lt;/strong&gt;不是&lt;strong&gt;github.com&lt;/strong&gt;，点击创建repository页面的底部点击&lt;strong&gt;Create repository&lt;/strong&gt;按钮后会要你选择博客的模板和一些信息，整个过程完成后，就可以直接访问&lt;a href=&quot;https://jacpy.github.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://jacpy.github.io&lt;/a&gt; 了。&lt;br&gt;具体参考：&lt;a href=&quot;https://pages.github.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://pages.github.com/&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id=&quot;安装git&quot;&gt;&lt;a href=&quot;#安装git&quot; class=&quot;headerlink&quot; title=&quot;安装git&quot;&gt;&lt;/a&gt;安装git&lt;/h2&gt;&lt;p&gt;如果你PC上安装过git，此步略过；如果没安装，那么从&lt;a href=&quot;https://git-scm.com/downloads&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;git官网&lt;/a&gt;  上下载git安装，安装过程中要将git添加到PATH中，安装过程中有页面有这样的选项，钩上就行了。&lt;/p&gt;
&lt;h2 id=&quot;安装node-js&quot;&gt;&lt;a href=&quot;#安装node-js&quot; class=&quot;headerlink&quot; title=&quot;安装node.js&quot;&gt;&lt;/a&gt;安装node.js&lt;/h2&gt;&lt;p&gt;到&lt;a href=&quot;https://nodejs.org/download/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;node.js官网&lt;/a&gt; 下载一个安装，如果你是老版本了，建议升级成最新版本，我PC上安装的是最新的0.12.7版本，npm -v的版本是2.11.3。&lt;/p&gt;
&lt;h2 id=&quot;安装hexo&quot;&gt;&lt;a href=&quot;#安装hexo&quot; class=&quot;headerlink&quot; title=&quot;安装hexo&quot;&gt;&lt;/a&gt;安装hexo&lt;/h2&gt;&lt;h3 id=&quot;1-安装&quot;&gt;&lt;a href=&quot;#1-安装&quot; class=&quot;headerlink&quot; title=&quot;1.安装&quot;&gt;&lt;/a&gt;1.安装&lt;/h3&gt;&lt;p&gt;打开命令行，执行以下命令：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;npm install -g hexo-cli&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo --save&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;2-配置&quot;&gt;&lt;a href=&quot;#2-配置&quot; class=&quot;headerlink&quot; title=&quot;2.配置&quot;&gt;&lt;/a&gt;2.配置&lt;/h3&gt;&lt;p&gt;先创建一个目录jacpy，再在命令行cd到这个目录，执行下面命令，执行初始化操作和安装一些插件：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;hexo init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-generator-index --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-generator-archive --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-generator-category --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-generator-tag --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-server --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-deployer-git --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-deployer-heroku --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-deployer-rsync --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-deployer-openshift --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-renderer-marked@&lt;span class=&quot;number&quot;&gt;0.2&lt;/span&gt; --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-renderer-stylus@&lt;span class=&quot;number&quot;&gt;0.2&lt;/span&gt; --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-generator-feed@&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; --save&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm install hexo-generator-sitemap@&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; --save&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;提示：把上面一大串命令直接复制到命令行，不用一条一条复制，再回车。&lt;br&gt;&lt;strong&gt;注意：&lt;/strong&gt;如果在执行命令过程中会有一些提示，比如提示要执行一些命令，那么就按要求直接执行，下同，不然就出现一些意想不到的情况。后面会有一个错误解决的例子。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;3-本地效果查看&quot;&gt;&lt;a href=&quot;#3-本地效果查看&quot; class=&quot;headerlink&quot; title=&quot;3.本地效果查看&quot;&gt;&lt;/a&gt;3.本地效果查看&lt;/h3&gt;&lt;p&gt;环境已经准备好了，接下来就可以写一篇了博客了，执行创建命令：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;hexo &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; blog-width-hexo-in-github&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;等待几秒，会在jacpy/source/_posts/创建一个blog-width-hexo-in-github.md文件。打开文件就可以编辑，使用的markdown语法。&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;话说这命令执行的速度太慢了吧，貌似整个一晚上的操作印象中，执行命令速度都很慢，都要等几秒钟，没有瞬间完成的，吐槽一下执行的速度。另外如果长时间发现命令没响应，就按ctrl + C终止命令，重新再执行一下，这个也是坑爹的地方。&lt;/li&gt;
&lt;li&gt;生成的md文件介绍可以参考&lt;a href=&quot;https://hexo.io/zh-cn/docs/writing.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;写作&lt;/a&gt; ， &lt;a href=&quot;https://hexo.io/zh-cn/docs/front-matter.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Front-matter&lt;/a&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;清除和生成静态HTML文件，命令如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;hexo clean&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;hexo generate&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;执行后，会在目录jacpy目录下创建一个public目录，里面是生成网页的全部内容，OK，启动服务预览一下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;hexo server&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在浏览器中访问:localhost:4000，你可以看到正常的页面内容，如果出现以下不正常的页面：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;%- partial(&lt;span class=&quot;string&quot;&gt;&#39;_partial/head&#39;&lt;/span&gt;) %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;%- partial(&lt;span class=&quot;string&quot;&gt;&#39;_partial/header&#39;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &amp;#123;cache: !config.relative_link&amp;#125;) %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;%- body %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;% &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (theme.sidebar &amp;amp;&amp;amp; theme.sidebar !== &lt;span class=&quot;string&quot;&gt;&#39;bottom&#39;&lt;/span&gt;)&amp;#123; %&amp;gt; &amp;lt;%- partial(&lt;span class=&quot;string&quot;&gt;&#39;_partial/sidebar&#39;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;,     &amp;#123;cache: !config.relative_link&amp;#125;) %&amp;gt; &amp;lt;% &amp;#125; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;%- partial(&lt;span class=&quot;string&quot;&gt;&#39;_partial/footer&#39;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &amp;#123;cache: !config.relative_link&amp;#125;) %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;%- partial(&lt;span class=&quot;string&quot;&gt;&#39;_partial/mobile-nav&#39;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &amp;#123;cache: !config.relative_link&amp;#125;) %&amp;gt; &amp;lt;%- partial(&lt;span class=&quot;string&quot;&gt;&#39;_partial/after-footer&#39;&lt;/span&gt;) %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在命令行执行：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;npm install&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;再生成执行清除和生成HTML命令即OK。因为在执行上面命令后，会有提示要执行npm install命令，但自己忽略了，才导致这个问题。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id=&quot;导出wordpress博客&quot;&gt;&lt;a href=&quot;#导出wordpress博客&quot; class=&quot;headerlink&quot; title=&quot;导出wordpress博客&quot;&gt;&lt;/a&gt;导出wordpress博客&lt;/h2&gt;&lt;p&gt;导出wordpress博客可参考&lt;a href=&quot;https://hexo.io/zh-cn/docs/migration.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;hexo官方说明&lt;/a&gt;。&lt;br&gt;导出来的是一个xml文件，转换完成后，在命令行cd到public目录，先删除public目录中的内容，再执行初始化命令：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git remote add origin https:&lt;span class=&quot;comment&quot;&gt;//github.com/jacpy/jacpy.github.io.git&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git pull origin master&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;注意：&lt;/strong&gt;是master分支，不是gh-pages分支。后面的内容都是在master分支上操作。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;OK，删除public中所有的内容，除了.git目录。然后执行：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git add -A&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git commit -m &lt;span class=&quot;string&quot;&gt;&quot;remove default pages&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git push origin master&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;按提示输入用户名和密码。上面的操作是将github上面的页面文件先删除，也可以在github上面打开文件，点击文件右上角的垃圾箱按钮，一个一个的删除。&lt;br&gt;再回到jacpy目录，执行清除和生成HTML命令，最后使用上面的命令将publish的内容提交到github上面，再刷新一下你的jacpy.github.io主页，内容已经更新上去。&lt;br&gt;到这一步已经大功了。当然你可以使用hexo deploy命令，将内容提交到github，需要配置jacpy目录下的_config.yml文件，在末尾找到deploy项，进行编辑：&lt;br&gt;&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;## Docs: http://hexo.io/docs/deployment.html&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deploy:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  type: git&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  repo: https://github.com/jacpy/jacpy.github.io.git&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  branch: master&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;修改域名解析&quot;&gt;&lt;a href=&quot;#修改域名解析&quot; class=&quot;headerlink&quot; title=&quot;修改域名解析&quot;&gt;&lt;/a&gt;修改域名解析&lt;/h2&gt;&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;这部分是自己耗时最多的地方，中间还遇到404问题，卡了很久。如果你自己有一个域名，想直接通过域名访问你的github上面的博客，形如访问jacpy.com时，会自动跳转到jacpy.github.io页面，但地址栏并没有改变，那么接着往下看。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;因为自己的域名是在万网上注册的，所以到万网上修改配置。为了避免做广告之嫌，推荐一下&lt;a href=&quot;https://www.godaddy.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;godady&lt;/a&gt; 可以对比一下性价比。万网现在已经被阿里收购了，所以网页风格都和阿里云保持一致了，访问[域名列表页面(&lt;a href=&quot;http://netcn.console.aliyun.com/core/domain/tclist&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://netcn.console.aliyun.com/core/domain/tclist&lt;/a&gt;) ，点击自己的域名会跳转到另外一个页面，我原来是将这个域名绑定到一个IP地址，所以看到的&lt;strong&gt;记录类型&lt;/strong&gt;是&lt;strong&gt;A&lt;/strong&gt;，点击右边的修改栏，将记录类型修改成&lt;strong&gt;CNAME&lt;/strong&gt;，如下图所示：&lt;br&gt;&lt;img src=&quot;https://github.com/jacpy/jacpy.github.io/raw/master/images/2015/08/29/domain_list.jpg&quot; alt=&quot;域名列表截图&quot;&gt;&lt;/p&gt;
&lt;p&gt;保存以后，如果现在访问你的域名jacpy.com，肯定会出现404，因为还要在master分支上创建一个CNAME文件。&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;出现404有两个原因，一个是你访问的是&lt;strong&gt;jacpy.github.com&lt;/strong&gt;而不是&lt;strong&gt;jacpy.github.io&lt;/strong&gt;，另外一个就是在master分支上没有CNAME文件。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;OK，在jacpy/source目录中创建一个CNAME文件，在里面在增加一行内容：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;jacpy.com&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后再重新生成HTML命令和提交到github。OK，到此已经全部完成了：)。&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;如果发现HTML中有乱码，将md文件转换成UTF-8编码即可。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;参考：&lt;br&gt;&lt;a href=&quot;http://wsgzao.github.io/post/hexo-guide/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://wsgzao.github.io/post/hexo-guide/&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://linux.cn/article-5930-qqmail.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://linux.cn/article-5930-qqmail.html&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://help.github.com/categories/github-pages-basics/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://help.github.com/categories/github-pages-basics/&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://hexo.io/zh-cn/docs/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://hexo.io/zh-cn/docs/&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要是介绍自己在github上搭建blog，把自己在wordpress中的博客迁移过来的过程，以及这过程中遇到的坑。&lt;/p&gt;
    
    </summary>
    
      <category term="github" scheme="http://www.jacpy.com/categories/github/"/>
    
    
      <category term="github hex blog" scheme="http://www.jacpy.com/tags/github-hex-blog/"/>
    
  </entry>
  
  <entry>
    <title>android SQLite性能优化（二）——使用NDK优化</title>
    <link href="http://www.jacpy.com/2015/06/24/android-sqlite-performance-optimization-used-ndk.html"/>
    <id>http://www.jacpy.com/2015/06/24/android-sqlite-performance-optimization-used-ndk.html</id>
    <published>2015-06-23T19:56:18.000Z</published>
    <updated>2016-03-12T08:06:14.000Z</updated>
    
    <content type="html">&lt;p&gt;在做android SQLite数据插入性能优化时，前面一篇&lt;a href=&quot;http://www.jacpy.com/?p=47&quot;&gt;android SQLite性能优化（一）——使用事务和预处理&lt;/a&gt;提到了使用事务和预处理做优化，本篇介绍使用NDK的方式进行数据插入优化。&lt;br&gt;使用NDK操作数据库时，需要使用sqlite的官方源码，我这里测试使用的是官方的3.8.7.4版本的代码。同样在使用sqlite操作数据库时使用了事务和预处理。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;下面是Java层的代码，主要是将List数据转换成数组数据，指定数据库文件路径，及数组数据和长度。&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;insertNative&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(List&amp;lt;DemoItem&amp;gt; data)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Log.d(TAG, &lt;span class=&quot;string&quot;&gt;&quot;databases path: &quot;&lt;/span&gt; + getCacheDir());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; size = data.size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DemoItem[] items = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; DemoItem[size];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    data.toArray(items);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    File file = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; File(getCacheDir(), &lt;span class=&quot;string&quot;&gt;&quot;tel.db&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; start = System.currentTimeMillis();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    TelTools.insertNative(file.getAbsolutePath(), items, items.length);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; end = System.currentTimeMillis();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Log.d(TAG, &lt;span class=&quot;string&quot;&gt;&quot;used time: &quot;&lt;/span&gt; + (end - start) + &lt;span class=&quot;string&quot;&gt;&quot;, nums: &quot;&lt;/span&gt; + items.length + &lt;span class=&quot;string&quot;&gt;&quot;, average item: &quot;&lt;/span&gt; + (end - start) / items.length);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 使用预处理&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// used time: 2372, nums: 65536, average item: 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// used time: 2422, nums: 65536, average item: 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt; 整个耗时2.4秒左右，是使用Java的方式耗时的一半都不到。下面是C代码，可以看出来，使用C代码操作数据库需要做很多事情，远没有Java来的方便；如果数据库结构发生修改，就更难维护了。&lt;br&gt;&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;JNIEXPORT jint JNICALL &lt;span class=&quot;title&quot;&gt;Java_com_example_sqlitedemo_TelTools_insertNative&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;params&quot;&gt;(JNIEnv *env, jclass jcls, jstring jdbPath, jobjectArray jarr, jint jlen)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (jlen &amp;lt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        LOGW(&lt;span class=&quot;string&quot;&gt;&quot;len must &amp;gt; 0&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* sdbPath = (*env)-&amp;gt;GetStringUTFChars(env, jdbPath, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sqlite3* db;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; result = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sqlite3_initialize( );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    result = sqlite3_open_v2(sdbPath, &amp;amp;db, SQLITE_OPEN_READWRITE|SQLITE_OPEN_CREATE, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (SQLITE_OK != result) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        LOGE(&lt;span class=&quot;string&quot;&gt;&quot;sqlite3_open failed, result: %d, error msg: %s&quot;&lt;/span&gt;, result, sqlite3_errmsg(db));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; result;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* createSQL = &lt;span class=&quot;string&quot;&gt;&quot;CREATE TABLE tel(_id INTEGER PRIMARY KEY, id TEXT, tel TEXT, code TEXT, address TEXT, type TEXT, date INTEGER)&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* pErrorMsg;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    result = sqlite3_exec(db, createSQL, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &amp;amp;pErrorMsg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (SQLITE_ERROR != result &amp;amp;&amp;amp; SQLITE_OK != result) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        LOGE(&lt;span class=&quot;string&quot;&gt;&quot;exec sql(%s) failed, result: %d, error msg: %s&quot;&lt;/span&gt;, createSQL, result, pErrorMsg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_free(pErrorMsg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_close(db);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; result;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jclass cItem = (*env)-&amp;gt;FindClass(env, &lt;span class=&quot;string&quot;&gt;&quot;com/example/sqlitedemo/mode/DemoItem&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jfieldID fID = (*env)-&amp;gt;GetFieldID(env, cItem, &lt;span class=&quot;string&quot;&gt;&quot;id&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Ljava/lang/String;&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jfieldID fTel = (*env)-&amp;gt;GetFieldID(env, cItem, &lt;span class=&quot;string&quot;&gt;&quot;tel&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Ljava/lang/String;&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jfieldID fCode = (*env)-&amp;gt;GetFieldID(env, cItem, &lt;span class=&quot;string&quot;&gt;&quot;code&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Ljava/lang/String;&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jfieldID fAddress = (*env)-&amp;gt;GetFieldID(env, cItem, &lt;span class=&quot;string&quot;&gt;&quot;address&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Ljava/lang/String;&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jfieldID fType = (*env)-&amp;gt;GetFieldID(env, cItem, &lt;span class=&quot;string&quot;&gt;&quot;type&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Ljava/lang/String;&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jfieldID fDate = (*env)-&amp;gt;GetFieldID(env, cItem, &lt;span class=&quot;string&quot;&gt;&quot;date&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;J&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//const int sqlLen = 512;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//char sql[sqlLen];&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* insertSQL = &lt;span class=&quot;string&quot;&gt;&quot;insert into tel(id, tel, code, address, type, date) values(?,?,?,?,?,?)&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* beginSQL = &lt;span class=&quot;string&quot;&gt;&quot;begin;&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* commitSQL = &lt;span class=&quot;string&quot;&gt;&quot;commit;&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* rollbackSQL = &lt;span class=&quot;string&quot;&gt;&quot;rollback;&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sqlite3_exec(db, beginSQL, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//string sql;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; isSuccess = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jobject obj;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jstring sId, sTel, sCode, sAddress, sType;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sqlite3_stmt *stmt = &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sqlite3_prepare_v2(db, insertSQL, &lt;span class=&quot;built_in&quot;&gt;strlen&lt;/span&gt;(insertSQL) * &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &amp;amp;stmt, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; jlen; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        obj = (*env)-&amp;gt;GetObjectArrayElement(env, jarr, i);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sId = (jstring) ((*env)-&amp;gt;GetObjectField(env, obj, fID));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* id = (*env)-&amp;gt;GetStringUTFChars(env, sId, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sTel = (jstring) ((*env)-&amp;gt;GetObjectField(env, obj, fTel));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* tel = (*env)-&amp;gt;GetStringUTFChars(env, sTel, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sCode = (jstring) ((*env)-&amp;gt;GetObjectField(env, obj, fCode));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* code = (*env)-&amp;gt;GetStringUTFChars(env, sCode, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sAddress = (jstring) ((*env)-&amp;gt;GetObjectField(env, obj, fAddress));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* address = (*env)-&amp;gt;GetStringUTFChars(env, sAddress, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sType = (jstring) ((*env)-&amp;gt;GetObjectField(env, obj, fType));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* type = (*env)-&amp;gt;GetStringUTFChars(env, sType, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;DeleteLocalRef(env, obj);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//jstring sDate = (jstring) (env-&amp;gt;GetObjectField(obj, fTel));&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//const char* tel = env-&amp;gt;GetStringUTFChars(sTel, NULL);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_bind_text(stmt, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, id, &lt;span class=&quot;built_in&quot;&gt;strlen&lt;/span&gt;(id), &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_bind_text(stmt, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, tel, &lt;span class=&quot;built_in&quot;&gt;strlen&lt;/span&gt;(tel), &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_bind_text(stmt, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, code, &lt;span class=&quot;built_in&quot;&gt;strlen&lt;/span&gt;(code), &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_bind_text(stmt, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;, address, &lt;span class=&quot;built_in&quot;&gt;strlen&lt;/span&gt;(address), &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_bind_text(stmt, &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;, type, &lt;span class=&quot;built_in&quot;&gt;strlen&lt;/span&gt;(type), &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_bind_text(stmt, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;10000000&quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_step(stmt);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_reset(stmt);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_clear_bindings(stmt);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//LOGD(&quot;sql: %s&quot;, sql.c_str());&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//result = sqlite3_exec(db, sql, NULL, NULL, &amp;amp;pErrorMsg);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//sql.clear();&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;ReleaseStringUTFChars(env, sId, id);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;ReleaseStringUTFChars(env, sTel, tel);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;ReleaseStringUTFChars(env, sCode, code);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;ReleaseStringUTFChars(env, sAddress, address);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;ReleaseStringUTFChars(env, sType, type);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;DeleteLocalRef(env, sId);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;DeleteLocalRef(env, sTel);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;DeleteLocalRef(env, sCode);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;DeleteLocalRef(env, sAddress);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (*env)-&amp;gt;DeleteLocalRef(env, sType);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//        isSuccess = result == 0;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//        if (!isSuccess) &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//            break;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//        &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isSuccess) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_exec(db, commitSQL, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sqlite3_exec(db, rollbackSQL, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (*env)-&amp;gt;ReleaseStringUTFChars(env, jdbPath, sdbPath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (*env)-&amp;gt;DeleteLocalRef(env, jdbPath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sqlite3_free(pErrorMsg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sqlite3_finalize(stmt);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sqlite3_close(db);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sqlite3_shutdown();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; result;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;So，到这一步就没能再进行优化下去了，上面测试的表结构没有加索引，加了会影响性能，但可以提高查询效率。其中要注意语言细节性能问题，因为循环有几万次，所以很小的细节都会被放大。网上还有论文优化了sqlite的查询性能，单次性能提升了10%，目测是修改了sqlite中虚拟机产生代码的处理流程，恕水平有限，没有耗更多的精力和时间在这上面，到此就结束了，如果读者感兴趣，可以接着优化。google搜索关键字《SQLite的SQL语句高速缓存技术》即可找到这篇论文。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;在做android SQLite数据插入性能优化时，前面一篇&lt;a href=&quot;http://www.jacpy.com/?p=47&quot;&gt;android SQLite性能优化（一）——使用事务和预处理&lt;/a&gt;提到了使用事务和预处理做优化，本篇介绍使用NDK的方式进行数据插入优化。&lt;br&gt;使用NDK操作数据库时，需要使用sqlite的官方源码，我这里测试使用的是官方的3.8.7.4版本的代码。同样在使用sqlite操作数据库时使用了事务和预处理。&lt;/p&gt;
    
    </summary>
    
      <category term="sqlite" scheme="http://www.jacpy.com/categories/sqlite/"/>
    
    
      <category term="SQLite性能优化" scheme="http://www.jacpy.com/tags/SQLite%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>android SQLite性能优化（一）——使用事务和预处理</title>
    <link href="http://www.jacpy.com/2015/06/24/android-sqlite-performance-optimization-used-transaction-and-sql-compile.html"/>
    <id>http://www.jacpy.com/2015/06/24/android-sqlite-performance-optimization-used-transaction-and-sql-compile.html</id>
    <published>2015-06-23T19:44:11.000Z</published>
    <updated>2016-03-12T08:06:51.000Z</updated>
    
    <content type="html">&lt;p&gt;老大交给了一个任务，其他项目组在应用初始化时，需要从服务器下载通讯录，然后插入到本地数据，由于数据量比较大，整个插入过程非常耗时，看我能不能优化一下。于是就有了下文。&lt;/p&gt;
&lt;p&gt;SQL执行性能影响从根本原因上不外乎以下几种情况：&lt;/p&gt;
&lt;p&gt;1.CPU执行时间；&lt;/p&gt;
&lt;p&gt;2.存储器读写时间；&lt;/p&gt;
&lt;p&gt;3.网络传输消耗。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;第1点针对CPU可以做的优化有使用预处理，防止CPU多次解析SQL语句；第2点针对存储器读写时间的优化有使用事务，将数据写全部写入到内容，然后一次性写入到本地存储空间，当然这需要足够的内存空间，否则会导致内存溢出，这个问题在android开发尤其重要，不然App会退出运行。第3点在android开发中基本用不到，所以只针对前面两点考虑优化。&lt;/p&gt;
&lt;p&gt;下面是优化的案例，数据是从网上下载的号码归属地XLS数据，总共65535行数据，老大说通讯录的数据也有几万条，正好可以用这个数据做测试，只不过XLS数据每行数据差别不大，很有规律，通过跟真实数据测试发现，差别不大。&lt;/p&gt;
&lt;p&gt;按照上面的思路，基本告别android.content.ContentValues类，得自己拼接SQL，再使用SQLiteDatabse.execSQL()执行预处理。&lt;/p&gt;
&lt;p&gt;下面代码是表结构（没有从代码中整理成表格，大概能知道有几个字段及字段的类型）：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;db.execSQL(“CREATE TABLE “ + TelColumns.TABLE_NAME + “ (“&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    + TelColumns._ID + “ INTEGER PRIMARY KEY,“&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    + TelColumns.ID + “ TEXT,“&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    + TelColumns.TEL + “ TEXT,“&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    + TelColumns.CODE + “ TEXT,“&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    + TelColumns.ADDRESS + “ TEXT,“&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    + TelColumns.TYPE + “ TEXT,“&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    + TelColumns.DATE + “ INTEGER“&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    + “);“);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;TelColumns&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BaseColumns&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String TABLE_NAME = “tel“;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String ID = “id“;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String TEL = “tel“;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String CODE = “code“;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String TYPE = “name“;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String ADDRESS = “depart“;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String DATE = “date“;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;下面代码使用了事务和和预处理的SQL，data数据来源于对XLS数据的解析。在开始执行事务时开始记时，完成后关闭数据库记时结束。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;insertByRaw&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(List&amp;amp;lt;DemoItem&amp;amp;gt; data)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; size = data.size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; idx = size;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	TelDatabase db = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; TelDatabase(getApplicationContext());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	SQLiteDatabase sqliteDB = db.getWritableDatabase();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; start = System.currentTimeMillis();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	sqliteDB.beginTransaction(); &lt;span class=&quot;comment&quot;&gt;// 事务开始&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	DemoItem item = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	StringBuilder sb = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; StringBuilder();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	sb.append(“INSERT INTO “).append(TelColumns.TABLE_NAME)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	.append(“(“)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	.append(TelColumns.ID).append(“,“)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	.append(TelColumns.TEL).append(“,“)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	.append(TelColumns.CODE).append(“,“)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	.append(TelColumns.ADDRESS).append(“,“)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	.append(TelColumns.TYPE).append(“,“)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	.append(TelColumns.DATE)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	.append(“)“)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	.append(“ VALUES(?,?,?,?,?,?)“); &lt;span class=&quot;comment&quot;&gt;// 预处理SQL&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	String sql = sb.toString();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	SQLiteStatement stmt = sqliteDB.compileStatement(sql);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;amp;lt; idx; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			item = data.get(i);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			stmt.bindString(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, item.id);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			stmt.bindString(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, item.tel);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			stmt.bindString(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;, item.code);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			stmt.bindString(&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;, item.address);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			stmt.bindString(&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;, item.type);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			stmt.bindLong(&lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;, System.currentTimeMillis());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			stmt.execute();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		sqliteDB.setTransactionSuccessful();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		sqliteDB.endTransaction();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		stmt.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; end = System.currentTimeMillis();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	sqliteDB.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Log.d(TAG, “used time: “ + (end - start) + “, nums: “ + idx + “, average item: “ + (end - start) / size);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// used time: 5616, nums: 65536, average item: 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// used time: 5720, nums: 65536, average item: 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// used time: 5615, nums: 65536, average item: 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面代码在我的MOTO G XT1032手机上测试，耗时在5.6秒上下波动，上面注释的used time代码即为实际运行时间的随机值。数据插入完成后整个数据库文件有4.48M。&lt;/p&gt;
&lt;p&gt;后面用android.content.ContentValues类和SQLiteDatabase.insert()方法，同样加了事务测试了一下，运行耗时在17秒左右。很明显，慢了很多。&lt;/p&gt;
&lt;p&gt;So，测试到这儿任务结束了吗？前面的优化方法估计一般开发都能做到，那还有没有优化的空间？如果要体现自己的优势，那么就要寻找耗时更短的优化方式。后面还有性能提升的空间，请看下一篇&lt;a href=&quot;http://www.jacpy.com/?p=53&quot;&gt;android SQLite性能优化（二）——使用NDK优化&lt;/a&gt;。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;老大交给了一个任务，其他项目组在应用初始化时，需要从服务器下载通讯录，然后插入到本地数据，由于数据量比较大，整个插入过程非常耗时，看我能不能优化一下。于是就有了下文。&lt;/p&gt;
&lt;p&gt;SQL执行性能影响从根本原因上不外乎以下几种情况：&lt;/p&gt;
&lt;p&gt;1.CPU执行时间；&lt;/p&gt;
&lt;p&gt;2.存储器读写时间；&lt;/p&gt;
&lt;p&gt;3.网络传输消耗。&lt;/p&gt;
    
    </summary>
    
      <category term="sqlite" scheme="http://www.jacpy.com/categories/sqlite/"/>
    
    
      <category term="SQLite性能优化" scheme="http://www.jacpy.com/tags/SQLite%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>NDK编译时报错：make.exe: *** No rule to make target `jni/jni/apk_loader.cpp&#39;, needed by `obj/local/armeabi-v7a/objs/jni/apk_loader.o&#39;.  Stop.解决方法</title>
    <link href="http://www.jacpy.com/2015/06/05/ndk-compile-error-make-exe-no-rule-to-make-target-jnijniapk-loader-cpp-needed-by-objlocalarmeabi-v7aobjsjniapk-loader-o-stop-resolved.html"/>
    <id>http://www.jacpy.com/2015/06/05/ndk-compile-error-make-exe-no-rule-to-make-target-jnijniapk-loader-cpp-needed-by-objlocalarmeabi-v7aobjsjniapk-loader-o-stop-resolved.html</id>
    <published>2015-06-04T16:38:19.000Z</published>
    <updated>2015-10-30T15:47:54.000Z</updated>
    
    <content type="html">&lt;p&gt;在使用NDK编译代码时，如果出现如下错误：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;make.exe: *** No rule to make target `jni/jni/apk_loader.cpp&lt;span class=&quot;string&quot;&gt;&#39;, needed by `obj/local/armeabi-v7a/objs/hook50/jni/apk_loader.o&#39;&lt;/span&gt;.  Stop.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;很有可能是被编译的apk_loader.cpp在LOCAL_SRC_FILES变量中的路径有问题或者文件名不正确，仔细检查即可解决。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;在使用NDK编译代码时，如果出现如下错误：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;make.exe: *** No rule to make target `jni/jni/apk_loader.cpp&lt;span class=&quot;string&quot;&gt;&#39;, needed by `obj/local/armeabi-v7a/objs/hook50/jni/apk_loader.o&#39;&lt;/span&gt;.  Stop.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ndk" scheme="http://www.jacpy.com/categories/ndk/"/>
    
    
  </entry>
  
  <entry>
    <title>NDK使用zlib mini压缩报错：Zip: EOCD not found, dex is not zip</title>
    <link href="http://www.jacpy.com/2015/05/26/ndk-used-zlib-mini-compress-occur-zip-eocd-not-found-dex-is-not-zip.html"/>
    <id>http://www.jacpy.com/2015/05/26/ndk-used-zlib-mini-compress-occur-zip-eocd-not-found-dex-is-not-zip.html</id>
    <published>2015-05-25T23:46:01.000Z</published>
    <updated>2015-10-30T15:43:32.000Z</updated>
    
    <content type="html">&lt;p&gt;最近在对Dex文件在内存中解密后压缩成zip文件写到本地供DVM加载时出现了Zip: EOCD not found, *.dex is not zip异常，折腾了好几个小时，终于解决了。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;按照DVM的错误提示找到了系统源码出错的地方，在dalvik/libdex/ZipArchive.cpp文件mapCentralDirectory0(int fd, const char* debugFileName, ZipArchive* pArchive, off_t fileLength, size_t readAmount, u1* scanBuf)函数中。在解析ZIP文件时，因为缺少 EOCD(&lt;strong&gt;E&lt;/strong&gt;nd &lt;strong&gt;O&lt;/strong&gt;f &lt;strong&gt;C&lt;/strong&gt;entral &lt;strong&gt;D&lt;/strong&gt;irectory)段的内容，即没有找到50 4b 05 06这样的魔数内容，导致entry数量和目录大小及偏移地址等重要数据不能解析，所以DVM提示解析失败，这个段内容是在ZIP文件的末尾部分，所以只需要补上去就OK。对照自己使用ZIP mini写的压缩出来的文件，发现没有EOCD段，但是使用RAR解压却没有问题，纠结了好长时间，于是乎到zlib中全局搜索EOCD关键字，在zlib/src/contrib/minizip/zip.c文件中的找到了ENDHEADERMAGIC宏定义，使用是在Write_EndOfCentralDirectoryRecord(zip64_internal* zi, uLong size_centraldir, ZPOS64_T centraldir_pos_inzip)函数中使用，被&lt;strong&gt;zipClose&lt;/strong&gt; (zipFile file, const char* global_comment)函数调用。原来是自己写的压缩代码中没有调用zipClose函数，补上就OK了。&lt;/p&gt;
&lt;p&gt;在google上搜索发现很多人也出现类似的问题，很大一部分原因是apk文件被破坏，极有可能是文件在传输过程中没有传输完整，比如USB传输中断，网络传输中断导致文件 EOCD段缺失（因为这部分内容在文件的末尾）。也发现网上的有些代码中有坑，需谨慎使用，谨记。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;最近在对Dex文件在内存中解密后压缩成zip文件写到本地供DVM加载时出现了Zip: EOCD not found, *.dex is not zip异常，折腾了好几个小时，终于解决了。&lt;/p&gt;
    
    </summary>
    
      <category term="ndk" scheme="http://www.jacpy.com/categories/ndk/"/>
    
    
      <category term="EOCD" scheme="http://www.jacpy.com/tags/EOCD/"/>
    
      <category term="zlib压缩" scheme="http://www.jacpy.com/tags/zlib%E5%8E%8B%E7%BC%A9/"/>
    
  </entry>
  
  <entry>
    <title>NDK编译ART代码出现错误：art/runtime/atomic.h:21:18: fatal error: atomic: No such file or directory</title>
    <link href="http://www.jacpy.com/2015/05/26/ndk-compile-art-occur-artruntimeatomic-h2118-fatal-error-atomic-no-such-file-or-directory.html"/>
    <id>http://www.jacpy.com/2015/05/26/ndk-compile-art-occur-artruntimeatomic-h2118-fatal-error-atomic-no-such-file-or-directory.html</id>
    <published>2015-05-25T17:43:27.000Z</published>
    <updated>2015-10-30T15:51:10.000Z</updated>
    
    <content type="html">&lt;p&gt;今天使用NDK编译ART代码时出现了这样的错：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;**art/runtime/atomic.h:21:18: fatal error: atomic: No such file or directory**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;** #include &amp;lt;atomic&amp;gt;**&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;stackoverflow上有人说把Application.mk文件中的APP_STL := stlport_shared换成stlport_static就行了，试了一下，发现编译还是出现同样的错。&lt;strong&gt;最后换成gnustl_shared或者gnustl_static就OK了&lt;/strong&gt;，莫非gnustl比stlport支持的功能多？不得而知，而且还有一种很让人很费解的问题：使用android4.4版本的ART的代码编译通过，而使用android5.0版本的ART的代码编译就会提示上面的错误，atomic.h文件内容都一样，mk文件中只有使用的SO库不一样，一个是4.4系统上面的libart.so，一个是5.0系统上面的libart.so，其他环境都是一样。唉，水平有限，解释不了。&lt;/p&gt;
&lt;p&gt;知乎上解释stlport与gnustl两者的不同：&lt;a href=&quot;http://www.zhihu.com/question/20845153&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.zhihu.com/question/20845153&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;今天使用NDK编译ART代码时出现了这样的错：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;**art/runtime/atomic.h:21:18: fatal error: atomic: No such file or directory**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;** #include &amp;lt;atomic&amp;gt;**&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="ndk" scheme="http://www.jacpy.com/categories/ndk/"/>
    
    
      <category term="gnustl" scheme="http://www.jacpy.com/tags/gnustl/"/>
    
      <category term="stlport" scheme="http://www.jacpy.com/tags/stlport/"/>
    
  </entry>
  
  <entry>
    <title>android 4.4系统调用Class.getTypeParameters()出现JNI function NewGlobalRef called with exception pending错误</title>
    <link href="http://www.jacpy.com/2015/05/10/android-4-4-call-class-gettypeparameters-occur-jni-function-newglobalref-called-with-exception-pending.html"/>
    <id>http://www.jacpy.com/2015/05/10/android-4-4-call-class-gettypeparameters-occur-jni-function-newglobalref-called-with-exception-pending.html</id>
    <published>2015-05-10T15:35:49.000Z</published>
    <updated>2015-10-30T15:48:50.000Z</updated>
    
    <content type="html">&lt;p&gt;先看一下异常信息：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;JNI WARNING: JNI function NewGlobalRef called with exception pending&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;in Ljava/lang/Class;.getDex:()Lcom/android/dex/Dex; (NewGlobalRef)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Pending exception is:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java.lang.IndexOutOfBoundsException: index=0, limit=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at java.nio.Buffer.checkIndex(Buffer.java:156)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at java.nio.DirectByteBuffer.get(DirectByteBuffer.java:157)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at com.android.dex.Dex.create(Dex.java:129)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at java.lang.Class.getDex(Native Method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at libcore.reflect.AnnotationAccess.getSignature(AnnotationAccess.java:447)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at java.lang.Class.getTypeParameters(Class.java:1070)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;05-11 15:14:28.285: I/dalvikvm(8083): at android.app.Activity.performCreate(Activity.java:5248)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1110)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2162)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2257)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.app.ActivityThread.access$800(ActivityThread.java:139)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1210)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.os.Handler.dispatchMessage(Handler.java:102)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.os.Looper.loop(Looper.java:136)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at android.app.ActivityThread.main(ActivityThread.java:5086)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at java.lang.reflect.Method.invokeNative(Native Method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at java.lang.reflect.Method.invoke(Method.java:515)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:785)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:601)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at dalvik.system.NativeStart.main(Native Method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&quot;main&quot; prio=5 tid=1 NATIVE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| group=&quot;main&quot; sCount=0 dsCount=0 obj=0x416b6e40 self=0x415d8500&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| sysTid=8083 nice=0 sched=0/0 cgrp=apps handle=1074389332&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| state=R schedstat=( 0 0 0 ) utm=13 stm=4 core=3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#00 pc 0000132e /system/lib/libcorkscrew.so (unwind_backtrace_thread+29)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#01 pc 000635ba /system/lib/libdvm.so (dvmDumpNativeStack(DebugOutputTarget const*, int)+33)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#02 pc 00057590 /system/lib/libdvm.so (dvmDumpThreadEx(DebugOutputTarget const*, Thread*, bool)+395)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#03 pc 000575fe /system/lib/libdvm.so (dvmDumpThread(Thread*, bool)+25)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#04 pc 0003b554 /system/lib/libdvm.so&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#05 pc 00043f2c /system/lib/libdvm.so&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#06 pc 0006a4ea /system/lib/libdvm.so (Java_java_lang_Class_getDex(_JNIEnv*, _jclass*)+141)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#07 pc 000203cc /system/lib/libdvm.so (dvmPlatformInvoke+112)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#08 pc 00050eea /system/lib/libdvm.so (dvmCallJNIMethod(unsigned int const*, JValue*, Method const*, Thread*)+397)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#09 pc 00029860 /system/lib/libdvm.so&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#10 pc 00030b68 /system/lib/libdvm.so (dvmMterpStd(Thread*)+76)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#11 pc 0002e200 /system/lib/libdvm.so (dvmInterpret(Thread*, Method const*, JValue*)+184)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#12 pc 000637cc /system/lib/libdvm.so (dvmInvokeMethod(Object*, Method const*, ArrayObject*, ArrayObject*, ClassObject*, bool)+391)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#13 pc 0006b6aa /system/lib/libdvm.so&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#14 pc 00029860 /system/lib/libdvm.so&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#15 pc 00030b68 /system/lib/libdvm.so (dvmMterpStd(Thread*)+76)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#16 pc 0002e200 /system/lib/libdvm.so (dvmInterpret(Thread*, Method const*, JValue*)+184)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#17 pc 000634e8 /system/lib/libdvm.so (dvmCallMethodV(Thread*, Method const*, Object*, bool, JValue*, std::__va_list)+335)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#18 pc 0004cab6 /system/lib/libdvm.so&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#19 pc 0004d5c0 /system/lib/libandroid_runtime.so&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#20 pc 0004e2e6 /system/lib/libandroid_runtime.so (android::AndroidRuntime::start(char const*, char const*)+353)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#21 pc 0000105a /system/bin/app_process&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#22 pc 0000e510 /system/lib/libc.so (__libc_init+47)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;很明显，是因为应用调用了 java.lang.Class.getTypeParameters()方法导致的问题，这个方法是用来获取泛型数量，在GSON或fastjson这样的第三方JSON反射框架中会出现这样的调用，出现这样的问题也正是使用这样的类库出现的。为什么只会在android4.4系统中出现这样的兼容性问题，而其他版本没有？从堆栈错误信息中可以看出来，在Java层最后调用的一个方法是Class.getDex()，这个是个native方法，只在C++代码中实现，而android其他版本却没有这个方法。查看dalvik/vm/native/java_lang_Class.cpp中的JNIEXPORT jobject JNICALL Java_java_lang_Class_getDex(JNIEnv* env, jclass javaClass)函数发现，在NDK中new一个Dex对象，而在这个对象时传的参数为空，导致在java层通过下标访问时出现了java.lang.IndexOutOfBoundsException异常，这也解释了为什么会出现NewGlobalRef pending exception。最后在源码中插入LOG，编译验证了一下，证明确实是这样。&lt;/p&gt;
&lt;p&gt;OK，问题产生的原因找到了，怎么解决呢？&lt;/p&gt;
&lt;p&gt;应用加载DEX文件时，调用了4.4新增了static void Dalvik_dalvik_system_DexFile_openDexFile_bytearray(const u4&lt;em&gt; args, JValue&lt;/em&gt; pResult)函数，直接将一个DEX文件的字节流传入，虚拟机自动解析并加载类相关信息。虽然这个函数是static，但因为使用到了NDK注册的方式，将Java层的方法与C++层对应的函数绑定到了一起，这样就可以使用指针遍历dvm_dalvik_system_DexFile数组找到对应的函数指针，从而可以调用。而在Java层的DexFile类中没有找到与之对应的int openDexFile(byte)方法，估计是被删了，而这个函数又没有被google官方验证，所以种种巧合，掉进了这个坑。唉，不说了，都是泪啊。&lt;/p&gt;
&lt;p&gt;最后问题还是解决了，根本原因是RawDexFile-&amp;gt;pDvmDex-&amp;gt;memMap指针为空，分配内存赋值就O了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;先看一下异常信息：&lt;/p&gt;
    
    </summary>
    
      <category term="dvm" scheme="http://www.jacpy.com/categories/dvm/"/>
    
    
  </entry>
  
  <entry>
    <title>NDK C++11编译DVM代码报错：external/safe-iop/include/safe_iop.h:80:14: error: &#39;typeof&#39; was not declared in this scope</title>
    <link href="http://www.jacpy.com/2015/05/10/ndk-used-cpp11-compile-dvm-occur-externalsafe-iopincludesafe-iop-h8014-error-typeof-was-not-declared-in-this-scope.html"/>
    <id>http://www.jacpy.com/2015/05/10/ndk-used-cpp11-compile-dvm-occur-externalsafe-iopincludesafe-iop-h8014-error-typeof-was-not-declared-in-this-scope.html</id>
    <published>2015-05-10T14:44:54.000Z</published>
    <updated>2015-10-30T15:49:18.000Z</updated>
    
    <content type="html">&lt;p&gt;今天在使用NDK C++11编译androidDVM代码时，报了如下的错：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;external/safe-iop/include/safe_iop.h:&lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;14&lt;/span&gt;: error: &lt;span class=&quot;string&quot;&gt;&#39;typeof&#39;&lt;/span&gt; was not declared in &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt; scope&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;原因是GCC编译器在C++11时已经不推荐使用typeof关键字了，可以使用&lt;strong&gt;typeof&lt;/strong&gt;替换即可。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;今天在使用NDK C++11编译androidDVM代码时，报了如下的错：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;external/safe-iop/include/safe_iop.h:&lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;14&lt;/span&gt;: error: &lt;span class=&quot;string&quot;&gt;&#39;typeof&#39;&lt;/span&gt; was not declared in &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt; scope&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="ndk" scheme="http://www.jacpy.com/categories/ndk/"/>
    
    
  </entry>
  
  <entry>
    <title>写在最前面</title>
    <link href="http://www.jacpy.com/2015/04/27/write-before.html"/>
    <id>http://www.jacpy.com/2015/04/27/write-before.html</id>
    <published>2015-04-27T13:07:55.000Z</published>
    <updated>2015-10-30T15:32:16.000Z</updated>
    
    <content type="html">&lt;p&gt;这一刻准备了好久，今天终于成为了现实。&lt;/p&gt;
&lt;p&gt;一直打算自己建一个博客，写点东西放在上面，由于各种原因未能实现，前些日子忙完了，今天正式开通了。主要打算将自己遇到的问题、解决的方案整理成博客分享出来，一来可以锻炼自己的表达能力，二来给别人提供一些参考。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;希望自己以后能坚持写下去，分享一些技术干货，别人写过的、重复的不会放上来，保证博客原创、有价值，每篇都是精品。希望能借博客结识更多的志同道合的伙伴，将这条路一直走下去。&lt;/p&gt;
&lt;p&gt;毕竟已经工作快五年，得记录点什么东西，展示一下自己吧。若干年后，再回过来看看自己当年的幼稚和无知，也何尝不是一种乐趣。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这一刻准备了好久，今天终于成为了现实。&lt;/p&gt;
&lt;p&gt;一直打算自己建一个博客，写点东西放在上面，由于各种原因未能实现，前些日子忙完了，今天正式开通了。主要打算将自己遇到的问题、解决的方案整理成博客分享出来，一来可以锻炼自己的表达能力，二来给别人提供一些参考。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
  </entry>
  
</feed>
