<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jacpy&#39;s blog</title>
  <subtitle>enjoy mobile development</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.jacpy.com/"/>
  <updated>2017-02-20T01:39:40.000Z</updated>
  <id>http://www.jacpy.com/</id>
  
  <author>
    <name>jacpy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>golang抓取html转换成pdf</title>
    <link href="http://www.jacpy.com/2017/02/19/go-html-to-pdf.html"/>
    <id>http://www.jacpy.com/2017/02/19/go-html-to-pdf.html</id>
    <published>2017-02-19T14:39:21.000Z</published>
    <updated>2017-02-20T01:39:40.000Z</updated>
    
    <content type="html">&lt;p&gt;总结一下学习十来天go语言的成果，看了一遍语法之后，写了一个抓取HTML然后转换成PDF文件的程序，分享一下，代码点&lt;a href=&quot;https://github.com/jacpy/GoDemo/blob/master/html2pdf/html2pdf.go&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;。代码在目前go的1.7.5版本和1.8版本上运行没有问题，据说go向下兼容，而不像swift。但发现有些比较老的资料上的代码，在新的go版本上看不到效果，比如打印地址&lt;code&gt;%p&lt;/code&gt;，在新版本中必须得使用&lt;code&gt;unsafe.Pointer(p)&lt;/code&gt;转换一下，否则格式化输出指针变量不会打印出内存地址。&lt;/p&gt;
&lt;p&gt;其中使用了两个第三方库：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;html操作使用了&lt;a href=&quot;https://github.com/PuerkitoBio/goquery&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;goquery&lt;/a&gt;的第三方库，对html操作很方便；&lt;/li&gt;
&lt;li&gt;html转PDF使用了&lt;a href=&quot;http://wkhtmltopdf.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;wkhtmltopdf&lt;/a&gt;库，到官方网站上选择相应的平台下载安装，然后在go语言中执行相应的命令即可。使用说明点&lt;a href=&quot;http://wkhtmltopdf.org/usage/wkhtmltopdf.txt&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另外还有一个去水印的功能，想具体了解请参考代码。&lt;/p&gt;
&lt;p&gt;通过这个功能的练手，发现go语言还是相关操作都很方便。比如文件读写：不像java那样，不同的流嵌套，然后就是try-catch。go里面写起来，相比而言简单好多。goquery这个库操作HTML很方便，唯一感觉不好用的地方是修改HTML标签的属性值，没有找到类似这种&lt;code&gt;p.Find(&amp;quot;div.Part div a img&amp;quot;).RemoveAttr(&amp;quot;alt&amp;quot;)&lt;/code&gt;好用的函数。&lt;/p&gt;
&lt;p&gt;后面希望能更深入的了解go语言。&lt;/p&gt;
&lt;p&gt;附已经转换OK的PDF的下载地址：&lt;a href=&quot;https://github.com/jacpy/GoDemo/blob/master/html2pdf/TCP:IP%E8%AF%A6%E8%A7%A3%20%E5%8D%B71%EF%BC%9A%E5%8D%8F%E8%AE%AE.pdf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;TCP:IP详解 卷1：协议.pdf&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;总结一下学习十来天go语言的成果，看了一遍语法之后，写了一个抓取HTML然后转换成PDF文件的程序，分享一下，代码点&lt;a href=&quot;https://github.com/jacpy/GoDemo/blob/master/html2pdf/html2pdf.go&quot;&gt;这里&lt;/a&gt;。代码在目前go的1.7.5版本和1.8版本上运行没有问题，据说go向下兼容，而不像swift。但发现有些比较老的资料上的代码，在新的go版本上看不到效果，比如打印地址&lt;code&gt;%p&lt;/code&gt;，在新版本中必须得使用&lt;code&gt;unsafe.Pointer(p)&lt;/code&gt;转换一下，否则格式化输出指针变量不会打印出内存地址。&lt;/p&gt;
&lt;p&gt;其中使用了两个第三方库：&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://www.jacpy.com/categories/go/"/>
    
    
      <category term="go html to pdf" scheme="http://www.jacpy.com/tags/go-html-to-pdf/"/>
    
  </entry>
  
  <entry>
    <title>android集成华为推送总结</title>
    <link href="http://www.jacpy.com/2017/01/20/huawei-push-summary.html"/>
    <id>http://www.jacpy.com/2017/01/20/huawei-push-summary.html</id>
    <published>2017-01-20T08:01:07.000Z</published>
    <updated>2017-01-22T03:15:21.000Z</updated>
    
    <content type="html">&lt;p&gt;前段时间在应用中集成了华为推送，现在终于告一段落了，回首起来，发现一路踩的坑，都是泪啊。&lt;/p&gt;
&lt;p&gt;先交待下集成华为推送的背景：由于android手机上的google官方的推送GCM在中国大陆基本是残废，而大陆有些手机厂商可能会干掉这部分，造成GCM推送基本不可用。而像小米、华为等手机厂商对android系统的ROM进行了深度定制，用户可以手机桌面直接将应用程序kill，即使有后台服务，都被会一起干掉，同时android新的版本为了改善手机续行，在6.0开始增加了Doze机制，无疑对推送又是一大打击。综合这些因素，决定选几种推送一起集成进来，其中就有针对华为手机的华为推送。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;去华为开发者官网发现，华为推送有两种，不细心还真发现不了。一种是已经明确标识的&lt;code&gt;PUSH服务&lt;/code&gt;，另一种是&lt;code&gt;华为移动服务（HMS）&lt;/code&gt;。&lt;code&gt;PUSH服务&lt;/code&gt;仅是提供推送服务，所以一般推送使用这种。如果华为手机没有打开&lt;code&gt;应用自启动&lt;/code&gt;也可以使用这种推送，但使用这种推送如果推送多条消息，会在通知栏显示多条通知，不会自动合并成一条，如果是用在IM中作为消息推送，N条消息一过来，用户体验可想而知。而相反，小米的推送就好很多，通知栏通知会自动合并，只显示一条。另外&lt;code&gt;HMS&lt;/code&gt;中不仅集成了推送，还包括支付等服务，使用&lt;code&gt;HMS&lt;/code&gt;中的推送可以自定义消息通知栏，还可以自定义数据格式，官方称这种方式为透传。&lt;code&gt;PUSH服务&lt;/code&gt;只能是系统弹出通知栏，应用没有控制权限，也不能额外的再传递数据，所以使用&lt;code&gt;HMS&lt;/code&gt;自定义通知栏通知可以解决通知栏弹出N多通知的问题。&lt;code&gt;PUSH服务&lt;/code&gt;与&lt;code&gt;HMS&lt;/code&gt;在华为手机上相比，前者的通用性更强些。目前在几台华为手机上测试发现，&lt;code&gt;PUSH服务&lt;/code&gt;都能注册成功，而&lt;code&gt;HMS&lt;/code&gt;在有些手机上不能注册成功，需要打开应用的&lt;code&gt;应用自启动&lt;/code&gt;开关，甚至有的手机上根本注册不成功，不管怎么折腾。&lt;/p&gt;
&lt;p&gt;那么想要好的推送效果，又想要好的推送体验，唯一解决办法是两种都集成，先通过&lt;code&gt;HMS&lt;/code&gt;注册，如果注册不成功，则使用使用&lt;code&gt;PUSH服务&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;写这篇记录的时候去官网看了一下，官方已经将&lt;code&gt;PUSH服务&lt;/code&gt;与&lt;code&gt;HMS&lt;/code&gt;中的推送合并，下图是官方的文档说明：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/01/22/hw_push_merge.png&quot; alt=&quot;PUSH服务与HMS推送合并&quot;&gt;&lt;/p&gt;
&lt;p&gt;另外还有一些坑：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;1.华为联盟后台的账号登录后会在浏览器缓存cookie，如果切换账号，发现后台的信息还是上一个账号的，需要清除浏览器cookie缓存才OK。这是同事在使用公司的账号和个人的账号测试时发现的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;2.如果在推送中已经填写了Debug Key的SHA256证书指纹，再改成Release Key的指纹时，发现手机一直获取不到token，解决办法是把手机中相关华为的服务的应用缓存清除掉，特别是华为移动服务。如果还是不行，把华为商城应用升级到最新版本。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;添加指纹的位置：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://developer.huawei.com/consumer/cn/wiki/images/3/3b/x04.HMS,PE5,PBC,P80,PE5,P8F,P91,PE6,P8C,P87,PE5,PAF,PBC,PE4,PB9,PA6-PUSH,PE6,P9C,P8D,PE5,P8A,PA1,PE6,P8E,PA5,PE5,P8F,PA3-,PE7,P8E,PB0,PE6,P9C,P89,PE4,PB8,P9A,PE5,P8A,PA1,PE8,PBF,P81,PE7,PA7,PBB.png.pagespeed.ic.AU0p7gImxO.webp&quot; alt=&quot;华为联盟后台推送添加SHA256指纹的官网截图&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;3.如果一直能正常获取到token，突然又不能，解决办法是重启手机再试。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;4.如果注册成功，发现收到消息，首先排查服务器端调用华为SDK是否OK，如果服务器端调用OK，没有出现报错之类的问题，然后就是等，可能是10分钟后或者20分钟后，甚至是第二天，你就&lt;code&gt;基本&lt;/code&gt;能收到消息了。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;自己集成SDK测试时，出现了几次消息没收到的情况，也就是推送丢失了。但使用华为联盟后台推送比使用SDK推送，消息的到达率和准时性要好。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面这张截图是华为官方的服务介绍：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/01/22/hw_push_msg_arrived_ratio.png&quot; alt=&quot;基本100%送到，远远高于其他推送平台&quot;&gt;&lt;/p&gt;
&lt;p&gt;还有一些问题的解决方案参考这里：&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.jacpy.com/2017/01/19/huawei-hms-push-timepicker-inflate-error.html&quot;&gt;使用HMS推送定义了EMUI的样式导致TimePicker初始化失败&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;如果还遇到其他问题解决不了，通过QQ找他们技术支持。&lt;/p&gt;
&lt;p&gt;希望能帮到一些人，以上。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前段时间在应用中集成了华为推送，现在终于告一段落了，回首起来，发现一路踩的坑，都是泪啊。&lt;/p&gt;
&lt;p&gt;先交待下集成华为推送的背景：由于android手机上的google官方的推送GCM在中国大陆基本是残废，而大陆有些手机厂商可能会干掉这部分，造成GCM推送基本不可用。而像小米、华为等手机厂商对android系统的ROM进行了深度定制，用户可以手机桌面直接将应用程序kill，即使有后台服务，都被会一起干掉，同时android新的版本为了改善手机续行，在6.0开始增加了Doze机制，无疑对推送又是一大打击。综合这些因素，决定选几种推送一起集成进来，其中就有针对华为手机的华为推送。&lt;/p&gt;
    
    </summary>
    
    
      <category term="HMS 华为透传 华为推送" scheme="http://www.jacpy.com/tags/HMS-%E5%8D%8E%E4%B8%BA%E9%80%8F%E4%BC%A0-%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>使用HMS推送定义了EMUI的样式导致TimePicker初始化失败</title>
    <link href="http://www.jacpy.com/2017/01/19/huawei-hms-push-timepicker-inflate-error.html"/>
    <id>http://www.jacpy.com/2017/01/19/huawei-hms-push-timepicker-inflate-error.html</id>
    <published>2017-01-19T07:46:24.000Z</published>
    <updated>2017-01-19T09:34:59.000Z</updated>
    
    <content type="html">&lt;p&gt;昨天遇到一个很奇葩的问题，使用了华为HMS SDK中的推送功能，然后插件布局文件中的TimePicker初始化时，会报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.view.InflateException: Binary XML file line #47: Error inflating class huawei.android.widget.TimePicker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;很奇怪，&lt;code&gt;TimePicker&lt;/code&gt;在布局文件中使用&lt;code&gt;&amp;lt;TimePicker/&amp;gt;&lt;/code&gt;标签，当布局文件被inflate后，在&lt;code&gt;android.widget.TimePicker&lt;/code&gt;前面加了一个&lt;code&gt;huawei.&lt;/code&gt;。如果使用&lt;code&gt;&amp;lt;android.widget.TimePicker/&amp;gt;&lt;/code&gt;标签，则不会有问题；而其他有地方会出现这个新的错误：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.view.InflateException: Binary XML file line #20: Error inflating class &amp;lt;unknown&amp;gt;at android.view.LayoutInflater.createView(LayoutInflater.java:620)at com.android.internal.policy.impl.PhoneLayoutInflater.onCreateView(PhoneLayoutInflater.java:56)at android.view.LayoutInflater.onCreateView(LayoutInflater.java:669)at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:694)at android.view.LayoutInflater.inflate(LayoutInflater.java:469)at android.view.LayoutInflater.inflate(LayoutInflater.java:397)at android.view.LayoutInflater.inflate(LayoutInflater.java:353)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:103)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:74)at android.view.View.performClick(View.java:4447)at android.view.View$PerformClick.run(View.java:18457)at android.os.Handler.handleCallback(Handler.java:733)at android.os.Handler.dispatchMessage(Handler.java:95)at android.os.Looper.loop(Looper.java:136)at android.app.ActivityThread.main(ActivityThread.java:5119)at java.lang.reflect.Method.invokeNative(Native Method)at java.lang.reflect.Method.invoke(Method.java:515)at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:789)at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:605)at dalvik.system.NativeStart.main(Native Method)Caused by: java.lang.reflect.InvocationTargetExceptionat java.lang.reflect.Constructor.constructNative(Native Method)at java.lang.reflect.Constructor.newInstance(Constructor.java:423)at android.view.LayoutInflater.createView(LayoutInflater.java:594)... 20 moreCaused by: java.lang.NullPointerExceptionat android.view.ViewGroup.addView(ViewGroup.java:3353)at com.huawei.android.hwcontrol.TimePickerFactory.updateAmPmStart(TimePickerFactory.java:92)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:265)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:139)... 23 morejava.lang.reflect.InvocationTargetExceptionat java.lang.reflect.Constructor.constructNative(Native Method)at java.lang.reflect.Constructor.newInstance(Constructor.java:423)at android.view.LayoutInflater.createView(LayoutInflater.java:594)at com.android.internal.policy.impl.PhoneLayoutInflater.onCreateView(PhoneLayoutInflater.java:56)at android.view.LayoutInflater.onCreateView(LayoutInflater.java:669)at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:694)at android.view.LayoutInflater.inflate(LayoutInflater.java:469)at android.view.LayoutInflater.inflate(LayoutInflater.java:397)at android.view.LayoutInflater.inflate(LayoutInflater.java:353)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:103)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:74)at android.view.View.performClick(View.java:4447)at android.view.View$PerformClick.run(View.java:18457)at android.os.Handler.handleCallback(Handler.java:733)at android.os.Handler.dispatchMessage(Handler.java:95)at android.os.Looper.loop(Looper.java:136)at android.app.ActivityThread.main(ActivityThread.java:5119)at java.lang.reflect.Method.invokeNative(Native Method)at java.lang.reflect.Method.invoke(Method.java:515)at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:789)at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:605)at dalvik.system.NativeStart.main(Native Method)Caused by: java.lang.NullPointerExceptionat android.view.ViewGroup.addView(ViewGroup.java:3353)at com.huawei.android.hwcontrol.TimePickerFactory.updateAmPmStart(TimePickerFactory.java:92)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:265)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:139)... 23 more&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但如果不使用插件，在主应用中使用TimePicker之类的组件，就一切OK。&lt;/p&gt;
&lt;p&gt;好吧，问题很严重，已经定位到是集成了推送的功能之后出现的。但很难定位为什么出现这种问题，注册Token后，跨进程通讯问题？后台推送服务导致的？&lt;/p&gt;
&lt;p&gt;看到这个&lt;code&gt;huawei.android.widget.TimePicker&lt;/code&gt;在想，华为又调皮了，又改了系统的源码。因为google官方的android系统源中有这样一个逻辑，发现布局文件中的View没有包名，会自动加上&lt;code&gt;android.widget.&lt;/code&gt;前缀。&lt;/p&gt;
&lt;p&gt;已经在怀疑是在AndroidManifest.xml文件中配置了什么导致了问题，所以一行一行的排查。果然，在去掉下面这行后，就正常了。&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;application&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;meta-data android:name=&quot;hwc-theme&quot;            android:value=&quot;androidhwext:style/Theme.Emui.NoActionBar&quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/application&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个&lt;code&gt;meta-data&lt;/code&gt;定义是放在&lt;code&gt;applicaton&lt;/code&gt;标签中，所以会针对整个App。把这行干掉之后，问题解决。&lt;/p&gt;
&lt;p&gt;这种问题也只能是在这种特定场景中被遇到，一般还真遇不到。三生有幸！&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;昨天遇到一个很奇葩的问题，使用了华为HMS SDK中的推送功能，然后插件布局文件中的TimePicker初始化时，会报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.view.InflateException: Binary XML file line #47: Error inflating class huawei.android.widget.TimePicker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="android push" scheme="http://www.jacpy.com/categories/android-push/"/>
    
    
      <category term="推送" scheme="http://www.jacpy.com/tags/%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>android点击通知栏通知启动Activity问题</title>
    <link href="http://www.jacpy.com/2016/12/28/android-notification-launch-activity.html"/>
    <id>http://www.jacpy.com/2016/12/28/android-notification-launch-activity.html</id>
    <published>2016-12-28T08:36:40.000Z</published>
    <updated>2017-01-19T09:36:41.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天遇到一个很奇葩的问题，终于解决了，记录一下。&lt;/p&gt;
&lt;p&gt;问题场景是：用小米手机使用小米推送一条消息，然后点击通知栏中的消息启动应用，然后进入会话的Activity。应用启动后，如果当前界面不是会话界面，那么新消息会在通知栏显示消息提醒，然后点击会话消息后却进不了会话的Activity，即点击了通知栏通知后，系统都没有启动指定Activity的意思，没有看到系统启动Activity的Log，到是会看到系统处理这个Activity的影子。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;这个指定的Activity不是会话的Activity，而是在AndroidManifest.xml文件中指定&lt;code&gt;android.intent.category.LAUNCHER&lt;/code&gt;的Activity A。也就是说有会话消息都是先从这个A开始，然后把数据往后面的Activity传。&lt;/p&gt;
&lt;p&gt;这里显示通知有两种方式，一种是由手机系统在通知栏弹出，比如小米手机上使用小米推送，华为手机上使用华为推送，另外一种是由应用的远程进程弹出。&lt;/p&gt;
&lt;p&gt;启动应用的第一个Activity A也有两种方式，一种是直接通过new来构造一个Intent，然后传入Activity A的class；另外一种是通过&lt;code&gt;context.getPackageManager().getLaunchIntentForPackage(context.getPackageName())&lt;/code&gt;来获取启动的Activity A的Intent。然后调用PendingIntent.getActivity()方法，将得到的intent传入。&lt;/p&gt;
&lt;p&gt;那么问题来了，如果是点击系统弹出的通知栏或者远程进程弹出的通知栏，如果只是使用其中一种启动方式启动应用，那么在应用启动后，点击通知栏中由后台远程进程弹出的新消息通知，这个时候就不能进入会话的Activity。从系统的日志来看，没有启动Activity，只是对Activity做了处理。&lt;/p&gt;
&lt;p&gt;可能有人会想到是不是要加一个&lt;code&gt;Intent.FLAG_ACTIVITY_NEW_TASK&lt;/code&gt;标识，因为在&lt;code&gt;getLaunchIntentForPackage()&lt;/code&gt;方法中加了这个标识。&lt;/p&gt;
&lt;p&gt;最后测试发现，只要应用没有被启动，不管是点击系统弹出的通知栏还是远程进程弹出的通知栏，如果再收到新消息通知，再点击通知栏，就能进入会话Activity了。那只要判断应用中是否有Activity被启动就OK了，貌似问题可以解决了。&lt;/p&gt;
&lt;p&gt;于是用了下面的逻辑来判断是否有前台Activity在运行。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/** * 判断UI进程是否正在运行 * &lt;span class=&quot;doctag&quot;&gt;@return&lt;/span&gt; 返回true表示正在运行，否则没有运行 */&lt;/span&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isForegroundRunning&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;    ActivityManager am = (ActivityManager) EimCloud.getContext().getSystemService(Context.ACTIVITY_SERVICE);    List&amp;lt;ActivityManager.RunningAppProcessInfo&amp;gt; list = am.getRunningAppProcesses();    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (list != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (ActivityManager.RunningAppProcessInfo info : list) &amp;#123;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (info.importance == ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND						&amp;amp;&amp;amp; EimCloud.getContext().getPackageName().equals(info.processName)) &amp;#123;					&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;            &amp;#125;        &amp;#125;    &amp;#125;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是上面的方法在小米手机上凑效了，但在华为手机上还是有问题，即使同样的场景。华为又坑爹了！&lt;/p&gt;
&lt;p&gt;于是开始从上面的&lt;code&gt;ActivityManager.RunningAppProcessInfo&lt;/code&gt;类中的&lt;code&gt;importance&lt;/code&gt;变量的状态入手，然后测试各种场景可能出现的变量值，结果发现效果不尽人意，有些场景问题依旧。&lt;/p&gt;
&lt;p&gt;最后，又换种思路：不从Activity A开始启动应用，换个Activity B，也就是在调用&lt;code&gt;PendingIntent.getActivity()&lt;/code&gt;方法传入Intent对象使用B的class。启动B会发现应用没有被初始化，则跳转到A执行初始化，然后再走正常流程。&lt;/p&gt;
&lt;p&gt;再针对各种场景以及各种机型测试，发现问题解决。从上面可以看出，虽然不懂背后原理，但解决问题的思路一定要广，特别是在急着发版本的时候，不要在一棵树上吊死。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天遇到一个很奇葩的问题，终于解决了，记录一下。&lt;/p&gt;
&lt;p&gt;问题场景是：用小米手机使用小米推送一条消息，然后点击通知栏中的消息启动应用，然后进入会话的Activity。应用启动后，如果当前界面不是会话界面，那么新消息会在通知栏显示消息提醒，然后点击会话消息后却进不了会话的Activity，即点击了通知栏通知后，系统都没有启动指定Activity的意思，没有看到系统启动Activity的Log，到是会看到系统处理这个Activity的影子。&lt;/p&gt;
    
    </summary>
    
      <category term="android push" scheme="http://www.jacpy.com/categories/android-push/"/>
    
    
      <category term="notification" scheme="http://www.jacpy.com/tags/notification/"/>
    
  </entry>
  
  <entry>
    <title>android布局中的EXACTLY、AT_MOST、UNSPECIFIED详解</title>
    <link href="http://www.jacpy.com/2016/12/18/android-exactly-atmost-unspecified-detailed-explaintion.html"/>
    <id>http://www.jacpy.com/2016/12/18/android-exactly-atmost-unspecified-detailed-explaintion.html</id>
    <published>2016-12-18T09:55:42.000Z</published>
    <updated>2016-12-18T09:55:52.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;前几天在给一个同事讲&amp;amp;运算取变量的状态写法，原因是我看到他代码中这样写会产生问题，所以想纠正他一下，于是就跟他说你可以参考下android系统中View在measure时使用的状态是怎么通过&amp;amp;运算获取的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;他也说这几个状态是与View在布局文件中设置width或height时，有个对应关系。就这个机会，深入的了解了下View的宽高的measure是怎么与&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#EXACTLY&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.view.View.MeasureSpec.EXACTLY&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#AT_MOST&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.view.View.MeasureSpec.AT_MOST&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#UNSPECIFIED&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.view.View.MeasureSpec.UNSPECIFIED&lt;/a&gt;这三种状态一一对应的。于是就有了下文。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;在布局文件中设置View的&lt;code&gt;layout_width&lt;/code&gt;或&lt;code&gt;layout_height&lt;/code&gt;时，可以设置三种值&lt;code&gt;match_parent&lt;/code&gt;、&lt;code&gt;wrap_content&lt;/code&gt;和具体的长度值，下面看下android系统源码中是怎么处理这几种值的。&lt;/p&gt;
&lt;p&gt;做过android开发都知道，如果在Activity的&lt;code&gt;onCreate()&lt;/code&gt;方法中通过调用View的&lt;code&gt;getWidth()&lt;/code&gt;方法是获取不到View的宽高的，此时返回的是0，因为View还没有初始化完成。那么查看View的&lt;code&gt;getWidth()&lt;/code&gt;方法发现，返回的值是通过&lt;code&gt;mRight - mLeft&lt;/code&gt;返回的值，也就是说如果调用&lt;code&gt;getWidth()&lt;/code&gt;返回值，那么一定是&lt;code&gt;mRight&lt;/code&gt;和&lt;code&gt;mLeft&lt;/code&gt;这两个变量被赋值了。View的&lt;code&gt;getHeight()&lt;/code&gt;方法返回高度同理。在View中&lt;code&gt;mLeft&lt;/code&gt;个成员被初始化值在两个方法中，一个是&lt;code&gt;setLeft(int)&lt;/code&gt;方法中，一个是&lt;code&gt;setFrame(int,int,int,int)&lt;/code&gt;中，实际上这两个方法都是由系统来调用的，尤其是&lt;code&gt;setFrame()&lt;/code&gt;方法被标记为隐藏。通过查看源码发现，&lt;code&gt;setLeft(int)&lt;/code&gt;这个方法很少被使用，倒是跟踪&lt;code&gt;setFrame(int,int,int,int)&lt;/code&gt;方法时，发现一些眉目，最后发现这个这个&lt;code&gt;setFrame()&lt;/code&gt;方法是在View的&lt;code&gt;layout()&lt;/code&gt;方法中一直调用过来的。OK，那么这个layout()方法的调用轨迹是怎样的呢？可以自定义一个View，然后重写这个View的&lt;code&gt;layout()&lt;/code&gt;方法，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;layout&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; l, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; t, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; r, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; b)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.layout(l, t, r, b);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Throwable th = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Throwable();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    th.printStackTrace(); &lt;span class=&quot;comment&quot;&gt;// 打印被调用的栈信息&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出的LOG如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;W/System.err: java.lang.Throwable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at com.jacpy.busline.widget.BusLineView.layout(BusLineView.java:243)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.RelativeLayout.onLayout(RelativeLayout.java:1055)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.layoutChildren(FrameLayout.java:453)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.onLayout(FrameLayout.java:388)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.LinearLayout.setChildFrame(LinearLayout.java:1671)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.LinearLayout.layoutVertical(LinearLayout.java:1525)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.LinearLayout.onLayout(LinearLayout.java:1434)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.layoutChildren(FrameLayout.java:453)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.onLayout(FrameLayout.java:388)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl.performLayout(ViewRootImpl.java:2013)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:1770)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:1019)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:5725)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer$CallbackRecord.run(Choreographer.java:761)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer.doCallbacks(Choreographer.java:574)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer.doFrame(Choreographer.java:544)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer$FrameDisplayEventReceiver.run(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.os.Handler.handleCallback(Handler.java:733)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.os.Looper.loop(Looper.java:136)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.app.ActivityThread.main(ActivityThread.java:5086)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at java.lang.reflect.Method.invokeNative(Native Method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at java.lang.reflect.Method.invoke(Method.java:515)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:601)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at dalvik.system.NativeStart.main(Native Method)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这段LOG从下往上看，首先是ZygoteInit启动，也就是手机系统的启动，这部分忽略，只看与应用相关的，从&lt;code&gt;ActivityThread.main()&lt;/code&gt;开始。在&lt;code&gt;ActivityThread&lt;/code&gt;中启动的Looper主线程用来执行了一个Runnable实例，这个实例是&lt;code&gt;android.view.Choreographer$FrameDisplayEventReceiver&lt;/code&gt;类的实例，在这个类的&lt;code&gt;run()&lt;/code&gt;方法中执行了Choreographer的&lt;code&gt;doFrame()&lt;/code&gt;方法，在这个方法中看到熟悉的日志输出：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Log.i(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Skipped &quot;&lt;/span&gt; + skippedFrames + &lt;span class=&quot;string&quot;&gt;&quot; frames!  &quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            + &lt;span class=&quot;string&quot;&gt;&quot;The application may be doing too much work on its main thread.&quot;&lt;/span&gt;);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当View初始化时在主线程中做的操作过多导致卡帧时，这个LOG就会输出。&lt;/p&gt;
&lt;p&gt;OK，跑题了，继续看日志。在&lt;code&gt;doCallbacks()&lt;/code&gt;方法中从&lt;code&gt;mCallbackQueues&lt;/code&gt;这个回调队列中根据回调的类型取出要执行的CallbackRecord对象，并调用其&lt;code&gt;run()&lt;/code&gt;方法。而ViewRootImpl的TraversalRunnable对象是通过在ViewRootImpl的&lt;code&gt;scheduleTraversals()&lt;/code&gt;方法中设置的。代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;scheduleTraversals&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mTraversalScheduled) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mTraversalScheduled = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mTraversalBarrier = mHandler.getLooper().postSyncBarrier();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mChoreographer.postCallback(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// 将mTranversalRunnable加入到mChoreographer的mCallbackQueues的队列中&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mUnbufferedInputDispatch) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            scheduleConsumeBatchedInput();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        notifyRendererOfFramePending();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最后在&lt;code&gt;performLayout()&lt;/code&gt;方法中看到具体调用View的&lt;code&gt;layout()&lt;/code&gt;方法的代码：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;host.layout(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, host.getMeasuredWidth(), host.getMeasuredHeight());&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里的host是ViewRootImpl的&lt;code&gt;mView&lt;/code&gt;对象，这个对象是一个PhoneWindow.DecorView对象，后面会有文章分析。&lt;/p&gt;
&lt;p&gt;OK，这里可以看到&lt;code&gt;mLeft&lt;/code&gt;赋值是0，&lt;code&gt;mRight&lt;/code&gt;就是&lt;code&gt;getMeasureWidth()&lt;/code&gt;方法的返回值。&lt;code&gt;getMeasureWidth()&lt;/code&gt;这个方法代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; MEASURED_SIZE_MASK = &lt;span class=&quot;number&quot;&gt;0x00ffffff&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getMeasuredWidth&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; mMeasuredWidth &amp;amp; MEASURED_SIZE_MASK;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面的代码可以看出，&lt;code&gt;mMeasureWidth&lt;/code&gt;取了后三个字节，也就是本来是int类型的&lt;code&gt;mMeasureWidth&lt;/code&gt;实际目前只使用了低位三个字节，对于目前的显示的分辨率来说足够。&lt;/p&gt;
&lt;p&gt;OK，重点来了，这个&lt;code&gt;mMeasureWidth&lt;/code&gt;的值是怎么来的？继续跟代码发现这个变量在View的&lt;code&gt;setMeasuredDimensionRaw()&lt;/code&gt;方法中被赋值，使用方法中的参数赋值。接着发现这个方法在&lt;code&gt;setMeasuredDimension()&lt;/code&gt;和&lt;code&gt;measure()&lt;/code&gt;方法中被调用。而在&lt;code&gt;measure()&lt;/code&gt;方法中&lt;code&gt;cacheIndex&lt;/code&gt;这个变量可能是-1，因为&lt;code&gt;mMeasureCache&lt;/code&gt;变量中的键值对只在&lt;code&gt;measure()&lt;/code&gt;方法最后才放进去的，而最后是调用了&lt;code&gt;onMeasure()&lt;/code&gt;方法。代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;measure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightMeasureSpec)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;// Suppress sign extension for the low bytes&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; key = (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) widthMeasureSpec &amp;lt;&amp;lt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt; | (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) heightMeasureSpec &amp;amp; &lt;span class=&quot;number&quot;&gt;0xffffffffL&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;// 用一个64位的long类型保存两个32位的值，高32位是宽，低32位是高&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mMeasureCache == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) mMeasureCache = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; LongSparseLongArray(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((mPrivateFlags &amp;amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            widthMeasureSpec != mOldWidthMeasureSpec ||&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            heightMeasureSpec != mOldHeightMeasureSpec) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// first clears the measured dimension flag&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mPrivateFlags &amp;amp;= ~PFLAG_MEASURED_DIMENSION_SET;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		 &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; cacheIndex = (mPrivateFlags &amp;amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; :&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                mMeasureCache.indexOfKey(key); &lt;span class=&quot;comment&quot;&gt;// 如果没有找到这个Key也是返回-1&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (cacheIndex &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || sIgnoreMeasureCache) &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 极有可能是走这个判断&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// measure ourselves, this should set the measured dimension flag back&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            onMeasure(widthMeasureSpec, heightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPrivateFlags3 &amp;amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; value = mMeasureCache.valueAt(cacheIndex);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Casting a long to int drops the high 32 bits, no mask needed&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            setMeasuredDimensionRaw((&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) (value &amp;gt;&amp;gt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;), (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) value);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		 &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	 &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	 &lt;span class=&quot;comment&quot;&gt;// 保存键值对&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mMeasureCache.put(key, ((&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) mMeasuredWidth) &amp;lt;&amp;lt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt; |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) mMeasuredHeight &amp;amp; &lt;span class=&quot;number&quot;&gt;0xffffffffL&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// suppress sign extension&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;而&lt;code&gt;setMeasuredDimension()&lt;/code&gt;方法是在&lt;code&gt;onMeasure()&lt;/code&gt;方法中有调用。因此，上面的代码不管是走&lt;code&gt;if&lt;/code&gt;流程还是&lt;code&gt;else&lt;/code&gt;流程，最终都会调用&lt;code&gt;setMeasuredDimensionRaw()&lt;/code&gt;这个方法。不管流程怎样，这个值是从&lt;code&gt;measure()&lt;/code&gt;这个方法中的参数传进来的。以同样的方法重写View的&lt;code&gt;onMeasure()&lt;/code&gt;方法，如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onMeasure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightMeasureSpec)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onMeasure(widthMeasureSpec, heightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Throwable t = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Throwable();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    t.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出的LOG如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;java.lang.Throwable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.jacpy.busline.widget.BusLineView.onMeasure(BusLineView.java:442)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.RelativeLayout.measureChildHorizontal(RelativeLayout.java:719)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.RelativeLayout.onMeasure(RelativeLayout.java:455)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:5137)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.FrameLayout.onMeasure(FrameLayout.java:310)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:5137)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.LinearLayout.measureChildBeforeLayout(LinearLayout.java:1404)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.LinearLayout.measureVertical(LinearLayout.java:695)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.LinearLayout.onMeasure(LinearLayout.java:588)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:5137)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.FrameLayout.onMeasure(FrameLayout.java:310)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.internal.policy.impl.PhoneWindow$DecorView.onMeasure(PhoneWindow.java:2291)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.performMeasure(ViewRootImpl.java:1942)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.measureHierarchy(ViewRootImpl.java:1132)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:1321)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:1019)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:5725)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer$CallbackRecord.run(Choreographer.java:761)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer.doCallbacks(Choreographer.java:574)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer.doFrame(Choreographer.java:544)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:747)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.os.Handler.handleCallback(Handler.java:733)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.os.Looper.loop(Looper.java:136)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.app.ActivityThread.main(ActivityThread.java:5086)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at java.lang.reflect.Method.invokeNative(Native Method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at java.lang.reflect.Method.invoke(Method.java:515)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:785)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:601)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at dalvik.system.NativeStart.main(Native Method)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从上面的LOG可以看出来，最终是在&lt;code&gt;measure()&lt;/code&gt;方法中调到&lt;code&gt;onMeasure()&lt;/code&gt;方法，也就是上面分析的流程。&lt;/p&gt;
&lt;p&gt;通过上面两段LOG发现，最终都指向了同一个地方，那就是ViewRootImpl的&lt;code&gt;performTraversals()&lt;/code&gt;。也就是说，在这个方法中先measure，然后再layout。&lt;/p&gt;
&lt;p&gt;从&lt;code&gt;measureHierarchy()&lt;/code&gt;方法中可以看出来在调用&lt;code&gt;performMeasure(int,int)&lt;/code&gt;方法时，传了两个参数&lt;code&gt;childWidthMeasureSpec&lt;/code&gt;和&lt;code&gt;childHeightMeasureSpec&lt;/code&gt;，而这两个变量是通过&lt;code&gt;getRootMeasureSpec()&lt;/code&gt;方法返回的，如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;measureHierarchy&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; View host, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; WindowManager.LayoutParams lp,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Resources res, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; desiredWindowWidth, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; desiredWindowHeight) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childWidthMeasureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childHeightMeasureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; windowSizeMayChange = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; goodMeasure = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// On large screens, we don&#39;t want to allow dialogs to just&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// stretch to fill the entire width of the screen to display&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// one line of text.  First try doing the layout at a smaller&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// size to see if it will fit.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; DisplayMetrics packageMetrics = res.getDisplayMetrics();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        res.getValue(com.android.internal.R.dimen.config_prefDialogWidth, mTmpValue, &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; baseSize = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mTmpValue.type == TypedValue.TYPE_DIMENSION) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            baseSize = (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)mTmpValue.getDimension(packageMetrics);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: baseSize=&quot;&lt;/span&gt; + baseSize);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (baseSize != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; desiredWindowWidth &amp;gt; baseSize) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: measured (&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    + host.getMeasuredWidth() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + host.getMeasuredHeight() + &lt;span class=&quot;string&quot;&gt;&quot;)&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((host.getMeasuredWidthAndState()&amp;amp;View.MEASURED_STATE_TOO_SMALL) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                goodMeasure = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// Didn&#39;t fit in that size... try expanding a bit.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                baseSize = (baseSize+desiredWindowWidth)/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: next baseSize=&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        + baseSize);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: measured (&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        + host.getMeasuredWidth() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + host.getMeasuredHeight() + &lt;span class=&quot;string&quot;&gt;&quot;)&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((host.getMeasuredWidthAndState()&amp;amp;View.MEASURED_STATE_TOO_SMALL) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Good!&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    goodMeasure = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!goodMeasure) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight()) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            windowSizeMayChange = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; windowSizeMayChange;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;本文的重点来了，&lt;code&gt;getRootMeasureSpec()&lt;/code&gt;方法的代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getRootMeasureSpec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; windowSize, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; rootDimension)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; measureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (rootDimension) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; ViewGroup.LayoutParams.MATCH_PARENT:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Window can&#39;t resize. Force root view to be windowSize.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; ViewGroup.LayoutParams.WRAP_CONTENT:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Window can resize. Set max size for root view.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Window wants to be an exact size. Force root view to be that size.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; measureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;从方法中的switch可以看到，&lt;code&gt;MATCH_PARENT&lt;/code&gt;对应&lt;code&gt;MeasureSpec.EXACTLY&lt;/code&gt;、&lt;code&gt;WRAP_CONTENT&lt;/code&gt;对应&lt;code&gt;MeasureSpec.AT_MOST&lt;/code&gt;，默认的可以认为是设置了具体的值对应的是&lt;code&gt;MeasureSpec.EXACTLY&lt;/code&gt;。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;为了确定一下，可以看下MeasureSpc的&lt;code&gt;makeMeasureSpec()&lt;/code&gt;方法的代码，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; MODE_SHIFT = &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; MODE_MASK  = &lt;span class=&quot;number&quot;&gt;0x3&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; UNSPECIFIED = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; EXACTLY     = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; AT_MOST     = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;makeMeasureSpec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; size, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; mode)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (sUseBrokenMakeMeasureSpec) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; size + mode;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; (size &amp;amp; ~MODE_MASK) | (mode &amp;amp; MODE_MASK);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前面说尺寸值是由低三个字节表示，这里可以看到高位第一个字节的前两个位用来表示mode。也就是说int类型的第31、32位表示的是mode值，低30位表示是具体的长度值。&lt;/p&gt;
&lt;p&gt;OK，最后是在ViewGroup的&lt;code&gt;measureChildWithMargins()&lt;/code&gt;方法中调用每个child的&lt;code&gt;measure()&lt;/code&gt;方法去具体测量每个子View的长度，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;measureChildWithMargins&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(View child,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; parentWidthMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthUsed,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; parentHeightMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightUsed) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    + widthUsed, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    + heightUsed, lp.height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;而其中被调用的&lt;code&gt;getChildMeasureSpec()&lt;/code&gt;方法中子View的大小是根据父View的大小及模式来决定的，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getChildMeasureSpec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; spec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; padding, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childDimension)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; specMode = MeasureSpec.getMode(spec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; specSize = MeasureSpec.getSize(spec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; size = Math.max(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, specSize - padding);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; resultSize = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; resultMode = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (specMode) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Parent has imposed an exact size on us&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MeasureSpec.EXACTLY:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = childDimension;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.MATCH_PARENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to be our size. So be it.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to determine its own size. It can&#39;t be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// bigger than us.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.AT_MOST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Parent has imposed a maximum size on us&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MeasureSpec.AT_MOST:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants a specific size... so be it&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = childDimension;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.MATCH_PARENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to be our size, but our size is not fixed.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Constrain child to not be bigger than us.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.AT_MOST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to determine its own size. It can&#39;t be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// bigger than us.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.AT_MOST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Parent asked to see how big we want to be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MeasureSpec.UNSPECIFIED:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants a specific size... let him have it&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = childDimension;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.MATCH_PARENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to be our size... find out how big it should&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; : size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.UNSPECIFIED;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to determine its own size.... find out how&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// big it should be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; : size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.UNSPECIFIED;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; MeasureSpec.makeMeasureSpec(resultSize, resultMode);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;OK，以上就是整个分析过程。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;前几天在给一个同事讲&amp;amp;运算取变量的状态写法，原因是我看到他代码中这样写会产生问题，所以想纠正他一下，于是就跟他说你可以参考下android系统中View在measure时使用的状态是怎么通过&amp;amp;运算获取的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;他也说这几个状态是与View在布局文件中设置width或height时，有个对应关系。就这个机会，深入的了解了下View的宽高的measure是怎么与&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#EXACTLY&quot;&gt;android.view.View.MeasureSpec.EXACTLY&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#AT_MOST&quot;&gt;android.view.View.MeasureSpec.AT_MOST&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#UNSPECIFIED&quot;&gt;android.view.View.MeasureSpec.UNSPECIFIED&lt;/a&gt;这三种状态一一对应的。于是就有了下文。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="view" scheme="http://www.jacpy.com/categories/view/"/>
    
    
      <category term="EXACTLY AT_MOST UNSPECIFIED" scheme="http://www.jacpy.com/tags/EXACTLY-AT-MOST-UNSPECIFIED/"/>
    
  </entry>
  
  <entry>
    <title>android中View创建过程详解</title>
    <link href="http://www.jacpy.com/2016/12/13/android-view-create-detail.html"/>
    <id>http://www.jacpy.com/2016/12/13/android-view-create-detail.html</id>
    <published>2016-12-13T01:46:45.000Z</published>
    <updated>2016-12-17T11:12:01.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天在看View的尺寸是怎样计算出来的，于是看了整个View被初始化的过程，结合系统源码总结了一下。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;从布局文件到LayoutParams&quot;&gt;&lt;a href=&quot;#从布局文件到LayoutParams&quot; class=&quot;headerlink&quot; title=&quot;从布局文件到LayoutParams&quot;&gt;&lt;/a&gt;从布局文件到LayoutParams&lt;/h2&gt;&lt;p&gt;首先从Activity的&lt;code&gt;setContentView(int)&lt;/code&gt;方法开始，只要设置了R.layout的布局文件，那么界面上就会显示出来对应的内容。所以以这个方法为初发点，然后往后跟踪代码。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;setContentView&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(@LayoutRes &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; layoutResID)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    getWindow().setContentView(layoutResID);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    initWindowDecorActionBar();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过以上代码发现调用了Window类的&lt;code&gt;setContentView&lt;/code&gt;方法，那么这个Window对象&lt;code&gt;mWindow&lt;/code&gt;又是怎么初始化的？在Activity中搜索发现是在Activity的&lt;code&gt;attach&lt;/code&gt;方法中初始化的，构造了一个PhoneWindow对象。如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;attach&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Context context, ActivityThread aThread,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Instrumentation instr, IBinder token, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; ident,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Application application, Intent intent, ActivityInfo info,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        CharSequence title, Activity parent, String id,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        NonConfigurationInstances lastNonConfigurationInstances,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Configuration config, String referrer, IVoiceInteractor voiceInteractor) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    attachBaseContext(context);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mFragments.attachHost(&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;/*parent*/&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; PhoneWindow(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// 这里创建了Window对象&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow.setCallback(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow.setOnWindowDismissedCallback(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow.getLayoutInflater().setPrivateFactory(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ... 中间部分代码省略&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindow.setWindowManager(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mToken, mComponent.flattenToString(),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            (info.flags &amp;amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mParent != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mWindow.setContainer(mParent.getWindow());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mWindowManager = mWindow.getWindowManager();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mCurrentConfig = config;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在PhoneWindow的&lt;code&gt;setContentView(int)&lt;/code&gt;方法中，发现是调用了LayoutInflater的&lt;code&gt;inflate(int, View)&lt;/code&gt;方法，对这个布局文件进行转换成View，并添加到后面View这个参数中。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;setContentView&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; layoutResID)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// decor, when theme attributes and the like are crystalized. Do not check the feature&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// before this happens.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mContentParent == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        installDecor();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mContentParent.removeAllViews();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    	&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mLayoutInflater.inflate(layoutResID, mContentParent);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;这里面顺带穿插说一下View的根节点是怎样初始化出来的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这里有一个关键的地方是这个&lt;code&gt;installDecor()&lt;/code&gt;方法，在这个方法中通过调用&lt;code&gt;generateDecor()&lt;/code&gt;方法创建了这个mDecor的对象，通过调用&lt;code&gt;generateLayout(DecorView)&lt;/code&gt;方法初始化出来了mContentParent对象。其中，mDecor是&lt;code&gt;PhoneWindow.DecorView&lt;/code&gt;的类实例，mContentParent是展示所有内容的，是通过&lt;code&gt;com.android.internal.R.id.content&lt;/code&gt;ID来找到这个View。具体代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; ViewGroup &lt;span class=&quot;title&quot;&gt;generateLayout&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(DecorView decor)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	View in = mLayoutInflater.inflate(layoutResource, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// layoutResource是根据对当前显示View的Activity的theme属性值来决定由系统加载对应的布局文件&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	decor.addView(in, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	mContentRoot = (ViewGroup) in;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (contentParent == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	   &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;string&quot;&gt;&quot;Window couldn&#39;t find content container view&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; contentParent;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;那么在哪里面可以看到这个DecorView呢？看下面图。&lt;/p&gt;
&lt;p&gt;下面这张图是在debug模式下连接手机调试App，使用Layout Inspector工具查看得到的图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/12/13/phonewindow_decorview.png&quot; alt=&quot;PhoneWindow.DecorView&quot;&gt;&lt;/p&gt;
&lt;p&gt;其中从&lt;code&gt;1&lt;/code&gt;位置可以看出，整个View的根节点的View是PhoneWindow.DecorView实例；从&lt;code&gt;2&lt;/code&gt;位置和&lt;code&gt;3&lt;/code&gt;位置的mId可以推断出来，上面的mContentParent就是ContentFrameLayout类的实例；位置&lt;code&gt;4&lt;/code&gt;中的蓝色区域是mContentParent所表示的位置和大小。&lt;/p&gt;
&lt;p&gt;以上图是在AS 2.2.3版本上使用Android Monitor Tab页中的Layout Inspector工具（参考位置&lt;code&gt;5&lt;/code&gt;）生成。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;紧接着跟踪上面LayoutInflater中的&lt;code&gt;inflate()&lt;/code&gt;方法中调用，发现最后调用到了&lt;br&gt;&lt;code&gt;inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot)&lt;/code&gt;方法中，在这个方法中构造了&lt;code&gt;XmlResourceParser&lt;/code&gt;对象，而这个parser对象构造代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;XmlResourceParser &lt;span class=&quot;title&quot;&gt;loadXmlResourceParser&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; id, String type)&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; NotFoundException &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (mAccessLock) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        TypedValue value = mTmpValue;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (value == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mTmpValue = value = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; TypedValue();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        getValue(id, value, &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (value.type == TypedValue.TYPE_STRING) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; loadXmlResourceParser(value.string.toString(), id,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    value.assetCookie, type);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; NotFoundException(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;string&quot;&gt;&quot;Resource ID #0x&quot;&lt;/span&gt; + Integer.toHexString(id) + &lt;span class=&quot;string&quot;&gt;&quot; type #0x&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                + Integer.toHexString(value.type) + &lt;span class=&quot;string&quot;&gt;&quot; is not valid&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;XmlResourceParser &lt;span class=&quot;title&quot;&gt;loadXmlResourceParser&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String file, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; id,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; assetCookie, String type) &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; NotFoundException &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (id != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// These may be compiled...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (mCachedXmlBlockIds) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// First see if this block is in our cache.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; num = mCachedXmlBlockIds.length;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i=&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i&amp;lt;num; i++) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mCachedXmlBlockIds[i] == id) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;//System.out.println(&quot;**** REUSING XML BLOCK!  id=&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;//                   + id + &quot;, index=&quot; + i);&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; mCachedXmlBlocks[i].newParser();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Not in the cache, create a new block and put it at&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// the next slot in the cache.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            XmlBlock block = mAssets.openXmlBlockAsset(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    assetCookie, file);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (block != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; pos = mLastCachedXmlBlockIndex+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (pos &amp;gt;= num) pos = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                mLastCachedXmlBlockIndex = pos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                XmlBlock oldBlock = mCachedXmlBlocks[pos];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (oldBlock != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    oldBlock.close();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                mCachedXmlBlockIds[pos] = id;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                mCachedXmlBlocks[pos] = block;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//System.out.println(&quot;**** CACHING NEW XML BLOCK!  id=&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//                   + id + &quot;, index=&quot; + pos);&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; block.newParser();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中&lt;code&gt;getValue()&lt;/code&gt;方法调用到本地&lt;code&gt;frameworks/base/core/jni/android_util_AssetManager.cpp&lt;/code&gt;文件中的&lt;code&gt;static jint android_content_AssetManager_loadResourceValue&lt;/code&gt;函数，而在这个函数中java层的&lt;code&gt;TypeValue&lt;/code&gt;的类对象value对象属性通过JNI形式被赋值。&lt;/p&gt;
&lt;p&gt;在构建这个parser时，经历了很复杂的过程，从TypeValue中的&lt;code&gt;assetCookie&lt;/code&gt;属性，到XmlBlock中的&lt;code&gt;xmlBlock&lt;/code&gt;属性，再到XmlBlock.Parser中的&lt;code&gt;mParseState&lt;/code&gt;属性，都是用来保存JNI层的数据，因为最终操作这些资源数据是在native层，所以必不可少通过JNI这种方式，在java层和native层周旋。这里没有深入到native层去分析资源是如何被加载解析的，后面有机会再说。&lt;/p&gt;
&lt;p&gt;最后跟到了这个&lt;code&gt;public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot)&lt;/code&gt;方法中，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; View &lt;span class=&quot;title&quot;&gt;inflate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(XmlPullParser parser, @Nullable ViewGroup root, &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; attachToRoot)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (mConstructorArgs) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Context inflaterContext = mContext;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; AttributeSet attrs = Xml.asAttributeSet(parser);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Context lastContext = (Context) mConstructorArgs[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    View result = root;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// Temp is the root view that was found in the xml&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; View temp = createViewFromTag(root, name, inflaterContext, attrs); &lt;span class=&quot;comment&quot;&gt;// 这里将布局文件中的名称反射成具体的View类对象&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ViewGroup.LayoutParams params = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (root != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Create layout params that match root, if supplied&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        params = root.generateLayoutParams(attrs); &lt;span class=&quot;comment&quot;&gt;// 这里将尺寸转换成了LayoutParams&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!attachToRoot) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Set the layout params for temp if we are not&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// attaching. (If we are, we use addView, below)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            temp.setLayoutParams(params);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Inflate all children under temp against its context.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    rInflateChildren(parser, temp, attrs, &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// We are supposed to attach all the views we found (int temp)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// to root. Do that now.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (root != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; attachToRoot) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        root.addView(temp, params); &lt;span class=&quot;comment&quot;&gt;// 将布局文件中根的View添加到mContentParent中&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; result;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;接着看View的&lt;code&gt;generateLayoutParams(AttributeSet)&lt;/code&gt;方法，因为这里返回了params。查看代码最后发现LayoutParams的&lt;code&gt;width&lt;/code&gt;和&lt;code&gt;height&lt;/code&gt;属性赋值的代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;LayoutParams&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Context c, AttributeSet attrs)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    TypedArray a = c.obtainStyledAttributes(attrs, R.styleable.ViewGroup_Layout);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    setBaseAttributes(a,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            R.styleable.ViewGroup_Layout_layout_width,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            R.styleable.ViewGroup_Layout_layout_height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    a.recycle();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;setBaseAttributes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(TypedArray a, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthAttr, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightAttr)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    width = a.getLayoutDimension(widthAttr, &lt;span class=&quot;string&quot;&gt;&quot;layout_width&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    height = a.getLayoutDimension(heightAttr, &lt;span class=&quot;string&quot;&gt;&quot;layout_height&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过查看TypedArray类中的&lt;code&gt;getLayoutDimension()&lt;/code&gt;方法发现，获取的值是通过index在&lt;code&gt;mData&lt;/code&gt;这个成员数组中获取的。这个&lt;code&gt;mData&lt;/code&gt;的值是在创建TypedArray对象时被赋的值，具体参见TypedArray的&lt;code&gt;obtain&lt;/code&gt;方法。这个数组是在Resources的&lt;code&gt;obtainStyledAttributes()&lt;/code&gt;方法中通过调用&lt;code&gt;AssetManager.applyStyle()&lt;/code&gt;方法被初始化值的。&lt;code&gt;applyStyle()&lt;/code&gt;方法是一个native方法，对应&lt;code&gt;frameworks/base/core/jni/android_util_AssetManager.cpp&lt;/code&gt;文件中的&lt;code&gt;android_content_AssetManager_applyStyle&lt;/code&gt;函数。在这个函数中发现，传入的Resrouces类中的&lt;code&gt;mTheme&lt;/code&gt;成员以及XmlBlock.Parse类的&lt;code&gt;mParseState&lt;/code&gt;成员都是一个C++对象的指针，在java类中以整型或长整型值保存。&lt;/p&gt;
&lt;p&gt;至此，布局文件中的尺寸值已经被转换成了具体的int类型值。&lt;/p&gt;
&lt;h2 id=&quot;从布局文件到View&quot;&gt;&lt;a href=&quot;#从布局文件到View&quot; class=&quot;headerlink&quot; title=&quot;从布局文件到View&quot;&gt;&lt;/a&gt;从布局文件到View&lt;/h2&gt;&lt;p&gt;从上面的&lt;code&gt;public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot)&lt;/code&gt;方法中看到View是通过这行代码&lt;code&gt;final View temp = createViewFromTag(root, name, inflaterContext, attrs);&lt;/code&gt;创建出来的，而这个&lt;code&gt;name&lt;/code&gt;就是XML文件在解析时遇到的标签名称，比如&lt;code&gt;TextView&lt;/code&gt;。此时的&lt;code&gt;attrs&lt;/code&gt;也就是上面分析的&lt;code&gt;XmlBlock.Parser&lt;/code&gt;的对象。最后发现View是在&lt;code&gt;createViewFromTag()&lt;/code&gt;方法中创建的，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;View &lt;span class=&quot;title&quot;&gt;createViewFromTag&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(View parent, String name, Context context, AttributeSet attrs,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; ignoreThemeAttr) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (name.equals(&lt;span class=&quot;string&quot;&gt;&quot;view&quot;&lt;/span&gt;)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        name = attrs.getAttributeValue(&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;class&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Apply a theme wrapper, if allowed and one is specified.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!ignoreThemeAttr) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; themeResId = ta.getResourceId(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (themeResId != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            context = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ContextThemeWrapper(context, themeResId);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ta.recycle();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    View view;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mFactory2 != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        view = mFactory2.onCreateView(parent, name, context, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mFactory != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        view = mFactory.onCreateView(name, context, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        view = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (view == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; mPrivateFactory != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        view = mPrivateFactory.onCreateView(parent, name, context, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (view == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Object lastContext = mConstructorArgs[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mConstructorArgs[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] = context;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; == name.indexOf(&lt;span class=&quot;string&quot;&gt;&#39;.&#39;&lt;/span&gt;)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                view = onCreateView(parent, name, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                view = createView(name, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, attrs);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mConstructorArgs[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] = lastContext;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; view;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里要注意一下，&lt;code&gt;mConstructorArgs&lt;/code&gt;的第一个值是一个Context，而这个Context有可能已经不是当前Activity的Context。&lt;/p&gt;
&lt;p&gt;看到这里，下面这样的代码片段是不是很熟悉？&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (name.equals(&lt;span class=&quot;string&quot;&gt;&quot;view&quot;&lt;/span&gt;)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name = attrs.getAttributeValue(&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;class&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面Factory这个接口对象在LayoutInflater类中就有三个属性，分别对应：&lt;code&gt;factory&lt;/code&gt;、&lt;code&gt;factory2&lt;/code&gt;、&lt;code&gt;mPrivateFactory&lt;/code&gt;。很明显，弄清了这三个对象，也就知道了View的初始化流程。下面代码是对这三个属性的值的输出：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MainActivity&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;AppCompatActivity&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Bundle savedInstanceState)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onCreate(savedInstanceState);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        setContentView(R.layout.activity_main);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        LayoutInflater inflater = getLayoutInflater();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        LayoutInflater inflater1 = LayoutInflater.from(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Field f = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            f = LayoutInflater.class.getDeclaredField(&lt;span class=&quot;string&quot;&gt;&quot;mPrivateFactory&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            f.setAccessible(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (NoSuchFieldException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		  Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;the same object: &quot;&lt;/span&gt; + (inflater == inflater1));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;inflater factory: &quot;&lt;/span&gt; + inflater.getFactory() + &lt;span class=&quot;string&quot;&gt;&quot;, factory2: &quot;&lt;/span&gt; + inflater.getFactory2());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;inflater1 factory: &quot;&lt;/span&gt; + inflater1.getFactory() + &lt;span class=&quot;string&quot;&gt;&quot;, factory2: &quot;&lt;/span&gt; + inflater1.getFactory2());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (f != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;inflater mPrivateFactory: &quot;&lt;/span&gt; + f.get(inflater));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;inflater1 mPrivateFactory: &quot;&lt;/span&gt; + f.get(inflater1));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IllegalAccessException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出的LOG如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;// 当前Activiy继承的是android.support.v7.app.AppCompatActivity&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the same object: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater factory: android.support.v4.view.LayoutInflaterCompatHC$FactoryWrapperHC&amp;#123;android.support.v7.app.AppCompatDelegateImplV14@41fdf0b0&amp;#125;, factory2: android.support.v4.view.LayoutInflaterCompatHC$FactoryWrapperHC&amp;#123;android.support.v7.app.AppCompatDelegateImplV14@41fdf0b0&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater1 factory: android.support.v4.view.LayoutInflaterCompatHC$FactoryWrapperHC&amp;#123;android.support.v7.app.AppCompatDelegateImplV14@41fdf0b0&amp;#125;, factory2: android.support.v4.view.LayoutInflaterCompatHC$FactoryWrapperHC&amp;#123;android.support.v7.app.AppCompatDelegateImplV14@41fdf0b0&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater mPrivateFactory: com.jacpy.sb.MainActivity@41fd9e70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater1 mPrivateFactory: com.jacpy.sb.MainActivity@41fd9e70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;// 当前Activity继承的是android.app.Activity&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the same object: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater factory: null, factory2: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater1 factory: null, factory2: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater mPrivateFactory: com.jacpy.sb.MainActivity@41fd9a28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;inflater1 mPrivateFactory: com.jacpy.sb.MainActivity@41fd9a28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;首先看到&lt;code&gt;mPrivateFactory&lt;/code&gt;是当前的Activity实例，因为Activity也实现的Factory2接口。首先看LayoutInflater的创建过程，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/12/13/layoutinflater_init.png&quot; alt=&quot;LayoutInflater初始化流程&quot;&gt;&lt;/p&gt;
&lt;p&gt;而生成的PhoneLayoutInflater对象是缓存在ContextImpl类的属性&lt;code&gt;SYSTEM_SERVICE_MAP&lt;/code&gt;中，所以通过&lt;code&gt;Context.LAYOUT_INFLATER_SERVIC&lt;/code&gt;去取，始终是同一个对象，当然仅限于当前Context中。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;mPrivateFactory&lt;/code&gt;属性的赋值是在Activity的&lt;code&gt;attach()&lt;/code&gt;方法中，通过调用&lt;code&gt;mWindow.getLayoutInflater().setPrivateFactory(this);&lt;/code&gt;，因此调用Factory2的&lt;code&gt;onCreateView()&lt;/code&gt;方法时，实际是调用Activity中的&lt;code&gt;onCreateView()&lt;/code&gt;方法。而Activity中的&lt;code&gt;onCreateView()&lt;/code&gt;实际返回的是null，所以最后创建View的是&lt;code&gt;if&lt;/code&gt;判断中的&lt;code&gt;onCreateView(parent, name, attrs)&lt;/code&gt;方法，最后View是在LayoutInflater类中的&lt;code&gt;public final View createView(String name, String prefix, AttributeSet attrs)
            throws ClassNotFoundException, InflateException&lt;/code&gt;方法中创建：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; View &lt;span class=&quot;title&quot;&gt;createView&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String name, String prefix, AttributeSet attrs)&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; ClassNotFoundException, InflateException &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Constructor&amp;lt;? extends View&amp;gt; constructor = sConstructorMap.get(name);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Class&amp;lt;? extends View&amp;gt; clazz = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Class not found in the cache, see if it&#39;s real, and try to add it&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    clazz = mContext.getClassLoader().loadClass(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            prefix != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; ? (prefix + name) : name).asSubclass(View.class); &lt;span class=&quot;comment&quot;&gt;// prefix传的值是android.view.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    constructor = clazz.getConstructor(mConstructorSignature); &lt;span class=&quot;comment&quot;&gt;// Class&amp;lt;?&amp;gt;[] mConstructorSignature = new Class[] &amp;#123;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Context.class, AttributeSet.class&amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    constructor.setAccessible(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sConstructorMap.put(name, constructor);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Object[] args = mConstructorArgs;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    args[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] = attrs; &lt;span class=&quot;comment&quot;&gt;// 这个值是XmlBlock.Parser对象&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; View view = constructor.newInstance(args);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (view &lt;span class=&quot;keyword&quot;&gt;instanceof&lt;/span&gt; ViewStub) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Use the same context when inflating ViewStub later.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; ViewStub viewStub = (ViewStub) view;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        viewStub.setLayoutInflater(cloneInContext((Context) args[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; view;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里有没有发现&lt;code&gt;mConstructorSignature&lt;/code&gt;数组的长度决定了调用了View的哪个构造方法？&lt;/p&gt;
&lt;p&gt;至此，View已经创建成功。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天在看View的尺寸是怎样计算出来的，于是看了整个View被初始化的过程，结合系统源码总结了一下。&lt;/p&gt;
    
    </summary>
    
      <category term="view" scheme="http://www.jacpy.com/categories/view/"/>
    
    
      <category term="view create detail" scheme="http://www.jacpy.com/tags/view-create-detail/"/>
    
  </entry>
  
  <entry>
    <title>android Activity设置为SingleTop值时的生命周期在7.0以上系统中的变化</title>
    <link href="http://www.jacpy.com/2016/12/11/android-single-top-activity-lifecycle-changed-by-android-7.html"/>
    <id>http://www.jacpy.com/2016/12/11/android-single-top-activity-lifecycle-changed-by-android-7.html</id>
    <published>2016-12-11T04:13:15.000Z</published>
    <updated>2016-12-11T08:41:18.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;前几天在解决应用中一个问题，现象是在nexus 7.0以上系统的手机上创建群组会话时，消息发送超时。然后测试了一上，发现是必现的，而4.4系统的手机上却一切正常，于是一路分析了别人写的代码。最后找到原因并解决，于是就有了本文。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;最后找到原因是在Android系统7.0以上，当把Activity的&lt;code&gt;launchMode&lt;/code&gt;属性值设置为&lt;code&gt;singleTop&lt;/code&gt;时，Activity的生命周期与以前的系统版本对应的生命周期有所不同。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;我们都知道从Activity A启动了个Activity B，并在A中调用&lt;code&gt;finish()&lt;/code&gt;方法关闭A时，整个过程的生命周期的方法调用顺序是：先调用B的&lt;code&gt;onCreate()&lt;/code&gt;，然后再调用A的&lt;code&gt;onDestroy()&lt;/code&gt;。android系统这样做可能是为了提高系统的响应的速度，让应用以最快的速度看到UI发生变化，而不是从系统的角度考虑，先回收资源，资源回收OK了，再创建新的资源，所以就有了上面的这样生命周期方法的调用顺序。但在android 7.0系统以前有个例外情况：&lt;/p&gt;
&lt;p&gt;假如Activity A的&lt;code&gt;launchMode&lt;/code&gt;属性值被设置为&lt;code&gt;singleTop&lt;/code&gt;时，如果Activity A启动Activity B，在B中又启动了A，同时关闭B，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/12/11/activity_single_top_flow.png&quot; alt=&quot;singleTop流程图&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;此时A的生命周期方法的调用是：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;先调用A的&lt;code&gt;onDestroy&lt;/code&gt;方法，用来关闭以前被启动的旧的Activity A，然后再调用在B中新startActivity的A的&lt;code&gt;onCreate&lt;/code&gt;方法。&lt;/p&gt;
&lt;p&gt;那么这里所说的生命周期与前面所说的情况不一样，就因为设置了一个&lt;code&gt;singleTop&lt;/code&gt;值。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;这个是android系统7.0以前的，那么7.0以后的系统上走上述同样的流程，生命周期的方法调用顺序是：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;先调用新的Activity A的&lt;code&gt;onCreate&lt;/code&gt;方法，然后再调用旧A的&lt;code&gt;onDestroy&lt;/code&gt;方法。&lt;/p&gt;
&lt;p&gt;发现这里与没有设置&lt;code&gt;singleTop&lt;/code&gt;值时的生命周期一致，形成了统一。&lt;/p&gt;
&lt;p&gt;以上就是问题的原因，因为系统的差异造成的。由于使用的是google官方出的nexus系列手机测试，而又是使用原生的系统，可以认为是android官方系统这块的逻辑处理发生了变化。&lt;/p&gt;
&lt;p&gt;好了，下面就说实际遇到的场景：&lt;/p&gt;
&lt;p&gt;因为在Activity A中的&lt;code&gt;onDestroy&lt;/code&gt;方法中调用了关闭会话，并将一个全局的状态值修改为非法值，而在&lt;code&gt;onCreate&lt;/code&gt;方法中是重新初始化这个状态值。因为生命周期方法调用顺序在不同的系统上实现的差异，而导致这个状态值设置OK后，又被修改成非法值，从而使发送消息出去的报名格式发生变化，而服务器端在接收这个程序性错误后没有异常反馈，而终端则认为是服务器端没有响应而当作超时处理，所以发送失败。&lt;/p&gt;
&lt;p&gt;从上面现象可以看出系统后台设计人员并没有对这些程序性非业务逻辑性错误作出错误反馈，而后台有没有Log记录呢？&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;前几天在解决应用中一个问题，现象是在nexus 7.0以上系统的手机上创建群组会话时，消息发送超时。然后测试了一上，发现是必现的，而4.4系统的手机上却一切正常，于是一路分析了别人写的代码。最后找到原因并解决，于是就有了本文。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;最后找到原因是在Android系统7.0以上，当把Activity的&lt;code&gt;launchMode&lt;/code&gt;属性值设置为&lt;code&gt;singleTop&lt;/code&gt;时，Activity的生命周期与以前的系统版本对应的生命周期有所不同。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="singleTop android7.0" scheme="http://www.jacpy.com/tags/singleTop-android7-0/"/>
    
  </entry>
  
  <entry>
    <title>公交站点线路自定义View分享</title>
    <link href="http://www.jacpy.com/2016/09/17/share-bus-line-custom-view.html"/>
    <id>http://www.jacpy.com/2016/09/17/share-bus-line-custom-view.html</id>
    <published>2016-09-17T04:23:19.000Z</published>
    <updated>2016-09-17T05:18:07.000Z</updated>
    
    <content type="html">&lt;p&gt;分享一个仿《车来了》公交线路提示的自定义组件。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;先上效果图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/jacpy/BusLine/blob/master/captures/bus_line.gif?raw=true&quot; alt=&quot;效果图&quot;&gt;&lt;/p&gt;
&lt;p&gt;github地址：&lt;a href=&quot;https://github.com/jacpy/BusLine&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/jacpy/BusLine&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;用工具分析了官方的实现，使用的是google提供的v4包中的RecycleView来实现的，所以会看到各种View叠加。&lt;/p&gt;
&lt;p&gt;上面View实现方式是使用自定义View的方式，使用了绘图方面的API和滑动手势控制，还实现了站点点击事件控制。所以整个就一个View，也就不存在View回收的问题。另外要注意在View中调用次数比较频繁的方法中要注意性能，比如onDraw()方法中，刷的次数非常频繁，特别是在滑动的时候，而这个方法又是一个关键的处理方法，计算特别多，所以这里要注意，否则方法运行时间超过16ms就会造成卡顿。&lt;/p&gt;
&lt;p&gt;经过测试：在2013年的机型MOTO G XT1032机子上运行，同时刷新96个公交站点数据，onDraw()方法耗时平均7ms左右。&lt;/p&gt;
&lt;p&gt;后面会写文章分析下实现方式及遇到的坑和解决方案。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;分享一个仿《车来了》公交线路提示的自定义组件。&lt;/p&gt;
    
    </summary>
    
      <category term="android view" scheme="http://www.jacpy.com/categories/android-view/"/>
    
    
      <category term="自定义View 公交线路" scheme="http://www.jacpy.com/tags/%E8%87%AA%E5%AE%9A%E4%B9%89View-%E5%85%AC%E4%BA%A4%E7%BA%BF%E8%B7%AF/"/>
    
  </entry>
  
  <entry>
    <title>React Native iOS集成说明</title>
    <link href="http://www.jacpy.com/2016/09/06/react-native-ios-integrated.html"/>
    <id>http://www.jacpy.com/2016/09/06/react-native-ios-integrated.html</id>
    <published>2016-09-06T03:52:54.000Z</published>
    <updated>2016-09-06T08:57:47.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;本文主要是记录将React Native集成到现有项目的说明步骤及中间遇到的一些坑的记录。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;一、模板生成&quot;&gt;&lt;a href=&quot;#一、模板生成&quot; class=&quot;headerlink&quot; title=&quot;一、模板生成&quot;&gt;&lt;/a&gt;一、模板生成&lt;/h3&gt;&lt;p&gt;假如你的PC已经安装好了React Native环境，只需要在命令行执行以下命令即可以生成模板：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$react-native init RNDemo&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中RNDemo是项目名称，这里确保与你现在的项目名称一致。&lt;/p&gt;
&lt;p&gt;生成好模板后，cd到RNDemo/ios/目录中，将该目录下的所有文件都删除，然后将现有项目所有文件复制到ios目录中。&lt;/p&gt;
&lt;hr&gt;
&lt;h3 id=&quot;二、环境配置&quot;&gt;&lt;a href=&quot;#二、环境配置&quot; class=&quot;headerlink&quot; title=&quot;二、环境配置&quot;&gt;&lt;/a&gt;二、环境配置&lt;/h3&gt;&lt;h4 id=&quot;2-1-添加项目库&quot;&gt;&lt;a href=&quot;#2-1-添加项目库&quot; class=&quot;headerlink&quot; title=&quot;2.1 添加项目库&quot;&gt;&lt;/a&gt;2.1 添加项目库&lt;/h4&gt;&lt;p&gt;使用xcode打开现有项目，将以下库添加到项目中：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;react-native/React/React.xcodeproj&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;react-native/Libraries/Network/RCTNetwork.xcodeproj&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;react-native/Libraries/Text/RCTText.xcodeproj&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;react-native/Libraries/WebSocket/RCTWebSocket.xcodeproj&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;react-native/Libraries/ActionSheetIOS/RCTActionSheet.xcodeproj&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;添加方法如下图所示：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/xcode_config_project_library.png&quot; alt=&quot;xcode配置&quot;&gt;&lt;br&gt;在弹出的窗口的右下角点击&lt;code&gt;Add Others...&lt;/code&gt;按钮，在弹出的窗口中选择上面相应目录下的&lt;code&gt;.xcodeproj&lt;/code&gt;文件，将项目库包含进来。操作完成后，需要再次点击&lt;code&gt;+&lt;/code&gt;号，将静态库都包含进来，如下图所示：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/xcode_config_add_static_library.png&quot; alt=&quot;xcode添加静态库&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h4 id=&quot;2-2-添加配置&quot;&gt;&lt;a href=&quot;#2-2-添加配置&quot; class=&quot;headerlink&quot; title=&quot;2.2 添加配置&quot;&gt;&lt;/a&gt;2.2 添加配置&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;如下配置如果已经配置过，则可以跳过。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;1）搜索头文件地址配置&lt;br&gt;头文件搜索路径配置如下所示：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/xcode_config_head_search_path.png&quot; alt=&quot;头文件目录搜索路径配置&quot;&gt;&lt;br&gt;双击&lt;code&gt;Header Search Path&lt;/code&gt;右侧区域即可显示弹出的层，双击其中的行，则进入编辑模式。&lt;/p&gt;
&lt;p&gt;其中&lt;code&gt;$(SRCROOT)&lt;/code&gt;为当前项目路径，可以理解为&lt;code&gt;.xcodeproj&lt;/code&gt;文件所在的路径，&lt;code&gt;../node_modules&lt;/code&gt;表示的是与ios同级目录的node_moduels目录。&lt;/p&gt;
&lt;p&gt;2）启用HTTP配置&lt;br&gt;点击项目中的info.plist文件（注意是项目的plist文件，不是Tests中的），在右侧增加如下图所示的配置：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/plist_add_http.png&quot; alt=&quot;启用HTTP配置&quot;&gt;&lt;br&gt;如果没有启用，运行时会提示如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;App Transport Security has blocked a cleartext HTTP (http://) resource load since it is insecure. &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Temporary exceptions can be configured via your app&amp;apos;s Info.plist file.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3）支持C++编译&lt;br&gt;添加C++编译支持如下图所示：&lt;br&gt;&lt;img src=&quot;/images/2016/09/06/other_linker_flag_support_cpp.png&quot; alt=&quot;添加C++编译支持&quot;&gt;&lt;br&gt;添加方法与上面添加&lt;code&gt;Header Search Path&lt;/code&gt;类似。&lt;br&gt;如果没有添加&lt;code&gt;-lc++&lt;/code&gt;，编译会报如下所示错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Undefined symbols for architecture x86_64:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;std::terminate()&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      ___clang_call_terminate in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;operator delete[](void*)&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJSCExecutor dealloc] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      executeRandomAccessModule(RCTJSCExecutor*, unsigned int, unsigned long, unsigned long) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      readRAMBundle(std::__1::unique_ptr&amp;lt;__sFILE, int (*)(__sFILE*)&amp;gt;, RandomAccessBundleData&amp;amp;) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      RandomAccessBundleData::~RandomAccessBundleData() in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;operator new[](unsigned long)&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      executeRandomAccessModule(RCTJSCExecutor*, unsigned int, unsigned long, unsigned long) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      readRAMBundle(std::__1::unique_ptr&amp;lt;__sFILE, int (*)(__sFILE*)&amp;gt;, RandomAccessBundleData&amp;amp;) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;___cxa_begin_catch&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      ___clang_call_terminate in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;___gxx_personality_v0&amp;quot;, referenced from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJavaScriptContext initWithJSContext:onThread:] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJavaScriptContext init] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJavaScriptContext invalidate] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      RCTNSErrorFromJSError(RCTJSCWrapper*, OpaqueJSContext const*, OpaqueJSValue const*) in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      +[RCTJSCExecutor runRunLoopThread] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJSCExecutor init] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      -[RCTJSCExecutor initWithUseCustomJSCLibrary:] in libReact.a(RCTJSCExecutor.o)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ld: symbol(s) not found for architecture x86_64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clang: error: linker command failed with exit code 1 (use -v to see invocation)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果没有添加&lt;code&gt;-ObjC&lt;/code&gt;，运行则会报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[error][tid:com.facebook.react.JavaScript] Native module cannot be null.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[error][tid:com.facebook.react.JavaScript] Requiring module &amp;quot;193&amp;quot;, name:InitializeJavaScriptAppEngine, which threw an exception.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RNDemo[13446:1473714] -[RCTRootView reactTag]: unrecognized selector sent to instance 0x7ff670d14de0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RNDemo[13446:1473714] *** Terminating app due to uncaught exception &amp;apos;NSInvalidArgumentException&amp;apos;, reason: &amp;apos;-[RCTRootView reactTag]: unrecognized selector sent to instance 0x7ff670d14de0&amp;apos;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可能提示的module Id不一样，导致的原因是一样的。在这里卡了很久:(。&lt;/p&gt;
&lt;hr&gt;
&lt;h3 id=&quot;三、增加代码&quot;&gt;&lt;a href=&quot;#三、增加代码&quot; class=&quot;headerlink&quot; title=&quot;三、增加代码&quot;&gt;&lt;/a&gt;三、增加代码&lt;/h3&gt;&lt;p&gt;在已有项目的启动配置位置，如&lt;code&gt;AppDelegate.m&lt;/code&gt;文件中增加上面没有删除的&lt;code&gt;AppDelegate.m&lt;/code&gt;文件中的代码，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#import &amp;quot;AppDelegate.h&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#import &amp;quot;RCTBundleURLProvider.h&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#import &amp;quot;RCTRootView.h&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;@implementation AppDelegate&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  NSURL *jsCodeLocation;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  [[RCTBundleURLProvider sharedSettings] setDefaults];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  jsCodeLocation = [[RCTBundleURLProvider sharedSettings] jsBundleURLForBundleRoot:@&amp;quot;index.ios&amp;quot; fallbackResource:nil];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  RCTRootView *rootView = [[RCTRootView alloc] initWithBundleURL:jsCodeLocation&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                                      moduleName:@&amp;quot;RNDemo&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                               initialProperties:nil&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                                   launchOptions:launchOptions];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  rootView.backgroundColor = [[UIColor alloc] initWithRed:1.0f green:1.0f blue:1.0f alpha:1];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  self.window = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  UIViewController *rootViewController = [UIViewController new];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  rootViewController.view = rootView;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  self.window.rootViewController = rootViewController;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  [self.window makeKeyAndVisible];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  return YES;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;@end&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意：&lt;code&gt;index.ios&lt;/code&gt;就是模板在RNDemo目录下生成的&lt;code&gt;index.ios.js&lt;/code&gt;文件，moduleName&lt;code&gt;RNDemo&lt;/code&gt;是项目的名称，这里要替换成刚开始初始化模板的命令的项目名称。&lt;/p&gt;
&lt;p&gt;最后，按cmd + r后，会自动启动React Native服务，可以看到运行效果。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;本文主要是记录将React Native集成到现有项目的说明步骤及中间遇到的一些坑的记录。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://www.jacpy.com/categories/iOS/"/>
    
    
      <category term="React Native" scheme="http://www.jacpy.com/tags/React-Native/"/>
    
  </entry>
  
  <entry>
    <title>chrome浏览器启动android应用并传递参数</title>
    <link href="http://www.jacpy.com/2016/06/27/chrome_open_android_app.html"/>
    <id>http://www.jacpy.com/2016/06/27/chrome_open_android_app.html</id>
    <published>2016-06-27T04:56:08.000Z</published>
    <updated>2016-06-27T05:05:31.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;本文档主要介绍如何在android手机的chrome浏览器中点击一个链接，然后启动一个本地的App，并使用App中的具有浏览器功能的界面，如包信有WebView的Activity，打开一个链接。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;协议介绍&quot;&gt;&lt;a href=&quot;#协议介绍&quot; class=&quot;headerlink&quot; title=&quot;协议介绍&quot;&gt;&lt;/a&gt;协议介绍&lt;/h2&gt;&lt;p&gt;这种打开方式要浏览器支持这种协议，比如chrome浏览器，然后浏览器根据协议来做指定的事情。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;协议格式如下所示：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;intent:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   HOST/URI-path // Optional host &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   #Intent; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      package=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      action=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      category=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      component=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      scheme=[string]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   end;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;参数说明：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;HOST: 对应intent-filter标签中的data标签中的&lt;code&gt;android:host&lt;/code&gt;属性说明；&lt;/li&gt;
&lt;li&gt;scheme：对应intent-filter标签中的data标签中的&lt;code&gt;android:scheme&lt;/code&gt;属性说明；&lt;/li&gt;
&lt;li&gt;package：打开的App的包名；&lt;/li&gt;
&lt;li&gt;action：接收处理这个Intent的action，可选；&lt;/li&gt;
&lt;li&gt;category：接收处理Intnet的category，可选；&lt;/li&gt;
&lt;li&gt;component：接收处理Intent的component，可选；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上面这些参数对应java的代码如下所示：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Intent intent = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Intent(&lt;span class=&quot;string&quot;&gt;&quot;action&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;intent.setData(Uri.pase(&lt;span class=&quot;string&quot;&gt;&quot;host&quot;&lt;/span&gt;));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;intent.addCategory(&lt;span class=&quot;string&quot;&gt;&quot;category&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;intent.setComponent(&lt;span class=&quot;string&quot;&gt;&quot;component&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;context.startActivity(intent);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;上面部分参数对应的在AndroidManifest.xml文件中的Activity中的配置如下所示：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;activity&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;com.jacpy.app.ui.WebViewActivity&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:screenOrientation&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;portrait&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:theme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;@android:style/Theme.Black.NoTitleBar&quot;&lt;/span&gt;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;intent-filter&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.action.VIEW&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.category.DEFAULT&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.category.BROWSABLE&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:scheme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;scheme&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:host&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;host&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;intent-filter&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;activity&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;上面的这些说明只是说要如何利用这些参数启动这个指定的App的Activity，接下来是说明如何将一些参数信息传递给这个指定的Activity，由这个Activity来处理一些指定的操作，比如打开一个链接。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;传递的参数类型在java中有9种类型，分别是String(S)、Boolean(B)、Byte(b)、Character(c)、Double(d)、Float(f)、Integer(i)、Long(l)、Short(s)，注意后面括号中的字母及大小写。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;比如要传一个字符串，可以写成如下所示：&lt;/p&gt;
&lt;p&gt;S.url=&lt;a href=&quot;http://www.baidu.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.baidu.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;键是&lt;code&gt;url&lt;/code&gt;，值是&lt;code&gt;http://www.baidu.com&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;传一个int值，可以写成这样：&lt;/p&gt;
&lt;p&gt;i.age=30&lt;/p&gt;
&lt;p&gt;键是&lt;code&gt;age&lt;/code&gt;，值是&lt;code&gt;30&lt;/code&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;这种传递方式对应的java代码如下所示：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;intent.putExtra(&lt;span class=&quot;string&quot;&gt;&quot;url&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;http://www.baidu.com&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;intnet.putExtra(&lt;span class=&quot;string&quot;&gt;&quot;age&quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;注意：&lt;code&gt;S.browser_fallback_url&lt;/code&gt;是chrome保留的内容，在手机安装了chrome 25以上版本，启动了包含有&lt;code&gt;S.browser_fallback_url&lt;/code&gt;信息的协议，如果手机中没有安装指定包名的App那么，就会跳转到&lt;code&gt;S.browser_fallback_url&lt;/code&gt;指定的链接，这个链接一般是放App的下载地址。在实际测试是，手机中不能安装Google Play，否则会打开google Play。而不会执行&lt;code&gt;S.browser_fallback_url&lt;/code&gt;这个跳转。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;实现&quot;&gt;&lt;a href=&quot;#实现&quot; class=&quot;headerlink&quot; title=&quot;实现&quot;&gt;&lt;/a&gt;实现&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;按照上面的协议说明可以自定义协议，如下所示：&lt;br&gt;intent://msp.url/#Intent;scheme=msp;package=com.jacpy.app;S.browser_fallback_url=&lt;a href=&quot;http://www.taobao.com/app/download;S.url=http://www.baidu.com;S.title=chrome启动应用测试;end&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.taobao.com/app/download;S.url=http://www.baidu.com;S.title=chrome启动应用测试;end&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;上面示例协议中，如果手机上没有安装包名为&lt;code&gt;com.jacpy.app&lt;/code&gt;的应用，并且手机上没有安装google play，那么最后页面会跳转到&lt;code&gt;http://wwww.taobao.com/app/download&lt;/code&gt;。&lt;br&gt;协议可以写在a标签中，如：&lt;/p&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;href&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;\&lt;/span&gt;&quot;&lt;span class=&quot;attr&quot;&gt;intent:&lt;/span&gt;//&lt;span class=&quot;attr&quot;&gt;msp.url&lt;/span&gt;/#&lt;span class=&quot;attr&quot;&gt;Intent&lt;/span&gt;;&lt;span class=&quot;attr&quot;&gt;scheme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;msp;package&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;com.jacpy.app;S.browser_fallback_url&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;http://www.taobao.com/app/download;S.url&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;http://www.baidu.com;S.title&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;chrome启动应用测试;end\&lt;/span&gt;&quot;&amp;gt;&lt;/span&gt;chrome启动应用测试&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;a&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;对应的Activity配置代码如下所示：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;manifest&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;xmlns:android&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;http://schemas.android.com/apk/res/android&quot;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;package&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;com.jacpy.app&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:versionCode&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:versionName&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;2.0.0.0&quot;&lt;/span&gt; &amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;application&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;com.jacpy.app.app.App&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;android:allowBackup&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;android:icon&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;@drawable/logo&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;android:label&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;@string/app_name&quot;&lt;/span&gt; &amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;activity&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;com.jacpy.app.ui.WebViewActivity&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;attr&quot;&gt;android:screenOrientation&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;portrait&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;attr&quot;&gt;android:theme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;@android:style/Theme.Black.NoTitleBar&quot;&lt;/span&gt;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;intent-filter&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.action.VIEW&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.category.DEFAULT&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;category&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;android.intent.category.BROWSABLE&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:scheme&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;msp&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;android:host&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;msp.url&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;intent-filter&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;activity&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;application&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;manifest&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;这里要注意，如果当前应用已经启动，点击跳转链接，浏览器是不会启动相应的界面打开链接，可以对当前Activity设置&lt;code&gt;android:launchMode=&amp;quot;singleInstance&amp;quot;&lt;/code&gt;试试。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;协议传递数据解析处理&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; com.jacpy.app.ui;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;WebViewActivity&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Activity&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Bundle b)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onCreate(b);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Intent data = getIntent();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String url = data.getStringExtra(&lt;span class=&quot;string&quot;&gt;&quot;url&quot;&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// 要跳转的链接&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String title = data.getStringExtra(&lt;span class=&quot;string&quot;&gt;&quot;title&quot;&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// 标题内容&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最后，这种通过浏览器打开应用的方式只在实现了类似机制的浏览器上使用，如chrome浏览器。通过测试其他如QQ浏览器的6.6版本也支持该方式，但UC、Opera、海豚浏览器均不支持该操作。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.&lt;a href=&quot;https://developer.chrome.com/multidevice/android/intents&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://developer.chrome.com/multidevice/android/intents&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2.&lt;a href=&quot;http://drops.wooyun.org/papers/2893&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://drops.wooyun.org/papers/2893&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;– EOF –&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;本文档主要介绍如何在android手机的chrome浏览器中点击一个链接，然后启动一个本地的App，并使用App中的具有浏览器功能的界面，如包信有WebView的Activity，打开一个链接。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="chrome" scheme="http://www.jacpy.com/tags/chrome/"/>
    
  </entry>
  
  <entry>
    <title>android应用开发常见的坑</title>
    <link href="http://www.jacpy.com/2016/05/10/android-app-develop-familiar-trap.html"/>
    <id>http://www.jacpy.com/2016/05/10/android-app-develop-familiar-trap.html</id>
    <published>2016-05-10T13:32:56.000Z</published>
    <updated>2016-07-15T06:44:15.000Z</updated>
    
    <content type="html">&lt;p&gt;android应用开发过程中，总会遇到一些坑。当遇到这些坑马上反应过来时，会很快解决。而没有反应过来时，估计是要折腾半天，下面记录一些这样的坑，防止自己遗忘再犯同样的错，自己以后再遇到类似的问题，也在这里记录下来。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;1.&lt;code&gt;context.startActivityForResult(intent, int)&lt;/code&gt;第二个参数int值要为大于0，并且不大于65535。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果为不大于0，则不会回调到Activity的&lt;code&gt;onActivityResult()&lt;/code&gt;方法。如果大于&lt;code&gt;65535&lt;/code&gt;为提示如下错误：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Caused by: java.lang.IllegalArgumentException: Can only use lower 16 bits for requestCode&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.support.v4.app.FragmentActivity.startActivityForResult(FragmentActivity.java:840)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;出现这种问题只有在Activity继承了&lt;code&gt;android.support.v4.app.FragmentActivity&lt;/code&gt;的时候才会出现，而继承&lt;code&gt;android.app.Activity&lt;/code&gt;的时候不会。所以为了不必要的麻烦，还是建议使用requestCode的值要不大于&lt;code&gt;65535&lt;/code&gt;。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;因为在同一个Activity和其中的Fragment都使用到了&lt;code&gt;onActivityResult()&lt;/code&gt;方法，为了避免Activity的requestCode不与Fragment冲突，所以就使用了&lt;code&gt;Integer.MAX_VALUE&lt;/code&gt;，结果就导致了上面的异常。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;2.重写Activity的&lt;code&gt;onActivityResult()&lt;/code&gt;方法时，如果在该Activity中使用了Fragment，并且重写了Fragment的&lt;code&gt;onActivityResult()&lt;/code&gt;方法，此时一定要在Activity的&lt;code&gt;onActivityResult()&lt;/code&gt;方法中调用&lt;code&gt;super.onActivityResult()&lt;/code&gt;，否则Fragment的&lt;code&gt;onActivityResult()&lt;/code&gt;方法不会被回调。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;3.在Fragment切换的布局中使用了FrameLayout后，为了能切换更快，使用了&lt;code&gt;FragmentTransaction.hide()&lt;/code&gt;方法，将已经初始化的Fragment隐藏，而没有使用&lt;code&gt;FragmentTransaction.replace()&lt;/code&gt;方法。其中有一个Fragment中的布局文件中的内容没有超过一屏，在点击底部空白的地方，会点击之前已经隐藏的Fragment的中布局文件中的组件。归根倒底是由于FrameLayout布局影响的，最快的解决办法是在内容没有超过一屏的布局文件中的根ViewGroup中设置`android:clickable=”false”即可，当然网上说重写onTouchEvent()方法，可以试试。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;4.在给ListView调用&lt;code&gt;addHeader()&lt;/code&gt;方法添加头部时，一定要在调用&lt;code&gt;setAdapter()&lt;/code&gt;方法之前调用，否则会出现如下错误， 这个错误&lt;code&gt;在android 4.4以前的系统会存在，4.4及以后的系统中修复了这个问题&lt;/code&gt;。错误提示也很明显：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;java.lang.IllegalStateException: Cannot add header view to list -- setAdapter has already been called.at android.widget.ListView.addHeaderView(ListView.java:&lt;span class=&quot;number&quot;&gt;261&lt;/span&gt;)at android.widget.ListView.addHeaderView(ListView.java:&lt;span class=&quot;number&quot;&gt;290&lt;/span&gt;)&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;at android.support.v4.app.Fragment.performCreateView(Fragment.java:&lt;span class=&quot;number&quot;&gt;1962&lt;/span&gt;)at android.support.v4.app.FragmentManagerImpl.moveToState(FragmentManager.java:&lt;span class=&quot;number&quot;&gt;1026&lt;/span&gt;)at android.support.v4.app.FragmentManagerImpl.moveToState(FragmentManager.java:&lt;span class=&quot;number&quot;&gt;1207&lt;/span&gt;)at android.support.v4.app.BackStackRecord.run(BackStackRecord.java:&lt;span class=&quot;number&quot;&gt;738&lt;/span&gt;)at android.support.v4.app.FragmentManagerImpl.execPendingActions(FragmentManager.java:&lt;span class=&quot;number&quot;&gt;1572&lt;/span&gt;)at android.support.v4.app.FragmentManagerImpl$&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;.run(FragmentManager.java:&lt;span class=&quot;number&quot;&gt;493&lt;/span&gt;)at android.os.Handler.handleCallback(Handler.java:&lt;span class=&quot;number&quot;&gt;800&lt;/span&gt;)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;android应用开发过程中，总会遇到一些坑。当遇到这些坑马上反应过来时，会很快解决。而没有反应过来时，估计是要折腾半天，下面记录一些这样的坑，防止自己遗忘再犯同样的错，自己以后再遇到类似的问题，也在这里记录下来。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="android" scheme="http://www.jacpy.com/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>微信支付返回code为-1解决方法之一</title>
    <link href="http://www.jacpy.com/2016/05/10/weixin-pay-return-code-1.html"/>
    <id>http://www.jacpy.com/2016/05/10/weixin-pay-return-code-1.html</id>
    <published>2016-05-10T13:28:57.000Z</published>
    <updated>2016-05-10T13:38:50.000Z</updated>
    
    <content type="html">&lt;p&gt;这两天在集成微信支付的功能，先是客户在插件中集成支付功能，后来发现回调不起来，于是将支付功能集成到了主应用，然后暴露接口给插件使用。费劲几个小时的折腾，于是乎就有下文。&lt;/p&gt;
&lt;p&gt;我们先来看下官网对于code为-1的说明（官网说明地址&lt;a href=&quot;http://kf.qq.com/faq/140225MveaUz150413VNj6nm.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;点这里&lt;/a&gt;）：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;开放平台配置的报名和应用签名是否一致：（android）；确认是否使用正式的keystore打包apk并安装调试；（android）；提交订单部分需要在服务器端完成。&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;先请仔细阅读，你遇到的问题就在这段描述中。其中注意，中间还错别字&lt;code&gt;报名&lt;/code&gt;应为&lt;code&gt;包名&lt;/code&gt;（鹅厂果然不一样）。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;下面开始说说事情的经过和结果：&lt;/p&gt;
&lt;p&gt;公司这里给客户做了一个应用，客户那边的业务扩展使用插件的方式开发，然后集成到主应用中来。由于客户业务中需要支付功能，而且在插件中支付功能不能正常运行，于是我这边就将插件中的支付集成到主应用中，然后给接口让插件调用。使用这种方式集成完后，我测试了一遍，支付宝支付OK，微信支付也OK。于是跟他们说集成好了，可以用了。&lt;/p&gt;
&lt;p&gt;客户那边测试使用的时候反馈，微信支付只能支付成功一次，第二次就不行了。于是乎，我这边也试了下，果然，第二次支付不成功。一看输出的LOG，回调的code返回-1。&lt;/p&gt;
&lt;p&gt;为了解决这个问题与客户进行了沟通，客户说是我集成的问题，说他们写了一个测试的demo，连续支付两次都没有问题。好吧，我自己寻找问题的解决方案。我很确信自己的代码集成没有问题，那部分代码也是来自客户写的支付代码。如果客户写的代码有问题，就不可能连续支付两次都OK。&lt;/p&gt;
&lt;p&gt;于是找到了前面的官方回调后返回code为-1的说明，当时也只是读了一遍，没深究，因为我觉得问题原因都不是，毕竟还支付成功过一次。&lt;/p&gt;
&lt;p&gt;最后去反编译看微信SDK的代码，支寻找为什么会返回-1，突然看到代码里面的getPackageName()时，想到了包名，回忆起之前集成微信第三方登录时绑定的包名和签名信息，突然大悟，是不是和包名有关？客户测试的demo包名和主应用的包名是不一样的。于是跟客户沟通，看了一下支付微信的后台配置，叫对方把包名改成主应用的包名，结果测试，支付两次OK。好吧，问题找到了。&lt;/p&gt;
&lt;p&gt;回想起整个问题解决过程，还是插件开发惹的祸。但中间种种不正常让人生疑，如果包名不对，为什么还能在清除应用缓存之后能支付成功？其实当时我应该就要反应过来，有谁会做成这种支付的时候还要清除缓存就能支付成功的？体验做成这样，还叫BAT？可能这个提示是官方支付demo里面的提示，集成的时候直接拿过来用了吧。&lt;/p&gt;
&lt;p&gt;中间客户也有叫我检查一下是不是服务器的问题，用工具抓一下微信请求的包，如果返回的code为0，就是请求成功，返回其他值就是不正常，服务器端就有问题。让我先排除一下，结果是code返回0，服务器端OK，没有问题。也就是问题还是在客户端。&lt;/p&gt;
&lt;p&gt;刚开始是怀疑签名有问题，于是用官方的工具检测了下，发现签名最后生成的信息是一样的。这个疑问就排除了。只是当时没想到去排除包名的问题。唉，支付宝怎么就没有这样坑人的问题呢？&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这两天在集成微信支付的功能，先是客户在插件中集成支付功能，后来发现回调不起来，于是将支付功能集成到了主应用，然后暴露接口给插件使用。费劲几个小时的折腾，于是乎就有下文。&lt;/p&gt;
&lt;p&gt;我们先来看下官网对于code为-1的说明（官网说明地址&lt;a href=&quot;http://kf.qq.com/faq/140225MveaUz150413VNj6nm.html&quot;&gt;点这里&lt;/a&gt;）：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;开放平台配置的报名和应用签名是否一致：（android）；确认是否使用正式的keystore打包apk并安装调试；（android）；提交订单部分需要在服务器端完成。&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;先请仔细阅读，你遇到的问题就在这段描述中。其中注意，中间还错别字&lt;code&gt;报名&lt;/code&gt;应为&lt;code&gt;包名&lt;/code&gt;（鹅厂果然不一样）。&lt;/p&gt;
    
    </summary>
    
      <category term="pay" scheme="http://www.jacpy.com/categories/pay/"/>
    
    
      <category term="微信支付返回code为-1" scheme="http://www.jacpy.com/tags/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E8%BF%94%E5%9B%9Ecode%E4%B8%BA-1/"/>
    
  </entry>
  
  <entry>
    <title>gradle build报错：Please correct the above warnings first解决方案</title>
    <link href="http://www.jacpy.com/2016/05/10/gradle-build-Please-correct-the-above-warnings-first.html"/>
    <id>http://www.jacpy.com/2016/05/10/gradle-build-Please-correct-the-above-warnings-first.html</id>
    <published>2016-05-10T13:25:04.000Z</published>
    <updated>2016-05-10T13:41:08.000Z</updated>
    
    <content type="html">&lt;p&gt;gradle在build混淆后的代码时，会出现如下错误提示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Warning: there were 2 unresolved references to library class members.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         You probably need to update the library versions.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         Alternatively, you may have to specify the option &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         &amp;apos;-dontskipnonpubliclibraryclassmembers&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         (http://proguard.sourceforge.net/manual/troubleshooting.html#unresolvedlibraryclassmember)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Warning: Exception while processing task java.io.IOException: Please correct the above warnings first.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:app:transformClassesAndResourcesWithProguardForRelease FAILED&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FAILURE: Build failed with an exception.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* What went wrong:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Execution failed for task &amp;apos;:app:transformClassesAndResourcesWithProguardForRelease&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; java.io.IOException: Please correct the above warnings first.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;上面提示编译过程中出现了warning，要求修复，所以停止了编译。按照上面的提示在混淆配置文件&lt;code&gt;proguard-rules.pro&lt;/code&gt;中增加&lt;code&gt;-dontskipnonpubliclibraryclassmembers&lt;/code&gt;项，也不会起作用。只能按上面提示寻找warings，如下Log中的中间两行&lt;code&gt;Waring&lt;/code&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Note: the configuration refers to the unknown class &amp;apos;com.alipay.mobile.security.senative.APSE&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Warning: com.baidu.platform.comapi.map.e: can&amp;apos;t find referenced method &amp;apos;float sqrt(float)&amp;apos; in library class android.util.FloatMath&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Warning: com.tencent.connect.avatar.c: can&amp;apos;t find referenced method &amp;apos;float sqrt(float)&amp;apos; in library class android.util.FloatMath&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: android.support.v4.text.ICUCompatIcs: can&amp;apos;t find dynamically referenced class libcore.icu.ICU&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;中间两行&lt;code&gt;Warning&lt;/code&gt;是分别使用了百度地图的jar包和QQ第三方登录的jar包，其中使用了FloatMath.sqrt()这个方法后，编译时找不到，原因是使用了android 6.0的jar包去编译。通过查看源代码，发现源码里面有这个方法的实现，但反编译SDK中的&lt;code&gt;android.jar&lt;/code&gt;时，发现里面没有实现，坑！&lt;/p&gt;
&lt;p&gt;之前一直没有使用android 23编译代码，现在项目要兼容6.0，就使用了6.0的编译环境，结果就出现了这样的错。唉，各种坑啊！&lt;/p&gt;
&lt;p&gt;不啰嗦了，上解决方案。&lt;/p&gt;
&lt;p&gt;在&lt;code&gt;proguard-rules.pro&lt;/code&gt;文件中增加如下所示的配置：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;-dontwarn com.baidu.**&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;-dontwarn com.tencent.**&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;以后遇上这种waring，都可以这样做，&lt;code&gt;-dontwarn&lt;/code&gt;是混淆参数，&lt;code&gt;com.xxx&lt;/code&gt;是包名，也就是忽略这个包名下面的waring。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;gradle在build混淆后的代码时，会出现如下错误提示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Warning: there were 2 unresolved references to library class members.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         You probably need to update the library versions.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         Alternatively, you may have to specify the option &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         &amp;apos;-dontskipnonpubliclibraryclassmembers&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         (http://proguard.sourceforge.net/manual/troubleshooting.html#unresolvedlibraryclassmember)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Warning: Exception while processing task java.io.IOException: Please correct the above warnings first.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:app:transformClassesAndResourcesWithProguardForRelease FAILED&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FAILURE: Build failed with an exception.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* What went wrong:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Execution failed for task &amp;apos;:app:transformClassesAndResourcesWithProguardForRelease&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; java.io.IOException: Please correct the above warnings first.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="gradle" scheme="http://www.jacpy.com/categories/gradle/"/>
    
    
      <category term="Please correct the above warnings first" scheme="http://www.jacpy.com/tags/Please-correct-the-above-warnings-first/"/>
    
  </entry>
  
  <entry>
    <title>gardle编译排除第三方库中的arm64、x86-64中的SO库</title>
    <link href="http://www.jacpy.com/2016/05/10/gradle-compile-exclude-third-library-arm64-x86-64.html"/>
    <id>http://www.jacpy.com/2016/05/10/gradle-compile-exclude-third-library-arm64-x86-64.html</id>
    <published>2016-05-10T13:20:16.000Z</published>
    <updated>2016-09-06T02:53:34.000Z</updated>
    
    <content type="html">&lt;p&gt;在开发android应用时，一般都会用很多的第三方框架。有些框架会提供各个CPU的架构的SO库，比如arm、arm-v7a、x86、mips，有的甚至还提供64位的版本；而有的为了缩小应用包的体积只提供了一些常用的，比如arm，x86。如果应用中有的第三方框架提供了arm和x86的版本，而有的提供了arm，arm-v7a，x86三个版本，那么当运行在arm-v7a版本的CPU上，就会提示找不到只有arm和x86版本的SO库，这样很容易导致应用挂掉，报&lt;code&gt;java.lang.UnsatisfiedLinkError&lt;/code&gt;错误，提示native方法找不到实现。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;按道理说arm-v7a的CPU会兼容arm版本，但系统去查找SO库的时候却只会在一个目录查找，找完了arm-v7a，没找到不会再去arm目录，这样就会导致兼容性问题。解决方法有两种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;一种是所有包含有SO库的第三方框架提供最新版本NDK支持的所有的CPU架构SO库，如：armeabi armeabi-v7a x86 mips arm64-v8a x86_64 mips64或者在编译时在Application.mk文件中配置&lt;code&gt;APP_ABI := all&lt;/code&gt;。这样做一般不合适，这样会分散开发者的注意力。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;第二种方法是：应用中所有的包含SO库的第三方框架只能取最小的子集，这种方法比较合适集成第三方框架。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下面以facebook的fresco框架为例来说明第二种方法的操作方式。&lt;/p&gt;
&lt;p&gt;fresco框架中提供了各个CPU架构的SO库，包括64位的，而自己的应用其他第三方带有SO库的框架A还没有使用64位的SO库，如果不做处理，应用运行在64位手机上，当使用框架A的时候应用就会闪退，因为框架A没有64位的库。那么解决办法只有将fresco库的64位SO库都删除，只保留框架A的相同目录下面的SO库。下面是gradle文件中的配置：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile &amp;apos;com.facebook.fresco:fresco:0.8.1&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;// 将fresco库除armeabi和x86包以外的SO库删除&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;def deleteSO() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def rootPath = rootProject.getRootDir().getAbsolutePath() + &amp;apos;/&amp;apos; + project.name&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    delete fileTree(dir: rootPath + &amp;quot;/build/intermediates/exploded-aar/com.facebook.fresco/imagepipeline/&amp;quot; + &amp;quot;$FRESCO_LIB_VERSION&amp;quot; + &amp;quot;/jni/&amp;quot;, excludes: [&amp;apos;**/armeabi/**&amp;apos;, &amp;apos;**/x86/**&amp;apos;])&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;project.afterEvaluate&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    // debug模式下删除SO库&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tasks.getByName(&amp;apos;prepareDebugDependencies&amp;apos;) &amp;#123; // Hook prepareDebugDependencies任务&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        it.doLast &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            // prepareDebugDependencies任务执行完成后删除SO库&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            deleteSO()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    // 打包的时候删除SO库&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tasks.getByName(&amp;apos;prepareReleaseDependencies&amp;apos;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        it.doLast &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            deleteSO()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;2016-08-24修改&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另外还可以使用gradle中的过滤器，可以很方便过滤SO库：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;release &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	ndk &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		abiFilters &amp;quot;armeabi&amp;quot;, &amp;quot;armeabi-v7a&amp;quot;, &amp;quot;x86&amp;quot; // 保留这三种架构的CPU&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;要求gradle版本不低于2.14.1(可以修改项目根目录下的gradle/wrapper/目录下的gradle-wrapper.properties文件内容，将gradle请求地址中的版本号修改)，否则会提示如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Gradle DSL method not found: &amp;apos;abiFilter()&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Possible causes:The project &amp;apos;*&amp;apos; may be using a version of the Android Gradle plug-in that does not contain the method (e.g. &amp;apos;testCompile&amp;apos; was added in 1.1.0).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Fix plugin version and sync projectThe project &amp;apos;*&amp;apos; may be using a version of Gradle that does not contain the method.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Open Gradle wrapper fileThe build file may be missing a Gradle plugin.Apply Gradle plugin&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;在开发android应用时，一般都会用很多的第三方框架。有些框架会提供各个CPU的架构的SO库，比如arm、arm-v7a、x86、mips，有的甚至还提供64位的版本；而有的为了缩小应用包的体积只提供了一些常用的，比如arm，x86。如果应用中有的第三方框架提供了arm和x86的版本，而有的提供了arm，arm-v7a，x86三个版本，那么当运行在arm-v7a版本的CPU上，就会提示找不到只有arm和x86版本的SO库，这样很容易导致应用挂掉，报&lt;code&gt;java.lang.UnsatisfiedLinkError&lt;/code&gt;错误，提示native方法找不到实现。&lt;/p&gt;
    
    </summary>
    
      <category term="gradle" scheme="http://www.jacpy.com/categories/gradle/"/>
    
    
      <category term="gradle 不编译 arm64 x86-64" scheme="http://www.jacpy.com/tags/gradle-%E4%B8%8D%E7%BC%96%E8%AF%91-arm64-x86-64/"/>
    
  </entry>
  
  <entry>
    <title>android studio gradle编译异常小结</title>
    <link href="http://www.jacpy.com/2016/04/22/android-studio-error-collection.html"/>
    <id>http://www.jacpy.com/2016/04/22/android-studio-error-collection.html</id>
    <published>2016-04-22T08:22:30.000Z</published>
    <updated>2016-06-14T03:36:14.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;在使用android studio过程中，使用gradle编译的时候总会出现一些问题，下面是几个常见问题的解决方法。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;被编译的代码或资源有问题（ finished with non-zero exit value 1）：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;出现这种编译异常表现是&lt;code&gt;exit value 1&lt;/code&gt;，一般会给出错误提示，所以很容易排查。这种错误很常见，错误提示有时候是在日志中明显的给出来了，如下示例所示：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;:app:processDebugManifest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:app:processDebugResources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;\app\src\main\res\layout\activity_welcome.xml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error:(42, 26) No resource found that matches the given name (at &amp;apos;src&amp;apos; with value &amp;apos;@drawable/welcome_03&amp;apos;).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error:Execution failed for task &amp;apos;:app:processDebugResources&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;com.android.ide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.common.process.ProcessException: org.gradle.process.internal.ExecException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Process &amp;apos;command &amp;apos;D:\android-sdk-windows\build-tools\22.0.1\aapt.exe&amp;apos;&amp;apos; finished with non-zero exit value 1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面错误提示找不到welcome_03这个drawable资源。有时候没有明显的提示，如下面这种错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;:app:transformClassesWithMultidexlistForDebug UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:app:transformClassesWithDexForDebug FAILED&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error:Execution failed for task &amp;apos;:app:transformClassesWithDexForDebug&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; com.android.build.api.transform.TransformException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;com.android.ide.common.process.ProcessException: java.util.concurrent.ExecutionException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;com.android.ide.common.process.ProcessException: org.gradle.process.internal.ExecException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Process &amp;apos;command &amp;apos;C:\Program Files\Java\jdk1.7.0_79\bin\java.exe&amp;apos;&amp;apos; finished with non-zero exit value 1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面这种错误没有给出很显示的提示，但是可以知道是在执行&lt;code&gt;Error:Execution failed for task &amp;#39;:app:transformClassesWithDexForDebug&amp;#39;&lt;/code&gt;这一步出错了，至少缩小了错误的排查范围，这个时候就需要经验来判断了，自己之前改过什么，自己回想一下。有时候往上面看错误日志，也会发现有很明显的错误提示。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;jar包冲突（finished with non-zero exit value 2）：&lt;br&gt;主要表现为编译后出现&lt;strong&gt;finished with non-zero exit value 2&lt;/strong&gt;错误，原因是jar包冲突，导致的原因可能是在dependencies中使用compile files()导入一次jar包，然后有其它jar的引入方式使用compile’com.xxx’方式，正好又引用了这个jar包，所以导致了重复引用jar包的冲突。最常见的是support-v4包的重复引用。具体报错如下所示：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Error:Execution failed for task &amp;apos;:task:transformClassesWithDexForDebug&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;com.android.build.api.transform.TransformException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;com.android.ide.common.process.ProcessException: org.gradle.process.internal.ExecException:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Process &amp;apos;command &amp;apos;C:\Java\jdk1.7.0_79\bin\java.exe&amp;apos;&amp;apos; finished with non-zero exit value 2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;编译的代码过多导致内存不足（finished with non-zero exit value 3）：&lt;br&gt;主要表现为编译后出现&lt;strong&gt;finished with non-zero exit value 3&lt;/strong&gt;错误，原因是因为编译的java代码过多，通常是方法数超过65535后使用了分包的机制，gradle在编译的时候由于编译的内存需要不能满足而导致错误。具体报错内容如下所示：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Error:java.lang.OutOfMemoryError: GC overhead limit exceeded&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error:Execution failed for task &amp;apos;:app:transformClassesWithDexForRelease&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;com.android.build.api.transform.TransformException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;com.android.ide.common.process.ProcessException: java.util.concurrent.ExecutionException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;com.android.ide.common.process.ProcessException: org.gradle.process.internal.ExecException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Process &amp;apos;command &amp;apos;C:\Java\jdk1.7.0_79\bin\java.exe&amp;apos;&amp;apos; finished with non-zero exit value 3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;解决方案是在gradle文件中的android代码块内增加如下内容即可解决：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;android &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    // ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    dexOptions &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	javaMaxHeapSize &amp;quot;4g&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;或者修改android studio的安装目录下的bin目录中的studio.vmoptions文件中的&lt;code&gt;Xms&lt;/code&gt;和&lt;code&gt;Xmx&lt;/code&gt;两项，将其值改大，如下所示：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;-Xms256m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;-Xmx1280m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;出现这种情况的原因是因为项目太大，编译需要更多的内存。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;在使用android studio过程中，使用gradle编译的时候总会出现一些问题，下面是几个常见问题的解决方法。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;被编译的代码或资源有问题（ finished with non-zero exit value 1）：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;出现这种编译异常表现是&lt;code&gt;exit value 1&lt;/code&gt;，一般会给出错误提示，所以很容易排查。这种错误很常见，错误提示有时候是在日志中明显的给出来了，如下示例所示：&lt;/p&gt;
    
    </summary>
    
      <category term="android studio" scheme="http://www.jacpy.com/categories/android-studio/"/>
    
    
      <category term="transformClassesWithDexForDebug" scheme="http://www.jacpy.com/tags/transformClassesWithDexForDebug/"/>
    
  </entry>
  
  <entry>
    <title>AndFix加载补丁包过程分析</title>
    <link href="http://www.jacpy.com/2016/03/24/andfix-load-patch-analysis.html"/>
    <id>http://www.jacpy.com/2016/03/24/andfix-load-patch-analysis.html</id>
    <published>2016-03-24T06:42:58.000Z</published>
    <updated>2016-03-24T06:58:22.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;AndFix加载补丁包过程分析&quot;&gt;&lt;a href=&quot;#AndFix加载补丁包过程分析&quot; class=&quot;headerlink&quot; title=&quot;AndFix加载补丁包过程分析&quot;&gt;&lt;/a&gt;AndFix加载补丁包过程分析&lt;/h3&gt;&lt;p&gt;andfix提供了一套可以热替换java中原有方法的工具，在实际应用中可以用来热替换修复出现bug的方法，从而使用应用不需要升级应用就能解决部分问题。&lt;/p&gt;
&lt;p&gt;本文主要是分析运行在android应用中的一套工具环境，从java层到native层分析andfix框架热替换方法的过程。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h4 id=&quot;一、解析补丁包&quot;&gt;&lt;a href=&quot;#一、解析补丁包&quot; class=&quot;headerlink&quot; title=&quot;一、解析补丁包&quot;&gt;&lt;/a&gt;一、解析补丁包&lt;/h4&gt;&lt;p&gt;首先来看andfix初始化代码：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.alipay.euler.andfix.patch.PatchManager;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;App&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Application&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onCreate();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String patchPath = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        PatchManager patchManager = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; PatchManager(getApplicationContext());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        patchManager.init(&lt;span class=&quot;string&quot;&gt;&quot;1.0&quot;&lt;/span&gt;);&lt;span class=&quot;comment&quot;&gt;//current version&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        patchManager.addPatch(patchPath);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        patchManager.loadPatch();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;一般这段初始化代码是放在Application的onCreate()方法中，原因是应用启动时，尽早替换出现问题的方法，等到方法执行时再替换就无意义了。&lt;/p&gt;
&lt;p&gt;在PatchManager对象调用init(String)方法时，传入的版本号值很关键。如果是初次初始化或者版本号发生变化，那么会清空原来已经缓存的patch包，同时会缓存新的版本号；如果不是，则会加载已经缓存过的patch包并解析成Patch对象缓存到集合中。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * initialize&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt; appVersion&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; *            App version&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String appVersion)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mPatchDir.exists() &amp;amp;&amp;amp; !mPatchDir.mkdirs()) &amp;#123;&lt;span class=&quot;comment&quot;&gt;// make directory fail&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		Log.e(TAG, &lt;span class=&quot;string&quot;&gt;&quot;patch dir create error.&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mPatchDir.isDirectory()) &amp;#123;&lt;span class=&quot;comment&quot;&gt;// not directory&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		mPatchDir.delete();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	SharedPreferences sp = mContext.getSharedPreferences(SP_NAME,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			Context.MODE_PRIVATE);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	String ver = sp.getString(SP_VERSION, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ver == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; || !ver.equalsIgnoreCase(appVersion)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		cleanPatch();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		sp.edit().putString(SP_VERSION, appVersion).commit();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		initPatchs();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;addPatch(String)的功能是加载patch包，并将patch包缓存到应用的/data/data/packageName/files/apatch/目录下。如果该缓存目录下已存在，则不会重复缓存。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * add patch at runtime&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt; path&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; *            patch path&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@throws&lt;/span&gt; IOException&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;addPatch&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String path)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	File src = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; File(path);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	File dest = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; File(mPatchDir, src.getName());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(!src.exists())&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; FileNotFoundException(path);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (dest.exists()) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		Log.d(TAG, &lt;span class=&quot;string&quot;&gt;&quot;patch [&quot;&lt;/span&gt; + path + &lt;span class=&quot;string&quot;&gt;&quot;] has be loaded.&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	FileUtil.copyFile(src, dest);&lt;span class=&quot;comment&quot;&gt;// copy to patch&#39;s directory&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	Patch patch = addPatch(dest);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (patch != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		loadPatch(patch);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;patch包解析构造成Patch类对象时，主要是解析patch包中的META-INF/PATCH.MF文件，将该文件中的Patch-Classes项对应的值解析出来，在前面 &lt;a href=&quot;/2016/03/24/apkpatch-tool-analysis.html&quot;&gt;apkpatch工具实现分析&lt;/a&gt; 一文中有介绍，这个字段对应的值是将修复的Class以英文逗号分隔组成。&lt;/p&gt;
&lt;h4 id=&quot;二、加载补丁包中的类&quot;&gt;&lt;a href=&quot;#二、加载补丁包中的类&quot; class=&quot;headerlink&quot; title=&quot;二、加载补丁包中的类&quot;&gt;&lt;/a&gt;二、加载补丁包中的类&lt;/h4&gt;&lt;p&gt;加载补丁包中的类并替换相应的方法是通过调用PatchManager的loadPatch()方法完成的。该方法是将缓存的patch中的Class名称，通过调用AndFixManager类的fix(File, ClassLoader, List&lt;string&gt;)方法转换成对应的Class类。&lt;/string&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;final DexFile dexFile = DexFile.loadDex(file.getAbsolutePath(),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;					optfile.getAbsolutePath(), Context.MODE_PRIVATE);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if (saveFingerprint) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	mSecurityChecker.saveOptSig(optfile);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ClassLoader patchClassLoader = new ClassLoader(classLoader) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	@Override&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	protected Class&amp;lt;?&amp;gt; findClass(String className)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			throws ClassNotFoundException &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		Class&amp;lt;?&amp;gt; clazz = dexFile.loadClass(className, this);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		if (clazz == null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;amp;&amp;amp; className.startsWith(&amp;quot;com.alipay.euler.andfix&amp;quot;)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			return Class.forName(className);// annotation’s class not found&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		if (clazz == null) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			throw new ClassNotFoundException(className);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		return clazz;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在fix()方法中会进行patch包的版本支持校验和安全校验，如果不支持或者校验不通过，则不会继续执行。在这个方法中以Patch包的路径为参数创建了DexFile类对象，并构造了ClassLoader类，并重写了其findClass(String)方法，ClassLoader去查找Class的时候，实际上是调用DexFile.loadClass(String, ClassLoader)方法来完成的。&lt;/p&gt;
&lt;p&gt;最后是调用DexFile.entries()方法该patch包中所有的类名，将这些已经在Patch-Classes中的类名通过调用DexFile.loadClass(String, ClassLoader)获取对应的Class。&lt;/p&gt;
&lt;p&gt;方法替换是通过调用AndFixManager的fixClass(Class, ClassLoader)方法实现，该方法中先找出该Class中的有MethodReplace注解的方法，然后拿出该注解的clz(原方法对应的类名)和meth(原方法名称)字段的值，获取到原方法的Method对象，最后通过执行AndFix.addReplaceMethod(Method, Method)方法调用replaceMethod(Method, Method)方法进而转入native层进行方法替换操作。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * fix class&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt; clazz&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; *            class&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;fixClass&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Class&amp;lt;?&amp;gt; clazz, ClassLoader classLoader)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	Method[] methods = clazz.getDeclaredMethods();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	MethodReplace methodReplace;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	String clz;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	String meth;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (Method method : methods) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		methodReplace = method.getAnnotation(MethodReplace.class);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (methodReplace == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		clz = methodReplace.clazz();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		meth = methodReplace.method();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!isEmpty(clz) &amp;amp;&amp;amp; !isEmpty(meth)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			replaceMethod(classLoader, clz, meth, method);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;三、安全校验&quot;&gt;&lt;a href=&quot;#三、安全校验&quot; class=&quot;headerlink&quot; title=&quot;三、安全校验&quot;&gt;&lt;/a&gt;三、安全校验&lt;/h4&gt;&lt;p&gt;是否支持方法热替换操作的是通过AndFixManager的mSupport属性判断。该属性是通过调用Compact.isSupport()方法返回的值，在该方法中会判断是否不是阿里云OS系统、调用native中的setup根据不同虚拟机初始化是否成功、判断android系统版本是否是在2.3 ~ 6.0之间。&lt;/p&gt;
&lt;p&gt;安全校验分两步：第一是校验patch包的签名是否与主应用的签名一致，如果主应用是调试的签名，也给予通过，这样做是为了调试方便。该过程是在SecurityChecker的verifyApk(File)方法中实现。&lt;/p&gt;
&lt;p&gt;第二步验证的是验证patch包中优化过的classes.dex文件，即odex或oat文件，只不过andfix将该生成的文件名修改为与patch包名称相同，放在了apatch_opt目录。该验证过程是通过比较优化后的odex文件的MD5值与上次获取优化后的odex文件缓存的MD5值，如果不相同，则会删除odex文件，重新调用SecurityChecker类的saveOptSig(File)方法缓存新生成的odex文件的MD5值。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt; file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; *            Dex file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@return&lt;/span&gt; true if verify fingerprint success&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;verifyOpt&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(File file)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	String fingerprint = getFileMD5(file);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	String saved = getFingerprint(file.getName());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (fingerprint != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; TextUtils.equals(fingerprint, saved)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;四、Dalvik虚拟机方法替换&quot;&gt;&lt;a href=&quot;#四、Dalvik虚拟机方法替换&quot; class=&quot;headerlink&quot; title=&quot;四、Dalvik虚拟机方法替换&quot;&gt;&lt;/a&gt;四、Dalvik虚拟机方法替换&lt;/h4&gt;&lt;p&gt;java层在调用AndFix类的replaceMethod()方法时，就转入了native层，在native层，该本地方法对应的函数是static void replaceMethod(JNIEnv* env, jclass clazz, jobject src,&lt;br&gt;        jobject dest)，中间使用了JNI中的主动注册的方式进行关联。如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * JNI registration.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; JNINativeMethod gMethods[] = &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* name, signature, funcPtr */&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123; &lt;span class=&quot;string&quot;&gt;&quot;setup&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;(ZI)Z&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;*) setup &amp;#125;, &amp;#123; &lt;span class=&quot;string&quot;&gt;&quot;replaceMethod&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;string&quot;&gt;&quot;(Ljava/lang/reflect/Method;Ljava/lang/reflect/Method;)V&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;*) replaceMethod &amp;#125;, &amp;#123; &lt;span class=&quot;string&quot;&gt;&quot;setFieldFlag&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;string&quot;&gt;&quot;(Ljava/lang/reflect/Field;)V&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;*) setFieldFlag &amp;#125;, &amp;#125;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在replaceMethod函数中根据当前是DVM还是ART虚拟机，分别调用dalvik_replaceMethod()和art_replaceMethod()函数。&lt;/p&gt;
&lt;p&gt;dalvik_replaceMethod()函数的定义是在jni/dalvik/dalvik_method_replace.cpp文件中。其中通过调用JNIEnv的FromReflectedMethod()函数获取java层Method类对象对应native层的Method结构体，然后修改该结构体中的accessFlags和jniArgInfo属性值，使这个java层的普通方法变成一个native方法。同时还修改了insns和nativeFunc属性，insns缓存的是已经修复bug的函数的Method结构体指针；nativeFunc属性值是dalvik_dispatcher函数地址，虚拟机在执行方法时，如果该方法是本地方法就会执行nativeFunc所指向的函数地址，也就是会执行dalvik_dispatcher函数。&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Method* meth = (Method*) env-&amp;gt;FromReflectedMethod(src);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Method* target = (Method*) env-&amp;gt;FromReflectedMethod(dest);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;LOGD(&lt;span class=&quot;string&quot;&gt;&quot;dalvikMethod: %s&quot;&lt;/span&gt;, meth-&amp;gt;name);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;meth-&amp;gt;jniArgInfo = &lt;span class=&quot;number&quot;&gt;0x80000000&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;meth-&amp;gt;accessFlags |= ACC_NATIVE;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; argsSize = dvmComputeMethodArgsSize_fnPtr(meth);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!dvmIsStaticMethod(meth))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	argsSize++;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;meth-&amp;gt;registersSize = meth-&amp;gt;insSize = argsSize;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;meth-&amp;gt;insns = (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;*) target;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;meth-&amp;gt;nativeFunc = dalvik_dispatcher;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在dalvik_dispatcher()函数中，会根据当前替换方法，即修复bug的方法是否是静态方法而分别做处理。这个与java语法相同，如果调用的是非静态方法，则会需要当前方法所在类的对象来调用，如果是静态方法，则只需要类即可。不管是处理哪种类型的方法，都会调用到dvmCallMethod_fnPtr()函数。这个函数是通过使用NDK中的&lt;dlfcn.h&gt;头文件中的相关函数打开android系统中的/system/lib/libdvm.so文件，使用dvmCallMethod名称获取到的函数地址，也就是说调用dvmCallMethod_fnPtr()函数，实际上是调用dvm虚拟机中的dvmCallMethod()函数，这个函数是在android系统源码中的dalvik/vm/interp/Stack.cpp文件中定义。上面获取函数地址的方法可以参见dalvik_setup()函数定义。通过dvmCallMethod()函数名称也能明白，该函数是虚拟机用来执行java层方法的。&lt;/dlfcn.h&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!dvmIsStaticMethod(meth)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// 中间代码省略 ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	dvmCallMethod_fnPtr(self, (Method*) jInvokeMethod,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			dvmCreateReflectMethodObject_fnPtr(meth), &amp;amp;result, thisObj,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			argArray);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	thisObj-&amp;gt;clazz = tmp;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// 中间代码省略 ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	dvmCallMethod_fnPtr(self, (Method*) jInvokeMethod,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			dvmCreateReflectMethodObject_fnPtr(meth), &amp;amp;result, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			argArray);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意，dvmCallMethod()函数传入的第二个参数是一个Method结构体指针，也就是当需要被执行的方法，但这个方法jInvokeMethod是一个java层的java.lang.reflect.Method的invoke()方法，是通过使用JNI的GetMethodID()函数获取到其对应ID作为一个参数，具体是在dalvik_setup()函数中获取；第三个参数才是替换方法，这个参数在dvmCallMethod()函数中作为被执行方法的调用对象。到这里应该能明白，实际上对应java层的调用是执行java.lang.reflect.Method对象的invoke()方法。&lt;/p&gt;
&lt;p&gt;在dalvik_dispatcher()函数的最后是处理异常和返回结果。&lt;/p&gt;
&lt;h4 id=&quot;五、ART虚拟机方法替换&quot;&gt;&lt;a href=&quot;#五、ART虚拟机方法替换&quot; class=&quot;headerlink&quot; title=&quot;五、ART虚拟机方法替换&quot;&gt;&lt;/a&gt;五、ART虚拟机方法替换&lt;/h4&gt;&lt;p&gt;art_replaceMethod()函数是在jni/art/art_method_replace.cpp文件中定义，该函数主要内容是根据ART虚拟机不同的版本，调用不同的函数。下面是具体代码：&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;__&lt;/span&gt;attribute__ ((visibility (&lt;span class=&quot;string&quot;&gt;&quot;hidden&quot;&lt;/span&gt;))) art_replaceMethod(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		JNIEnv* env, jobject src, jobject dest) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (apilevel &amp;gt; &lt;span class=&quot;number&quot;&gt;22&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		replace_6_0(env, src, dest);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (apilevel &amp;gt; &lt;span class=&quot;number&quot;&gt;21&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		replace_5_1(env, src, dest);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		replace_5_0(env, src, dest);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这几个函数分别是在对应的jni/art/art_method_replace_x_x.cpp文件中定义。因为ART虚拟机还不太成熟，google还在改进中，所以不同版本有些代码会不一样，才会针对不同的版本进行处理。&lt;/p&gt;
&lt;p&gt;这里从java层过来的Method对象，被转换成ART虚拟机中能识别的ArtMethod类指针。这些函数中处理都是相同的，将被替换方法和替换方法两个方法的属性值进行互相替换。这里的处理方式与DVM有很大不同，ART中只需要替换相应的属性，不需要进行方法调用，这与ART虚拟机原理有关。其中下面两个属性替换很关键：&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;smeth-&amp;gt;entry_point_from_compiled_code_ =&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			dmeth-&amp;gt;entry_point_from_compiled_code_;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;smeth-&amp;gt;entry_point_from_interpreter_ = dmeth-&amp;gt;entry_point_from_interpreter_;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;entry_point_from&lt;em&gt;interpreter&lt;/em&gt;可以认为是ART虚拟机执行方法的起点，这个指针实际上是一个函数指针，这个函数指针是由汇编实现，这个指针是在art/runtime/class_linker.cc文件中赋值，再往下找，就会找到汇编代码。&lt;br&gt;entry_point_from_compiled&lt;em&gt;code&lt;/em&gt;这个指针同理，当ART虚拟机执行代码，如果需要Interpreter，就会执行entry_point_from&lt;em&gt;interpreter&lt;/em&gt;指向的函数；如果不需要，则会执行entry_point_from_compiled&lt;em&gt;code&lt;/em&gt;指向的函数。两个函数之间又可以相互调用，这部分都是用汇编代码执行的。具体原理参见CSDN老罗的博客。&lt;/p&gt;
&lt;p&gt;– EOF –&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;AndFix加载补丁包过程分析&quot;&gt;&lt;a href=&quot;#AndFix加载补丁包过程分析&quot; class=&quot;headerlink&quot; title=&quot;AndFix加载补丁包过程分析&quot;&gt;&lt;/a&gt;AndFix加载补丁包过程分析&lt;/h3&gt;&lt;p&gt;andfix提供了一套可以热替换java中原有方法的工具，在实际应用中可以用来热替换修复出现bug的方法，从而使用应用不需要升级应用就能解决部分问题。&lt;/p&gt;
&lt;p&gt;本文主要是分析运行在android应用中的一套工具环境，从java层到native层分析andfix框架热替换方法的过程。&lt;/p&gt;
    
    </summary>
    
      <category term="andfix" scheme="http://www.jacpy.com/categories/andfix/"/>
    
    
      <category term="andfix" scheme="http://www.jacpy.com/tags/andfix/"/>
    
  </entry>
  
  <entry>
    <title>apkpatch工具实现分析</title>
    <link href="http://www.jacpy.com/2016/03/24/apkpatch-tool-analysis.html"/>
    <id>http://www.jacpy.com/2016/03/24/apkpatch-tool-analysis.html</id>
    <published>2016-03-24T05:27:17.000Z</published>
    <updated>2016-03-24T06:49:22.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;apkpatch工具实现分析&quot;&gt;&lt;a href=&quot;#apkpatch工具实现分析&quot; class=&quot;headerlink&quot; title=&quot;apkpatch工具实现分析&quot;&gt;&lt;/a&gt;apkpatch工具实现分析&lt;/h3&gt;&lt;p&gt;apkpatch工具是配套阿里AndFix框架的一个生成aptach补丁包的工具，链接地址是：&lt;a href=&quot;https://github.com/alibaba/AndFix/tree/master/tools&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/alibaba/AndFix/tree/master/tools&lt;/a&gt; 。主要包含反编译对比两个APK的类和方法、修改类名写入PACTH.MF文件、生成补丁apatch包。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;由于没有从网上找到对应的源码，以下分析过程均通过jd-gui工具反编译jar包阅读反编译代码完成。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h4 id=&quot;一、工具入口&quot;&gt;&lt;a href=&quot;#一、工具入口&quot; class=&quot;headerlink&quot; title=&quot;一、工具入口&quot;&gt;&lt;/a&gt;一、工具入口&lt;/h4&gt;&lt;p&gt;从命令行执行apkpatch命令时，调用的是com.euler.patch.Main类中的静态main()方法。通过对参数的解析，解析出两个APK的路径及签名文件相关信息。根据命令参数的不同，主要分为两个过程，第一个过程是如果参数中有&lt;strong&gt;-m&lt;/strong&gt;参数，那么会执行补丁包的合并过程，即将&lt;strong&gt;-m&lt;/strong&gt;参数指定的文件合并到一个merge.aptach文件中；另外一个过程是通过构造com.euler.patch.ApkPatch类对象，调用其doPatch()方法，启动生成补丁包。&lt;/p&gt;
&lt;p&gt;解析&lt;strong&gt;-m&lt;/strong&gt;参数为合并代码逻辑反编译代码如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/03/24/merge_patch.jpg&quot; alt=&quot;解析参数为合并&quot;&gt;&lt;/p&gt;
&lt;p&gt;生成补丁包的逻辑反编译代码如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/03/24/make_patch.jpg&quot; alt=&quot;生成补丁包&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;二、补丁包合并&quot;&gt;&lt;a href=&quot;#二、补丁包合并&quot; class=&quot;headerlink&quot; title=&quot;二、补丁包合并&quot;&gt;&lt;/a&gt;二、补丁包合并&lt;/h3&gt;&lt;p&gt;合并操作是调用com.euler.patch.MergePatch类中的doMerge()方法，其中会调用mergeCode(File)方法，将需要的合并的patch包中的classes.dex合并到一个dex文件中。合并过程是通过调用调用com.android.dx.merge.DexMerger类merge()方法完成。&lt;/p&gt;
&lt;h3 id=&quot;三、生成补丁包&quot;&gt;&lt;a href=&quot;#三、生成补丁包&quot; class=&quot;headerlink&quot; title=&quot;三、生成补丁包&quot;&gt;&lt;/a&gt;三、生成补丁包&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/2016/03/24/do_patch.jpg&quot; alt=&quot;生成补丁包&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-1、对比两个APK的类和方法&quot;&gt;&lt;a href=&quot;#3-1、对比两个APK的类和方法&quot; class=&quot;headerlink&quot; title=&quot;3.1、对比两个APK的类和方法&quot;&gt;&lt;/a&gt;3.1、对比两个APK的类和方法&lt;/h4&gt;&lt;p&gt;在执行apkpatch工具时，命令参数&lt;strong&gt;-f&lt;/strong&gt;表示的是新生成的APK，&lt;strong&gt;-t&lt;/strong&gt;参数表示的是原APK包，两个APK不同的信息保存在com.euler.patch.diff.DiffInfo类实例中，其中包括，不同的类信息、方法信息以及属性信息。这些不同的信息是通过调用com.euler.patch.diff.DexDiffer类的diff()方法获取。&lt;/p&gt;
&lt;p&gt;这里有个关键的地方是将修改的方法，也可以说是出现bug的方法会增加一个&lt;strong&gt;Lcom/alipay/euler/andfix/annotation/MethodReplace;&lt;/strong&gt;注解，在android加载补丁包的环境中，方法替换是根据方法是否有@MethodReplace注解而进行替换的。&lt;/p&gt;
&lt;p&gt;通过调用ApkPatch类的buildCode(File, File, DiffInfo)方法，将所有新增的类或发生修改的类根据类名将类的信息转换成smali格式的文件，修改类名信息后，即加上_CF后缀，重新生成新的新的dex文件。&lt;/p&gt;
&lt;h4 id=&quot;3-2、写入PACTH-MF文件&quot;&gt;&lt;a href=&quot;#3-2、写入PACTH-MF文件&quot; class=&quot;headerlink&quot; title=&quot;3.2、写入PACTH.MF文件&quot;&gt;&lt;/a&gt;3.2、写入PACTH.MF文件&lt;/h4&gt;&lt;p&gt;紧接着调用ApkPatch的父类，即Build类的build(File, File)方法打成APK包，同时调用getMeta()方法写入PATCH.MF文件补丁包信息。getMeta()方法具体实现是在ApkPatch类中，注意PATCH.MF文件中的Patch-Classes字段对应的内容是带_CF后缀的类名。这个在android运行环境中解析的时候会用到这个字段。&lt;/p&gt;
&lt;p&gt;getMeta()方法反编译代码如下所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/03/24/get_meta.jpg&quot; alt=&quot;写入MF信息&quot;&gt;&lt;/p&gt;
&lt;p&gt;最后是调用Build类中的release()方法对打包的APK文件进行签名，生成包含签名信息的patch包。&lt;/p&gt;
&lt;p&gt;– EOF –&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;apkpatch工具实现分析&quot;&gt;&lt;a href=&quot;#apkpatch工具实现分析&quot; class=&quot;headerlink&quot; title=&quot;apkpatch工具实现分析&quot;&gt;&lt;/a&gt;apkpatch工具实现分析&lt;/h3&gt;&lt;p&gt;apkpatch工具是配套阿里AndFix框架的一个生成aptach补丁包的工具，链接地址是：&lt;a href=&quot;https://github.com/alibaba/AndFix/tree/master/tools&quot;&gt;https://github.com/alibaba/AndFix/tree/master/tools&lt;/a&gt; 。主要包含反编译对比两个APK的类和方法、修改类名写入PACTH.MF文件、生成补丁apatch包。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;由于没有从网上找到对应的源码，以下分析过程均通过jd-gui工具反编译jar包阅读反编译代码完成。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="andfix" scheme="http://www.jacpy.com/categories/andfix/"/>
    
    
      <category term="andfix apkpatch" scheme="http://www.jacpy.com/tags/andfix-apkpatch/"/>
    
  </entry>
  
  <entry>
    <title>Genymotion模拟器长期使用占用大量磁盘空间解决方案</title>
    <link href="http://www.jacpy.com/2015/10/30/clear-genymotion-virturebox-cache-md.html"/>
    <id>http://www.jacpy.com/2015/10/30/clear-genymotion-virturebox-cache-md.html</id>
    <published>2015-10-30T12:54:28.000Z</published>
    <updated>2015-10-30T15:34:48.000Z</updated>
    
    <content type="html">&lt;p&gt;今天下午在调应用，突然Android Studio弹出&lt;code&gt;Low disk space on a Android Studio system directory partition&lt;/code&gt;提示，磁盘空间不够了？赶紧跑去看了磁盘用量。傻眼了，早上来还有几百M的C盘，现在只剩下几十M了。早在之前就已经注意到了C盘容量会莫名的减少，但是没有注意是哪个程序占用了更多的空间，今天决定要找找，于是就有了下文。&lt;/p&gt;
&lt;h3 id=&quot;1-二分法找出磁盘占用空间最大的目录&quot;&gt;&lt;a href=&quot;#1-二分法找出磁盘占用空间最大的目录&quot; class=&quot;headerlink&quot; title=&quot;1.二分法找出磁盘占用空间最大的目录&quot;&gt;&lt;/a&gt;1.二分法找出磁盘占用空间最大的目录&lt;/h3&gt;&lt;p&gt;Win 7的应用程序缓存目录是在&lt;code&gt;C:\Users\jacpy\AppData&lt;/code&gt;目录中，&lt;code&gt;jacpy&lt;/code&gt;为当前系统用户名。&lt;code&gt;AppData&lt;/code&gt;为隐藏目录，要在目录菜单的“组织”中找到“文件夹和搜索选项”的弹出框的“查看”Tab页中修改，不会修改也没关系，打开一个目录，把上面的路径直接copy到路径框里面，把用户名换成自己的电脑用户名，回车就行了。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;code&gt;AppData&lt;/code&gt;目录下面只有几个目录，所以挨个看下属性就知道，找占用空间最大的目录进去，无疑是&lt;code&gt;Local&lt;/code&gt;目录，实际上应用程序的缓存大部分在这个目录中。&lt;code&gt;Local&lt;/code&gt;目录中有N多目录，如果你装了很多的应用程序的话，OK，现在二分法表现的时候了。先选中目录中一半的目录，看一下属性，统计这些目录的磁盘占用的空间，也不用选择一半，差不多就行。然后在占用空间大的那部分目录里再进行同样的处理方式，传说中的logn级别的查找效率体现出来了有没有啊。很意外，找到的是Genymobile目录，通过观察其他子目录发现，也在意料之中。&lt;/p&gt;
&lt;h3 id=&quot;2-删除Genymotion的Snapshots文件目录&quot;&gt;&lt;a href=&quot;#2-删除Genymotion的Snapshots文件目录&quot; class=&quot;headerlink&quot; title=&quot;2.删除Genymotion的Snapshots文件目录&quot;&gt;&lt;/a&gt;2.删除Genymotion的Snapshots文件目录&lt;/h3&gt;&lt;p&gt;通过上面的二分法在Genymobile目录中找到空间占用最多的文件，最后是在&lt;code&gt;Google Nexus 4 - 4.2.2 - API 17 - 768x1280&lt;/code&gt;中的Snapshots目录中找到了一个有6个G的vdi文件，好家伙，这是什么鬼，这么大！立马删除。然后再去启动模拟器，启动不了。好吧，估计是组成的文件缺一不可吧，最后把&lt;code&gt;Google Nexus 4 - 4.2.2 - API 17 - 768x1280&lt;/code&gt;整个文件夹都删除了，打算重新再下载这个模拟器。&lt;/p&gt;
&lt;h3 id=&quot;3-重新部署Genymotion模拟器&quot;&gt;&lt;a href=&quot;#3-重新部署Genymotion模拟器&quot; class=&quot;headerlink&quot; title=&quot;3.重新部署Genymotion模拟器&quot;&gt;&lt;/a&gt;3.重新部署Genymotion模拟器&lt;/h3&gt;&lt;p&gt;打开Genymotion的PC端，选择还是那个模拟器镜像，然后下载，结果瞬间完成。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jacpy/jacpy.github.io/master/images/2015/10/30/genymotion_pc.png&quot; alt=&quot;Genymotion PC端截图&quot;&gt;&lt;br&gt;难道本地有缓存？又在目录里面找了一圈，发现在&lt;code&gt;ova&lt;/code&gt;目录中有ova缓存文件。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jacpy/jacpy.github.io/master/images/2015/10/30/genymotion_cache_file.jpg&quot; alt=&quot;缓存文件截图&quot;&gt;&lt;/p&gt;
&lt;p&gt;究其原理肯定是VirtureBox虚拟机文件越用越大，因为最近用模拟器调试应用（既然免费用别人的工具，打一下广告，Genymotion模拟器速度确实很快，比我的物理机速度还快，尤其是调试时安装应用的速度），时间长了，用的多了，虚拟机文件就会变得很大，跟vmare一个德性。&lt;/p&gt;
&lt;p&gt;干掉那么大一个文件，C盘又空出来很多空间，心里很爽。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;今天下午在调应用，突然Android Studio弹出&lt;code&gt;Low disk space on a Android Studio system directory partition&lt;/code&gt;提示，磁盘空间不够了？赶紧跑去看了磁盘用量。傻眼了，早上来还有几百M的C盘，现在只剩下几十M了。早在之前就已经注意到了C盘容量会莫名的减少，但是没有注意是哪个程序占用了更多的空间，今天决定要找找，于是就有了下文。&lt;/p&gt;
&lt;h3 id=&quot;1-二分法找出磁盘占用空间最大的目录&quot;&gt;&lt;a href=&quot;#1-二分法找出磁盘占用空间最大的目录&quot; class=&quot;headerlink&quot; title=&quot;1.二分法找出磁盘占用空间最大的目录&quot;&gt;&lt;/a&gt;1.二分法找出磁盘占用空间最大的目录&lt;/h3&gt;&lt;p&gt;Win 7的应用程序缓存目录是在&lt;code&gt;C:\Users\jacpy\AppData&lt;/code&gt;目录中，&lt;code&gt;jacpy&lt;/code&gt;为当前系统用户名。&lt;code&gt;AppData&lt;/code&gt;为隐藏目录，要在目录菜单的“组织”中找到“文件夹和搜索选项”的弹出框的“查看”Tab页中修改，不会修改也没关系，打开一个目录，把上面的路径直接copy到路径框里面，把用户名换成自己的电脑用户名，回车就行了。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="genymotion" scheme="http://www.jacpy.com/tags/genymotion/"/>
    
  </entry>
  
  <entry>
    <title>使用Gradle编译报错：Execution failed for task &#39;:packageAllDebugClassesForMultiDex&#39;  java.util.zip.ZipException duplicate entry解决方法</title>
    <link href="http://www.jacpy.com/2015/10/30/Error-Execution-failed-for-task-packageAllDebugClassesForMultiDex-duplicate-entry.html"/>
    <id>http://www.jacpy.com/2015/10/30/Error-Execution-failed-for-task-packageAllDebugClassesForMultiDex-duplicate-entry.html</id>
    <published>2015-10-30T04:42:40.000Z</published>
    <updated>2015-10-30T15:38:48.000Z</updated>
    
    <content type="html">&lt;p&gt;今天用Gradle编译Android项目时，报了一个错：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error:Execution failed &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; task &lt;span class=&quot;string&quot;&gt;&#39;:packageAllDebugClassesForMultiDex&#39;&lt;/span&gt;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; java.util.zip.ZipException: duplicate entry: com/taobao/tae/sdk/openim/OpenWXUiApiImpl$&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;$&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;.class&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;由于第一次遇到这种错，看提示信息以为是项目的方法数超过65535的限制，于是google一下，看别人有没有遇到这个问题。结果在&lt;code&gt;stackoverflow&lt;/code&gt;上好多人遇到这个问题，有人说是bug，有人说要求各种组合的jar包版本要一致，按上面说的修改方法在build.gradle配置文件中改了一下，编译后还是报这个错。&lt;/p&gt;
&lt;p&gt;这时心里开始犯嘀咕了，难道是新用的阿里的jar包方法数太多了？于是到libs目录看一下，这一看不要紧，发现问题了&lt;strong&gt;同一个jar包存在两个版本&lt;/strong&gt;，删除老的版本。重新编译，OK了。&lt;/p&gt;
&lt;p&gt;出现这样问题的原因是自己在Android Studio、Eclipse、SVN之间倒腾代码时没注意到jar包重复，出现重复包时Gradle编译出现的错误与Eclipse提示错误不一致。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;今天用Gradle编译Android项目时，报了一个错：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error:Execution failed &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; task &lt;span class=&quot;string&quot;&gt;&#39;:packageAllDebugClassesForMultiDex&#39;&lt;/span&gt;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; java.util.zip.ZipException: duplicate entry: com/taobao/tae/sdk/openim/OpenWXUiApiImpl$&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;$&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;.class&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="packageAllDebugClassesForMultiDex" scheme="http://www.jacpy.com/tags/packageAllDebugClassesForMultiDex/"/>
    
  </entry>
  
  <entry>
    <title>使用BaseAdapter的getItemViewType()报错解决方案</title>
    <link href="http://www.jacpy.com/2015/10/22/android-BaseAdapter-getItemViewType-must-be-in-the-range-0-to-getViewTypeCount-1.html"/>
    <id>http://www.jacpy.com/2015/10/22/android-BaseAdapter-getItemViewType-must-be-in-the-range-0-to-getViewTypeCount-1.html</id>
    <published>2015-10-22T13:13:40.000Z</published>
    <updated>2015-10-30T15:55:46.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天开发一个类似微信搜索显示搜索结果分类展示的功能，很自然的联想到了使用ListView去展示最后搜索的结果。每个分类最前面要显示一个分类的标题，就想使用&lt;code&gt;getItemViewType()&lt;/code&gt;、&lt;code&gt;getViewTypeCount()&lt;/code&gt;这两个方法做展示效果，结果在搜索过滤条件刷新Adapter的列表时，发生了以下错误：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;java.lang.ArrayIndexOutOfBoundsException: length=&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;; index=&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.AbsListView$RecycleBin.addScrapView(AbsListView.java:&lt;span class=&quot;number&quot;&gt;6355&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.ListView.layoutChildren(ListView.java:&lt;span class=&quot;number&quot;&gt;1565&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.AbsListView.onLayout(AbsListView.java:&lt;span class=&quot;number&quot;&gt;1994&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.LinearLayout.setChildFrame(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1663&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.LinearLayout.layoutVertical(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1521&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.LinearLayout.onLayout(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1434&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.FrameLayout.onLayout(FrameLayout.java:&lt;span class=&quot;number&quot;&gt;448&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.LinearLayout.setChildFrame(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1663&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.LinearLayout.layoutVertical(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1521&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.LinearLayout.onLayout(LinearLayout.java:&lt;span class=&quot;number&quot;&gt;1434&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.widget.FrameLayout.onLayout(FrameLayout.java:&lt;span class=&quot;number&quot;&gt;448&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.View.layout(View.java:&lt;span class=&quot;number&quot;&gt;14008&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.ViewGroup.layout(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;4373&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.ViewRootImpl.performLayout(ViewRootImpl.java:&lt;span class=&quot;number&quot;&gt;1892&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:&lt;span class=&quot;number&quot;&gt;1711&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:&lt;span class=&quot;number&quot;&gt;989&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:&lt;span class=&quot;number&quot;&gt;4351&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.Choreographer$CallbackRecord.run(Choreographer.java:&lt;span class=&quot;number&quot;&gt;749&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.Choreographer.doCallbacks(Choreographer.java:&lt;span class=&quot;number&quot;&gt;562&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.Choreographer.doFrame(Choreographer.java:&lt;span class=&quot;number&quot;&gt;532&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:&lt;span class=&quot;number&quot;&gt;735&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.os.Handler.handleCallback(Handler.java:&lt;span class=&quot;number&quot;&gt;725&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.os.Handler.dispatchMessage(Handler.java:&lt;span class=&quot;number&quot;&gt;92&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.os.Looper.loop(Looper.java:&lt;span class=&quot;number&quot;&gt;137&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at android.app.ActivityThread.main(ActivityThread.java:&lt;span class=&quot;number&quot;&gt;5041&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at java.lang.reflect.Method.invokeNative(Native Method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at java.lang.reflect.Method.invoke(Method.java:&lt;span class=&quot;number&quot;&gt;511&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:&lt;span class=&quot;number&quot;&gt;793&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:&lt;span class=&quot;number&quot;&gt;560&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;at dalvik.system.NativeStart.main(Native Method)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个错误是系统内容代码报错，感觉原因就出在这两个方法上，因为没有加这两个方法，列表展示刷新OK。&lt;br&gt;最后通过查找官方文档说明发现，&lt;strong&gt;&lt;code&gt;getItemViewType()&lt;/code&gt;方法返回的值必须在0 ~ &lt;code&gt;getViewTypeCount()&lt;/code&gt; - 1&lt;/strong&gt;这个范围内。记录一个这个问题。下面是文档说明：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;public int getItemViewType (int position)&lt;/p&gt;
&lt;p&gt;Get the type of View that will be created by getView(int, View, ViewGroup) for the specified item.&lt;br&gt;Parameters&lt;br&gt;position    The position of the item within the adapter’s data set whose view type we want.&lt;br&gt;Returns&lt;br&gt;An integer representing the type of View. Two views should share the same type if one can be converted to the other in getView(int, View, ViewGroup). &lt;strong&gt;Note: Integers must be in the range 0 to getViewTypeCount() - 1&lt;/strong&gt;. IGNORE_ITEM_VIEW_TYPE can also be returned.&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天开发一个类似微信搜索显示搜索结果分类展示的功能，很自然的联想到了使用ListView去展示最后搜索的结果。每个分类最前面要显示一个分类的标题，就想使用&lt;code&gt;getItemViewType()&lt;/code&gt;、&lt;code&gt;getViewTypeCount()&lt;/code&gt;这两个方法做展示效果，结果在搜索过滤条件刷新Adapter的列表时，发生了以下错误：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="getItemViewType" scheme="http://www.jacpy.com/tags/getItemViewType/"/>
    
      <category term="getViewTypeCount" scheme="http://www.jacpy.com/tags/getViewTypeCount/"/>
    
  </entry>
  
</feed>
