<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jacpy&#39;s blog</title>
  <subtitle>enjoy mobile development</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.jacpy.com/"/>
  <updated>2017-10-26T15:39:31.000Z</updated>
  <id>http://www.jacpy.com/</id>
  
  <author>
    <name>jacpy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>golang中append函数和copy函数操作slice的不同用法</title>
    <link href="http://www.jacpy.com/2017/10/26/golang-difference-between-append-and-copy-function.html"/>
    <id>http://www.jacpy.com/2017/10/26/golang-difference-between-append-and-copy-function.html</id>
    <published>2017-10-26T04:50:00.000Z</published>
    <updated>2017-10-26T15:39:31.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天使用&lt;code&gt;golang&lt;/code&gt;时，遇到一个很奇怪的问题，原因是对&lt;code&gt;golang&lt;/code&gt;不熟悉，所以记录一下。&lt;/p&gt;
&lt;p&gt;在使用&lt;code&gt;append()&lt;/code&gt;函数给&lt;code&gt;slice&lt;/code&gt;中添加元素时，&lt;code&gt;slice&lt;/code&gt;的初始大小可以为0，也就是&lt;code&gt;len&lt;/code&gt;可以为0。每次向&lt;code&gt;slice&lt;/code&gt;中&lt;code&gt;append&lt;/code&gt;的时候，如果容量&lt;code&gt;cap&lt;/code&gt;不够，会自动对&lt;code&gt;slice&lt;/code&gt;进行扩容，也就是改变&lt;code&gt;slice&lt;/code&gt;的&lt;code&gt;cap&lt;/code&gt;的大小。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;而在使用&lt;code&gt;copy()&lt;/code&gt;函数操作&lt;code&gt;slice&lt;/code&gt;时，如果&lt;code&gt;slice&lt;/code&gt;的大小为0时，会不添加任何元素，不会自动增加&lt;code&gt;slice&lt;/code&gt;的容量大小。这里要注意。&lt;/p&gt;
&lt;p&gt;下面是从golang官网源码库中看到的实现代码，如下所示：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;runtime/slice.go&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;slicecopy&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(to, fm slice, width &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;int&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; fm.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || to.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    n := fm.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; to.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt; &amp;lt; n &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        n = to.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; width == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; n&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; raceenabled &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        callerpc := getcallerpc(unsafe.Pointer(&amp;amp;to))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        pc := funcPC(slicecopy)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        racewriterangepc(to.array, &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(width)), callerpc, pc)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        racereadrangepc(fm.array, &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(width)), callerpc, pc)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; msanenabled &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        msanwrite(to.array, &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(width)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        msanread(fm.array, &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(width)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    size := &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n) * width&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; size == &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &amp;#123; &lt;span class=&quot;comment&quot;&gt;// common case worth about 2x to do here&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// &lt;span class=&quot;doctag&quot;&gt;TODO:&lt;/span&gt; is this still worth it with new memmove impl?&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        *(*&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;)(to.array) = *(*&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;)(fm.array) &lt;span class=&quot;comment&quot;&gt;// known to be a byte pointer&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        memmove(to.array, fm.array, size)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; n&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从上面的代码可以看出来，如果&lt;code&gt;slice&lt;/code&gt;的&lt;code&gt;len&lt;/code&gt;值为0，则直接&lt;code&gt;return&lt;/code&gt;，不会进行复制操作。&lt;/p&gt;
&lt;p&gt;下面是示例代码，验证一下：&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;regexp&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;log&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;unsafe&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;  &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.SetFlags(log.Lshortfile|log.LstdFlags)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sliceTest&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(list []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;  &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(list) &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        log.Println(&lt;span class=&quot;string&quot;&gt;&quot;func pos 0:&quot;&lt;/span&gt;, &amp;amp;list[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;])&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;func pointer:&quot;&lt;/span&gt;, unsafe.Pointer(&amp;amp;list))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;------&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;copyTest&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;  &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    list := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pointer:&quot;&lt;/span&gt;, unsafe.Pointer(&amp;amp;list))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sliceTest(list)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;++++++++++++++&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    list = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(list, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pos 0:&quot;&lt;/span&gt;, &amp;amp;list[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;])&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pointer:&quot;&lt;/span&gt;, unsafe.Pointer(&amp;amp;list))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sliceTest(list)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;++++++++++++++&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    list = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(list, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pos 0:&quot;&lt;/span&gt;, &amp;amp;list[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;])&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pointer:&quot;&lt;/span&gt;, unsafe.Pointer(&amp;amp;list))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sliceTest(list)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;++++++++++++++&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    copy1 := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;copy&lt;/span&gt;(copy1, list)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;copy1:&quot;&lt;/span&gt;, copy1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    copy2 := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;copy&lt;/span&gt;(copy2, list)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;copy2:&quot;&lt;/span&gt;, copy2)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    copy3 := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;copy&lt;/span&gt;(copy3, list)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;copy3:&quot;&lt;/span&gt;, copy3)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.Println()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    copyTest()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pointer: 0xc42000a060&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;func pointer: 0xc42000a080&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;++++++++++++++&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pos 0: 0xc4200160d0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pointer: 0xc42000a060&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;func pos 0: 0xc4200160d0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;func pointer: 0xc42000a0a0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;++++++++++++++&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pos 0: 0xc4200160f0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pointer: 0xc42000a060&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;func pos 0: 0xc4200160f0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;func pointer: 0xc42000a0c0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;++++++++++++++&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;copy1: []&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;copy2: [1 2]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;copy3: []&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;从上面的日志可以看出来，copy1和copy3都是空，没有进行复制操作；每次进行扩容的时候，&lt;code&gt;pos 0:&lt;/code&gt;的地址都会发生变化。另外还可以看出来，当把&lt;code&gt;slice&lt;/code&gt;传给一个函数时，对&lt;code&gt;slice&lt;/code&gt;的结构体发生的值传递，而&lt;code&gt;slice&lt;/code&gt;中指向数据内容的地址没有变，即上面&lt;code&gt;pos 0:&lt;/code&gt;和&lt;code&gt;func pos 0:&lt;/code&gt;输出的地址是一致。&lt;/p&gt;
&lt;p&gt;同样可以在&lt;code&gt;runtime/slice.go&lt;/code&gt;源码中的&lt;code&gt;makeslice()&lt;/code&gt;函数中可以看到创建的&lt;code&gt;slice&lt;/code&gt;结构体，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; slice &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    array unsafe.Pointer&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;   &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;   &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;也就是说当把&lt;code&gt;slice&lt;/code&gt;直接传给函数时，会对这个&lt;code&gt;slice&lt;/code&gt;结构体内容进行复制，而&lt;code&gt;array&lt;/code&gt;的地址不会变，始终指向数组内容的首元素地址。&lt;/p&gt;
&lt;p&gt;另外看这个&lt;code&gt;runtime/slice.go&lt;/code&gt;的源码时，还发现一个有趣的细节，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;growslice&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(et *_type, old slice, &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;slice&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    newcap := old.&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    doublecap := newcap + newcap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt; &amp;gt; doublecap &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        newcap = &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; old.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt; &amp;lt; &lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            newcap = doublecap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; newcap &amp;lt; &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                newcap += newcap / &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在&lt;code&gt;slice&lt;/code&gt;进行扩容的时候，如果其容量小于&lt;code&gt;1024&lt;/code&gt;，则容量增加一倍；否则容量以&lt;code&gt;1.25&lt;/code&gt;倍的数量增加。&lt;/p&gt;
&lt;p&gt;以上golang源码是基于1.9.1版本。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天使用&lt;code&gt;golang&lt;/code&gt;时，遇到一个很奇怪的问题，原因是对&lt;code&gt;golang&lt;/code&gt;不熟悉，所以记录一下。&lt;/p&gt;
&lt;p&gt;在使用&lt;code&gt;append()&lt;/code&gt;函数给&lt;code&gt;slice&lt;/code&gt;中添加元素时，&lt;code&gt;slice&lt;/code&gt;的初始大小可以为0，也就是&lt;code&gt;len&lt;/code&gt;可以为0。每次向&lt;code&gt;slice&lt;/code&gt;中&lt;code&gt;append&lt;/code&gt;的时候，如果容量&lt;code&gt;cap&lt;/code&gt;不够，会自动对&lt;code&gt;slice&lt;/code&gt;进行扩容，也就是改变&lt;code&gt;slice&lt;/code&gt;的&lt;code&gt;cap&lt;/code&gt;的大小。&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://www.jacpy.com/categories/go/"/>
    
    
      <category term="append copy slice" scheme="http://www.jacpy.com/tags/append-copy-slice/"/>
    
  </entry>
  
  <entry>
    <title>Okhttp使用注意事项</title>
    <link href="http://www.jacpy.com/2017/09/28/okhttp-used-attentions.html"/>
    <id>http://www.jacpy.com/2017/09/28/okhttp-used-attentions.html</id>
    <published>2017-09-28T07:10:42.000Z</published>
    <updated>2017-10-15T03:30:22.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在使用&lt;code&gt;Okhttp&lt;/code&gt;时遇到两个坑，这里记录一下。一个是在请求头中不需要设置&lt;code&gt;Accept-Encoding&lt;/code&gt;为&lt;code&gt;gzip&lt;/code&gt;，使用&lt;code&gt;Okhttp&lt;/code&gt;默认的就好；第二个是添加到&lt;code&gt;Okhttp&lt;/code&gt;请求头里面的键值对不能为空。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;默认不需要设置Accept-Encoding为gzip&quot;&gt;&lt;a href=&quot;#默认不需要设置Accept-Encoding为gzip&quot; class=&quot;headerlink&quot; title=&quot;默认不需要设置Accept-Encoding为gzip&quot;&gt;&lt;/a&gt;默认不需要设置Accept-Encoding为gzip&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Okhttp&lt;/code&gt;中如果外部请求没有在请求里面设置&lt;code&gt;Accept-Encoding&lt;/code&gt;值和&lt;code&gt;Range&lt;/code&gt;值时，会在请求头里增加设置&lt;code&gt;Accept-Encoding: gzip&lt;/code&gt;，如果外部设置这个&lt;code&gt;Accept-Encoding&lt;/code&gt;参数，则不会设置。如果是&lt;code&gt;Okhttp&lt;/code&gt;自己设置的参数，并且服务器端响应的头里包含有&lt;code&gt;Content-Encoding&lt;/code&gt;值为&lt;code&gt;gzip&lt;/code&gt;，则会使用&lt;code&gt;Gzip&lt;/code&gt;解压。如果是外部设置的，即使服务器端响应头里面包含有&lt;code&gt;Content-Encoding&lt;/code&gt;值为&lt;code&gt;gzip&lt;/code&gt;，也不会使用&lt;code&gt;Gzip&lt;/code&gt;解压，需要自己去解压。&lt;/p&gt;
&lt;p&gt;下面是官方代码，在&lt;code&gt;okhttp3.internal.http.BridgeInterceptor#intercept(Chain chain)&lt;/code&gt;方法中：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// If we add an &quot;Accept-Encoding: gzip&quot; header field we&#39;re responsible for also decompressing&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// the transfer stream.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; transparentGzip = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (userRequest.header(&lt;span class=&quot;string&quot;&gt;&quot;Accept-Encoding&quot;&lt;/span&gt;) == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; userRequest.header(&lt;span class=&quot;string&quot;&gt;&quot;Range&quot;&lt;/span&gt;) == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      transparentGzip = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      requestBuilder.header(&lt;span class=&quot;string&quot;&gt;&quot;Accept-Encoding&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;gzip&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    List&amp;lt;Cookie&amp;gt; cookies = cookieJar.loadForRequest(userRequest.url());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!cookies.isEmpty()) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      requestBuilder.header(&lt;span class=&quot;string&quot;&gt;&quot;Cookie&quot;&lt;/span&gt;, cookieHeader(cookies));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (userRequest.header(&lt;span class=&quot;string&quot;&gt;&quot;User-Agent&quot;&lt;/span&gt;) == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      requestBuilder.header(&lt;span class=&quot;string&quot;&gt;&quot;User-Agent&quot;&lt;/span&gt;, Version.userAgent());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Response networkResponse = chain.proceed(requestBuilder.build());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    HttpHeaders.receiveHeaders(cookieJar, userRequest.url(), networkResponse.headers());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Response.Builder responseBuilder = networkResponse.newBuilder()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        .request(userRequest);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (transparentGzip&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;amp;&amp;amp; &lt;span class=&quot;string&quot;&gt;&quot;gzip&quot;&lt;/span&gt;.equalsIgnoreCase(networkResponse.header(&lt;span class=&quot;string&quot;&gt;&quot;Content-Encoding&quot;&lt;/span&gt;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;amp;&amp;amp; HttpHeaders.hasBody(networkResponse)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      GzipSource responseBody = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; GzipSource(networkResponse.body().source());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      Headers strippedHeaders = networkResponse.headers().newBuilder()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          .removeAll(&lt;span class=&quot;string&quot;&gt;&quot;Content-Encoding&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          .removeAll(&lt;span class=&quot;string&quot;&gt;&quot;Content-Length&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          .build();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      responseBuilder.headers(strippedHeaders);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      responseBuilder.body(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RealResponseBody(strippedHeaders, Okio.buffer(responseBody)));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意整个逻辑是由&lt;code&gt;transparentGzip&lt;/code&gt;变量来控制的。刚开始不知道有这种逻辑，使用了&lt;code&gt;Okhttp&lt;/code&gt;做请求，然后在请求头里设置了&lt;code&gt;Accept-Encoding&lt;/code&gt;值为&lt;code&gt;gzip&lt;/code&gt;，于是使用&lt;code&gt;okhttp3.ResponseBody#string()&lt;/code&gt;方法来获取服务器端的响应字符串时，结果是乱码。去排查原因时发现上面这段逻辑。&lt;/p&gt;
&lt;h2 id=&quot;设置请求头信息时，值不能为空&quot;&gt;&lt;a href=&quot;#设置请求头信息时，值不能为空&quot; class=&quot;headerlink&quot; title=&quot;设置请求头信息时，值不能为空&quot;&gt;&lt;/a&gt;设置请求头信息时，值不能为空&lt;/h2&gt;&lt;p&gt;在使用&lt;code&gt;Okhttp&lt;/code&gt;请求时，由于设置请求的值为null值，所以App直接闪退，一看错误日志，发现了原因。原来源码里面有拦截操作，具体代码在&lt;code&gt;okhttp3.Headers#checkNameAndValue(String name, String value)&lt;/code&gt;方法中，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkNameAndValue&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String name, String value)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (name == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; NullPointerException(&lt;span class=&quot;string&quot;&gt;&quot;name == null&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (name.isEmpty()) &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;string&quot;&gt;&quot;name is empty&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, length = name.length(); i &amp;lt; length; i++) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; c = name.charAt(i);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (c &amp;lt;= &lt;span class=&quot;string&quot;&gt;&#39;\u0020&#39;&lt;/span&gt; || c &amp;gt;= &lt;span class=&quot;string&quot;&gt;&#39;\u007f&#39;&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(Util.format(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;Unexpected char %#04x at %d in header name: %s&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) c, i, name));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (value == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; NullPointerException(&lt;span class=&quot;string&quot;&gt;&quot;value for name &quot;&lt;/span&gt; + name + &lt;span class=&quot;string&quot;&gt;&quot; == null&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, length = value.length(); i &amp;lt; length; i++) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; c = value.charAt(i);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((c &amp;lt;= &lt;span class=&quot;string&quot;&gt;&#39;\u001f&#39;&lt;/span&gt; &amp;amp;&amp;amp; c != &lt;span class=&quot;string&quot;&gt;&#39;\t&#39;&lt;/span&gt;) || c &amp;gt;= &lt;span class=&quot;string&quot;&gt;&#39;\u007f&#39;&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(Util.format(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;Unexpected char %#04x at %d in %s value: %s&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) c, i, name, value));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果添加请求的键或值为&lt;code&gt;null&lt;/code&gt;，都会抛出异常，而且还要求键的长度不能为0，值的要求是可见字符，可以是&lt;code&gt;\t&lt;/code&gt;。否则都会抛出异常。&lt;/p&gt;
&lt;p&gt;解决方法是对请求时添加到头里面的内容过滤下就可以了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在使用&lt;code&gt;Okhttp&lt;/code&gt;时遇到两个坑，这里记录一下。一个是在请求头中不需要设置&lt;code&gt;Accept-Encoding&lt;/code&gt;为&lt;code&gt;gzip&lt;/code&gt;，使用&lt;code&gt;Okhttp&lt;/code&gt;默认的就好；第二个是添加到&lt;code&gt;Okhttp&lt;/code&gt;请求头里面的键值对不能为空。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="okhttp" scheme="http://www.jacpy.com/tags/okhttp/"/>
    
  </entry>
  
  <entry>
    <title>Fresco使用HttpURLConnection支持加载https链接图片</title>
    <link href="http://www.jacpy.com/2017/09/28/fresco-used-httpurlconnection-support-https-image-loader.html"/>
    <id>http://www.jacpy.com/2017/09/28/fresco-used-httpurlconnection-support-https-image-loader.html</id>
    <published>2017-09-28T07:09:41.000Z</published>
    <updated>2017-09-30T16:38:03.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天使用&lt;code&gt;Fresco&lt;/code&gt;加载图片时遇到图片加载不出来的问题，然后调试了一下，发现出现如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;javax.net.ssl.SSLException: Connection closed by peer&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;debug时的截图如下图所示：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/09/javax_net_ssl_sslexception.png&quot; alt=&quot;SSLException截图&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;查找原因&quot;&gt;&lt;a href=&quot;#查找原因&quot; class=&quot;headerlink&quot; title=&quot;查找原因&quot;&gt;&lt;/a&gt;查找原因&lt;/h2&gt;&lt;p&gt;上面的截图是在给&lt;code&gt;Fresco&lt;/code&gt;中的展示图片的类&lt;code&gt;SimpleDraweeView&lt;/code&gt;调用如下代码时出现的：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// SimpileDraweeView sdv = ...;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sdv.setController(Fresco.newDraweeControllerBuilder().setControllerListener(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BaseControllerListener&amp;lt;ImageInfo&amp;gt;() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFinalImageSet&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, ImageInfo imageInfo, Animatable animatable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            File file = getCacheFile(request);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (file != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                callback.onImageLoadFinish(file);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFailure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, Throwable throwable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// 这里throwable就是javax.net.ssl.SSLException: Connection closed by peer&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onFailure(id, throwable);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                callback.onFailure(uri, throwable);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    .setImageRequest(request)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    .build());&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看到上面的错误提示，马上反应是不是因为&lt;code&gt;https&lt;/code&gt;证书的原因？原来请求的图片链接是&lt;code&gt;https&lt;/code&gt;地址。到网上一搜，果然，&lt;code&gt;Fresco&lt;/code&gt;默认不支持&lt;code&gt;https&lt;/code&gt;，需要自己设置。一看网上的解决方法，都是使用&lt;code&gt;Okhttp&lt;/code&gt;库来解决的，由于项目比较老，还没有使用&lt;code&gt;Okhttp&lt;/code&gt;库，总不能为了解决这个问题而引入一个库吧？感觉代价太大了。所以跑去看了一下&lt;code&gt;Okhttp&lt;/code&gt;默认请求加载图片的实现。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Okhttp&lt;/code&gt;库加载图片的网络请求处理在这个类&lt;code&gt;com.facebook.imagepipeline.producers.HttpUrlConnectionNetworkFetcher&lt;/code&gt;中，关键的请求处理是在&lt;code&gt;downloadFrom(Uri uri, int maxRedirects)&lt;/code&gt;这个方法中，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; HttpURLConnection &lt;span class=&quot;title&quot;&gt;downloadFrom&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Uri uri, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; maxRedirects)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  HttpURLConnection connection = openConnectionTo(uri);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; responseCode = connection.getResponseCode(); &lt;span class=&quot;comment&quot;&gt;// 请求是在这一步发出的，在这之前设置HTTPS即可&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isHttpSuccess(responseCode)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; connection;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isHttpRedirect(responseCode)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      String nextUriString = connection.getHeaderField(&lt;span class=&quot;string&quot;&gt;&quot;Location&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      connection.disconnect();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      Uri nextUri = (nextUriString == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) ? &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; : Uri.parse(nextUriString);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      String originalScheme = uri.getScheme();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (maxRedirects &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; nextUri != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !nextUri.getScheme().equals(originalScheme)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; downloadFrom(nextUri, maxRedirects - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String message = maxRedirects == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            ? error(&lt;span class=&quot;string&quot;&gt;&quot;URL %s follows too many redirects&quot;&lt;/span&gt;, uri.toString())&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            : error(&lt;span class=&quot;string&quot;&gt;&quot;URL %s returned %d without a valid redirect&quot;&lt;/span&gt;, uri.toString(), responseCode);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IOException(message);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      connection.disconnect();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IOException(String&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          .format(&lt;span class=&quot;string&quot;&gt;&quot;Image URL %s returned HTTP code %d&quot;&lt;/span&gt;, uri.toString(), responseCode));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@VisibleForTesting&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; HttpURLConnection &lt;span class=&quot;title&quot;&gt;openConnectionTo&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Uri uri)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  URL url = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; URL(uri.toString());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; (HttpURLConnection) url.openConnection();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;解决方法&quot;&gt;&lt;a href=&quot;#解决方法&quot; class=&quot;headerlink&quot; title=&quot;解决方法&quot;&gt;&lt;/a&gt;解决方法&lt;/h2&gt;&lt;p&gt;从上面的代码可以看出来，请求是从&lt;code&gt;int responseCode = connection.getResponseCode();&lt;/code&gt;这行代码发出去的，但是又没有对&lt;code&gt;https&lt;/code&gt;的证书进行处理，所以在这之前增加处理即可。于是想到继承这个类来扩展处理&lt;code&gt;https&lt;/code&gt;的情况，结果从上面的代码来看，想从继承的角度增加&lt;code&gt;https&lt;/code&gt;的处理是不可能的。干脆把整个类的代码复制一份，修改类名为&lt;code&gt;HttpsUrlConnectionNetworkFetcher&lt;/code&gt;，修改&lt;code&gt;downloadFrom&lt;/code&gt;这个方法，增加&lt;code&gt;https&lt;/code&gt;证书处理，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HttpsUrlConnectionNetworkFetcher&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BaseNetworkFetcher&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;FetchState&lt;/span&gt;&amp;gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 中间代码忽略...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; HttpURLConnection &lt;span class=&quot;title&quot;&gt;downloadFrom&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Uri uri, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; maxRedirects)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        HttpURLConnection connection = openConnectionTo(uri);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 增加https支持&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String scheme = uri.getScheme();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;string&quot;&gt;&quot;https&quot;&lt;/span&gt;.equals(scheme)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            HttpsURLConnection httpsURLConnection = (HttpsURLConnection) connection;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            SSLContext sslContext = SSLContextUtils.getSSLContext();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (sslContext != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                SSLSocketFactory sslSocketFactory = sslContext.getSocketFactory();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                httpsURLConnection.setSSLSocketFactory(sslSocketFactory);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                httpsURLConnection.setHostnameVerifier(SSLContextUtils.getHostnameVerifier());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; responseCode = connection.getResponseCode(); &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 其它代码忽略...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;SSLContextUtils&lt;/code&gt;类中忽略对证书的处理，信任所有证书，这种做法很不安全，仅供参考。代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; android.util.Log;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.security.SecureRandom;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.security.cert.X509Certificate;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.HostnameVerifier;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.SSLContext;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.SSLSession;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.TrustManager;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.X509TrustManager;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * SSL工具类&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SSLContextUtils&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; HostnameVerifier hostnameVerifier = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HostnameVerifier() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;verify&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String hostname, SSLSession session)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; HostnameVerifier &lt;span class=&quot;title&quot;&gt;getHostnameVerifier&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; hostnameVerifier;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; SSLContext &lt;span class=&quot;title&quot;&gt;getSSLContext&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        SSLContext sslContext = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            sslContext = SSLContext.getInstance(&lt;span class=&quot;string&quot;&gt;&quot;TLS&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            sslContext.init(&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; TrustManager[]&amp;#123;&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; X509TrustManager() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkClientTrusted&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(X509Certificate[] chain, String authType)&lt;/span&gt;  &lt;/span&gt;&amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkServerTrusted&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(X509Certificate[] chain, String authType)&lt;/span&gt; &lt;/span&gt;&amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; X509Certificate[] getAcceptedIssuers() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; X509Certificate[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&amp;#125;, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; SecureRandom());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (Exception e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Log.e(&lt;span class=&quot;string&quot;&gt;&quot;SSLContextUtils&quot;&lt;/span&gt;, e.getMessage(), e);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; sslContext;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最后需要把这个自定义的类的通过调用&lt;code&gt;ImagePipelineConfig.Builder#setNetworkFetcher()&lt;/code&gt;方法设置进来，指定加载图片时使用新的网络请求策略。具体代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;ImagePipelineConfig config = ImagePipelineConfig.newBuilder(context)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        .setDownsampleEnabled(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        .setNetworkFetcher(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HttpsUrlConnectionNetworkFetcher()) &lt;span class=&quot;comment&quot;&gt;// 这里设置自定义类&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        .build();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Fresco.initialize(context, config);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再重新运行App，图片加载出来了，问题解决。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天使用&lt;code&gt;Fresco&lt;/code&gt;加载图片时遇到图片加载不出来的问题，然后调试了一下，发现出现如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;javax.net.ssl.SSLException: Connection closed by peer&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;debug时的截图如下图所示：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="fresco HttpURLConnection" scheme="http://www.jacpy.com/tags/fresco-HttpURLConnection/"/>
    
  </entry>
  
  <entry>
    <title>sublime使用markdownEdit设置</title>
    <link href="http://www.jacpy.com/2017/09/22/config-4-sublime-markdownedit.html"/>
    <id>http://www.jacpy.com/2017/09/22/config-4-sublime-markdownedit.html</id>
    <published>2017-09-22T11:12:12.000Z</published>
    <updated>2017-09-22T12:13:31.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天&lt;code&gt;sublime&lt;/code&gt;发布正式版本，mac下面一直没有发现跟windows下的&lt;code&gt;notepad++&lt;/code&gt;相媲美的工具，于是装了下&lt;code&gt;sublime&lt;/code&gt;玩玩，也试了下&lt;code&gt;markdown&lt;/code&gt;插件，结果发现太坑爹了，于是走上了不归路。&lt;/p&gt;
&lt;p&gt;装完&lt;code&gt;markdown&lt;/code&gt;插件后，打开&lt;code&gt;md&lt;/code&gt;文件，发现界面很丑，MD风格都被吓跑了。如下图所示：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/09/sublime_markdown_pre.png&quot; alt=&quot;配置前的样式&quot;&gt;&lt;/p&gt;
&lt;p&gt;经过一翻折腾，MD终于又回来了，结果图如下所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/09/sublime_markdown_post.png&quot; alt=&quot;配置后的样式&quot;&gt;&lt;/p&gt;
&lt;p&gt;修改的配置如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;color_scheme&amp;quot;: &amp;quot;Packages/Material Theme/schemes/Material-Theme-Darker.tmTheme&amp;quot;, // 修改主题为MD主题，此时发现背景色会改变，不再是白色&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;line_numbers&amp;quot;: true, // 显示行号&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;highlight_line&amp;quot;: true, // 光标所在行高亮&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;wrap_width&amp;quot;: 0, // 默认是80个字符就换行，这里改成0，使用默认值，sublime默认的配置就是这个值&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;draw_centered&amp;quot;: false, // 不自动居中，如果发现一行中内容不多，就会出现上面截图中左侧到行号之前有大面积空白&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;怎么修改配置呢？&lt;/p&gt;
&lt;p&gt;先注意&lt;code&gt;sublime&lt;/code&gt;的右下角有一个&lt;code&gt;Markdown GFM&lt;/code&gt;标识，然后依次&lt;code&gt;Preference&lt;/code&gt;-&amp;gt;&lt;code&gt;Package Settings&lt;/code&gt;-&amp;gt;&lt;code&gt;Markdown Edting&lt;/code&gt;-&amp;gt;&lt;code&gt;Markdown GFM Settings-User&lt;/code&gt;，操作如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/09/sublime_markdown_preference.png&quot; alt=&quot;配置后的样式&quot;&gt;&lt;/p&gt;
&lt;p&gt;会打开一个标题为&lt;code&gt;Markdown.sublime-settings--MarkdownEditing&lt;/code&gt;文件，把上面的配置内容复制进去，保存后重启&lt;code&gt;sublime&lt;/code&gt;，再打开md文件样式就已经改变了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天&lt;code&gt;sublime&lt;/code&gt;发布正式版本，mac下面一直没有发现跟windows下的&lt;code&gt;notepad++&lt;/code&gt;相媲美的工具，于是装了下&lt;code&gt;sublime&lt;/code&gt;玩玩，也试了下&lt;code&gt;markdown&lt;/code&gt;插件，结果发现太坑爹了，于是走上了不归路。&lt;/p&gt;
&lt;p&gt;装完&lt;code&gt;markdown&lt;/code&gt;插件后，打开&lt;code&gt;md&lt;/code&gt;文件，发现界面很丑，MD风格都被吓跑了。如下图所示：&lt;/p&gt;
    
    </summary>
    
      <category term="sublime" scheme="http://www.jacpy.com/categories/sublime/"/>
    
    
      <category term="markdown设置 sublime" scheme="http://www.jacpy.com/tags/markdown%E8%AE%BE%E7%BD%AE-sublime/"/>
    
  </entry>
  
  <entry>
    <title>android installation failed with message INSTALL_FAILED_TEST_ONLY</title>
    <link href="http://www.jacpy.com/2017/09/21/android-installation-failed-with-message-INSTALL-FAILED-TEST-ONLY-md.html"/>
    <id>http://www.jacpy.com/2017/09/21/android-installation-failed-with-message-INSTALL-FAILED-TEST-ONLY-md.html</id>
    <published>2017-09-21T05:28:12.000Z</published>
    <updated>2017-09-22T12:24:10.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天一直在试用Android Studio Beta版本，在给6.0的手机安装调试包是遇到了下面的问题，一运行AS就弹出&lt;code&gt;INSTALL_FAILED_TEST_ONLY&lt;/code&gt;对话框提示，然后点&lt;code&gt;OK&lt;/code&gt;，在6.0手机上提示&lt;code&gt;应用程序未安装&lt;/code&gt;，但是在4.4手机上运行却没有对话框提示，可以正常运行，奇了怪了，跑去搜索了一下。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Installation failed with message INSTALL_FAILED_TEST_ONLY.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;It is possible that this issue is resolved by uninstalling an existing version of the apk if it is present, and then re-installing.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;WARNING: Uninstalling will remove the application data!&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Do you want to uninstall the existing application?&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;结果找到了这篇文章&lt;code&gt;http://www.cnblogs.com/bluestorm/p/6934433.html&lt;/code&gt;，上面说&lt;code&gt;classpath&lt;/code&gt;与&lt;code&gt;distributionUrl&lt;/code&gt;要一一对应：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;在AS 2.3上面：&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;classpath &amp;apos;com.android.tools.build:gradle:2.3.2&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;对应：&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;distributionUrl=https\://services.gradle.org/distributions/gradle-3.3-all.zip&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;在AS 3.0上面：&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;classpath &amp;apos;com.android.tools.build:gradle:3.0.0-alpha2`&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;对应：&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;distributionUrl=https\://services.gradle.org/distributions/gradle-4.0-milestone-1-all.zip&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;由于自己当前使用的是AS 3.0 beta5版本，&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;classpath: &amp;apos;com.android.tools.build:gradle:3.0.0-beta5&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;distributionUrl=https\://services.gradle.org/distributions/gradle-4.1-all.zip&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;所以认为也是对的，按照上面的文章所说的对应关系。&lt;/p&gt;
&lt;p&gt;发现没有解决问题，在&lt;code&gt;stackoverflow&lt;/code&gt;上面找到这个链接&lt;code&gt;https://stackoverflow.com/questions/25274296/adb-install-fails-with-install-failed-test-only&lt;/code&gt;，说是在启动的时候加上&lt;code&gt;-t&lt;/code&gt;参数，结果试了下，发现还是弹框提示，问题没有解决。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;思路又回到之前的解决方案上面，难道是对应关系问题？于是改成以下对应关系：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;classpath &amp;apos;com.android.tools.build:gradle:2.3.3&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;distributionUrl=https\://services.gradle.org/distributions/gradle-4.1-all.zip&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;一运行，没弹框了，问题解决了。果真是对应关系问题。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天一直在试用Android Studio Beta版本，在给6.0的手机安装调试包是遇到了下面的问题，一运行AS就弹出&lt;code&gt;INSTALL_FAILED_TEST_ONLY&lt;/code&gt;对话框提示，然后点&lt;code&gt;OK&lt;/code&gt;，在6.0手机上提示&lt;code&gt;应用程序未安装&lt;/code&gt;，但是在4.4手机上运行却没有对话框提示，可以正常运行，奇了怪了，跑去搜索了一下。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="INSTALL_FAILED_TEST_ONLY" scheme="http://www.jacpy.com/tags/INSTALL-FAILED-TEST-ONLY/"/>
    
  </entry>
  
  <entry>
    <title>Android命令行安装APK时报错：INSTALL_FAILED_UID_CHANGED</title>
    <link href="http://www.jacpy.com/2017/09/07/android-install-apk-INSTALL-FAILED-UID-CHANGED.html"/>
    <id>http://www.jacpy.com/2017/09/07/android-install-apk-INSTALL-FAILED-UID-CHANGED.html</id>
    <published>2017-09-07T05:13:24.000Z</published>
    <updated>2017-09-07T06:29:02.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天使用命令行&lt;code&gt;adb install&lt;/code&gt;安装APK文件时，安装失败，遇到了这个错误提示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;INSTALL_FAILED_UID_CHANGED&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;突然反应过来了，刚刚使用手机的&lt;code&gt;root&lt;/code&gt;权限看app的缓存数据，命令行还在那个&lt;code&gt;/data/data/com.xxx.app&lt;/code&gt;目录下，由于命令行的占用，所以这个包名路径没有被删除掉。赶紧退出到&lt;code&gt;/data/data/&lt;/code&gt;目录下面，&lt;code&gt;ls&lt;/code&gt;一看，这个包名路径还存在，用&lt;code&gt;rm -rf&lt;/code&gt;一删除，再安装试下，成功了。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;回想之前调试微信支付功能，调的头大，经常卸载安装微信。结果有一次就安装失败了，提示&lt;code&gt;应用已经安装&lt;/code&gt;，结果同样去&lt;code&gt;/data/data&lt;/code&gt;目录下面一看，结果微信的包名路径还在。然后执行&lt;code&gt;rm -rf&lt;/code&gt;删除，删除失败，跑去删除子目录，都能删除，最后有一个目录删除不了。心想这跟U盘一样，出现坏道了？微信不可能创建一个目录还不让删除的。结果一直提示删除失败，这&lt;code&gt;root&lt;/code&gt;权限都使不上劲。最后没办法了，只好换台手机调试。&lt;/p&gt;
&lt;p&gt;自己的测试手机上装不了微信，这个事一直挂在心上。只要能把包名路径给删除了，就可以装微信了，想着怎么删除。突然有一天，想到看能不能把这个目录移出去，然后再来删除包名路径。于是使用&lt;code&gt;mv&lt;/code&gt;命令将这个目录移走，然后再删除包名，删除成功了，再删除那个目录，还是删除不掉，算了，不管了。一安装微信，装成功了。大喜！终于又可以装上微信了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天使用命令行&lt;code&gt;adb install&lt;/code&gt;安装APK文件时，安装失败，遇到了这个错误提示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;INSTALL_FAILED_UID_CHANGED&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;突然反应过来了，刚刚使用手机的&lt;code&gt;root&lt;/code&gt;权限看app的缓存数据，命令行还在那个&lt;code&gt;/data/data/com.xxx.app&lt;/code&gt;目录下，由于命令行的占用，所以这个包名路径没有被删除掉。赶紧退出到&lt;code&gt;/data/data/&lt;/code&gt;目录下面，&lt;code&gt;ls&lt;/code&gt;一看，这个包名路径还存在，用&lt;code&gt;rm -rf&lt;/code&gt;一删除，再安装试下，成功了。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="install apk INSTALL_FAILED_UID_CHANGED" scheme="http://www.jacpy.com/tags/install-apk-INSTALL-FAILED-UID-CHANGED/"/>
    
  </entry>
  
  <entry>
    <title>gradle failed to create MD5 hash for file</title>
    <link href="http://www.jacpy.com/2017/09/07/gradle-failed-to-create-md5-hash-for-file.html"/>
    <id>http://www.jacpy.com/2017/09/07/gradle-failed-to-create-md5-hash-for-file.html</id>
    <published>2017-09-07T05:03:59.000Z</published>
    <updated>2017-09-07T06:29:17.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在使用gradle编译项目插件，突然遇到这个错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;FAILURE: Build failed with an exception.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* What went wrong:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Execution failed for task &amp;apos;:compileReleaseJavaWithJavac&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; Failed to create MD5 hash for file &amp;apos;E:\workspace\as\app\libs\xxx.jar&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* Try:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BUILD FAILED&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;然后在对应目录找了下这个文件，发现没有这个&lt;code&gt;jar&lt;/code&gt;文件。于是去&lt;code&gt;build.gradle&lt;/code&gt;文件中的&lt;code&gt;depenencies&lt;/code&gt;下面找到了这个&lt;code&gt;provided files&lt;/code&gt;依赖，然后把这个&lt;code&gt;provided files&lt;/code&gt;行删除，然后重新编译就OK了。&lt;/p&gt;
&lt;p&gt;发现使用&lt;code&gt;compile files&lt;/code&gt;和&lt;code&gt;provided files&lt;/code&gt;引用文件时，如果引用的文件不存，都会报这个错误。删除就好了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在使用gradle编译项目插件，突然遇到这个错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;FAILURE: Build failed with an exception.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* What went wrong:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Execution failed for task &amp;apos;:compileReleaseJavaWithJavac&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; Failed to create MD5 hash for file &amp;apos;E:\workspace\as\app\libs\xxx.jar&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* Try:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BUILD FAILED&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="gradle" scheme="http://www.jacpy.com/categories/gradle/"/>
    
    
      <category term="failed to create MD5 hash for file" scheme="http://www.jacpy.com/tags/failed-to-create-MD5-hash-for-file/"/>
    
  </entry>
  
  <entry>
    <title>android听云升级后编译报错</title>
    <link href="http://www.jacpy.com/2017/08/03/network-bench-update-compile-error-md.html"/>
    <id>http://www.jacpy.com/2017/08/03/network-bench-update-compile-error-md.html</id>
    <published>2017-08-03T01:00:09.000Z</published>
    <updated>2017-08-07T05:16:41.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;升级遇到的问题&quot;&gt;&lt;a href=&quot;#升级遇到的问题&quot; class=&quot;headerlink&quot; title=&quot;升级遇到的问题&quot;&gt;&lt;/a&gt;升级遇到的问题&lt;/h2&gt;&lt;p&gt;项目中由于需要，集成了听云的SDK，最近把听云的SDK版本从&lt;code&gt;2.4.4&lt;/code&gt;升级到&lt;code&gt;2.5.7&lt;/code&gt;，重新运行时，在编译过程中报了如下错误：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[NBSAgent.error] Error:com.networkbench.agent.compile.a: NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;java.lang.RuntimeException: com.networkbench.agent.compile.a: NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.a(SourceFile:517)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.a(SourceFile:296)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e$1$1.invoke(SourceFile:328)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.invoke(SourceFile:425)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processClass(Main.java)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processFileBytes(Main.java:723)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.access$1200(Main.java:85)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main$FileBytesConsumer.processFileBytes(Main.java:1653)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.cf.direct.ClassPathOpener.processArchive(ClassPathOpener.java:284)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:166)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.cf.direct.ClassPathOpener.process(ClassPathOpener.java:144)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processOne(Main.java:677)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processAllFiles(Main.java:569)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.runMultiDex(Main.java:366)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.run(Main.java:275)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.main(Main.java:245)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.dx.command.Main.main(Main.java:106)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Caused by: com.networkbench.agent.compile.a: NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.a.e.a(SourceFile:91)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.a.h.a(SourceFile:43)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.b.f.a(SourceFile:644)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.b.f.a(SourceFile:439)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.a(SourceFile:479)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ... 16 more&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Dex: Error converting bytecode to dex:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Cause: java.lang.RuntimeException: Exception parsing classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    UNEXPECTED TOP-LEVEL EXCEPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    java.lang.RuntimeException: Exception parsing classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processClass(Main.java:760)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processFileBytes(Main.java:723)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.access$1200(Main.java:85)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main$FileBytesConsumer.processFileBytes(Main.java:1653)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.processArchive(ClassPathOpener.java:284)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:166)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.process(ClassPathOpener.java:144)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processOne(Main.java:677)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processAllFiles(Main.java:569)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.runMultiDex(Main.java:366)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.run(Main.java:275)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.main(Main.java:245)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.Main.main(Main.java:106)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Caused by: java.lang.NullPointerException&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.util.ByteArray.&amp;lt;init&amp;gt;(ByteArray.java:76)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.DirectClassFile.&amp;lt;init&amp;gt;(DirectClassFile.java:206)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.parseClass(Main.java:769)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.access$1500(Main.java:85)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main$ClassParserTask.call(Main.java:1700)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processClass(Main.java:755)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ... 12 more&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1 error; aborting&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:app:transformClassesWithDexForDebug FAILED&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:app:networkBenchNewLensDeinstrumentTask&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[NBSAgent.debug] NetworkBench begin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FAILURE: Build failed with an exception.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* What went wrong:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Execution failed for task &amp;apos;:app:transformClassesWithDexForDebug&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; com.android.build.api.transform.TransformException: com.android.ide.common.process.ProcessException: java.util.concurrent.ExecutionException: com.android.ide.common.process.ProcessException: Error while executing java process with main class com.android.dx.command.Main with arguments &amp;#123;--dex --num-threads=4 --multi-dex --main-dex-list /data/jenkins/workspace/app/build/intermediates/multi-dex/debug/maindexlist.txt --output /data/jenkins/workspace/app/build/intermediates/transforms/dex/debug/folders/1000/1f/main /data/jenkins/workspace/app/build/intermediates/transforms/jarMerging/debug/jars/1/1f/combined.jar&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* Try:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BUILD FAILED&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;解决问题&quot;&gt;&lt;a href=&quot;#解决问题&quot; class=&quot;headerlink&quot; title=&quot;解决问题&quot;&gt;&lt;/a&gt;解决问题&lt;/h2&gt;&lt;p&gt;遇到了上面的编译错误问题，先google了一下，没有人提出了这样的错误，也没有解决方案，而且从搜索的结果来看，用的人也不多。这问题只能是自己解决了，从上面的错误提示来看，这个错误是听云中抛出来的。也就是听云干预了编译过程。从这个&lt;code&gt;NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/code&gt;错误提示上来看，说是版本没有对应起来。的确，听云在&lt;code&gt;project&lt;/code&gt;下面的&lt;code&gt;build.gradle&lt;/code&gt;中的&lt;code&gt;dependencies&lt;/code&gt;块中的&lt;code&gt;classpath&lt;/code&gt;中和&lt;code&gt;module&lt;/code&gt;下面的&lt;code&gt;build.gradle&lt;/code&gt;中的&lt;code&gt;dependencies&lt;/code&gt;块中的&lt;code&gt;compile&lt;/code&gt;两个地方都要指定一个版本SDK。一个是用来干预编译过程，植入代码；一个则是要植入的代码。&lt;/p&gt;
&lt;p&gt;引入方式如下代码所示：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;project&lt;/code&gt;目录下面的&lt;code&gt;build.gradle&lt;/code&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    classpath &amp;apos;com.networkbench.newlens.agent.android:agent-gradle-plugin:2.5.7&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;app&lt;/code&gt;目录下面的&lt;code&gt;build.gradle&lt;/code&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   	compile &amp;apos;com.networkbench.newlens.agent.android:nbs.newlens.agent:2.5.7&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;那为什么会有上面有错误？按道理说两者都具备就可以了，猜是听云的版本兼容性问题，也就是&lt;code&gt;2.5.7&lt;/code&gt;不兼容&lt;code&gt;2.4.4&lt;/code&gt;版本。也就是上面说的&lt;code&gt;classpath&lt;/code&gt;与&lt;code&gt;compile&lt;/code&gt;版本要一一对应，版本号必须保持一致。但修改时的版本号是保持一致的呀？问题出在哪儿？缓存问题？&lt;/p&gt;
&lt;p&gt;于是先&lt;code&gt;clean&lt;/code&gt;，然后再重新&lt;code&gt;build了&lt;/code&gt;一下，再运行时，发现问题依旧。没折了，我把版本号改回去&lt;code&gt;2.4.4&lt;/code&gt;总行吧？结果还是编译报错，无语了，试了几次，还是这样，现在感觉到自己进入到进退两难的地步了。最后重新启动&lt;code&gt;AS&lt;/code&gt;，再重新运行了，问题解决了，编译时不报错了，真是太惊喜，太意外了。&lt;/p&gt;
&lt;p&gt;OK，本地问题解决了，服务器的自动构建上又出现问题。按照解决本地问题的思路，不可能重启服务器吧？仔细一想，还是缓存问题？问了运维，说每次构建都会自动清除&lt;code&gt;build&lt;/code&gt;目录中的内容。但心想，与&lt;code&gt;build&lt;/code&gt;目录的内容无关，自己解决问题时都删了好几次，问题依旧没有解决。突然想起平时经常被&lt;code&gt;kill&lt;/code&gt;的&lt;code&gt;java.exe&lt;/code&gt;进程，这个进程里面会缓存一些东西，编译时经常会看到&lt;code&gt;Starting a Gradle Daemon&lt;/code&gt;这样的提示，&lt;code&gt;AS&lt;/code&gt;要提高编译速度，肯定会在这个进程里面缓存一些东西，不然这个&lt;code&gt;java.exe&lt;/code&gt;进程内存占用会有几百M甚至超过1个G？&lt;/p&gt;
&lt;p&gt;跑去跟运维说，你把这个&lt;code&gt;java&lt;/code&gt;进程先&lt;code&gt;kill&lt;/code&gt;，然后再重新构建。果然，&lt;code&gt;kill&lt;/code&gt;进程之后再重新自动构建就OK了。后来想了一下，自己本地重启&lt;code&gt;AS&lt;/code&gt;也是重新启动这个&lt;code&gt;java&lt;/code&gt;进程。&lt;/p&gt;
&lt;h2 id=&quot;为什么要用听云&quot;&gt;&lt;a href=&quot;#为什么要用听云&quot; class=&quot;headerlink&quot; title=&quot;为什么要用听云&quot;&gt;&lt;/a&gt;为什么要用听云&lt;/h2&gt;&lt;p&gt;听云是收费的，但也有免费的版本，免费的版本最多只能看三天的数据。我看重听云的最大一个好处是可以监控网络情况，比如说哪些接口失败率比较高、请求耗时等，这样可以做一些优化。&lt;/p&gt;
&lt;p&gt;但听云有一个不好的地方是，对代码进行侵入，有时候在报错的堆栈中看到了听云的堆栈信息。如果项目结构设计不好，用的第三方库太多，估计听云的代码会插入的到处都是，这里没有整理出数据来。&lt;/p&gt;
&lt;p&gt;另外听去的另外一个ANR日志收集的功能没有做好，把&lt;code&gt;traces.txt&lt;/code&gt;日志文件中的有用的信息基本都过虑掉了，只留下一些堆栈信息。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;升级遇到的问题&quot;&gt;&lt;a href=&quot;#升级遇到的问题&quot; class=&quot;headerlink&quot; title=&quot;升级遇到的问题&quot;&gt;&lt;/a&gt;升级遇到的问题&lt;/h2&gt;&lt;p&gt;项目中由于需要，集成了听云的SDK，最近把听云的SDK版本从&lt;code&gt;2.4.4&lt;/code&gt;升级到&lt;code&gt;2.5.7&lt;/code&gt;，重新运行时，在编译过程中报了如下错误：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="听云" scheme="http://www.jacpy.com/tags/%E5%90%AC%E4%BA%91/"/>
    
  </entry>
  
  <entry>
    <title>sqlite cant open database exception unknow error code 14</title>
    <link href="http://www.jacpy.com/2017/08/03/sqlite-cant-open-database-exception-unknow-error-code-14-md.html"/>
    <id>http://www.jacpy.com/2017/08/03/sqlite-cant-open-database-exception-unknow-error-code-14-md.html</id>
    <published>2017-08-03T00:59:05.000Z</published>
    <updated>2017-08-07T07:44:03.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天在解决客户的一个问题，说用了发给我的sqlite的数据库文件会发生数据上传失败问题，于是结合发过来的数据库文件准备看一下。&lt;/p&gt;
&lt;p&gt;先是通过&lt;code&gt;adb push&lt;/code&gt;命令把文件copy到手机，然后cp到应用的缓存目录（需要root权限），覆盖原来的数据库文件。结果应用一运行就报了如下的错误：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;E/SQLiteLog: (14) cannot open file at line 30191 of [00bb9c9ce4]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;E/SQLiteLog: (14) os_unix.c:30191: (13) open(/data/data/com.xxx/databases/xxx) - &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;E/SQLiteDatabase: Failed to open database &amp;apos;/data/data/xxx/databases/xxxx&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.database.sqlite.SQLiteCantOpenDatabaseException: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;unknown error (code 14): Could not open database&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看提示说是读了多少行后报错，第一反应是数据库文件有问题？在PC端用工具打开那个文件，发现能正常打开，而且执行了SQL都是正常看到数据。奇了怪了，那个&lt;code&gt;line&lt;/code&gt;是代码的行数？直接搜索上面的错误，在&lt;code&gt;stackoverflow&lt;/code&gt;上面看别人各种回答。有的说是权限问题，要先申请权限，有的说是6.0上面的问题，要动态权限等等。结合自己的情况，发现都不是。接着往下看，发现有人提到了&lt;code&gt;SELinux security&lt;/code&gt;，突然想到了是不是权限问题？马上命令一看，果然只有root权限，执行&lt;code&gt;chomd 777 xxxx&lt;/code&gt;，然后再一运行app，OK了。&lt;/p&gt;
&lt;p&gt;运气太好了，这样就解决问题了，还想说报那个&lt;code&gt;code 14&lt;/code&gt;是什么错误呢。后来到sqlite源码里面找了一下，找到这个的一个宏定义&lt;code&gt;#define SQLITE_CANTOPEN    14   /* Unable to open the database file */&lt;/code&gt;，这个提示对解决问题并没有什么帮助，很佩服自己当时的反应。网上也有人说这里有一个bug，没有去深究，问题已解决，后面的事情还没有做呢！&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天在解决客户的一个问题，说用了发给我的sqlite的数据库文件会发生数据上传失败问题，于是结合发过来的数据库文件准备看一下。&lt;/p&gt;
&lt;p&gt;先是通过&lt;code&gt;adb push&lt;/code&gt;命令把文件copy到手机，然后cp到应用的缓存目录（需要root权限），覆盖原来的数据库文件。结果应用一运行就报了如下的错误：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="sqlite error code 14" scheme="http://www.jacpy.com/tags/sqlite-error-code-14/"/>
    
  </entry>
  
  <entry>
    <title>android device or resource busy</title>
    <link href="http://www.jacpy.com/2017/05/03/android-device-or-resource-busy.html"/>
    <id>http://www.jacpy.com/2017/05/03/android-device-or-resource-busy.html</id>
    <published>2017-05-03T09:28:14.000Z</published>
    <updated>2017-08-02T05:12:12.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在项目开发中遇到一个很奇葩的问题，在应用中做了一个清除应用缓存功能，将缓存目录文件中所有的文件都删除，然后再重新初始化的时候，这个目录就不能创建文件和目录了。在红米手机和魅族手机上试了，都会出现这个问题，华为手机上却没有这个问题，我的MOTO手机上也有这个问题。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;于是在命令行进入&lt;code&gt;shell&lt;/code&gt;，然后&lt;code&gt;cd&lt;/code&gt;到这个目录提示&lt;code&gt;tmp-mksh:  Device or resource busy&lt;/code&gt;错误。用手机中的文件管理器删除这个目录提示删除失败。最后把应用卸载了，然后再删除，又可以删除这个目录。&lt;/p&gt;
&lt;p&gt;这就奇了怪了，到底是怎么回事？在这个目录用执行&lt;code&gt;new File(path).mkdirs()&lt;/code&gt;方法时，返回false，创建目录失败。导致应用没有办法在这个目录创建缓存数据，导致整个应用都没有办法正常进行，如果处理这种失败情况，很多地方都得改。但有些地方是分裂式的，这一个地方失败，会影响其他N多地方。但是之前用这个功能都没有问题，只是近期出现了这个问题。&lt;/p&gt;
&lt;p&gt;不行，得找出原因。于是把清除缓存目录下面的文件路径都用日志输出了一遍，结果突然发现一些个奇怪的文件–&lt;code&gt;mmap&lt;/code&gt;文件。这些文件是在使用腾讯&lt;code&gt;mars&lt;/code&gt;开源库中的&lt;code&gt;xlog&lt;/code&gt;组件产生的内核映射文件，用来同步缓存日志，防止日志因为应用出现意外而丢失。按照&lt;code&gt;xlog&lt;/code&gt;的官方demo中的使用方法，&lt;code&gt;xlog&lt;/code&gt;的初始化和关闭都是在&lt;code&gt;Application&lt;/code&gt;中。删除缓存目录下面的日志文件时并没有关闭&lt;code&gt;xlog&lt;/code&gt;，&lt;code&gt;mmap&lt;/code&gt;文件直接被删除，所以才导致上面说的奇葩问题。&lt;/p&gt;
&lt;p&gt;目测是原因找到了，于是在删除缓存时，日志目录下面的日志文件都不删除，最后问题解决。至于是什么原因导致删除&lt;code&gt;mmap&lt;/code&gt;文件出现上面的问题就不得而知，但是感觉整个目录被锁死了，直到删除应用才释放，强制停止应用都不起作用。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在项目开发中遇到一个很奇葩的问题，在应用中做了一个清除应用缓存功能，将缓存目录文件中所有的文件都删除，然后再重新初始化的时候，这个目录就不能创建文件和目录了。在红米手机和魅族手机上试了，都会出现这个问题，华为手机上却没有这个问题，我的MOTO手机上也有这个问题。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="Device or resource busy" scheme="http://www.jacpy.com/tags/Device-or-resource-busy/"/>
    
  </entry>
  
  <entry>
    <title>关于android fresco初始化的一个坑</title>
    <link href="http://www.jacpy.com/2017/05/02/android-fresco-init.html"/>
    <id>http://www.jacpy.com/2017/05/02/android-fresco-init.html</id>
    <published>2017-05-02T13:42:22.000Z</published>
    <updated>2017-08-02T05:21:45.000Z</updated>
    
    <content type="html">&lt;p&gt;之前有写文章说别人对网上文章的看法，这次写的是我对网上文章的看法。一直以来对网上的文章的说法都抱有怀疑态度，一般都是把网上的东西作为参考，找准关键的地方，他的说法与自己写的有什么区别？一对比就知道哪些地方有欠缺，是什么原因。而不是直接copy过来使用。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;blockquote&gt;
&lt;p&gt;以下这段内容可以选择忽略。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;举个前几天在项目中遇到的例子。在&lt;code&gt;android中捕获崩溃日志&lt;/code&gt;看到了将Throwable对象转换成字符串，写了很大一串。心想这段代码肯定来自网络，写这篇文章的时候去搜索了一下，果然。因为系统已经提供了将Throwable对象转换为字符串的方法，只需要调用就行，一行代码就可以搞定，有的甚至把&lt;code&gt;android.util.Log&lt;/code&gt;输出Throwable对象的方式重新再写了一遍，解决问题的思路很赞。但如果再多看一眼，&lt;code&gt;Log&lt;/code&gt;类中提供了&lt;code&gt;getStackTraceString(Throwable)&lt;/code&gt;静态方法，方便处理这种事情，而且这个方法是从&lt;code&gt;API Level 1&lt;/code&gt;开始就有。&lt;/p&gt;
&lt;p&gt;OK，回到主题上来。事情的起因是项目中的一个bug。&lt;/p&gt;
&lt;p&gt;项目中有一个滚动的Gallery查看大图，还有一个将图片保存到本地功能。但保存图片时会概率性失败，这个问题是测试反馈的，而且概率很高。自己测试发现进这个界面保存当前看到的这张图片能成功，后面每次保存都失败。&lt;/p&gt;
&lt;p&gt;跟踪代码发现失败的原因是从SD卡中&lt;code&gt;Fresco&lt;/code&gt;库缓存取图片时，图片不存在，所以保存失败。那为什么保存当前图片成功？&lt;/p&gt;
&lt;p&gt;于是将缓存目录下面的内容都用日志打了出来。以下代码在每次图片加载完后就会把缓存内容都以LOG方式输出。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PhotoDraweeView photoDraweeView = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; PhotoDraweeView(context);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PipelineDraweeControllerBuilder controller = Fresco.newDraweeControllerBuilder();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller.setUri(uri); &lt;span class=&quot;comment&quot;&gt;// 图片请求的URL地址&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller.setAutoPlayAnimations(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller.setOldController(photoDraweeView.getController());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller.setControllerListener(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BaseControllerListener&amp;lt;ImageInfo&amp;gt;() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFinalImageSet&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, ImageInfo imageInfo, Animatable animatable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onFinalImageSet(id, imageInfo, animatable);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (imageInfo == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        FileBinaryResource resource = (FileBinaryResource) ImagePipelineFactory.getInstance().getMainFileCache().getResource(DefaultCacheKeyFactory.getInstance().getEncodedCacheKey(controller.getImageRequest(), &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;resource: &quot;&lt;/span&gt; + resource);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            List&amp;lt;DiskStorage.DiskDumpInfoEntry&amp;gt; list = Fresco.getImagePipelineFactory().getMainFileCache().getDumpInfo().entries;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (list != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !list.isEmpty()) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (DiskStorage.DiskDumpInfoEntry info : list) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;size: &quot;&lt;/span&gt; + info.size + &lt;span class=&quot;string&quot;&gt;&quot;, type: &quot;&lt;/span&gt; + info.type + &lt;span class=&quot;string&quot;&gt;&quot;, path: &quot;&lt;/span&gt; + info.path + &lt;span class=&quot;string&quot;&gt;&quot;, fb: &quot;&lt;/span&gt; + info.firstBits);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IOException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onIntermediateImageSet&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, ImageInfo imageInfo)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFailure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, Throwable throwable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以下是输出的LOG，&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@2f8cf0a9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1580616.0, type: jpg, path: imgcache/v2.ols100.1/3/3qC9ts9ad_tJcsN1ot7Ort5YQ9A.cnt, fb: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@411bafa9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1.0461388E7, type: jpg, path: imgcache/v2.ols100.1/24/r0c37nN9TT6P-HU0hoYwm_ZU5K4.cnt, fb: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@6d7fddcf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1622679.0, type: jpg, path: imgcache/v2.ols100.1/1/BYrt44bfrnqXpdkx5x4p1W_RsTY.cnt, fb: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@bfbbc062&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1127054.0, type: jpg, path: imgcache/v2.ols100.1/96/mhZk2iyqbM0iKt2RmDV0aKT0o5Q.cnt, fb:&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从上面的日志中看出图片都缓存到了指定的路径，但是从文件管理器中去查看&lt;code&gt;v2.ols100.1&lt;/code&gt;目录下面的对应目录基本都为空，只有一个目录中有缓存图片，整个目录大小只有几百KB。感觉图片只缓存了一张，其它的都没有缓存到外部存储空间上来。&lt;/p&gt;
&lt;p&gt;看了一下存储空间，还有几个G，不存在空间不足。与图片大小有关系？换了大图试试，也还是这样。开始怀疑与Fresco相关的代码，于是找到了Fresco初始化代码，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DiskCacheConfig.Builder builder = DiskCacheConfig.newBuilder(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSize(&lt;span class=&quot;number&quot;&gt;150&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnLowDiskSpace(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnVeryLowDiskSpace(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * ByteConstants.MB);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setVersion(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setBaseDirectoryName(&lt;span class=&quot;string&quot;&gt;&quot;imgcache&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setBaseDirectoryPath(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; File(FileUtils.getUserWorkingFolder()));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DiskCacheConfig diskCacheConfig = builder.build();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ImagePipelineConfig config = ImagePipelineConfig.newBuilder(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        .setMainDiskCacheConfig(diskCacheConfig)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        .build();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Fresco.initialize(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt; , config);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;想知道这几个参数值表示的是什么意思，是怎么使用的。于是就查看了源码，发现这个参数初始化代码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; mMaxCacheSize = &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt; * ByteConstants.MB;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; mMaxCacheSizeOnLowDiskSpace = &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; * ByteConstants.MB;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; mMaxCacheSizeOnVeryLowDiskSpace = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; * ByteConstants.MB;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Builder &lt;span class=&quot;title&quot;&gt;setMaxCacheSize&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; maxCacheSize)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mMaxCacheSize = maxCacheSize;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Builder &lt;span class=&quot;title&quot;&gt;setMaxCacheSizeOnLowDiskSpace&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; maxCacheSizeOnLowDiskSpace)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mMaxCacheSizeOnLowDiskSpace = maxCacheSizeOnLowDiskSpace;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Builder &lt;span class=&quot;title&quot;&gt;setMaxCacheSizeOnVeryLowDiskSpace&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; maxCacheSizeOnVeryLowDiskSpace)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mMaxCacheSizeOnVeryLowDiskSpace = maxCacheSizeOnVeryLowDiskSpace;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看到这个代码就立马反应过来了，少了一个常量&lt;code&gt;ByteConstants.MB&lt;/code&gt;？把项目中的初始化代码修改了一下，加上了这个常量，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DiskCacheConfig.Builder builder = DiskCacheConfig.newBuilder(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSize(&lt;span class=&quot;number&quot;&gt;150&lt;/span&gt; * ByteConstants.MB);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnLowDiskSpace(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt; * ByteConstants.MB);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnVeryLowDiskSpace(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * ByteConstants.MB);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再来测试时，发现问题解决了，不会出现保存失败的情况。&lt;code&gt;v2.ols100.1&lt;/code&gt;这个目录下缓存了很多文件，文件大小一下子就几M了。&lt;/p&gt;
&lt;p&gt;然后用上面代码中的关键字在google上搜索了一下，发现代码是copy过来的，参数值全部都一样。好吧，我认栽。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;之前有写文章说别人对网上文章的看法，这次写的是我对网上文章的看法。一直以来对网上的文章的说法都抱有怀疑态度，一般都是把网上的东西作为参考，找准关键的地方，他的说法与自己写的有什么区别？一对比就知道哪些地方有欠缺，是什么原因。而不是直接copy过来使用。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="fresco初始化设置" scheme="http://www.jacpy.com/tags/fresco%E5%88%9D%E5%A7%8B%E5%8C%96%E8%AE%BE%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>windows 7 驱动安装成功后无法启动</title>
    <link href="http://www.jacpy.com/2017/04/28/windows-driver-donot-install.html"/>
    <id>http://www.jacpy.com/2017/04/28/windows-driver-donot-install.html</id>
    <published>2017-04-28T00:27:57.000Z</published>
    <updated>2017-08-02T05:16:26.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在PC上安装无线网卡，可以将PC的网络通用Wi-Fi的形式让手机可以连接。由于系统限制，驱动安装成功，但是加载驱动却失败，于是开始找原因，就有了下文。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;首先驱动可以安装成功，但不能被系统加载，出现的情况下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/device.png&quot; alt=&quot;驱动未被加载&quot;&gt;&lt;/p&gt;
&lt;p&gt;然后选中黄色警告项，右键选择“更新驱动”，然后选择驱动安装目录，然后下一步，结果提示&lt;code&gt;系统策略禁止安装此设备，请与系统管理员联系&lt;/code&gt;，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/system_forbidden_install_driver_call_admin.jpg&quot; alt=&quot;系统策略禁止安装此设备，请与系统管理员联系&quot;&gt;&lt;/p&gt;
&lt;p&gt;于是打开组策略，开始找是哪项设置的。&lt;/p&gt;
&lt;p&gt;打开组策略后，先选中其中一个模板，比如&lt;code&gt;管理模板&lt;/code&gt;，然后点击&lt;code&gt;操作&lt;/code&gt;菜单中的&lt;code&gt;筛选器选项...&lt;/code&gt;项，如图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/gpedit_msc_drive_menu.png&quot; alt=&quot;筛选器选项菜单&quot;&gt;&lt;/p&gt;
&lt;p&gt;在弹出的窗口中什么都不用选，如下图所示，然后单击确定按钮：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/gpedit_msc_drive_dialog.png&quot; alt=&quot;筛选器选项&quot;&gt;&lt;/p&gt;
&lt;p&gt;最后发现什么都没有搜索出来，因为这些项都是未配置。心想，这里没有被人修改过，全都是系统默认的，现在怎么知道是哪项产生的影响？&lt;/p&gt;
&lt;p&gt;最后没办法，只得挨个找，最后还是被找到设置的位置。在&lt;code&gt;计算机配置&lt;/code&gt;-&amp;gt;&lt;code&gt;管理模板&lt;/code&gt;-&amp;gt;&lt;code&gt;系统&lt;/code&gt;-&amp;gt;&lt;code&gt;设备安装&lt;/code&gt;-&amp;gt;&lt;code&gt;设备安装限制&lt;/code&gt;的右侧面板中，分别修改&lt;code&gt;允许管理员忽略设备安装限制策略&lt;/code&gt;和&lt;code&gt;禁止安装未由其他策略设备描述的设备&lt;/code&gt;，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/gpedit_msc_drive.png&quot; alt=&quot;设备安装限制&quot;&gt;&lt;/p&gt;
&lt;p&gt;设置后，再去更新驱动，OK了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在PC上安装无线网卡，可以将PC的网络通用Wi-Fi的形式让手机可以连接。由于系统限制，驱动安装成功，但是加载驱动却失败，于是开始找原因，就有了下文。&lt;/p&gt;
    
    </summary>
    
      <category term="windows" scheme="http://www.jacpy.com/categories/windows/"/>
    
    
      <category term="windows 7 驱动安装成功后无法启动" scheme="http://www.jacpy.com/tags/windows-7-%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F%E5%90%8E%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8/"/>
    
  </entry>
  
  <entry>
    <title>android ANR——线程死锁分析</title>
    <link href="http://www.jacpy.com/2017/04/24/android-anr-thread-lock-analysis.html"/>
    <id>http://www.jacpy.com/2017/04/24/android-anr-thread-lock-analysis.html</id>
    <published>2017-04-24T01:55:18.000Z</published>
    <updated>2017-08-08T05:29:03.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天遇到了线程死锁问题，导致系统&lt;code&gt;ANR&lt;/code&gt;。然后拿到系统&lt;code&gt;/data/anr/traces.txt&lt;/code&gt;日志文件后，进行分析，然后找到原因，并解决了问题。&lt;/p&gt;
&lt;p&gt;java线程产生死锁的原因，要么同时满足死锁的四个条件，要么是android系统机制的原因，认为发生了类似死锁的情况而导致系统&lt;code&gt;ANR&lt;/code&gt;。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;很明显，既然导致了系统&lt;code&gt;ANR&lt;/code&gt;，那么肯定与UI线程有关。首先看下面出现死锁的代码：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * HTTP请求处理&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HttpRequest&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     * 请求次数计数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; mRequestCount;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Object mSyncObject = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Object();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PushRequestParams params, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; RequestCallback callback)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Thread(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Runnable() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                android.os.Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (mSyncObject) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    mRequestCount = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; RequestCallback cb = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RequestCallback() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onRequestCallback&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; state, String s)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (state == STATE_SUCCESS) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;comment&quot;&gt;// 请求成功&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    callback.onRequestCallback(state, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;comment&quot;&gt;// 这个必须放到while循环前面&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mRequestCount &amp;gt;= &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; &amp;amp;&amp;amp; callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    &lt;span class=&quot;comment&quot;&gt;// 请求失败&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    callback.onRequestCallback(state, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;comment&quot;&gt;// 失败后重试三次&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (mRequestCount &amp;lt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    ++mRequestCount;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                    request(params.toString(), params.sessionId, &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    request(params.toString(), params.sessionId, cb);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;).start();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String host, String sessionId, RequestCallback callback)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; isSuccess = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String s = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            URL url = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; URL(host);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            HttpURLConnection conn = (HttpURLConnection) url.openConnection();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setRequestMethod(&lt;span class=&quot;string&quot;&gt;&quot;GET&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setConnectTimeout(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setReadTimeout(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setRequestProperty(&lt;span class=&quot;string&quot;&gt;&quot;Cookie&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;JSESSIONID=&quot;&lt;/span&gt; + sessionId);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.connect();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; state = conn.getResponseCode();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;request state: &quot;&lt;/span&gt; + state);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (state == HttpURLConnection.HTTP_OK) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                s = streamToString(conn.getInputStream());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;result: &quot;&lt;/span&gt; + s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    JSONObject jobj = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; JSONObject(s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; code = jobj.optInt(&lt;span class=&quot;string&quot;&gt;&quot;code&quot;&lt;/span&gt;, -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (code == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        isSuccess = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (JSONException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (MalformedURLException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            s = e.toString();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IOException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            s = e.toString();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                callback.onRequestCallback(isSuccess ? RequestCallback.STATE_SUCCESS : RequestCallback.STATE_ERROR, s == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt; : s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面代码是为了保证请求次数&lt;code&gt;mRequestCount&lt;/code&gt;的值不超过3次，同时也考虑多线程的情况，所以对这个值进行修改时时行了同步。&lt;/p&gt;
&lt;p&gt;接着看出现&lt;code&gt;ANR&lt;/code&gt;的提示，以下是错误日志：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;main&amp;quot; prio=5 tid=1 Blocked&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | group=&amp;quot;main&amp;quot; sCount=1 dsCount=0 obj=0x750d06e8 self=0xe7685400&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | sysTid=29016 nice=-10 cgrp=default sched=0/0 handle=0xea2f5534&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | state=S schedstat=( 83840100682 22307763410 181443 ) utm=6702 stm=1680 core=1 HZ=100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | stack=0xff53a000-0xff53c000 stackSize=8MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | held mutexes=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at *.*.HttpRequest.request(HttpRequest.java:33)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - waiting to lock &amp;lt;0x08483a94&amp;gt; (a java.lang.Class&amp;lt;*.*.HttpRequest&amp;gt;) held by thread 24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.app.LoadedApk$ReceiverDispatcher$Args.run(LoadedApk.java:1122)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.os.Handler.handleCallback(Handler.java:751)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.os.Looper.loop(Looper.java:154)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at android.app.ActivityThread.main(ActivityThread.java:6119)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.lang.reflect.Method.invoke!(Native method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:886)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:776)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面的日志要耐着性子在&lt;code&gt;traces.txt&lt;/code&gt;文件中慢慢找，因为这个文件非常大，刚开始的内容不一定就是异常日志。如果运气好，打开就可以看到。所以可以试着找类似&lt;code&gt;&amp;quot;main&amp;quot; prio=5 tid=1 Blocked&lt;/code&gt;这样的字眼，或者查找自己的代码中类文件的主包名，这样来得更快（也有可能找不到:)    ）。&lt;/p&gt;
&lt;p&gt;从上面日志大概可以读出一些信息。比如&lt;code&gt;&amp;quot;main&amp;quot; prio=5 tid=1 Blocked&lt;/code&gt;表示当前线程被Blocked，即阻塞，线程的名称是&lt;code&gt;main&lt;/code&gt;，即UI主线程，&lt;code&gt;prio=5&lt;/code&gt;是线程的优先级，&lt;code&gt;tid=1&lt;/code&gt;是线程的ID。`held mutexes=&lt;br&gt;  at &lt;em&gt;.&lt;/em&gt;.HttpRequest.request(HttpRequest.java:33)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;waiting to lock &lt;0x08483a94&gt; (a java.lang.Class&amp;lt;&lt;em&gt;.&lt;/em&gt;.HttpRequest&amp;gt;) held by thread 24&lt;code&gt;这段日志中已经告诉了具体发生问题的原因。在&lt;/code&gt;HttpRequest.java:33&lt;code&gt;这个位置发生了阻塞，&lt;/code&gt;waiting to lock &lt;0x08483a94&gt;&lt;code&gt;等待&lt;/code&gt;0x08483a94&lt;code&gt;这个锁被释放，这个锁&lt;/code&gt;java.lang.Class&amp;lt;&lt;em&gt;.&lt;/em&gt;.HttpRequest&amp;gt;) &lt;code&gt;是一个Class锁，被&lt;/code&gt;held by thread 24 `线程ID为24的线程持有。&lt;/0x08483a94&gt;&lt;/0x08483a94&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;于是搜索关键字&lt;code&gt;&amp;lt;0x08483a94&amp;gt;&lt;/code&gt;，又可以找到下面一段日志。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;Thread-173&amp;quot; prio=5 tid=24 Native&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | group=&amp;quot;main&amp;quot; sCount=1 dsCount=0 obj=0x33824e50 self=0xb6cf2800&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | sysTid=11277 nice=10 cgrp=bg_non_interactive sched=0/0 handle=0xc4453920&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | state=S schedstat=( 8781561 3715104 14 ) utm=0 stm=0 core=2 HZ=100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | stack=0xc4351000-0xc4353000 stackSize=1038KB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | held mutexes=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: __switch_to+0x8c/0x98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: poll_schedule_timeout+0x54/0xbc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: do_sys_poll+0x2c4/0x384&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: compat_sys_ppoll+0x134/0x1e8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kernel: cpu_switch_to+0x48/0x4c&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #00 pc 00048684  /system/lib/libc.so (__ppoll+20)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #01 pc 0001cf67  /system/lib/libc.so (poll+46)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #02 pc 0000e6bd  /system/lib/libopenjdk.so (NET_Poll+52)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #03 pc 0001888f  /system/lib/libopenjdk.so (PlainSocketImpl_socketConnect+286)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  native: #04 pc 000b2cb7  /system/framework/arm/boot.oat (Java_java_net_PlainSocketImpl_socketConnect__Ljava_net_InetAddress_2II+114)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.PlainSocketImpl.socketConnect(Native method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:334)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - locked &amp;lt;0x09ddcdde&amp;gt; (a java.net.SocksSocketImpl)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:196)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:178)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:356)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.net.Socket.connect(Socket.java:605)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.Platform.connectSocket(Platform.java:113)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.Connection.connectSocket(Connection.java:196)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.Connection.connect(Connection.java:172)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.Connection.connectAndSetOwner(Connection.java:367)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.OkHttpClient$1.connectAndSetOwner(OkHttpClient.java:130)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.http.HttpEngine.connect(HttpEngine.java:329)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.http.HttpEngine.sendRequest(HttpEngine.java:246)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.huc.HttpURLConnectionImpl.execute(HttpURLConnectionImpl.java:457)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at com.android.okhttp.internal.huc.HttpURLConnectionImpl.connect(HttpURLConnectionImpl.java:126)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at *.*.HttpRequest.request(PushRequest.java:79)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - locked &amp;lt;0x08483a94&amp;gt; (a java.lang.Class&amp;lt;*.*.HttpRequest&amp;gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at *.*.HttpRequest.access$200(PushRequest.java:23)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at *.*.HttpRequest$1.run(PushRequest.java:63)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - locked &amp;lt;0x0fde7bbf&amp;gt; (a java.lang.Object)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  at java.lang.Thread.run(Thread.java:761)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;搜索上面的关键字会找到这里&lt;code&gt;locked &amp;lt;0x08483a94&amp;gt; (a java.lang.Class&amp;lt;*.*.HttpRequest&amp;gt;)&lt;/code&gt;，是在这个位置产生问题&lt;code&gt;at *.*.HttpRequest.request(PushRequest.java:79)&lt;/code&gt;。到这里问题就容易理解了，因为执行了&lt;code&gt;conn.connect();&lt;/code&gt;这行代码，这行代码所在的&lt;code&gt;request&lt;/code&gt;方法是同步方法，所以持有Class锁。而这行代码执行需要的时间是不确定的，这个得看网络情况，如果网络不好，需要等待30秒。&lt;/p&gt;
&lt;p&gt;当在主线程中调用这个类的&lt;code&gt;public synchronized static void request(final PushRequestParams params, final RequestCallback callback)&lt;/code&gt;这个方法时，由于这个方法也是同步的，因为是静态方法，所以这个同步的是Class，即持有Class锁。因为这个锁已经被执行&lt;code&gt;private synchronized static void request(String host, String sessionId, RequestCallback callback)&lt;/code&gt;方法所在的线程持有，而这个方法在做一个执行时间不确定的http请求，从而导致了互斥条件的产生。&lt;/p&gt;
&lt;p&gt;这种互斥不很严格意义上互斥，因为这个http请求最长时间是30秒，也就是30秒后释放锁，其他线程可以获得锁，但是违反了系统规则，因为在这个类的外部是在主线程中调用这个&lt;code&gt;request&lt;/code&gt;方法，导致主线程等待。由于android系统的机制，等待的时间超过了允许的时间限制，导致其他事件不能处理，所以直接就&lt;code&gt;ANR&lt;/code&gt;了。&lt;/p&gt;
&lt;p&gt;知道了原因，就开始改代码了，代码修改后如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * HTTP请求处理&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HttpRequest&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; ThreadPoolExecutor mThreadPool = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ThreadPoolExecutor(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, TimeUnit.SECONDS, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; LinkedBlockingQueue&amp;lt;Runnable&amp;gt;(), Executors.defaultThreadFactory(), &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ThreadPoolExecutor.DiscardOldestPolicy());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PushRequestParams params, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; RequestCallback callback)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mThreadPool.execute(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Runnable() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; requestCount = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                android.os.Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                requestCount = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; RequestCallback cb = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RequestCallback() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onRequestCallback&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; state, String s)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (state == STATE_SUCCESS) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;comment&quot;&gt;// 请求成功&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                callback.onRequestCallback(state, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;comment&quot;&gt;// 这个必须放到while循环前面&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (requestCount &amp;gt;= &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; &amp;amp;&amp;amp; callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                &lt;span class=&quot;comment&quot;&gt;// 请求失败&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                callback.onRequestCallback(state, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;comment&quot;&gt;// 失败后重试三次&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (requestCount &amp;lt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                ++requestCount;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                request(params.toString(), params.sessionId, &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                request(params.toString(), params.sessionId, cb);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String host, String sessionId, RequestCallback callback)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; isSuccess = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        String s = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            URL url = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; URL(host);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            HttpURLConnection conn = (HttpURLConnection) url.openConnection();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setRequestMethod(&lt;span class=&quot;string&quot;&gt;&quot;GET&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setConnectTimeout(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setReadTimeout(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.setRequestProperty(&lt;span class=&quot;string&quot;&gt;&quot;Cookie&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;JSESSIONID=&quot;&lt;/span&gt; + sessionId);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            conn.connect();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; state = conn.getResponseCode();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;request state: &quot;&lt;/span&gt; + state);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (state == HttpURLConnection.HTTP_OK) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                s = streamToString(conn.getInputStream());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;result: &quot;&lt;/span&gt; + s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    JSONObject jobj = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; JSONObject(s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; code = jobj.optInt(&lt;span class=&quot;string&quot;&gt;&quot;code&quot;&lt;/span&gt;, -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (code == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        isSuccess = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (JSONException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (MalformedURLException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            s = e.toString();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IOException e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            s = e.toString();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                callback.onRequestCallback(isSuccess ? RequestCallback.STATE_SUCCESS : RequestCallback.STATE_ERROR, s == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt; : s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用线程池，并且只有一个线程，在外部多次调用&lt;code&gt;request&lt;/code&gt;方法，让其进入队列等待。把请求次数的计数器&lt;code&gt;requestCount&lt;/code&gt;放在新建的&lt;code&gt;Runnable&lt;/code&gt;对象中，这样就不用担心多线程同步的问题。&lt;/p&gt;
&lt;p&gt;中间有个插曲。&lt;/p&gt;
&lt;p&gt;使用&lt;code&gt;adb pull /data/anr/traces.txt D:\&lt;/code&gt;命令获取ANR日志时，会提示&lt;code&gt;adb: error: cannot create file/directory &amp;#39;D:\&amp;#39;: No such file or directory&lt;/code&gt;错误，立马反应是修改目录为&lt;code&gt;D:\temp&lt;/code&gt;目录，PC的D盘是有这个目录的，然后就再执行&lt;code&gt;adb pull /data/anr/traces.txt D:\temp&lt;/code&gt;，OK了。后来在群里也有人遇到这个错误，然后问这个问题怎么解决，然后就是各种骂网上各种文章不靠谱，照着做都出问题。我想说的是，出现问题，自己先思考一下，看错误提示，不要急着找搜索引擎，答案就在错误提示中。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天遇到了线程死锁问题，导致系统&lt;code&gt;ANR&lt;/code&gt;。然后拿到系统&lt;code&gt;/data/anr/traces.txt&lt;/code&gt;日志文件后，进行分析，然后找到原因，并解决了问题。&lt;/p&gt;
&lt;p&gt;java线程产生死锁的原因，要么同时满足死锁的四个条件，要么是android系统机制的原因，认为发生了类似死锁的情况而导致系统&lt;code&gt;ANR&lt;/code&gt;。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="android死锁分析" scheme="http://www.jacpy.com/tags/android%E6%AD%BB%E9%94%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>android gradle常用配置总结</title>
    <link href="http://www.jacpy.com/2017/02/28/android-gradle-config-summary.html"/>
    <id>http://www.jacpy.com/2017/02/28/android-gradle-config-summary.html</id>
    <published>2017-02-28T07:40:50.000Z</published>
    <updated>2017-03-07T02:43:27.000Z</updated>
    
    <content type="html">&lt;h1 id=&quot;基本介绍&quot;&gt;&lt;a href=&quot;#基本介绍&quot; class=&quot;headerlink&quot; title=&quot;基本介绍&quot;&gt;&lt;/a&gt;基本介绍&lt;/h1&gt;&lt;p&gt;本文是针对android开发中的&lt;code&gt;build.gradle&lt;/code&gt;文件中的常用配置总结，一些配置是在特定的场景下才使用，一些是为了解决一些问题才加上。所以默认还是使用在Android Studio工具中新建项目时生成的默认的&lt;code&gt;build.gradle&lt;/code&gt;文件中的配置，等遇到了问题，再来加一些配置。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;101&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;102&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;103&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;104&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;105&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;106&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;107&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;108&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;109&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;110&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;111&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;112&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;113&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;114&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;115&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;116&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;117&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;118&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;119&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;120&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;121&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;122&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;123&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;124&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;125&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;126&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;127&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;128&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;129&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;130&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;131&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;132&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;133&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;134&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;135&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;136&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;137&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;138&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;139&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;140&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;141&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;142&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;143&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;144&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// apply plugin: &#39;com.android.library&#39; // 库配置&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apply &lt;span class=&quot;string&quot;&gt;plugin:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;com.android.application&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 应用程序配置&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;repositories &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 引入AAR文件时，需要配置这个，AAR文件放在libs目录中&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    flatDir &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        dirs &lt;span class=&quot;string&quot;&gt;&#39;libs&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compileSdkVersion &lt;span class=&quot;number&quot;&gt;25&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// android编译SDK的版本，即4.0SDK、5.0SDK等的android.jar文件&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    buildToolsVersion &lt;span class=&quot;string&quot;&gt;&quot;25.0.2&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 使用SDK中编译工具的版本&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    useLibrary &lt;span class=&quot;string&quot;&gt;&quot;org.apache.http.legacy&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 在6.0上使用apache的httpClient包，原因是google在6.0上去掉了这个http请求库&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    defaultConfig &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        applicationId &lt;span class=&quot;string&quot;&gt;&quot;com.xxx&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 应用的包名可以在AndroidMainfest.xml中使用$&amp;#123;applicationId&amp;#125;的方式引用这个包名&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        minSdkVersion &lt;span class=&quot;number&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 最小兼容版本&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        targetSdkVersion &lt;span class=&quot;number&quot;&gt;25&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 目标版本&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        versionCode &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 应用的版本号&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        versionName SDK_VERSION &lt;span class=&quot;comment&quot;&gt;// 应用的版本名称&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        multiDexEnabled &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 启用多dex，如果app中的代码方法数超过65535&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        testInstrumentationRunner &lt;span class=&quot;string&quot;&gt;&quot;android.support.test.runner.AndroidJUnitRunner&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// android单元测试配置&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   sourceSets &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 指定代码及资源的路径，具体可以参考这里http://google.github.io/android-gradle-dsl/2.3/com.android.build.gradle.api.AndroidSourceSet.html&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        main &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            manifest.srcFile &lt;span class=&quot;string&quot;&gt;&#39;AndroidManifest.xml&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 指定manifest.xml路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            java.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;src&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// java文件的路径，包名的上一层，多个目录使用逗号分隔，如[&#39;src&#39;, &#39;core&#39;]&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resources.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;src&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// resource资源所有的目录，注意这里是指jar文件中包含的一些资源，如properties文件，而不是APK中的res资源&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            aidl.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;src&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// aidl文件的目录&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            renderscript.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;src&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// renderscript文件的路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            res.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;res&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// android APK中的资源路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            assets.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;assets&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// android app中的asset目录&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            jniLibs.srcDirs = [&lt;span class=&quot;string&quot;&gt;&#39;libs&#39;&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// SO库的路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lintOptions &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        checkReleaseBuilds &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// release编译时禁用lint检查&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        abortOnError &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 报错不会停止打包，除非很严重的很影响&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        disable &lt;span class=&quot;string&quot;&gt;&#39;MissingTranslation&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;ExtraTranslation&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 禁用lint检查中的一些选项&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    dexOptions &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        javaMaxHeapSize &lt;span class=&quot;string&quot;&gt;&quot;4g&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 设置编译项目代码时最在的堆内存大小，否则项目过大时，编译内存溢出&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compileOptions &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 具体参考这里http://google.github.io/android-gradle-dsl/2.3/com.android.build.gradle.internal.CompileOptions.html&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        sourceCompatibility JavaVersion.VERSION_1_7 &lt;span class=&quot;comment&quot;&gt;// 设置代码编译的版本，一般是在使用JDK1.8时，配置这个，使编译出来的jar包让别人使用时更通用&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        targetCompatibility JavaVersion.VERSION_1_7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    packagingOptions &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/DEPENDENCIES.txt&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 排除这些第三方jar中的声明文件，否则编译时容易导致报错&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/LICENSE.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/NOTICE.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/NOTICE&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/LICENSE&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/DEPENDENCIES&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/notice.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/license.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/dependencies.txt&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;&#39;META-INF/LGPL2.1&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    buildTypes &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         debug &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    		 storeFile file(&lt;span class=&quot;string&quot;&gt;&quot;debug.keystore&quot;&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// 签名文件相对路径&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           storePassword &lt;span class=&quot;string&quot;&gt;&quot;android&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 签名的密码&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           keyAlias &lt;span class=&quot;string&quot;&gt;&quot;androiddebugkey&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 别名&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           keyPassword &lt;span class=&quot;string&quot;&gt;&quot;android&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 别名密码&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           buildConfigField &lt;span class=&quot;string&quot;&gt;&quot;boolean&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;FLAG_DEBUG&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;true&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 在BuildConfig.的类中自动生成public static final boolean FLAG_DEBUG = true;代码&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           buildConfigField &lt;span class=&quot;string&quot;&gt;&quot;String&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;API_VERSION&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;\&quot;1\&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           ndk &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           	abiFilters &lt;span class=&quot;string&quot;&gt;&quot;armeabi&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;armeabi-v7a&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 只保留这几种CPU架构的SO库，需要高版本的gradle才支持&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &lt;span class=&quot;comment&quot;&gt;// jniDebuggable true // 启用JNI debug，一般很少使用，不建议开这个选项，会影响java代码的debug速度&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        release &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            buildConfigField &lt;span class=&quot;string&quot;&gt;&quot;boolean&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;FLAG_DEBUG&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;false&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            buildConfigField &lt;span class=&quot;string&quot;&gt;&quot;String&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;API_VERSION&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;\&quot;1\&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            minifyEnabled &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 在混淆时去除代码中无用的内容&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            shrinkResources &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 在混淆时去除无用的资源，针对res/目录中的内容，不会压缩图片的大小&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            proguardFiles getDefaultProguardFile(&lt;span class=&quot;string&quot;&gt;&#39;proguard-android.txt&#39;&lt;/span&gt;), &lt;span class=&quot;string&quot;&gt;&#39;proguard-rules.pro&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 配置混淆文件&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            ndk &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            	abiFilters &lt;span class=&quot;string&quot;&gt;&quot;armeabi&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;armeabi-v7a&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 只保留这几种CPU架构的SO库，需要高版本的gradle才支持&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile fileTree(&lt;span class=&quot;string&quot;&gt;include:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;*.jar&#39;&lt;/span&gt;], &lt;span class=&quot;string&quot;&gt;dir:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;libs&#39;&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// 导入libs目录中的所有jar包&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    androidTestCompile(&lt;span class=&quot;string&quot;&gt;&#39;com.android.support.test.espresso:espresso-core:2.2.2&#39;&lt;/span&gt;, &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 排除group中的modle，注意group和module名称com.android.support:support-annotations&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exclude &lt;span class=&quot;string&quot;&gt;group:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;com.android.support&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;module:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;support-annotations&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile &lt;span class=&quot;string&quot;&gt;&#39;com.android.support:appcompat-v7:25.1.0&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 使用google的appcompat-v7包&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    testCompile &lt;span class=&quot;string&quot;&gt;&#39;junit:junit:4.12&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 引入junit单元测试&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile &lt;span class=&quot;string&quot;&gt;&#39;com.android.support:multidex:1.0.0&#39;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 加入加载多dex库&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile files(&lt;span class=&quot;string&quot;&gt;&#39;libs/gson.jar&#39;&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// 引用libs目录中的gson.jar包&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile(&lt;span class=&quot;string&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;HMS-SDK-2.4.0.300&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;ext:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;aar&#39;&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// 引入HMS-SDK-2.4.0.300.aar文件，同时还需要参考文件头部分的配置&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    compile(&lt;span class=&quot;string&quot;&gt;&#39;com.facebook.fresco:fresco:1.0.0&#39;&lt;/span&gt;) &amp;#123; exclude &lt;span class=&quot;string&quot;&gt;module:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;support-v4&#39;&lt;/span&gt; &amp;#125; &lt;span class=&quot;comment&quot;&gt;// 引入fresco库，但不使用其中引用的support-v4库，否则导致重复引入，编译报错duplicate&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    provided fileTree(&lt;span class=&quot;string&quot;&gt;dir:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;compilelibs&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;include:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;*.jar&#39;&lt;/span&gt;]) &lt;span class=&quot;comment&quot;&gt;// 引入compilelibs目录下面的jar文件参与编译，但不将这些包的代码打入APK、jar或AAR中。&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 使用jar任务生成jar文件，依赖assembleRelease的task&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;task buildJar(&lt;span class=&quot;string&quot;&gt;type:&lt;/span&gt; Jar, &lt;span class=&quot;string&quot;&gt;dependsOn:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;assembleRelease&#39;&lt;/span&gt;]) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    destinationDir = file(&lt;span class=&quot;string&quot;&gt;&#39;build/outputs/jar/&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    appendix = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    baseName = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    version = SDK_VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// manifest信息&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; map = [&lt;span class=&quot;string&quot;&gt;&#39;Version&#39;&lt;/span&gt;: SDK_VERSION,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Gradle&#39;&lt;/span&gt;: project.gradle.gradleVersion,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Vendor&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;szcomtop.com&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Date&#39;&lt;/span&gt;: &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Date().getDateTimeString()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    manifest.attributes(map)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//    from( &#39;build/intermediates/classes/release/&#39;)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    from(project.zipTree( &lt;span class=&quot;string&quot;&gt;&#39;build/intermediates/transforms/proguard/release/jars/3/3/main.jar&#39;&lt;/span&gt;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/BuildConfig.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/BuildConfig\$*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/R.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/R\$*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    include(&lt;span class=&quot;string&quot;&gt;&#39;**/*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 使用Copy任务复制内容&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;task copySDK(&lt;span class=&quot;string&quot;&gt;type:&lt;/span&gt; Copy, &lt;span class=&quot;string&quot;&gt;dependsOn:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;buildJar&#39;&lt;/span&gt;]) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    from(&lt;span class=&quot;string&quot;&gt;&#39;build/outputs/jar&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    into(&lt;span class=&quot;string&quot;&gt;&#39;../app/libs/&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    include(&lt;span class=&quot;string&quot;&gt;&quot;*.jar&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;hr&gt;
&lt;h1 id=&quot;使用方法&quot;&gt;&lt;a href=&quot;#使用方法&quot; class=&quot;headerlink&quot; title=&quot;使用方法&quot;&gt;&lt;/a&gt;使用方法&lt;/h1&gt;&lt;p&gt;本方会持续更新，随着android的gradle工具的升级，可能有些配置会发生变化。比如&lt;code&gt;ndk.abiFilters&lt;/code&gt;需要在高版本的gradle工具中才能使用，如何升级gradle版本，也可能会带来编译不通过等问题，需要耗费较长时间去解决，所以请慎重。&lt;/p&gt;
&lt;p&gt;关于一些配置的用法，下面举其中一个例子，其他雷同。&lt;/p&gt;
&lt;p&gt;比如怎么知道有这个&lt;code&gt;compileOptions&lt;/code&gt;配置？这个配置下面的又有哪些可以设置？这些设置怎么去使用？能给哪些值？&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;compileOptions &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sourceCompatibility JavaVersion.VERSION_1_7 // 设置代码编译的版本，一般是在使用JDK1.8时，配置这个，使编译出来的jar包让别人使用时更通用&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    targetCompatibility JavaVersion.VERSION_1_7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;从官网入手&quot;&gt;&lt;a href=&quot;#从官网入手&quot; class=&quot;headerlink&quot; title=&quot;从官网入手&quot;&gt;&lt;/a&gt;从官网入手&lt;/h2&gt;&lt;p&gt;android官方定义的gradle工具的使用说明文档点&lt;a href=&quot;http://google.github.io/android-gradle-dsl/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;，gradle官方的说明文档点&lt;a href=&quot;https://docs.gradle.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;点开链接中有个&lt;code&gt;DSL&lt;/code&gt;，这个&lt;code&gt;DSL&lt;/code&gt;是啥？&lt;code&gt;DSL&lt;/code&gt;就是&lt;code&gt;Gradle Build Language&lt;/code&gt;的缩写。哈哈，开个玩笑，是&lt;code&gt;Domain Specific Language&lt;/code&gt;的缩写，&lt;code&gt;Domain&lt;/code&gt;可以理解为&lt;code&gt;Project&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;跑题了，继续。&lt;/p&gt;
&lt;h2 id=&quot;compileOptions示例&quot;&gt;&lt;a href=&quot;#compileOptions示例&quot; class=&quot;headerlink&quot; title=&quot;compileOptions示例&quot;&gt;&lt;/a&gt;compileOptions示例&lt;/h2&gt;&lt;p&gt;打开android gradle工具的官方说明文档页面会看到如下图所示的版本选择页面：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/android-gradle-plugin-version.png&quot; alt=&quot;android gradle工具版本&quot;&gt;&lt;/p&gt;
&lt;p&gt;这个版本是与&lt;code&gt;android studio&lt;/code&gt;项目根目录下的&lt;code&gt;build.gradle&lt;/code&gt;文件中的gradle版本是对应起来的。同时发现，这个版本会与&lt;code&gt;android studio&lt;/code&gt;的版本对应。如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/android-studio-build-gradle-location.png&quot; alt=&quot;android studio build.gradle文件中的版本&quot;&gt;&lt;/p&gt;
&lt;p&gt;点击当前的2.2版本的链接，进入到如下界面，如下图所示，在左侧找到&lt;code&gt;compileOptions&lt;/code&gt;，并点击这个链接（熟悉这个官方文档可以从左侧的Home项开始）：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/compile-options-location.png&quot; alt=&quot;compileOptions的位置&quot;&gt;&lt;/p&gt;
&lt;p&gt;再点击上图中红色框框标记的链接，就会跳转到如下图所示位置的配置说明，这种跳转的方式有点类似Java的API，只不过这个时候看到的应该是详细，结果却没有：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/compile-options-detail.png&quot; alt=&quot;compileOptions详细说明&quot;&gt;&lt;/p&gt;
&lt;p&gt;需要进一步查看详细，只能是点击上图红色框框标记的链接，进去之后就会发现熟悉的内容了，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/compile-options-detail-page.png&quot; alt=&quot;compileOptions详细配置说明页面&quot;&gt;&lt;/p&gt;
&lt;p&gt;有没有一种久违的感觉，终于快看到真相了吧？还差一步。compileOptions中可用的选项及含义已经在上面写的很清楚了。再点击&lt;code&gt;sourceCompatibility&lt;/code&gt;会跳到如下图所示内容：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/02/28/source-compatibility-values.png&quot; alt=&quot;sourceCompatibility可配置的参数&quot;&gt;&lt;/p&gt;
&lt;p&gt;可以从上面看到&lt;code&gt;sourceCompatibility&lt;/code&gt;可以取哪些值，终于找到结果了。&lt;/p&gt;
&lt;p&gt;OK，&lt;code&gt;compileOptions&lt;/code&gt;示例就到这里，其它的配置使用也可以使用相同的方法，gradle官方使用文档也是类似，剩下的只是熟悉的问题了。&lt;/p&gt;
&lt;h1 id=&quot;注意事项：&quot;&gt;&lt;a href=&quot;#注意事项：&quot; class=&quot;headerlink&quot; title=&quot;注意事项：&quot;&gt;&lt;/a&gt;注意事项：&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;ol&gt;
&lt;li&gt;如果&lt;code&gt;shrinkResources&lt;/code&gt;设置为true，在高版本的gradle中打release APK时会出现如下错误：&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;build\intermediates\res\resources-release-stripped.ap_&amp;apos; specified for property &amp;apos;resourceFile&amp;apos; does not exist.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;导致的原因不明，解决方法是将其设置为false。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;更新日志：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;2017-03-07 增加&lt;code&gt;注意事项&lt;/code&gt;中的1说明。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;基本介绍&quot;&gt;&lt;a href=&quot;#基本介绍&quot; class=&quot;headerlink&quot; title=&quot;基本介绍&quot;&gt;&lt;/a&gt;基本介绍&lt;/h1&gt;&lt;p&gt;本文是针对android开发中的&lt;code&gt;build.gradle&lt;/code&gt;文件中的常用配置总结，一些配置是在特定的场景下才使用，一些是为了解决一些问题才加上。所以默认还是使用在Android Studio工具中新建项目时生成的默认的&lt;code&gt;build.gradle&lt;/code&gt;文件中的配置，等遇到了问题，再来加一些配置。&lt;/p&gt;
    
    </summary>
    
      <category term="gradle" scheme="http://www.jacpy.com/categories/gradle/"/>
    
    
      <category term="gradle配置" scheme="http://www.jacpy.com/tags/gradle%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>android studio 使用gradle打jar包并混淆</title>
    <link href="http://www.jacpy.com/2017/02/28/android-studio-gradle-make-jar-and-proguard.html"/>
    <id>http://www.jacpy.com/2017/02/28/android-studio-gradle-make-jar-and-proguard.html</id>
    <published>2017-02-28T01:11:22.000Z</published>
    <updated>2017-03-05T14:00:14.000Z</updated>
    
    <content type="html">&lt;p&gt;昨天准备把写好的代码使用gradle打jar包出来，并打算加混淆。打jar包容易，结果在混淆上走了弯路。&lt;/p&gt;
&lt;p&gt;首先打jar包的配置很简单，使用jar的task，可以参考&lt;a href=&quot;https://docs.gradle.org/3.3/dsl/org.gradle.api.tasks.bundling.Jar.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gradle官方文档&lt;/a&gt;，具体代码如下：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;task buildJar(&lt;span class=&quot;string&quot;&gt;type:&lt;/span&gt; Jar, &lt;span class=&quot;string&quot;&gt;dependsOn:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&#39;assembleRelease&#39;&lt;/span&gt;]) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    destinationDir = file(&lt;span class=&quot;string&quot;&gt;&#39;build/outputs/jar/&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    appendix = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    baseName = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    version = SDK_VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// manifest信息&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; map = [&lt;span class=&quot;string&quot;&gt;&#39;Version&#39;&lt;/span&gt;: SDK_VERSION,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Gradle&#39;&lt;/span&gt;: project.gradle.gradleVersion,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Vendor&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &lt;span class=&quot;string&quot;&gt;&#39;Date&#39;&lt;/span&gt;: &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Date().getDateTimeString()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    manifest.attributes(map)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    from(&lt;span class=&quot;string&quot;&gt;&#39;build/intermediates/classes/release/&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/BuildConfig.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/BuildConfig\$*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/R.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&lt;span class=&quot;string&quot;&gt;&#39;**/R\$*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    include(&lt;span class=&quot;string&quot;&gt;&#39;**/*.class&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是发现上面打出来的jar包中的代码没有被混淆，于是加混淆。使用混淆的proguard.gradle.ProGuardTask task时，发现总是报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;java.io.IOException: The output jar [....jar] must be specified after an input jar, or it will be empty.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;按照上面的提示，&lt;code&gt;outjars&lt;/code&gt;是写在&lt;code&gt;injars&lt;/code&gt;后面啊，&lt;code&gt;it will be empty&lt;/code&gt;是提示哪里有问题？以为是&lt;code&gt;proguard-rules.pro&lt;/code&gt;文件中的配置有问题，结果把文件清空，还是报上面的错误，错误原因不得而知了。在这个问题上耗了很长时间，最终还是没有解决。&lt;/p&gt;
&lt;p&gt;突然看到上面的&lt;code&gt;assembleRelease&lt;/code&gt; task想起了平常打APK时，会使用到这个task，打出来的APK会自动混淆。那这个&lt;code&gt;assembleRelease&lt;/code&gt; task就会依赖处理混淆的task，于是查看了输出日志：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;101&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;102&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;103&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;104&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;105&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;106&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;107&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;108&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;109&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;110&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;111&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;112&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;To honour the JVM settings for this build a new JVM will be forked. Please consider using the daemon: https://docs.gradle.org/2.14.1/userguide/gradle_daemon.html.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Observed package id &amp;apos;system-images;android-22;google_apis;x86&amp;apos; in inconsistent location &amp;apos;android-sdk-windows-studio\system-images\addon-google_apis-google-22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;\x86&amp;apos; (Expected &amp;apos;android-sdk-windows-studio\system-images\android-22\google_apis\x86&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Observed package id &amp;apos;system-images;android-22;google_apis;x86&amp;apos; in inconsistent location &amp;apos;android-sdk-windows-studio\system-images\addon-google_apis-google-22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;\x86&amp;apos; (Expected &amp;apos;android-sdk-windows-studio\system-images\android-22\google_apis\x86&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Incremental java compilation is an incubating feature.                &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preBuild UP-TO-DATE                                                                                                                                                &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:extractProguardFiles&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preReleaseBuild&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:checkReleaseManifest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preDebugAndroidTestBuild UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preDebugBuild UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preDebugUnitTestBuild UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:preReleaseUnitTestBuild UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportAnimatedVectorDrawable2510Library UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportAppcompatV72510Library UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportCompat2510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportCoreUi2510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportCoreUtils2510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportFragment2510Library UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportMediaCompat2510Library UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportV42510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareComAndroidSupportSupportVectorDrawable2510Library UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:prepareReleaseDependencies&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseAidl UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseNdk UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileLint UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:copyReleaseLint UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseRenderscript UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseBuildConfig                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseResValues UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseResources UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseResources UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:processReleaseManifest UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:processReleaseResources UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseSources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:incrementalReleaseJavaCompilationSafeguard                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseJavaWithJavac                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseJavaWithJavac - is not incremental (e.g. outputs have changed, no previous execution, etc.).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;注: 某些输入文件使用或覆盖了已过时的 API。                                                                                                                               &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;注: 有关详细信息, 请使用 -Xlint:deprecation 重新编译。                                                                                                                   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:extractReleaseAnnotations                   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseShaders UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseShaders UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:generateReleaseAssets UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseAssets UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseProguardFiles UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:packageReleaseRenderscript UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:packageReleaseResources UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:processReleaseJavaRes UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformResourcesWithMergeJavaResForRelease UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformClassesAndResourcesWithProguardForRelease                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ProGuard, version 5.2.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading input...                                                        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading program directory [sdk\build\intermediates\classes\release] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-media-compat\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-compat\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-fragment\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-core-ui\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\animated-vector-drawable\25.1.0\jars\classes.jar] (filte&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;red)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [android-sdk-windows-studio\extras\android\m2repository\com\android\support\support-annotations\25.1.0\support-annotations-25.1.0.jar] (f&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;iltered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-v4\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-vector-drawable\25.1.0\jars\classes.jar] (filter&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ed)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\appcompat-v7\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [sdk\build\intermediates\exploded-aar\com.android.support\support-core-utils\25.1.0\jars\classes.jar] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [\android-sdk-windows-studio\platforms\android-25\android.jar]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Reading library jar [\android-sdk-windows-studio\platforms\android-25\optional\org.apache.http.legacy.jar]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [android.net.http.HttpResponseCache]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [android.net.http.SslCertificate$DName]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [android.net.http.SslError]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [android.net.http.SslCertificate]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.params.CoreConnectionPNames]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.params.HttpConnectionParams]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.params.HttpParams]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.conn.scheme.SocketFactory]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.conn.scheme.LayeredSocketFactory]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.conn.scheme.HostNameResolver]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: duplicate definition of library class [org.apache.http.conn.ConnectTimeoutException]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: there were 11 duplicate class definitions.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      (http://proguard.sourceforge.net/manual/troubleshooting.html#duplicateclass)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Initializing...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Note: you&amp;apos;re ignoring all warnings!                                     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Ignoring unused library classes...                                      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Original number of library classes: 5857&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Final number of library classes:    383&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Printing kept classes, fields, and methods...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Shrinking...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Printing usage to [sdk\build\outputs\mapping\release\usage.txt]...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Removing unused program classes and class elements...                   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Original number of program classes: 52                                &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Final number of program classes:    48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Obfuscating...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Printing mapping to [sdk\build\outputs\mapping\release\mapping.txt]...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Writing output...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Preparing output jar [sdk\build\intermediates\transforms\proguard\release\jars\3\3\main.jar]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Copying resources from program directory [sdk\build\intermediates\classes\release] (filtered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Printing classes to [sdk\build\outputs\mapping\release\dump.txt]...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformClassesAndResourcesWithSyncLibJarsForRelease                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:mergeReleaseJniLibFolders UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformNative_libsWithMergeJniLibsForRelease UP-TO-DATE      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:transformNative_libsWithSyncJniLibsForRelease UP-TO-DATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:bundleRelease                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:compileReleaseSources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:assembleRelease&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:sdk:buildJar                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;              &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BUILD SUCCESSFUL.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;好家伙，被我发现了。其中从&lt;code&gt;:sdk:transformClassesAndResourcesWithProguardForRelease&lt;/code&gt;这个task就可以看到，下面一堆日志是关于&lt;code&gt;ProGuard&lt;/code&gt;混淆工具的，最后可以看到：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Preparing output jar [sdk\build\intermediates\transforms\proguard\release\jars\3\3\main.jar]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个&lt;code&gt;main.jar&lt;/code&gt;就是混淆后的jar包，只不过这个jar还包含了&lt;code&gt;R&lt;/code&gt;类和&lt;code&gt;BuildConfig&lt;/code&gt;类的信息，所以将这个信息过滤掉就可以。但问题也来了，jar包都已经打好了，怎么配置混淆？解决方法是只要把jar包当输入就行了，最终配置如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;task buildJar(type: Jar, dependsOn: [&amp;apos;assembleRelease&amp;apos;]) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    destinationDir = file(&amp;apos;build/outputs/jar/&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    appendix = &amp;quot;&amp;quot; // SDK的后缀名称&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    baseName = &amp;quot;&amp;quot; // SDK名称&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    version = SDK_VERSION // 这个常量是在gradle.properties中配置的&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    // manifest信息&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def map = [&amp;apos;Version&amp;apos;: SDK_VERSION,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &amp;apos;Gradle&amp;apos;: project.gradle.gradleVersion,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &amp;apos;Vendor&amp;apos;: &amp;apos;&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;               &amp;apos;Date&amp;apos;: new Date().getDateTimeString()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    manifest.attributes(map)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    from(project.zipTree(&amp;apos;build/intermediates/transforms/proguard/release/jars/3/3/main.jar&amp;apos;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&amp;apos;**/BuildConfig.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&amp;apos;**/BuildConfig\$*.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&amp;apos;**/R.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    exclude(&amp;apos;**/R\$*.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    include(&amp;apos;**/*.class&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;OK，任务搞定。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;昨天准备把写好的代码使用gradle打jar包出来，并打算加混淆。打jar包容易，结果在混淆上走了弯路。&lt;/p&gt;
&lt;p&gt;首先打jar包的配置很简单，使用jar的task，可以参考&lt;a href=&quot;https://docs.gradle.org/3.3/dsl/org.gradle.api.tasks.bundling.Jar.html&quot;&gt;gradle官方文档&lt;/a&gt;，具体代码如下：&lt;/p&gt;
    
    </summary>
    
      <category term="gradle" scheme="http://www.jacpy.com/categories/gradle/"/>
    
    
      <category term="gradle打jar包 混淆" scheme="http://www.jacpy.com/tags/gradle%E6%89%93jar%E5%8C%85-%E6%B7%B7%E6%B7%86/"/>
    
  </entry>
  
  <entry>
    <title>golang抓取html转换成pdf</title>
    <link href="http://www.jacpy.com/2017/02/19/go-html-to-pdf.html"/>
    <id>http://www.jacpy.com/2017/02/19/go-html-to-pdf.html</id>
    <published>2017-02-19T14:39:21.000Z</published>
    <updated>2017-03-05T14:01:34.000Z</updated>
    
    <content type="html">&lt;p&gt;总结一下学习十来天go语言的成果，看了一遍语法之后，写了一个抓取HTML然后转换成PDF文件的程序，分享一下，代码点&lt;a href=&quot;https://github.com/jacpy/GoDemo/blob/master/html2pdf/html2pdf.go&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;。代码在目前go的1.7.5版本和1.8版本上运行没有问题，据说go向下兼容，而不像swift。但发现有些比较老的资料上的代码，在新的go版本上看不到效果，比如打印地址&lt;code&gt;%p&lt;/code&gt;，在新版本中必须得使用&lt;code&gt;unsafe.Pointer(p)&lt;/code&gt;转换一下，否则格式化输出指针变量不会打印出内存地址。&lt;/p&gt;
&lt;p&gt;其中使用了两个第三方库：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;html操作使用了&lt;a href=&quot;https://github.com/PuerkitoBio/goquery&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;goquery&lt;/a&gt;的第三方库，对html操作很方便；&lt;/li&gt;
&lt;li&gt;html转PDF使用了&lt;a href=&quot;http://wkhtmltopdf.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;wkhtmltopdf&lt;/a&gt;库，到官方网站上选择相应的平台下载安装，然后在go语言中执行相应的命令即可。使用说明点&lt;a href=&quot;http://wkhtmltopdf.org/usage/wkhtmltopdf.txt&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另外还有一个去水印的功能，想具体了解请参考代码。&lt;/p&gt;
&lt;p&gt;通过这个功能的练手，发现go语言还是相关操作都很方便。比如文件读写：不像java那样，不同的流嵌套，然后就是try-catch。go里面写起来，相比而言简单好多。goquery这个库操作HTML很方便，唯一感觉不好用的地方是修改HTML标签的属性值，没有找到类似这种&lt;code&gt;p.Find(&amp;quot;div.Part div a img&amp;quot;).RemoveAttr(&amp;quot;alt&amp;quot;)&lt;/code&gt;好用的函数。&lt;/p&gt;
&lt;p&gt;后面希望能更深入的了解go语言。&lt;/p&gt;
&lt;p&gt;附已经转换OK的PDF的下载地址：&lt;a href=&quot;https://github.com/jacpy/GoDemo/blob/master/html2pdf/TCP:IP%E8%AF%A6%E8%A7%A3%20%E5%8D%B71%EF%BC%9A%E5%8D%8F%E8%AE%AE.pdf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;TCP:IP详解 卷1：协议.pdf&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;总结一下学习十来天go语言的成果，看了一遍语法之后，写了一个抓取HTML然后转换成PDF文件的程序，分享一下，代码点&lt;a href=&quot;https://github.com/jacpy/GoDemo/blob/master/html2pdf/html2pdf.go&quot;&gt;这里&lt;/a&gt;。代码在目前go的1.7.5版本和1.8版本上运行没有问题，据说go向下兼容，而不像swift。但发现有些比较老的资料上的代码，在新的go版本上看不到效果，比如打印地址&lt;code&gt;%p&lt;/code&gt;，在新版本中必须得使用&lt;code&gt;unsafe.Pointer(p)&lt;/code&gt;转换一下，否则格式化输出指针变量不会打印出内存地址。&lt;/p&gt;
&lt;p&gt;其中使用了两个第三方库：&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://www.jacpy.com/categories/go/"/>
    
    
      <category term="go html to pdf" scheme="http://www.jacpy.com/tags/go-html-to-pdf/"/>
    
  </entry>
  
  <entry>
    <title>android集成华为推送总结</title>
    <link href="http://www.jacpy.com/2017/01/20/huawei-push-summary.html"/>
    <id>http://www.jacpy.com/2017/01/20/huawei-push-summary.html</id>
    <published>2017-01-20T08:01:07.000Z</published>
    <updated>2017-03-05T14:02:43.000Z</updated>
    
    <content type="html">&lt;p&gt;前段时间在应用中集成了华为推送，现在终于告一段落了，回首起来，发现一路踩的坑，都是泪啊。&lt;/p&gt;
&lt;p&gt;先交待下集成华为推送的背景：由于android手机上的google官方的推送GCM在中国大陆基本是残废，而大陆有些手机厂商可能会干掉这部分，造成GCM推送基本不可用。而像小米、华为等手机厂商对android系统的ROM进行了深度定制，用户可以手机桌面直接将应用程序kill，即使有后台服务，都被会一起干掉，同时android新的版本为了改善手机续行，在6.0开始增加了Doze机制，无疑对推送又是一大打击。综合这些因素，决定选几种推送一起集成进来，其中就有针对华为手机的华为推送。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;去华为开发者官网发现，华为推送有两种，不细心还真发现不了。一种是已经明确标识的&lt;code&gt;PUSH服务&lt;/code&gt;，另一种是&lt;code&gt;华为移动服务（HMS）&lt;/code&gt;。&lt;code&gt;PUSH服务&lt;/code&gt;仅是提供推送服务，所以一般推送使用这种。如果华为手机没有打开&lt;code&gt;应用自启动&lt;/code&gt;也可以使用这种推送，但使用这种推送如果推送多条消息，会在通知栏显示多条通知，不会自动合并成一条，如果是用在IM中作为消息推送，N条消息一过来，用户体验可想而知。而相反，小米的推送就好很多，通知栏通知会自动合并，只显示一条。另外&lt;code&gt;HMS&lt;/code&gt;中不仅集成了推送，还包括支付等服务，使用&lt;code&gt;HMS&lt;/code&gt;中的推送可以自定义消息通知栏，还可以自定义数据格式，官方称这种方式为透传。&lt;code&gt;PUSH服务&lt;/code&gt;只能是系统弹出通知栏，应用没有控制权限，也不能额外的再传递数据，所以使用&lt;code&gt;HMS&lt;/code&gt;自定义通知栏通知可以解决通知栏弹出N多通知的问题。&lt;code&gt;PUSH服务&lt;/code&gt;与&lt;code&gt;HMS&lt;/code&gt;在华为手机上相比，前者的通用性更强些。目前在几台华为手机上测试发现，&lt;code&gt;PUSH服务&lt;/code&gt;都能注册成功，而&lt;code&gt;HMS&lt;/code&gt;在有些手机上不能注册成功，需要打开应用的&lt;code&gt;应用自启动&lt;/code&gt;开关，甚至有的手机上根本注册不成功，不管怎么折腾。&lt;/p&gt;
&lt;p&gt;那么想要好的推送效果，又想要好的推送体验，唯一解决办法是两种都集成，先通过&lt;code&gt;HMS&lt;/code&gt;注册，如果注册不成功，则使用使用&lt;code&gt;PUSH服务&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;写这篇记录的时候去官网看了一下，官方已经将&lt;code&gt;PUSH服务&lt;/code&gt;与&lt;code&gt;HMS&lt;/code&gt;中的推送合并，下图是官方的文档说明：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/01/22/hw_push_merge.png&quot; alt=&quot;PUSH服务与HMS推送合并&quot;&gt;&lt;/p&gt;
&lt;p&gt;另外还有一些坑：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;1.华为联盟后台的账号登录后会在浏览器缓存cookie，如果切换账号，发现后台的信息还是上一个账号的，需要清除浏览器cookie缓存才OK。这是同事在使用公司的账号和个人的账号测试时发现的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;2.如果在推送中已经填写了Debug Key的SHA256证书指纹，再改成Release Key的指纹时，发现手机一直获取不到token，解决办法是把手机中相关华为的服务的应用缓存清除掉，特别是华为移动服务。如果还是不行，把华为商城应用升级到最新版本。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;添加指纹的位置：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://developer.huawei.com/consumer/cn/wiki/images/3/3b/x04.HMS,PE5,PBC,P80,PE5,P8F,P91,PE6,P8C,P87,PE5,PAF,PBC,PE4,PB9,PA6-PUSH,PE6,P9C,P8D,PE5,P8A,PA1,PE6,P8E,PA5,PE5,P8F,PA3-,PE7,P8E,PB0,PE6,P9C,P89,PE4,PB8,P9A,PE5,P8A,PA1,PE8,PBF,P81,PE7,PA7,PBB.png.pagespeed.ic.AU0p7gImxO.webp&quot; alt=&quot;华为联盟后台推送添加SHA256指纹的官网截图&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;3.如果一直能正常获取到token，突然又不能，解决办法是重启手机再试。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;4.如果注册成功，发现收到消息，首先排查服务器端调用华为SDK是否OK，如果服务器端调用OK，没有出现报错之类的问题，然后就是等，可能是10分钟后或者20分钟后，甚至是第二天，你就&lt;code&gt;基本&lt;/code&gt;能收到消息了。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;自己集成SDK测试时，出现了几次消息没收到的情况，也就是推送丢失了。但使用华为联盟后台推送比使用SDK推送，消息的到达率和准时性要好。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面这张截图是华为官方的服务介绍：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/01/22/hw_push_msg_arrived_ratio.png&quot; alt=&quot;基本100%送到，远远高于其他推送平台&quot;&gt;&lt;/p&gt;
&lt;p&gt;还有一些问题的解决方案参考这里：&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.jacpy.com/2017/01/19/huawei-hms-push-timepicker-inflate-error.html&quot;&gt;使用HMS推送定义了EMUI的样式导致TimePicker初始化失败&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;如果还遇到其他问题解决不了，通过QQ找他们技术支持。&lt;/p&gt;
&lt;p&gt;希望能帮到一些人，以上。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前段时间在应用中集成了华为推送，现在终于告一段落了，回首起来，发现一路踩的坑，都是泪啊。&lt;/p&gt;
&lt;p&gt;先交待下集成华为推送的背景：由于android手机上的google官方的推送GCM在中国大陆基本是残废，而大陆有些手机厂商可能会干掉这部分，造成GCM推送基本不可用。而像小米、华为等手机厂商对android系统的ROM进行了深度定制，用户可以手机桌面直接将应用程序kill，即使有后台服务，都被会一起干掉，同时android新的版本为了改善手机续行，在6.0开始增加了Doze机制，无疑对推送又是一大打击。综合这些因素，决定选几种推送一起集成进来，其中就有针对华为手机的华为推送。&lt;/p&gt;
    
    </summary>
    
    
      <category term="HMS 华为透传 华为推送" scheme="http://www.jacpy.com/tags/HMS-%E5%8D%8E%E4%B8%BA%E9%80%8F%E4%BC%A0-%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>使用HMS推送定义了EMUI的样式导致TimePicker初始化失败</title>
    <link href="http://www.jacpy.com/2017/01/19/huawei-hms-push-timepicker-inflate-error.html"/>
    <id>http://www.jacpy.com/2017/01/19/huawei-hms-push-timepicker-inflate-error.html</id>
    <published>2017-01-19T07:46:24.000Z</published>
    <updated>2017-01-19T09:34:59.000Z</updated>
    
    <content type="html">&lt;p&gt;昨天遇到一个很奇葩的问题，使用了华为HMS SDK中的推送功能，然后插件布局文件中的TimePicker初始化时，会报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.view.InflateException: Binary XML file line #47: Error inflating class huawei.android.widget.TimePicker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;很奇怪，&lt;code&gt;TimePicker&lt;/code&gt;在布局文件中使用&lt;code&gt;&amp;lt;TimePicker/&amp;gt;&lt;/code&gt;标签，当布局文件被inflate后，在&lt;code&gt;android.widget.TimePicker&lt;/code&gt;前面加了一个&lt;code&gt;huawei.&lt;/code&gt;。如果使用&lt;code&gt;&amp;lt;android.widget.TimePicker/&amp;gt;&lt;/code&gt;标签，则不会有问题；而其他有地方会出现这个新的错误：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.view.InflateException: Binary XML file line #20: Error inflating class &amp;lt;unknown&amp;gt;at android.view.LayoutInflater.createView(LayoutInflater.java:620)at com.android.internal.policy.impl.PhoneLayoutInflater.onCreateView(PhoneLayoutInflater.java:56)at android.view.LayoutInflater.onCreateView(LayoutInflater.java:669)at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:694)at android.view.LayoutInflater.inflate(LayoutInflater.java:469)at android.view.LayoutInflater.inflate(LayoutInflater.java:397)at android.view.LayoutInflater.inflate(LayoutInflater.java:353)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:103)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:74)at android.view.View.performClick(View.java:4447)at android.view.View$PerformClick.run(View.java:18457)at android.os.Handler.handleCallback(Handler.java:733)at android.os.Handler.dispatchMessage(Handler.java:95)at android.os.Looper.loop(Looper.java:136)at android.app.ActivityThread.main(ActivityThread.java:5119)at java.lang.reflect.Method.invokeNative(Native Method)at java.lang.reflect.Method.invoke(Method.java:515)at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:789)at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:605)at dalvik.system.NativeStart.main(Native Method)Caused by: java.lang.reflect.InvocationTargetExceptionat java.lang.reflect.Constructor.constructNative(Native Method)at java.lang.reflect.Constructor.newInstance(Constructor.java:423)at android.view.LayoutInflater.createView(LayoutInflater.java:594)... 20 moreCaused by: java.lang.NullPointerExceptionat android.view.ViewGroup.addView(ViewGroup.java:3353)at com.huawei.android.hwcontrol.TimePickerFactory.updateAmPmStart(TimePickerFactory.java:92)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:265)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:139)... 23 morejava.lang.reflect.InvocationTargetExceptionat java.lang.reflect.Constructor.constructNative(Native Method)at java.lang.reflect.Constructor.newInstance(Constructor.java:423)at android.view.LayoutInflater.createView(LayoutInflater.java:594)at com.android.internal.policy.impl.PhoneLayoutInflater.onCreateView(PhoneLayoutInflater.java:56)at android.view.LayoutInflater.onCreateView(LayoutInflater.java:669)at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:694)at android.view.LayoutInflater.inflate(LayoutInflater.java:469)at android.view.LayoutInflater.inflate(LayoutInflater.java:397)at android.view.LayoutInflater.inflate(LayoutInflater.java:353)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:103)at android.app.TimePickerDialog.&amp;lt;init&amp;gt;(TimePickerDialog.java:74)at android.view.View.performClick(View.java:4447)at android.view.View$PerformClick.run(View.java:18457)at android.os.Handler.handleCallback(Handler.java:733)at android.os.Handler.dispatchMessage(Handler.java:95)at android.os.Looper.loop(Looper.java:136)at android.app.ActivityThread.main(ActivityThread.java:5119)at java.lang.reflect.Method.invokeNative(Native Method)at java.lang.reflect.Method.invoke(Method.java:515)at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:789)at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:605)at dalvik.system.NativeStart.main(Native Method)Caused by: java.lang.NullPointerExceptionat android.view.ViewGroup.addView(ViewGroup.java:3353)at com.huawei.android.hwcontrol.TimePickerFactory.updateAmPmStart(TimePickerFactory.java:92)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:265)at android.widget.TimePicker.&amp;lt;init&amp;gt;(TimePicker.java:139)... 23 more&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但如果不使用插件，在主应用中使用TimePicker之类的组件，就一切OK。&lt;/p&gt;
&lt;p&gt;好吧，问题很严重，已经定位到是集成了推送的功能之后出现的。但很难定位为什么出现这种问题，注册Token后，跨进程通讯问题？后台推送服务导致的？&lt;/p&gt;
&lt;p&gt;看到这个&lt;code&gt;huawei.android.widget.TimePicker&lt;/code&gt;在想，华为又调皮了，又改了系统的源码。因为google官方的android系统源中有这样一个逻辑，发现布局文件中的View没有包名，会自动加上&lt;code&gt;android.widget.&lt;/code&gt;前缀。&lt;/p&gt;
&lt;p&gt;已经在怀疑是在AndroidManifest.xml文件中配置了什么导致了问题，所以一行一行的排查。果然，在去掉下面这行后，就正常了。&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;application&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;meta-data android:name=&quot;hwc-theme&quot;            android:value=&quot;androidhwext:style/Theme.Emui.NoActionBar&quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/application&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个&lt;code&gt;meta-data&lt;/code&gt;定义是放在&lt;code&gt;applicaton&lt;/code&gt;标签中，所以会针对整个App。把这行干掉之后，问题解决。&lt;/p&gt;
&lt;p&gt;这种问题也只能是在这种特定场景中被遇到，一般还真遇不到。三生有幸！&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;昨天遇到一个很奇葩的问题，使用了华为HMS SDK中的推送功能，然后插件布局文件中的TimePicker初始化时，会报如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;android.view.InflateException: Binary XML file line #47: Error inflating class huawei.android.widget.TimePicker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="android push" scheme="http://www.jacpy.com/categories/android-push/"/>
    
    
      <category term="推送" scheme="http://www.jacpy.com/tags/%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>android点击通知栏通知启动Activity问题</title>
    <link href="http://www.jacpy.com/2016/12/28/android-notification-launch-activity.html"/>
    <id>http://www.jacpy.com/2016/12/28/android-notification-launch-activity.html</id>
    <published>2016-12-28T08:36:40.000Z</published>
    <updated>2017-01-19T09:36:41.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天遇到一个很奇葩的问题，终于解决了，记录一下。&lt;/p&gt;
&lt;p&gt;问题场景是：用小米手机使用小米推送一条消息，然后点击通知栏中的消息启动应用，然后进入会话的Activity。应用启动后，如果当前界面不是会话界面，那么新消息会在通知栏显示消息提醒，然后点击会话消息后却进不了会话的Activity，即点击了通知栏通知后，系统都没有启动指定Activity的意思，没有看到系统启动Activity的Log，到是会看到系统处理这个Activity的影子。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;这个指定的Activity不是会话的Activity，而是在AndroidManifest.xml文件中指定&lt;code&gt;android.intent.category.LAUNCHER&lt;/code&gt;的Activity A。也就是说有会话消息都是先从这个A开始，然后把数据往后面的Activity传。&lt;/p&gt;
&lt;p&gt;这里显示通知有两种方式，一种是由手机系统在通知栏弹出，比如小米手机上使用小米推送，华为手机上使用华为推送，另外一种是由应用的远程进程弹出。&lt;/p&gt;
&lt;p&gt;启动应用的第一个Activity A也有两种方式，一种是直接通过new来构造一个Intent，然后传入Activity A的class；另外一种是通过&lt;code&gt;context.getPackageManager().getLaunchIntentForPackage(context.getPackageName())&lt;/code&gt;来获取启动的Activity A的Intent。然后调用PendingIntent.getActivity()方法，将得到的intent传入。&lt;/p&gt;
&lt;p&gt;那么问题来了，如果是点击系统弹出的通知栏或者远程进程弹出的通知栏，如果只是使用其中一种启动方式启动应用，那么在应用启动后，点击通知栏中由后台远程进程弹出的新消息通知，这个时候就不能进入会话的Activity。从系统的日志来看，没有启动Activity，只是对Activity做了处理。&lt;/p&gt;
&lt;p&gt;可能有人会想到是不是要加一个&lt;code&gt;Intent.FLAG_ACTIVITY_NEW_TASK&lt;/code&gt;标识，因为在&lt;code&gt;getLaunchIntentForPackage()&lt;/code&gt;方法中加了这个标识。&lt;/p&gt;
&lt;p&gt;最后测试发现，只要应用没有被启动，不管是点击系统弹出的通知栏还是远程进程弹出的通知栏，如果再收到新消息通知，再点击通知栏，就能进入会话Activity了。那只要判断应用中是否有Activity被启动就OK了，貌似问题可以解决了。&lt;/p&gt;
&lt;p&gt;于是用了下面的逻辑来判断是否有前台Activity在运行。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/** * 判断UI进程是否正在运行 * &lt;span class=&quot;doctag&quot;&gt;@return&lt;/span&gt; 返回true表示正在运行，否则没有运行 */&lt;/span&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isForegroundRunning&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;    ActivityManager am = (ActivityManager) EimCloud.getContext().getSystemService(Context.ACTIVITY_SERVICE);    List&amp;lt;ActivityManager.RunningAppProcessInfo&amp;gt; list = am.getRunningAppProcesses();    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (list != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (ActivityManager.RunningAppProcessInfo info : list) &amp;#123;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (info.importance == ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND						&amp;amp;&amp;amp; EimCloud.getContext().getPackageName().equals(info.processName)) &amp;#123;					&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;            &amp;#125;        &amp;#125;    &amp;#125;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是上面的方法在小米手机上凑效了，但在华为手机上还是有问题，即使同样的场景。华为又坑爹了！&lt;/p&gt;
&lt;p&gt;于是开始从上面的&lt;code&gt;ActivityManager.RunningAppProcessInfo&lt;/code&gt;类中的&lt;code&gt;importance&lt;/code&gt;变量的状态入手，然后测试各种场景可能出现的变量值，结果发现效果不尽人意，有些场景问题依旧。&lt;/p&gt;
&lt;p&gt;最后，又换种思路：不从Activity A开始启动应用，换个Activity B，也就是在调用&lt;code&gt;PendingIntent.getActivity()&lt;/code&gt;方法传入Intent对象使用B的class。启动B会发现应用没有被初始化，则跳转到A执行初始化，然后再走正常流程。&lt;/p&gt;
&lt;p&gt;再针对各种场景以及各种机型测试，发现问题解决。从上面可以看出，虽然不懂背后原理，但解决问题的思路一定要广，特别是在急着发版本的时候，不要在一棵树上吊死。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天遇到一个很奇葩的问题，终于解决了，记录一下。&lt;/p&gt;
&lt;p&gt;问题场景是：用小米手机使用小米推送一条消息，然后点击通知栏中的消息启动应用，然后进入会话的Activity。应用启动后，如果当前界面不是会话界面，那么新消息会在通知栏显示消息提醒，然后点击会话消息后却进不了会话的Activity，即点击了通知栏通知后，系统都没有启动指定Activity的意思，没有看到系统启动Activity的Log，到是会看到系统处理这个Activity的影子。&lt;/p&gt;
    
    </summary>
    
      <category term="android push" scheme="http://www.jacpy.com/categories/android-push/"/>
    
    
      <category term="notification" scheme="http://www.jacpy.com/tags/notification/"/>
    
  </entry>
  
  <entry>
    <title>android布局中的EXACTLY、AT_MOST、UNSPECIFIED详解</title>
    <link href="http://www.jacpy.com/2016/12/18/android-exactly-atmost-unspecified-detailed-explaintion.html"/>
    <id>http://www.jacpy.com/2016/12/18/android-exactly-atmost-unspecified-detailed-explaintion.html</id>
    <published>2016-12-18T09:55:42.000Z</published>
    <updated>2016-12-18T09:55:52.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;前几天在给一个同事讲&amp;amp;运算取变量的状态写法，原因是我看到他代码中这样写会产生问题，所以想纠正他一下，于是就跟他说你可以参考下android系统中View在measure时使用的状态是怎么通过&amp;amp;运算获取的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;他也说这几个状态是与View在布局文件中设置width或height时，有个对应关系。就这个机会，深入的了解了下View的宽高的measure是怎么与&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#EXACTLY&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.view.View.MeasureSpec.EXACTLY&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#AT_MOST&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.view.View.MeasureSpec.AT_MOST&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#UNSPECIFIED&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.view.View.MeasureSpec.UNSPECIFIED&lt;/a&gt;这三种状态一一对应的。于是就有了下文。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;在布局文件中设置View的&lt;code&gt;layout_width&lt;/code&gt;或&lt;code&gt;layout_height&lt;/code&gt;时，可以设置三种值&lt;code&gt;match_parent&lt;/code&gt;、&lt;code&gt;wrap_content&lt;/code&gt;和具体的长度值，下面看下android系统源码中是怎么处理这几种值的。&lt;/p&gt;
&lt;p&gt;做过android开发都知道，如果在Activity的&lt;code&gt;onCreate()&lt;/code&gt;方法中通过调用View的&lt;code&gt;getWidth()&lt;/code&gt;方法是获取不到View的宽高的，此时返回的是0，因为View还没有初始化完成。那么查看View的&lt;code&gt;getWidth()&lt;/code&gt;方法发现，返回的值是通过&lt;code&gt;mRight - mLeft&lt;/code&gt;返回的值，也就是说如果调用&lt;code&gt;getWidth()&lt;/code&gt;返回值，那么一定是&lt;code&gt;mRight&lt;/code&gt;和&lt;code&gt;mLeft&lt;/code&gt;这两个变量被赋值了。View的&lt;code&gt;getHeight()&lt;/code&gt;方法返回高度同理。在View中&lt;code&gt;mLeft&lt;/code&gt;个成员被初始化值在两个方法中，一个是&lt;code&gt;setLeft(int)&lt;/code&gt;方法中，一个是&lt;code&gt;setFrame(int,int,int,int)&lt;/code&gt;中，实际上这两个方法都是由系统来调用的，尤其是&lt;code&gt;setFrame()&lt;/code&gt;方法被标记为隐藏。通过查看源码发现，&lt;code&gt;setLeft(int)&lt;/code&gt;这个方法很少被使用，倒是跟踪&lt;code&gt;setFrame(int,int,int,int)&lt;/code&gt;方法时，发现一些眉目，最后发现这个这个&lt;code&gt;setFrame()&lt;/code&gt;方法是在View的&lt;code&gt;layout()&lt;/code&gt;方法中一直调用过来的。OK，那么这个layout()方法的调用轨迹是怎样的呢？可以自定义一个View，然后重写这个View的&lt;code&gt;layout()&lt;/code&gt;方法，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;layout&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; l, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; t, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; r, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; b)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.layout(l, t, r, b);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Throwable th = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Throwable();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    th.printStackTrace(); &lt;span class=&quot;comment&quot;&gt;// 打印被调用的栈信息&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出的LOG如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;W/System.err: java.lang.Throwable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at com.jacpy.busline.widget.BusLineView.layout(BusLineView.java:243)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.RelativeLayout.onLayout(RelativeLayout.java:1055)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.layoutChildren(FrameLayout.java:453)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.onLayout(FrameLayout.java:388)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.LinearLayout.setChildFrame(LinearLayout.java:1671)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.LinearLayout.layoutVertical(LinearLayout.java:1525)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.LinearLayout.onLayout(LinearLayout.java:1434)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.layoutChildren(FrameLayout.java:453)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.widget.FrameLayout.onLayout(FrameLayout.java:388)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.View.layout(View.java:14860)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewGroup.layout(ViewGroup.java:4643)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl.performLayout(ViewRootImpl.java:2013)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:1770)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:1019)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:5725)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer$CallbackRecord.run(Choreographer.java:761)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer.doCallbacks(Choreographer.java:574)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer.doFrame(Choreographer.java:544)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.view.Choreographer$FrameDisplayEventReceiver.run(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.os.Handler.handleCallback(Handler.java:733)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.os.Looper.loop(Looper.java:136)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at android.app.ActivityThread.main(ActivityThread.java:5086)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at java.lang.reflect.Method.invokeNative(Native Method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at java.lang.reflect.Method.invoke(Method.java:515)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:601)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W/System.err:     at dalvik.system.NativeStart.main(Native Method)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这段LOG从下往上看，首先是ZygoteInit启动，也就是手机系统的启动，这部分忽略，只看与应用相关的，从&lt;code&gt;ActivityThread.main()&lt;/code&gt;开始。在&lt;code&gt;ActivityThread&lt;/code&gt;中启动的Looper主线程用来执行了一个Runnable实例，这个实例是&lt;code&gt;android.view.Choreographer$FrameDisplayEventReceiver&lt;/code&gt;类的实例，在这个类的&lt;code&gt;run()&lt;/code&gt;方法中执行了Choreographer的&lt;code&gt;doFrame()&lt;/code&gt;方法，在这个方法中看到熟悉的日志输出：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Log.i(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Skipped &quot;&lt;/span&gt; + skippedFrames + &lt;span class=&quot;string&quot;&gt;&quot; frames!  &quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                            + &lt;span class=&quot;string&quot;&gt;&quot;The application may be doing too much work on its main thread.&quot;&lt;/span&gt;);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当View初始化时在主线程中做的操作过多导致卡帧时，这个LOG就会输出。&lt;/p&gt;
&lt;p&gt;OK，跑题了，继续看日志。在&lt;code&gt;doCallbacks()&lt;/code&gt;方法中从&lt;code&gt;mCallbackQueues&lt;/code&gt;这个回调队列中根据回调的类型取出要执行的CallbackRecord对象，并调用其&lt;code&gt;run()&lt;/code&gt;方法。而ViewRootImpl的TraversalRunnable对象是通过在ViewRootImpl的&lt;code&gt;scheduleTraversals()&lt;/code&gt;方法中设置的。代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;scheduleTraversals&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mTraversalScheduled) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mTraversalScheduled = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mTraversalBarrier = mHandler.getLooper().postSyncBarrier();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mChoreographer.postCallback(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// 将mTranversalRunnable加入到mChoreographer的mCallbackQueues的队列中&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!mUnbufferedInputDispatch) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            scheduleConsumeBatchedInput();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        notifyRendererOfFramePending();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最后在&lt;code&gt;performLayout()&lt;/code&gt;方法中看到具体调用View的&lt;code&gt;layout()&lt;/code&gt;方法的代码：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;host.layout(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, host.getMeasuredWidth(), host.getMeasuredHeight());&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里的host是ViewRootImpl的&lt;code&gt;mView&lt;/code&gt;对象，这个对象是一个PhoneWindow.DecorView对象，后面会有文章分析。&lt;/p&gt;
&lt;p&gt;OK，这里可以看到&lt;code&gt;mLeft&lt;/code&gt;赋值是0，&lt;code&gt;mRight&lt;/code&gt;就是&lt;code&gt;getMeasureWidth()&lt;/code&gt;方法的返回值。&lt;code&gt;getMeasureWidth()&lt;/code&gt;这个方法代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; MEASURED_SIZE_MASK = &lt;span class=&quot;number&quot;&gt;0x00ffffff&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getMeasuredWidth&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; mMeasuredWidth &amp;amp; MEASURED_SIZE_MASK;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面的代码可以看出，&lt;code&gt;mMeasureWidth&lt;/code&gt;取了后三个字节，也就是本来是int类型的&lt;code&gt;mMeasureWidth&lt;/code&gt;实际目前只使用了低位三个字节，对于目前的显示的分辨率来说足够。&lt;/p&gt;
&lt;p&gt;OK，重点来了，这个&lt;code&gt;mMeasureWidth&lt;/code&gt;的值是怎么来的？继续跟代码发现这个变量在View的&lt;code&gt;setMeasuredDimensionRaw()&lt;/code&gt;方法中被赋值，使用方法中的参数赋值。接着发现这个方法在&lt;code&gt;setMeasuredDimension()&lt;/code&gt;和&lt;code&gt;measure()&lt;/code&gt;方法中被调用。而在&lt;code&gt;measure()&lt;/code&gt;方法中&lt;code&gt;cacheIndex&lt;/code&gt;这个变量可能是-1，因为&lt;code&gt;mMeasureCache&lt;/code&gt;变量中的键值对只在&lt;code&gt;measure()&lt;/code&gt;方法最后才放进去的，而最后是调用了&lt;code&gt;onMeasure()&lt;/code&gt;方法。代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;measure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightMeasureSpec)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;// Suppress sign extension for the low bytes&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; key = (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) widthMeasureSpec &amp;lt;&amp;lt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt; | (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) heightMeasureSpec &amp;amp; &lt;span class=&quot;number&quot;&gt;0xffffffffL&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;// 用一个64位的long类型保存两个32位的值，高32位是宽，低32位是高&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mMeasureCache == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) mMeasureCache = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; LongSparseLongArray(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((mPrivateFlags &amp;amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            widthMeasureSpec != mOldWidthMeasureSpec ||&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            heightMeasureSpec != mOldHeightMeasureSpec) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// first clears the measured dimension flag&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mPrivateFlags &amp;amp;= ~PFLAG_MEASURED_DIMENSION_SET;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		 &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; cacheIndex = (mPrivateFlags &amp;amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; :&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                mMeasureCache.indexOfKey(key); &lt;span class=&quot;comment&quot;&gt;// 如果没有找到这个Key也是返回-1&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (cacheIndex &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || sIgnoreMeasureCache) &amp;#123; &lt;span class=&quot;comment&quot;&gt;// 极有可能是走这个判断&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// measure ourselves, this should set the measured dimension flag back&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            onMeasure(widthMeasureSpec, heightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPrivateFlags3 &amp;amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; value = mMeasureCache.valueAt(cacheIndex);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Casting a long to int drops the high 32 bits, no mask needed&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            setMeasuredDimensionRaw((&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) (value &amp;gt;&amp;gt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;), (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) value);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		 &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	 &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	 &lt;span class=&quot;comment&quot;&gt;// 保存键值对&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mMeasureCache.put(key, ((&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) mMeasuredWidth) &amp;lt;&amp;lt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt; |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;) mMeasuredHeight &amp;amp; &lt;span class=&quot;number&quot;&gt;0xffffffffL&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// suppress sign extension&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;而&lt;code&gt;setMeasuredDimension()&lt;/code&gt;方法是在&lt;code&gt;onMeasure()&lt;/code&gt;方法中有调用。因此，上面的代码不管是走&lt;code&gt;if&lt;/code&gt;流程还是&lt;code&gt;else&lt;/code&gt;流程，最终都会调用&lt;code&gt;setMeasuredDimensionRaw()&lt;/code&gt;这个方法。不管流程怎样，这个值是从&lt;code&gt;measure()&lt;/code&gt;这个方法中的参数传进来的。以同样的方法重写View的&lt;code&gt;onMeasure()&lt;/code&gt;方法，如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onMeasure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightMeasureSpec)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onMeasure(widthMeasureSpec, heightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Throwable t = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Throwable();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    t.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出的LOG如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;java.lang.Throwable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.jacpy.busline.widget.BusLineView.onMeasure(BusLineView.java:442)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.RelativeLayout.measureChildHorizontal(RelativeLayout.java:719)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.RelativeLayout.onMeasure(RelativeLayout.java:455)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:5137)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.FrameLayout.onMeasure(FrameLayout.java:310)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:5137)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.LinearLayout.measureChildBeforeLayout(LinearLayout.java:1404)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.LinearLayout.measureVertical(LinearLayout.java:695)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.LinearLayout.onMeasure(LinearLayout.java:588)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:5137)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.widget.FrameLayout.onMeasure(FrameLayout.java:310)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.internal.policy.impl.PhoneWindow$DecorView.onMeasure(PhoneWindow.java:2291)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.measure(View.java:16540)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.performMeasure(ViewRootImpl.java:1942)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.measureHierarchy(ViewRootImpl.java:1132)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:1321)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:1019)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:5725)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer$CallbackRecord.run(Choreographer.java:761)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer.doCallbacks(Choreographer.java:574)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer.doFrame(Choreographer.java:544)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:747)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.os.Handler.handleCallback(Handler.java:733)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.os.Looper.loop(Looper.java:136)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.app.ActivityThread.main(ActivityThread.java:5086)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at java.lang.reflect.Method.invokeNative(Native Method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at java.lang.reflect.Method.invoke(Method.java:515)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:785)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:601)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at dalvik.system.NativeStart.main(Native Method)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从上面的LOG可以看出来，最终是在&lt;code&gt;measure()&lt;/code&gt;方法中调到&lt;code&gt;onMeasure()&lt;/code&gt;方法，也就是上面分析的流程。&lt;/p&gt;
&lt;p&gt;通过上面两段LOG发现，最终都指向了同一个地方，那就是ViewRootImpl的&lt;code&gt;performTraversals()&lt;/code&gt;。也就是说，在这个方法中先measure，然后再layout。&lt;/p&gt;
&lt;p&gt;从&lt;code&gt;measureHierarchy()&lt;/code&gt;方法中可以看出来在调用&lt;code&gt;performMeasure(int,int)&lt;/code&gt;方法时，传了两个参数&lt;code&gt;childWidthMeasureSpec&lt;/code&gt;和&lt;code&gt;childHeightMeasureSpec&lt;/code&gt;，而这两个变量是通过&lt;code&gt;getRootMeasureSpec()&lt;/code&gt;方法返回的，如下代码所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;measureHierarchy&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; View host, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; WindowManager.LayoutParams lp,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Resources res, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; desiredWindowWidth, &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; desiredWindowHeight) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childWidthMeasureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childHeightMeasureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; windowSizeMayChange = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; goodMeasure = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// On large screens, we don&#39;t want to allow dialogs to just&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// stretch to fill the entire width of the screen to display&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// one line of text.  First try doing the layout at a smaller&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// size to see if it will fit.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; DisplayMetrics packageMetrics = res.getDisplayMetrics();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        res.getValue(com.android.internal.R.dimen.config_prefDialogWidth, mTmpValue, &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; baseSize = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mTmpValue.type == TypedValue.TYPE_DIMENSION) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            baseSize = (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)mTmpValue.getDimension(packageMetrics);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: baseSize=&quot;&lt;/span&gt; + baseSize);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (baseSize != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; desiredWindowWidth &amp;gt; baseSize) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: measured (&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    + host.getMeasuredWidth() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + host.getMeasuredHeight() + &lt;span class=&quot;string&quot;&gt;&quot;)&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((host.getMeasuredWidthAndState()&amp;amp;View.MEASURED_STATE_TOO_SMALL) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                goodMeasure = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// Didn&#39;t fit in that size... try expanding a bit.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                baseSize = (baseSize+desiredWindowWidth)/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: next baseSize=&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        + baseSize);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Window &quot;&lt;/span&gt; + mView + &lt;span class=&quot;string&quot;&gt;&quot;: measured (&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        + host.getMeasuredWidth() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + host.getMeasuredHeight() + &lt;span class=&quot;string&quot;&gt;&quot;)&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((host.getMeasuredWidthAndState()&amp;amp;View.MEASURED_STATE_TOO_SMALL) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (DEBUG_DIALOG) Log.v(TAG, &lt;span class=&quot;string&quot;&gt;&quot;Good!&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    goodMeasure = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!goodMeasure) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight()) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            windowSizeMayChange = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; windowSizeMayChange;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;本文的重点来了，&lt;code&gt;getRootMeasureSpec()&lt;/code&gt;方法的代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getRootMeasureSpec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; windowSize, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; rootDimension)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; measureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (rootDimension) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; ViewGroup.LayoutParams.MATCH_PARENT:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Window can&#39;t resize. Force root view to be windowSize.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; ViewGroup.LayoutParams.WRAP_CONTENT:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Window can resize. Set max size for root view.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Window wants to be an exact size. Force root view to be that size.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; measureSpec;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;从方法中的switch可以看到，&lt;code&gt;MATCH_PARENT&lt;/code&gt;对应&lt;code&gt;MeasureSpec.EXACTLY&lt;/code&gt;、&lt;code&gt;WRAP_CONTENT&lt;/code&gt;对应&lt;code&gt;MeasureSpec.AT_MOST&lt;/code&gt;，默认的可以认为是设置了具体的值对应的是&lt;code&gt;MeasureSpec.EXACTLY&lt;/code&gt;。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;为了确定一下，可以看下MeasureSpc的&lt;code&gt;makeMeasureSpec()&lt;/code&gt;方法的代码，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; MODE_SHIFT = &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; MODE_MASK  = &lt;span class=&quot;number&quot;&gt;0x3&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; UNSPECIFIED = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; EXACTLY     = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; AT_MOST     = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &amp;lt;&amp;lt; MODE_SHIFT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;makeMeasureSpec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; size, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; mode)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (sUseBrokenMakeMeasureSpec) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; size + mode;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; (size &amp;amp; ~MODE_MASK) | (mode &amp;amp; MODE_MASK);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前面说尺寸值是由低三个字节表示，这里可以看到高位第一个字节的前两个位用来表示mode。也就是说int类型的第31、32位表示的是mode值，低30位表示是具体的长度值。&lt;/p&gt;
&lt;p&gt;OK，最后是在ViewGroup的&lt;code&gt;measureChildWithMargins()&lt;/code&gt;方法中调用每个child的&lt;code&gt;measure()&lt;/code&gt;方法去具体测量每个子View的长度，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;measureChildWithMargins&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(View child,&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; parentWidthMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; widthUsed,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; parentHeightMeasureSpec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; heightUsed) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    + widthUsed, lp.width);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    + heightUsed, lp.height);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;而其中被调用的&lt;code&gt;getChildMeasureSpec()&lt;/code&gt;方法中子View的大小是根据父View的大小及模式来决定的，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getChildMeasureSpec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; spec, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; padding, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; childDimension)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; specMode = MeasureSpec.getMode(spec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; specSize = MeasureSpec.getSize(spec);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; size = Math.max(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, specSize - padding);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; resultSize = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; resultMode = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (specMode) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Parent has imposed an exact size on us&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MeasureSpec.EXACTLY:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = childDimension;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.MATCH_PARENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to be our size. So be it.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to determine its own size. It can&#39;t be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// bigger than us.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.AT_MOST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Parent has imposed a maximum size on us&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MeasureSpec.AT_MOST:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants a specific size... so be it&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = childDimension;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.MATCH_PARENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to be our size, but our size is not fixed.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Constrain child to not be bigger than us.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.AT_MOST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to determine its own size. It can&#39;t be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// bigger than us.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.AT_MOST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Parent asked to see how big we want to be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MeasureSpec.UNSPECIFIED:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants a specific size... let him have it&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = childDimension;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.EXACTLY;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.MATCH_PARENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to be our size... find out how big it should&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; : size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.UNSPECIFIED;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (childDimension == LayoutParams.WRAP_CONTENT) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Child wants to determine its own size.... find out how&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// big it should be&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; : size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultMode = MeasureSpec.UNSPECIFIED;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; MeasureSpec.makeMeasureSpec(resultSize, resultMode);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;OK，以上就是整个分析过程。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;前几天在给一个同事讲&amp;amp;运算取变量的状态写法，原因是我看到他代码中这样写会产生问题，所以想纠正他一下，于是就跟他说你可以参考下android系统中View在measure时使用的状态是怎么通过&amp;amp;运算获取的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;他也说这几个状态是与View在布局文件中设置width或height时，有个对应关系。就这个机会，深入的了解了下View的宽高的measure是怎么与&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#EXACTLY&quot;&gt;android.view.View.MeasureSpec.EXACTLY&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#AT_MOST&quot;&gt;android.view.View.MeasureSpec.AT_MOST&lt;/a&gt;、&lt;a href=&quot;https://developer.android.google.cn/reference/android/view/View.MeasureSpec.html#UNSPECIFIED&quot;&gt;android.view.View.MeasureSpec.UNSPECIFIED&lt;/a&gt;这三种状态一一对应的。于是就有了下文。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="view" scheme="http://www.jacpy.com/categories/view/"/>
    
    
      <category term="EXACTLY AT_MOST UNSPECIFIED" scheme="http://www.jacpy.com/tags/EXACTLY-AT-MOST-UNSPECIFIED/"/>
    
  </entry>
  
</feed>
