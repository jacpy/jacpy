<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jacpy&#39;s blog</title>
  <subtitle>enjoy mobile development</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.jacpy.com/"/>
  <updated>2019-09-16T09:40:02.221Z</updated>
  <id>http://www.jacpy.com/</id>
  
  <author>
    <name>jacpy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>jquery跨域问题导致ajax请求直接走error回调函数</title>
    <link href="http://www.jacpy.com/2019/09/16/jquery-cors.html"/>
    <id>http://www.jacpy.com/2019/09/16/jquery-cors.html</id>
    <published>2019-09-16T09:02:48.000Z</published>
    <updated>2019-09-16T09:40:02.221Z</updated>
    
    <content type="html">&lt;p&gt;使用jquery的ajax请求时，发现每次都是走error的回调函数，错误提示的日志为&lt;code&gt;{&amp;quot;readyState&amp;quot;:0, status: 0, status:&amp;quot;error&amp;quot;}&lt;/code&gt;。抓包请求发现请求正常返回数据，但是js代码却执行error的回调。其他组开发人员反馈的问题描述是在App中使用离线代码没有问题，使用地址访问就有问题。自然而然就想到了跨域问题，一看请求地址，果然。&lt;/p&gt;
&lt;p&gt;服务器端接口响应的头增加以下内容就可以解决：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Access-Control-Allow-Origin: http://foo.example&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Access-Control-Allow-Methods: POST, GET, OPTIONS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Access-Control-Allow-Headers: X-PINGOTHER, Content-Type&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Access-Control-Max-Age: 86400&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;注意：相应的域名要替换一下，&lt;/strong&gt;替换成请求页面的地址，包括端口号。&lt;/p&gt;
&lt;p&gt;响应头中返回以上内容就相当于告诉浏览器，这个数据来源可靠，把数据返回到JS中。否则浏览器认为响应数据不安全，直接拦截，不返回正确的数据，而返回错误。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;使用jquery的ajax请求时，发现每次都是走error的回调函数，错误提示的日志为&lt;code&gt;{&amp;quot;readyState&amp;quot;:0, status: 0, status:&amp;quot;error&amp;quot;}&lt;/code&gt;。抓包请求发现请求正常返回数据，但是js代码却执行error的回调。其他组开发人员反馈的问题描述是在App中使用离线代码没有问题，使用地址访问就有问题。自然而然就想到了跨域问题，一看请求地址，果然。&lt;/p&gt;
&lt;p&gt;服务器端接口响应的头增加以下内容就可以解决：&lt;/p&gt;
    
    </summary>
    
      <category term="javascript" scheme="http://www.jacpy.com/categories/javascript/"/>
    
    
      <category term="jquery跨域问题" scheme="http://www.jacpy.com/tags/jquery%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>EventBus实现分析（下）</title>
    <link href="http://www.jacpy.com/2018/07/26/eventbus-implement-analysis-2.html"/>
    <id>http://www.jacpy.com/2018/07/26/eventbus-implement-analysis-2.html</id>
    <published>2018-07-26T01:45:13.000Z</published>
    <updated>2019-01-27T01:14:15.839Z</updated>
    
    <content type="html">&lt;p&gt;&lt;a href=&quot;/2018/07/23/eventbus-implement-analysis-1.html&quot;&gt;EventBus实现分析（上）&lt;/a&gt;中介绍了&lt;code&gt;EventBus&lt;/code&gt;的&lt;code&gt;简单使用&lt;/code&gt;和&lt;code&gt;解决什么问题&lt;/code&gt;，这一节介绍EventBus的实现细节。&lt;/p&gt;
&lt;h2 id=&quot;三、实现细节&quot;&gt;&lt;a href=&quot;#三、实现细节&quot; class=&quot;headerlink&quot; title=&quot;三、实现细节&quot;&gt;&lt;/a&gt;三、实现细节&lt;/h2&gt;&lt;p&gt;前面在介绍EventBus的使用时，也顺带着讲了一些细节。下面先从两个流程开始，一个是注册流程，另一个是发送消息并且处理的流程。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;3-1-注册流程&quot;&gt;&lt;a href=&quot;#3-1-注册流程&quot; class=&quot;headerlink&quot; title=&quot;3.1 注册流程&quot;&gt;&lt;/a&gt;3.1 注册流程&lt;/h3&gt;&lt;p&gt;注册过程要根据消息类型缓存对应消息接收的方法，缓存的集合是一个HashMap，缓存集合代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;Class&amp;lt;?&amp;gt;, CopyOnWriteArrayList&amp;lt;Subscription&amp;gt;&amp;gt; subscriptionsByEventType;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中键是消息类型的Class对象，值中的&lt;code&gt;org.greenrobot.eventbus.Subscription&lt;/code&gt;的对象中包含当前方法所在的对象，即订阅者，还包含订阅的方法。代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Subscription&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Object subscriber;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; SubscriberMethod subscriberMethod;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ... 其它代码省略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SubscriberMethod&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 订阅方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Method method;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 线程模型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; ThreadMode threadMode;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 消息类型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Class&amp;lt;?&amp;gt; eventType;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 优先级&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; priority;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// stick模式&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; sticky;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/** Used for efficient comparison */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String methodString;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...其它代码省略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;中间的解析缓存过程如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/07/eventbus_register_cache.png&quot; alt=&quot;解析缓存过程图&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;3-2-消息处理流程&quot;&gt;&lt;a href=&quot;#3-2-消息处理流程&quot; class=&quot;headerlink&quot; title=&quot;3.2 消息处理流程&quot;&gt;&lt;/a&gt;3.2 消息处理流程&lt;/h3&gt;&lt;p&gt;上面的缓存过程在这一步起作用了。&lt;/p&gt;
&lt;p&gt;1）暂存消息到消息队列&lt;/p&gt;
&lt;p&gt;当调用&lt;code&gt;EventBus#post&lt;/code&gt;消息时，先从当前线程中取到消息队列，然后将消息放入到消息队列中，再从消息队列中取消息进行处理。代码如下所示：&lt;/p&gt;
&lt;p&gt;org.greenrobot.eventbus.EventBus#post&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;post&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Object event)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 每个线程都有一个消息队列，避免同步，提高效率&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    PostingThreadState postingState = currentPostingThreadState.get();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    List&amp;lt;Object&amp;gt; eventQueue = postingState.eventQueue;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    eventQueue.add(event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!postingState.isPosting) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 参数准备&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        postingState.isMainThread = Looper.getMainLooper() == Looper.myLooper();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        postingState.isPosting = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (postingState.canceled) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; EventBusException(&lt;span class=&quot;string&quot;&gt;&quot;Internal error. Abort state was not reset&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (!eventQueue.isEmpty()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// 执行消息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                postSingleEvent(eventQueue.remove(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), postingState);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            postingState.isPosting = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            postingState.isMainThread = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2）找到消息类型对应方法&lt;/p&gt;
&lt;p&gt;这一步主要是从消息类型的HashMap缓存&lt;code&gt;subscriptionsByEventType&lt;/code&gt;中取出对应的方法集合。代码如下&lt;code&gt;postSingleEventForEventType&lt;/code&gt;方法所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;postSingleEvent&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Object event, PostingThreadState postingState)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; Error &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Class&amp;lt;?&amp;gt; eventClass = event.getClass();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; subscriptionFound = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// eventInheritance默认为true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (eventInheritance) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 查找所有event类型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        List&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt; eventTypes = lookupAllEventTypes(eventClass);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; countTypes = eventTypes.size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; h = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; h &amp;lt; countTypes; h++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Class&amp;lt;?&amp;gt; clazz = eventTypes.get(h);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// 遍历event的类型，针对每种类型都会处理&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ... 省略部分代码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;postSingleEventForEventType&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Object event, PostingThreadState postingState, Class&amp;lt;?&amp;gt; eventClass)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CopyOnWriteArrayList&amp;lt;Subscription&amp;gt; subscriptions;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        subscriptions = subscriptionsByEventType.get(eventClass);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (subscriptions != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !subscriptions.isEmpty()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (Subscription subscription : subscriptions) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            postingState.event = event;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            postingState.subscription = subscription;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; aborted = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                postToSubscription(subscription, event, postingState.isMainThread);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                aborted = postingState.canceled;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// ... 省略部分代码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// ...省略部分代码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在上面&lt;code&gt;postSingleEvent&lt;/code&gt;方法中使用一个&lt;code&gt;eventInheritance&lt;/code&gt;参数，这个参数默认为true，也就是说消息类型对应的父类都会被找出来。上一节的示例中，如果有订阅方法的参数是&lt;code&gt;Object&lt;/code&gt;，post消息是&lt;code&gt;String&lt;/code&gt;，这时候对应处理消息的方法参数是&lt;code&gt;Object&lt;/code&gt;的方法也会被执行；如果是false，则参数为&lt;code&gt;Object&lt;/code&gt;的方法不会执行，只有参数为&lt;code&gt;String&lt;/code&gt;的方法会执行。这个参数是在&lt;code&gt;EventBusBuilder&lt;/code&gt;中设置后，创建&lt;code&gt;EventBus&lt;/code&gt;对象时使用。&lt;/p&gt;
&lt;p&gt;3）执行对应方法&lt;/p&gt;
&lt;p&gt;&lt;code&gt;postToSubscription&lt;/code&gt;是将消息加入执行列表中还是直接执行，这个是根据线程模型来的，前面有说过。下面就不贴代码了。&lt;/p&gt;
&lt;h2 id=&quot;四、优化&quot;&gt;&lt;a href=&quot;#四、优化&quot; class=&quot;headerlink&quot; title=&quot;四、优化&quot;&gt;&lt;/a&gt;四、优化&lt;/h2&gt;&lt;p&gt;在最后将消息加入到消息队列中的时候，&lt;code&gt;EventBus&lt;/code&gt;在处理消息时，做了优化处理。&lt;/p&gt;
&lt;h3 id=&quot;4-1-主线程执行消息&quot;&gt;&lt;a href=&quot;#4-1-主线程执行消息&quot; class=&quot;headerlink&quot; title=&quot;4.1 主线程执行消息&quot;&gt;&lt;/a&gt;4.1 主线程执行消息&lt;/h3&gt;&lt;p&gt;当消息需要在UI线程中执行时，消息可能会被加入到消息队列中，也就是加入到&lt;code&gt;mainThreadPoster&lt;/code&gt;队列中。代码如下所示：&lt;/p&gt;
&lt;p&gt;org.greenrobot.eventbus.EventBus#postToSubscription&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;postToSubscription&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Subscription subscription, Object event, &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; isMainThread)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (subscription.subscriberMethod.threadMode) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MAIN:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isMainThread) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                invokeSubscriber(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                mainThreadPoster.enqueue(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 部分代码省略...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在主线程中执行消息代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HandlerPoster&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Handler&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PendingPostQueue queue;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; maxMillisInsideHandleMessage;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; EventBus eventBus;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; handlerActive;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    HandlerPoster(EventBus eventBus, Looper looper, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; maxMillisInsideHandleMessage) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;(looper);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.eventBus = eventBus;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 这个值是10，即10ms&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.maxMillisInsideHandleMessage = maxMillisInsideHandleMessage;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        queue = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; PendingPostQueue();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;enqueue&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Subscription subscription, Object event)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            queue.enqueue(pendingPost);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!handlerActive) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                handlerActive = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!sendMessage(obtainMessage())) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// 触发handleMessage方法被调用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; EventBusException(&lt;span class=&quot;string&quot;&gt;&quot;Could not send handler message&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;handleMessage&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Message msg)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; rescheduled = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; started = SystemClock.uptimeMillis();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                PendingPost pendingPost = queue.poll();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (pendingPost == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;comment&quot;&gt;// Check again, this time in synchronized&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        pendingPost = queue.poll();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (pendingPost == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            handlerActive = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                eventBus.invokeSubscriber(pendingPost);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; timeInMethod = SystemClock.uptimeMillis() - started;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (timeInMethod &amp;gt;= maxMillisInsideHandleMessage) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// 处理消息超过10ms&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!sendMessage(obtainMessage())) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; EventBusException(&lt;span class=&quot;string&quot;&gt;&quot;Could not send handler message&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    rescheduled = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// 结束循环&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            handlerActive = rescheduled;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里做了一个优化处理是当&lt;code&gt;EventBus&lt;/code&gt;UI线程中待执行的消息队列&lt;code&gt;queue&lt;/code&gt;中的消息执行耗时超过&lt;code&gt;maxMillisInsideHandleMessage&lt;/code&gt;，即10ms，就会停止执行&lt;code&gt;queue&lt;/code&gt;消息队列中的消息，不阻碍App中UI线程中的其他消息执行。等App中的UI线程中的消息执行完后，再执行到这里的&lt;code&gt;handleMessage&lt;/code&gt;方法。在&lt;code&gt;handleMessage&lt;/code&gt;方法中的&lt;code&gt;sendMessage(obtainMessage())&lt;/code&gt;操作就是这个意思。&lt;/p&gt;
&lt;h3 id=&quot;4-2-后台线程执行消息&quot;&gt;&lt;a href=&quot;#4-2-后台线程执行消息&quot; class=&quot;headerlink&quot; title=&quot;4.2 后台线程执行消息&quot;&gt;&lt;/a&gt;4.2 后台线程执行消息&lt;/h3&gt;&lt;p&gt;同样，&lt;code&gt;EventBus&lt;/code&gt;执行后台线程（非UI线程）中的消息队列中的消息时，也使用了优化。&lt;code&gt;org.greenrobot.eventbus.EventBus#backgroundPoster&lt;/code&gt;为后台线程的消息队列，&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BackgroundPoster&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Runnable&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PendingPostQueue queue;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; EventBus eventBus;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; executorRunning;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    BackgroundPoster(EventBus eventBus) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.eventBus = eventBus;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        queue = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; PendingPostQueue();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;enqueue&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Subscription subscription, Object event)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// 先加入到队列中&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            queue.enqueue(pendingPost);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!executorRunning) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                executorRunning = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// 最后会在线程池中的线程中执行run方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                eventBus.getExecutorService().execute(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// 如果消息队列中有消息，则立及返回，否则会等1秒钟，再从消息队列取消息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    PendingPost pendingPost = queue.poll(&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (pendingPost == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            &lt;span class=&quot;comment&quot;&gt;// Check again, this time in synchronized&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            pendingPost = queue.poll();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (pendingPost == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                executorRunning = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// 执行对应订阅的方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    eventBus.invokeSubscriber(pendingPost);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                Log.w(&lt;span class=&quot;string&quot;&gt;&quot;Event&quot;&lt;/span&gt;, Thread.currentThread().getName() + &lt;span class=&quot;string&quot;&gt;&quot; was interruppted&quot;&lt;/span&gt;, e);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            executorRunning = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;while循环中的&lt;code&gt;queue.poll&lt;/code&gt;方法如下所示：&lt;/p&gt;
&lt;p&gt;org.greenrobot.eventbus.PendingPostQueue&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; PendingPost &lt;span class=&quot;title&quot;&gt;poll&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    PendingPost pendingPost = head;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (head != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        head = head.next;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (head == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            tail = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; pendingPost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; PendingPost &lt;span class=&quot;title&quot;&gt;poll&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; maxMillisToWait)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; InterruptedException &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (head == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 线程等待&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        wait(maxMillisToWait);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 这里调用上面的poll方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; poll();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面这种做法避免了线程切换带来的开销。也就是说，如果两次&lt;code&gt;post&lt;/code&gt;消息间隔是在1秒内，则有可能这两次消息都是在同一个线程中执行，而不是两个线程。但不知道为什么这个值是1秒。&lt;/p&gt;
&lt;h2 id=&quot;五、问题&quot;&gt;&lt;a href=&quot;#五、问题&quot; class=&quot;headerlink&quot; title=&quot;五、问题&quot;&gt;&lt;/a&gt;五、问题&lt;/h2&gt;&lt;h3 id=&quot;5-1-订阅方法继承问题&quot;&gt;&lt;a href=&quot;#5-1-订阅方法继承问题&quot; class=&quot;headerlink&quot; title=&quot;5.1 订阅方法继承问题&quot;&gt;&lt;/a&gt;5.1 订阅方法继承问题&lt;/h3&gt;&lt;h5 id=&quot;5-1-1-新版本订阅方法的继承问题&quot;&gt;&lt;a href=&quot;#5-1-1-新版本订阅方法的继承问题&quot; class=&quot;headerlink&quot; title=&quot;5.1.1 新版本订阅方法的继承问题&quot;&gt;&lt;/a&gt;5.1.1 新版本订阅方法的继承问题&lt;/h5&gt;&lt;ul&gt;
&lt;li&gt;子类override的方法，&lt;code&gt;@subscribe&lt;/code&gt;注解不管是写在子类方法上还是基类的方法上，子类方法都会被执行。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;前提条件是订阅对象使用的是子类对象，因为是遵循java多态语法规则，子类override基类中的方法，所以调用的是子类中的方法。如果子类方法中调用了&lt;code&gt;super&lt;/code&gt;，则会调用基类方法。如果没有调用，则会完全override基类方法，基类方法不会执行。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;基类方法上使用&lt;code&gt;@subscribe&lt;/code&gt;注解后，子类override的方法则不需要注解标记，即使加了效果也是一样的。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&quot;5-1-2-旧版本的继承问题&quot;&gt;&lt;a href=&quot;#5-1-2-旧版本的继承问题&quot; class=&quot;headerlink&quot; title=&quot;5.1.2 旧版本的继承问题&quot;&gt;&lt;/a&gt;5.1.2 旧版本的继承问题&lt;/h5&gt;&lt;p&gt;旧版本解析订阅方法都是以&lt;code&gt;onEvent&lt;/code&gt;开头的，规则更简单一点，override方法完全按照java多态语法来。&lt;/p&gt;
&lt;h3 id=&quot;5-2-订阅方法重载问题&quot;&gt;&lt;a href=&quot;#5-2-订阅方法重载问题&quot; class=&quot;headerlink&quot; title=&quot;5.2 订阅方法重载问题&quot;&gt;&lt;/a&gt;5.2 订阅方法重载问题&lt;/h3&gt;&lt;p&gt;重载的方法如果也标记为订阅方法，消息类型都兼容，则都会执行。什么意思呢？就像前面的举例，如果post的是&lt;code&gt;String&lt;/code&gt;类型，重载的参数是&lt;code&gt;String&lt;/code&gt;和&lt;code&gt;Object&lt;/code&gt;类型，则&lt;code&gt;Object&lt;/code&gt;类型的方法也会执行。如果post的是&lt;code&gt;Object&lt;/code&gt;类型，那么&lt;code&gt;String&lt;/code&gt;参数的订阅方法不会被执行，&lt;code&gt;Object&lt;/code&gt;参数的订阅方法会被执行。&lt;/p&gt;
&lt;p&gt;为什么都订阅的重载方法都会执行呢？因为它们都订阅了啊，我是认真的。&lt;/p&gt;
&lt;h2 id=&quot;六、写在最后&quot;&gt;&lt;a href=&quot;#六、写在最后&quot; class=&quot;headerlink&quot; title=&quot;六、写在最后&quot;&gt;&lt;/a&gt;六、写在最后&lt;/h2&gt;&lt;p&gt;最后总结一下，用&lt;code&gt;EventBus&lt;/code&gt;要注意&lt;code&gt;register&lt;/code&gt;方法和&lt;code&gt;unregister&lt;/code&gt;方法配对使用，否则容易导致内存泄露。&lt;code&gt;EventBus&lt;/code&gt;要灵活使用，建议在项目某一解耦层使用，如果大面积使用会导致项目缺乏逻辑性，使用不当会导致代码臃肿，所以注意使用场景。&lt;/p&gt;
&lt;p&gt;（全文完）&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/2018/07/23/eventbus-implement-analysis-1.html&quot;&gt;EventBus实现分析（上）&lt;/a&gt;中介绍了&lt;code&gt;EventBus&lt;/code&gt;的&lt;code&gt;简单使用&lt;/code&gt;和&lt;code&gt;解决什么问题&lt;/code&gt;，这一节介绍EventBus的实现细节。&lt;/p&gt;
&lt;h2 id=&quot;三、实现细节&quot;&gt;&lt;a href=&quot;#三、实现细节&quot; class=&quot;headerlink&quot; title=&quot;三、实现细节&quot;&gt;&lt;/a&gt;三、实现细节&lt;/h2&gt;&lt;p&gt;前面在介绍EventBus的使用时，也顺带着讲了一些细节。下面先从两个流程开始，一个是注册流程，另一个是发送消息并且处理的流程。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="EventBus 分析" scheme="http://www.jacpy.com/tags/EventBus-%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>EventBus实现分析（上）</title>
    <link href="http://www.jacpy.com/2018/07/23/eventbus-implement-analysis-1.html"/>
    <id>http://www.jacpy.com/2018/07/23/eventbus-implement-analysis-1.html</id>
    <published>2018-07-23T04:59:17.000Z</published>
    <updated>2018-07-30T09:04:22.423Z</updated>
    
    <content type="html">&lt;p&gt;最近看了一下&lt;code&gt;EventBus&lt;/code&gt;实现的源码，分享一下自己的心得体会。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;EventBus&lt;/code&gt;这个库实现很简单，如官方所说一样，库体积很小。将组件之间的通信通过解耦的方式表现的淋漓尽致，废话不多说，&lt;code&gt;EventBus&lt;/code&gt;优点官网上列举了一堆，有兴趣的可以去看一下&lt;a href=&quot;http://greenrobot.org/eventbus/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://greenrobot.org/eventbus/&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;分享主要有以下几个方面：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;1）简单使用&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;简单的说明EventBus的使用&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;2）解决什么问题&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;比如解决了组件之间解耦问题，线程切换问题。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;3）实现细节&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;EventBus是怎样注册订阅者，怎样通过post将消息发送到订阅者。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;4）优化&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;EventBus中使用的一些细节优化，考虑很周全。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;5）问题&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;针对EventBus中使用的一些问题。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;中间可能会介绍新旧版本的区别，新旧版本指的是3.0及以后的版本和以前的版本。要注意的是新旧版本不仅是版本号的区别，包名也不一样。旧版本的包名是&lt;code&gt;de.greenrobot.even&lt;/code&gt;，新版本的包名是&lt;code&gt;org.greenrobot.eventbu&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&quot;一、简单使用&quot;&gt;&lt;a href=&quot;#一、简单使用&quot; class=&quot;headerlink&quot; title=&quot;一、简单使用&quot;&gt;&lt;/a&gt;一、简单使用&lt;/h2&gt;&lt;h3 id=&quot;1-1-新版本使用&quot;&gt;&lt;a href=&quot;#1-1-新版本使用&quot; class=&quot;headerlink&quot; title=&quot;1.1 新版本使用&quot;&gt;&lt;/a&gt;1.1 新版本使用&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;注册消息订阅者，代码如下所示：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;EbNewActivity&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BaseNewActivity&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(@Nullable Bundle savedInstanceState)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onCreate(savedInstanceState);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setContentView(R.layout.activity_eb_new);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 注册必须在Fragment初始化之前，因为订阅消息发送是在Fragment中&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        EventBus.getDefault().register(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        getSupportFragmentManager()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .beginTransaction()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .add(R.id.frame_content, EbNewFragment.newInstance())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .commit();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Subscribe&lt;/span&gt;(threadMode = ThreadMode.MAIN)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onEventBusMainEvent&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String msg)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Log.d(&lt;span class=&quot;string&quot;&gt;&quot;onEventBusMainEvent&quot;&lt;/span&gt;, Thread.currentThread().getName() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 默认是ThreadMode.POSTING，注意这里参数是Object，与其它不同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Subscribe&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onEventBusPostEvent&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Object msg)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Log.i(&lt;span class=&quot;string&quot;&gt;&quot;onEventBusPostEvent&quot;&lt;/span&gt;, Thread.currentThread().getName() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Subscribe&lt;/span&gt;(threadMode = ThreadMode.BACKGROUND)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onEventBusBackgroundEvent&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String msg)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Log.w(&lt;span class=&quot;string&quot;&gt;&quot;onEventBusBgEvent&quot;&lt;/span&gt;, Thread.currentThread().getName() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Subscribe&lt;/span&gt;(threadMode = ThreadMode.ASYNC)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onEventBusAsyncEvent&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String msg)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Log.e(&lt;span class=&quot;string&quot;&gt;&quot;onEventBusAsyncEvent&quot;&lt;/span&gt;, Thread.currentThread().getName() + &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt; + msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onDestroy&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onDestroy();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 注销，否则会导致Activity内存泄露&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        EventBus.getDefault().unregister(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;activity_eb_new.xml&lt;/code&gt;布局文件很简单，里面只有一个&lt;code&gt;LinearLayout&lt;/code&gt;，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;LinearLayout&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;xmlns:android&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;http://schemas.android.com/apk/res/android&quot;&lt;/span&gt; &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:layout_width&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;match_parent&quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:layout_height&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;match_parent&quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:orientation&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;vertical&quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;android:id&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;@+id/frame_content&quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;    /&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;@Subscribe&lt;/code&gt;注解除了指定&lt;code&gt;EventBus&lt;/code&gt;的线程模型，还可以指定订阅者的优先级以及是否为&lt;code&gt;sticky&lt;/code&gt;模式。&lt;/p&gt;
&lt;p&gt;优先级的意思是当&lt;code&gt;EventBus#post&lt;/code&gt;消息时，根据订阅的方法的优先级来执行相应的方法。优先级高的即&lt;code&gt;priority&lt;/code&gt;的值越大的，先收到订阅消息。在注册订阅者时，就会根据这个&lt;code&gt;priority&lt;/code&gt;的大小对顺序进行排序。代码如下所示：&lt;/p&gt;
&lt;p&gt;org.greenrobot.eventbus.EventBus#subscribe&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;subscribe&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Object subscriber, SubscriberMethod subscriberMethod)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Class&amp;lt;?&amp;gt; eventType = subscriberMethod.eventType;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Subscription newSubscription = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Subscription(subscriber, subscriberMethod);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CopyOnWriteArrayList&amp;lt;Subscription&amp;gt; subscriptions = subscriptionsByEventType.get(eventType);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (subscriptions == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        subscriptions = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; CopyOnWriteArrayList&amp;lt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        subscriptionsByEventType.put(eventType, subscriptions);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (subscriptions.contains(newSubscription)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; EventBusException(&lt;span class=&quot;string&quot;&gt;&quot;Subscriber &quot;&lt;/span&gt; + subscriber.getClass() + &lt;span class=&quot;string&quot;&gt;&quot; already registered to event &quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    + eventType);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; size = subscriptions.size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt;= size; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 根据优先级进行排序&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (i == size || subscriberMethod.priority &amp;gt; subscriptions.get(i).subscriberMethod.priority) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            subscriptions.add(i, newSubscription);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;stick&lt;/code&gt;模式是指当&lt;code&gt;EventBus#postSticky&lt;/code&gt;消息时，该消息会被缓存，当下次调用&lt;code&gt;EventBus#register&lt;/code&gt;注册订阅者后，会把相应接收消息的方法都执行一遍。&lt;/p&gt;
&lt;p&gt;可能描述太抽象，举个例子：一个项目组在一个房间封闭开发项目，其中测试人员和UI设计都不在。这个时候产品经理跑过来说，改个需求，这时候只有开发人员都知道。产品经理口头通知改需求就相当于&lt;code&gt;post&lt;/code&gt;，发送的消息只有已经注册过接收者接收。产品经理把要改的需求打印到一张纸上，然后粘在门上，并向房间里面的开发人员描述了修改的需求。测试人员和UI设计回来之后，发现粘在门上的需求变更通知，也都知道了。产品经理把修改的需求粘在门上并向室内开发人员描述修改的需求这个过程就相当于&lt;code&gt;postSticky&lt;/code&gt;，后面注册的接收者也会收到这个消息，先注册的就不用说了。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;postSticky&lt;/code&gt;可以用来做延迟接收消息。下面看下源码的实现：&lt;/p&gt;
&lt;p&gt;postSticky操作：&lt;/p&gt;
&lt;p&gt;1）缓存消息&lt;/p&gt;
&lt;p&gt;org.greenrobot.eventbus.EventBus#postSticky&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;postSticky&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Object event)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (stickyEvents) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 这里会缓存消息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        stickyEvents.put(event.getClass(), event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Should be posted after it is putted, in case the subscriber wants to remove immediately&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    post(event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2）接收消息&lt;/p&gt;
&lt;p&gt;org.greenrobot.eventbus.EventBus#register&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;register&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Object subscriber)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Class&amp;lt;?&amp;gt; subscriberClass = subscriber.getClass();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    List&amp;lt;SubscriberMethod&amp;gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (SubscriberMethod subscriberMethod : subscriberMethods) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// 这里处理订阅的方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            subscribe(subscriber, subscriberMethod);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;subscribe&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Object subscriber, SubscriberMethod subscriberMethod)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ... 中间代码省略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (subscriberMethod.sticky) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 重点看这里&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (eventInheritance) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Existing sticky events of all subclasses of eventType have to be considered.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Note: Iterating over all events may be inefficient with lots of sticky events,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// thus data structure should be changed to allow a more efficient lookup&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// (e.g. an additional map storing sub classes of super classes: Class -&amp;gt; List&amp;lt;Class&amp;gt;).&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Set&amp;lt;Map.Entry&amp;lt;Class&amp;lt;?&amp;gt;, Object&amp;gt;&amp;gt; entries = stickyEvents.entrySet();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;Class&amp;lt;?&amp;gt;, Object&amp;gt; entry : entries) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                Class&amp;lt;?&amp;gt; candidateEventType = entry.getKey();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (eventType.isAssignableFrom(candidateEventType)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    Object stickyEvent = entry.getValue();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// 执行消息会到这里&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Object stickyEvent = stickyEvents.get(eventType);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// 执行消息会到这里&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            checkPostStickyEventToSubscription(newSubscription, stickyEvent);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkPostStickyEventToSubscription&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Subscription newSubscription, Object stickyEvent)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (stickyEvent != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// If the subscriber is trying to abort the event, it will fail (event is not tracked in posting state)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// --&amp;gt; Strange corner case, which we don&#39;t take care of here.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 执行消息或者加入消息队列中&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        postToSubscription(newSubscription, stickyEvent, Looper.getMainLooper() == Looper.myLooper());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;postToSubscription&lt;/code&gt;方法中会根据线程模型来执行订阅的方法。也就是后注册进来的订阅者也会收到之前的&lt;code&gt;postStick&lt;/code&gt;消息。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;线程模型&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;EventBus&lt;/code&gt;的线程模型有四种，分别如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;enum&lt;/span&gt; ThreadMode &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    POSTING,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    MAIN,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    BACKGROUND,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ASYNC&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;POSTING&lt;/code&gt;表示在当前线程执行，也就是&lt;code&gt;post&lt;/code&gt;方法在哪个线程中执行，对应的接收消息的方法就在哪个线程执行；&lt;br&gt;&lt;code&gt;MAIN&lt;/code&gt;表示接收的消息在UI线程中执行；&lt;br&gt;&lt;code&gt;BACKGROUND&lt;/code&gt;表示接收的消息在非UI线程中执行，如果当前是在非UI线程中执行&lt;code&gt;post&lt;/code&gt;，则会在当前线程中执行接收消息的方法；如果是在UI线程中执行&lt;code&gt;post&lt;/code&gt;方法，则会在非UI线程中执行接收消息的方法。&lt;br&gt;&lt;code&gt;ASYNC&lt;/code&gt;表示在与执行&lt;code&gt;post&lt;/code&gt;线程不同的另外一个非UI线程中执行接收消息的方法。&lt;/p&gt;
&lt;p&gt;上面的解释可能不太好理解，上面的代码日志输出如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;onEventBusAsyncEvent: pool-1-thread-1,onAttach&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;onEventBusMainEvent: main,onAttach&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;onEventBusBgEvent: pool-1-thread-2,onAttach&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;onEventBusPostEvent: main,onAttach&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;对比下日志前面的线程名称就清楚了。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;发送消息&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;EbNewFragment&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Fragment&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; EbNewFragment &lt;span class=&quot;title&quot;&gt;newInstance&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        EbNewFragment fragment = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; EbNewFragment();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; fragment;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onAttach&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Context context)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onAttach(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 发送消息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        EventBus.getDefault().post(&lt;span class=&quot;string&quot;&gt;&quot;onAttach&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因为在&lt;code&gt;Activity&lt;/code&gt;中注册的方法接收的消息类型是&lt;code&gt;String&lt;/code&gt;和&lt;code&gt;Object&lt;/code&gt;（eventInheritance参数为true，第二篇会解释），所以这里&lt;code&gt;post(&amp;quot;onAttach&amp;quot;)&lt;/code&gt;后，那些方法都会收到消息。&lt;/p&gt;
&lt;h3 id=&quot;1-2-旧版本使用&quot;&gt;&lt;a href=&quot;#1-2-旧版本使用&quot; class=&quot;headerlink&quot; title=&quot;1.2 旧版本使用&quot;&gt;&lt;/a&gt;1.2 旧版本使用&lt;/h3&gt;&lt;p&gt;老版本接收消息的订阅方法都是以&lt;code&gt;onEvent&lt;/code&gt;开头，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;EbOldActivity&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Activity&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(@Nullable Bundle savedInstanceState)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onCreate(savedInstanceState);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setContentView(R.layout.activity_eb_old);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        EventBus.getDefault().register(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        getSupportFragmentManager()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .beginTransaction()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .add(R.id.frame_content, EbOldFragment.newInstance())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .commit();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onEvent&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String msg)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log(&lt;span class=&quot;string&quot;&gt;&quot;onEvent&quot;&lt;/span&gt;, msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onEventMainThread&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String msg)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log(&lt;span class=&quot;string&quot;&gt;&quot;onEventMainThread&quot;&lt;/span&gt;, msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onEventBackgroundThread&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String msg)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log(&lt;span class=&quot;string&quot;&gt;&quot;onEventBackgroundThread&quot;&lt;/span&gt;, msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onEventAsync&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String msg)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log(&lt;span class=&quot;string&quot;&gt;&quot;onEventAsync&quot;&lt;/span&gt;, msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onDestroy&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onDestroy();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        EventBus.getDefault().unregister(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;activity_eb_old.xml&lt;/code&gt;布局文件内容与上面的&lt;code&gt;activity_eb_new.xml&lt;/code&gt;布局文件类似。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;onEvent&lt;/code&gt;后缀表示线程对应的线程模型，对应关系看下面的源码就清楚了：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;de.greenrobot.event.SubscriberMethodFinder#findSubscriberMethods&lt;/code&gt;部分代码：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (methodName.startsWith(ON_EVENT_METHOD_NAME)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; modifiers = method.getModifiers();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((modifiers &amp;amp; Modifier.PUBLIC) != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; (modifiers &amp;amp; MODIFIERS_IGNORE) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Class&amp;lt;?&amp;gt;[] parameterTypes = method.getParameterTypes();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (parameterTypes.length == &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// ON_EVENT_METHOD_NAME为onEvent&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            String modifierString = methodName.substring(ON_EVENT_METHOD_NAME.length());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ThreadMode threadMode;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (modifierString.length() == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// onEvent方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                threadMode = ThreadMode.PostThread;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (modifierString.equals(&lt;span class=&quot;string&quot;&gt;&quot;MainThread&quot;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// onEventMainThread方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                threadMode = ThreadMode.MainThread;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (modifierString.equals(&lt;span class=&quot;string&quot;&gt;&quot;BackgroundThread&quot;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// onEventBackgroundThread方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                threadMode = ThreadMode.BackgroundThread;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (modifierString.equals(&lt;span class=&quot;string&quot;&gt;&quot;Async&quot;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// onEventAsync方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                threadMode = ThreadMode.Async;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (skipMethodVerificationForClasses.containsKey(clazz)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; EventBusException(&lt;span class=&quot;string&quot;&gt;&quot;Illegal onEvent method, check for typos: &quot;&lt;/span&gt; + method);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从上面源码中也可以看出来注册的订阅方法有一些要求：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;方法必须是public，不能是抽象和静态的；&lt;/li&gt;
&lt;li&gt;方法参数只能有一个。&lt;/li&gt;
&lt;li&gt;其它方法不能以&lt;code&gt;onEvent&lt;/code&gt;开头，或者必须通过&lt;code&gt;EventBusBuilder&lt;/code&gt;来创建&lt;code&gt;EventBus&lt;/code&gt;实例，并且调用&lt;code&gt;EventBusBuilder#skipMethodVerificationFor&lt;/code&gt;方法注册class，以忽略当前包含其它以&lt;code&gt;onEvent&lt;/code&gt;开头的方法。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;整个调用流程如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/07/eventbus_register_post.png&quot; alt=&quot;EventBus注册、发送消息流程&quot;&gt;&lt;/p&gt;
&lt;p&gt;OK，简单使用介绍完了，下面看看解决了什么问题。&lt;/p&gt;
&lt;h2 id=&quot;二、解决什么问题&quot;&gt;&lt;a href=&quot;#二、解决什么问题&quot; class=&quot;headerlink&quot; title=&quot;二、解决什么问题&quot;&gt;&lt;/a&gt;二、解决什么问题&lt;/h2&gt;&lt;p&gt;通过上面的使用，很明显知道&lt;code&gt;EventBus&lt;/code&gt;解决了什么问题。&lt;/p&gt;
&lt;h3 id=&quot;2-1-通信解耦&quot;&gt;&lt;a href=&quot;#2-1-通信解耦&quot; class=&quot;headerlink&quot; title=&quot;2.1 通信解耦&quot;&gt;&lt;/a&gt;2.1 通信解耦&lt;/h3&gt;&lt;p&gt;通过&lt;code&gt;EventBus.register&lt;/code&gt;来注册订阅者，通过注解反射的方式提取接收消息的方法，再通过&lt;code&gt;EventBus.post&lt;/code&gt;发送消息，从接收消息方法的缓存列表中找到对应消息接收者进行消息处理。这个时候也是通过反射调用方法。&lt;/p&gt;
&lt;p&gt;所以这里是通过反射的方式来做到解耦。&lt;/p&gt;
&lt;h3 id=&quot;2-2-线程切换&quot;&gt;&lt;a href=&quot;#2-2-线程切换&quot; class=&quot;headerlink&quot; title=&quot;2.2 线程切换&quot;&gt;&lt;/a&gt;2.2 线程切换&lt;/h3&gt;&lt;p&gt;线程模型在老版本上是通过后缀来区别，新版本是以注解的方式来指定的，这样为线程切换提供很大的便利。&lt;code&gt;EventBus&lt;/code&gt;自己提供了一个线程池来管理线程，&lt;code&gt;ASYNC&lt;/code&gt;和&lt;code&gt;BACKGROUND&lt;/code&gt;标记的方法都是在同一个线程池中的线程来执行的。&lt;/p&gt;
&lt;p&gt;另外就是&lt;code&gt;EventBus&lt;/code&gt;还提供了一个消息队列，发送的消息是先进消息队列还是立及执行，这个是根据线程模型来的。部分源码如下所示：&lt;/p&gt;
&lt;p&gt;org.greenrobot.eventbus.EventBus#postToSubscription&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;postToSubscription&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Subscription subscription, Object event, &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; isMainThread)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (subscription.subscriberMethod.threadMode) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; POSTING:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// 立及执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            invokeSubscriber(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; MAIN:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isMainThread) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// 立及执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                invokeSubscriber(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// UI线程的消息队列&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                mainThreadPoster.enqueue(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; BACKGROUND:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isMainThread) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// 后台线程的消息队列&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                backgroundPoster.enqueue(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// 立及执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                invokeSubscriber(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; ASYNC:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// 异步线程的消息队列&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            asyncPoster.enqueue(subscription, event);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;string&quot;&gt;&quot;Unknown thread mode: &quot;&lt;/span&gt; + subscription.subscriberMethod.threadMode);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;消息队列有三种，UI线程执行消息的消息队列、后台线程的消息队列、异步线程的消息队列。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;这部分写到这里，未完待续。&lt;/p&gt;
&lt;p&gt;第二篇看这里&lt;a href=&quot;/2018/07/26/eventbus-implement-analysis-2.html&quot;&gt;EventBus实现分析（下）&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;最近看了一下&lt;code&gt;EventBus&lt;/code&gt;实现的源码，分享一下自己的心得体会。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;EventBus&lt;/code&gt;这个库实现很简单，如官方所说一样，库体积很小。将组件之间的通信通过解耦的方式表现的淋漓尽致，废话不多说，&lt;code&gt;EventBus&lt;/code&gt;优点官网上列举了一堆，有兴趣的可以去看一下&lt;a href=&quot;http://greenrobot.org/eventbus/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://greenrobot.org/eventbus/&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;分享主要有以下几个方面：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="EventBus 分析" scheme="http://www.jacpy.com/tags/EventBus-%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>android 安全检测工具drozer环境搭建</title>
    <link href="http://www.jacpy.com/2018/07/05/android-security-check-tool-drozer.html"/>
    <id>http://www.jacpy.com/2018/07/05/android-security-check-tool-drozer.html</id>
    <published>2018-07-05T00:52:47.000Z</published>
    <updated>2018-07-06T05:16:03.708Z</updated>
    
    <content type="html">&lt;p&gt;最近在处理公司App的安全问题，跟第三方公司人员沟通，提到有使用&lt;code&gt;drozer&lt;/code&gt;工具检测。装了下这个工具，在这里记录一些坑。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;drozer&lt;/code&gt;是一个python编写的开源工具，在&lt;code&gt;github&lt;/code&gt;上面有源码，地址：&lt;a href=&quot;https://github.com/mwrlabs/drozer&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/mwrlabs/drozer&lt;/a&gt;。其功能很强大，可以检测App中的四大组件的导出情况、Intent拒绝服务、SQL注入风险以及可以自定义Module等。尤其是自定义Module功能，自己按格式编写一个Module功能，就可以获取终端设备及App的信息。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;drozer&lt;/code&gt;工具有两部分：一是PC端，另一部分是终端APK。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;环境搭建步骤有两种方式，一种是使用github上面的源码自己编译安装；另一种是官方提供了一些常用操作系统的安装包，可以直接安装。 下面以windows环境编译为例：&lt;/p&gt;
&lt;h2 id=&quot;一、源码编译安装&quot;&gt;&lt;a href=&quot;#一、源码编译安装&quot; class=&quot;headerlink&quot; title=&quot;一、源码编译安装&quot;&gt;&lt;/a&gt;一、源码编译安装&lt;/h2&gt;&lt;h3 id=&quot;1-1-编译环境搭建&quot;&gt;&lt;a href=&quot;#1-1-编译环境搭建&quot; class=&quot;headerlink&quot; title=&quot;1.1 编译环境搭建&quot;&gt;&lt;/a&gt;1.1 编译环境搭建&lt;/h3&gt;&lt;p&gt;编译前安装的环境与&lt;code&gt;github&lt;/code&gt;上README所说的环境要一致，一定要一致！！！&lt;/p&gt;
&lt;h4 id=&quot;1-1-1-jdk版本问题&quot;&gt;&lt;a href=&quot;#1-1-1-jdk版本问题&quot; class=&quot;headerlink&quot; title=&quot;1.1.1 jdk版本问题&quot;&gt;&lt;/a&gt;1.1.1 jdk版本问题&lt;/h4&gt;&lt;p&gt;如果JDK版本不一致，编译时会提示以下错误，导致编译APK失败。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;UNEXPECTED TOP-LEVEL EXCEPTION:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;com.android.dx.cf.iface.ParseException: bad class file magic (cafebabe) or version (0034.0000)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.DirectClassFile.parse0(DirectClassFile.java:472)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.DirectClassFile.parse(DirectClassFile.java:406)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.DirectClassFile.parseToInterfacesIfNecessary(DirectClassFile.java:388)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.DirectClassFile.getMagic(DirectClassFile.java:251)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processClass(Main.java:665)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processFileBytes(Main.java:634)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.access$600(Main.java:78)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main$1.processFileBytes(Main.java:572)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:170)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.process(ClassPathOpener.java:144)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processOne(Main.java:596)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processAllFiles(Main.java:498)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.runMonoDex(Main.java:264)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.run(Main.java:230)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.main(Main.java:199)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.Main.main(Main.java:103)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...while parsing ByteStreamReader.class&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;目前编译的版本是&lt;code&gt;2.4.3&lt;/code&gt;，github网站&lt;code&gt;README&lt;/code&gt;说明使用JDK版本为1.7。但官方网站上的说明文档还是老版本，使用的是JDK 1.6。所以这里要注意一下。&lt;/p&gt;
&lt;h4 id=&quot;1-1-2-安装pip&quot;&gt;&lt;a href=&quot;#1-1-2-安装pip&quot; class=&quot;headerlink&quot; title=&quot;1.1.2 安装pip&quot;&gt;&lt;/a&gt;1.1.2 安装pip&lt;/h4&gt;&lt;p&gt;pip是python库的管理工具，通过它可以很方便下载一些其他库，编译&lt;code&gt;drozer&lt;/code&gt;所需要的&lt;code&gt;Protobuf&lt;/code&gt;、&lt;code&gt;Pyopenssl&lt;/code&gt;、&lt;code&gt;Twisted&lt;/code&gt;等库都可以通过它来下载。&lt;/p&gt;
&lt;p&gt;下载地址是：&lt;a href=&quot;https://pypi.python.org/pypi/pip#downloads&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://pypi.python.org/pypi/pip#downloads&lt;/a&gt;，下载后解压，在命令行&lt;code&gt;cd&lt;/code&gt;到解压目录，然后执行&lt;code&gt;python setup.py install&lt;/code&gt;即可以安装&lt;code&gt;pip&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;安装成功后，将&lt;code&gt;C:\Python27\Scripts&lt;/code&gt;目录配置到系统的环境变量中。重新启动命令行， 执行&lt;code&gt;pip install protobuf&lt;/code&gt;命令就可以安装&lt;code&gt;protobuf&lt;/code&gt;库，其他库类似。&lt;/p&gt;
&lt;h3 id=&quot;1-2-安装工具&quot;&gt;&lt;a href=&quot;#1-2-安装工具&quot; class=&quot;headerlink&quot; title=&quot;1.2 安装工具&quot;&gt;&lt;/a&gt;1.2 安装工具&lt;/h3&gt;&lt;p&gt;上述过程编译成功后，会在&lt;code&gt;dist&lt;/code&gt;目录生成&lt;code&gt;msi&lt;/code&gt;文件。&lt;/p&gt;
&lt;h4 id=&quot;1-2-1-安装msi&quot;&gt;&lt;a href=&quot;#1-2-1-安装msi&quot; class=&quot;headerlink&quot; title=&quot;1.2.1 安装msi&quot;&gt;&lt;/a&gt;1.2.1 安装msi&lt;/h4&gt;&lt;p&gt;安装&lt;code&gt;msi&lt;/code&gt;文件下一步就可以，但下面这个页面不要选错，否则都不知道上哪儿找&lt;code&gt;drozer.bat&lt;/code&gt;文件。如果找到源码中的这个文件，在后面连接成功后，执行&lt;code&gt;list&lt;/code&gt;命令会显示空白，即没有命令工具可以使用。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/07/drozer_setup_path_select.png&quot; alt=&quot;安装选项&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;1-2-2-安装APK&quot;&gt;&lt;a href=&quot;#1-2-2-安装APK&quot; class=&quot;headerlink&quot; title=&quot;1.2.2 安装APK&quot;&gt;&lt;/a&gt;1.2.2 安装APK&lt;/h4&gt;&lt;p&gt;APK官方直接给出了下载地址：&lt;a href=&quot;https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk&lt;/a&gt;，下载下来后，直接使用&lt;code&gt;adb install drozer-agent-2.3.4.apk&lt;/code&gt;。这一步没什么好说的，只要将&lt;code&gt;adb&lt;/code&gt;命令配置到环境变量，就可以直接执行&lt;code&gt;adb&lt;/code&gt;命令。&lt;/p&gt;
&lt;h3 id=&quot;1-3-工具使用&quot;&gt;&lt;a href=&quot;#1-3-工具使用&quot; class=&quot;headerlink&quot; title=&quot;1.3 工具使用&quot;&gt;&lt;/a&gt;1.3 工具使用&lt;/h3&gt;&lt;h4 id=&quot;1-3-1-启动APK&quot;&gt;&lt;a href=&quot;#1-3-1-启动APK&quot; class=&quot;headerlink&quot; title=&quot;1.3.1 启动APK&quot;&gt;&lt;/a&gt;1.3.1 启动APK&lt;/h4&gt;&lt;p&gt;工具使用之前，要先启动在终端安装的App&lt;code&gt;drozer Agent&lt;/code&gt;，点击底部的&lt;code&gt;Embedded Server&lt;/code&gt;，进入到新页面后滑动顶部的控件，将其置为&lt;code&gt;Enabled&lt;/code&gt;状态。如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/07/drozer_app_enabled.png&quot; alt=&quot;Enabled状态&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;1-3-2-PC连接远程服务&quot;&gt;&lt;a href=&quot;#1-3-2-PC连接远程服务&quot; class=&quot;headerlink&quot; title=&quot;1.3.2 PC连接远程服务&quot;&gt;&lt;/a&gt;1.3.2 PC连接远程服务&lt;/h4&gt;&lt;p&gt;这一步按官方说明来：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;转发端口&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;adb forward tcp:31415 tcp:31415&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;连接应用&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果是模拟器，直接执行：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;drozer.bat console connect&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果是物理机，需要知道连接Wi-Fi的IP地址，启动命令的PC端网络要和物理机的网络在同一内网中。执行命令需要带上IP：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;drozer.bat console connect --server 192.168.0.10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我用物理机没有连接成功，用模拟就OK，所以如果网络环境复杂，建议使用模拟器。&lt;/p&gt;
&lt;p&gt;连接成功如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/07/drozer_console_connect.png&quot; alt=&quot;drozer连接成功&quot;&gt;&lt;/p&gt;
&lt;p&gt;执行&lt;code&gt;list&lt;/code&gt;命令显示的部分命令列表如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/07/drozer_console_list.png&quot; alt=&quot;drozer list&quot;&gt;&lt;/p&gt;
&lt;p&gt;如果&lt;code&gt;drozer.bat console connect&lt;/code&gt;执行失败，出现如下提示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Traceback (most recent call last):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File &amp;quot;bin/drozer&amp;quot;, line 30, in &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import(&amp;quot;drozer.cli.%s&amp;quot; % (sys.argv[1]))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ImportError: No module named drozer.cli.console&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;则是python找不到&lt;code&gt;drozer.cli.console&lt;/code&gt;库，在系统的环境变量中增加&lt;code&gt;PYTHONPATH&lt;/code&gt;变量，路径为上面安装&lt;code&gt;msi&lt;/code&gt;文件时指定的路径中的子目录&lt;code&gt;site-packages&lt;/code&gt;路径。如果环境变量中已经有这个变量，则增加一个路径，中间使用英文逗号分隔。如下所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/07/drozer_python_path.png&quot; alt=&quot;PYTHONPATH环境变量&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;1-3-3-执行命令&quot;&gt;&lt;a href=&quot;#1-3-3-执行命令&quot; class=&quot;headerlink&quot; title=&quot;1.3.3 执行命令&quot;&gt;&lt;/a&gt;1.3.3 执行命令&lt;/h4&gt;&lt;p&gt;命令执行可以参考&lt;a href=&quot;https://www.cnblogs.com/goodhacker/p/3906180.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;利用drozer进行Android渗透测试&lt;/a&gt;。&lt;/p&gt;
&lt;h2 id=&quot;二、可执行文件安装&quot;&gt;&lt;a href=&quot;#二、可执行文件安装&quot; class=&quot;headerlink&quot; title=&quot;二、可执行文件安装&quot;&gt;&lt;/a&gt;二、可执行文件安装&lt;/h2&gt;&lt;p&gt;如果不想自己编译，PC端可执行文件以及APK可以从这个官方地址&lt;a href=&quot;https://labs.mwrinfosecurity.com/tools/drozer&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://labs.mwrinfosecurity.com/tools/drozer&lt;/a&gt;下载。其他安装步骤和操作步骤与上面步骤一样，要注意一下编译生成的&lt;code&gt;msi&lt;/code&gt;文件的安装路径。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;最近在处理公司App的安全问题，跟第三方公司人员沟通，提到有使用&lt;code&gt;drozer&lt;/code&gt;工具检测。装了下这个工具，在这里记录一些坑。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;drozer&lt;/code&gt;是一个python编写的开源工具，在&lt;code&gt;github&lt;/code&gt;上面有源码，地址：&lt;a href=&quot;https://github.com/mwrlabs/drozer&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/mwrlabs/drozer&lt;/a&gt;。其功能很强大，可以检测App中的四大组件的导出情况、Intent拒绝服务、SQL注入风险以及可以自定义Module等。尤其是自定义Module功能，自己按格式编写一个Module功能，就可以获取终端设备及App的信息。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;drozer&lt;/code&gt;工具有两部分：一是PC端，另一部分是终端APK。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="android security" scheme="http://www.jacpy.com/tags/android-security/"/>
    
  </entry>
  
  <entry>
    <title>okhttp too many follow-up requests 21</title>
    <link href="http://www.jacpy.com/2018/05/18/okhttp-too-many-follow-up-requests-21.html"/>
    <id>http://www.jacpy.com/2018/05/18/okhttp-too-many-follow-up-requests-21.html</id>
    <published>2018-05-18T05:12:17.000Z</published>
    <updated>2018-05-19T00:38:08.601Z</updated>
    
    <content type="html">&lt;p&gt;博客好长时间没有更新了，因为年底和年初，你懂的，希望以后进入轨。&lt;/p&gt;
&lt;p&gt;前几天在开发过程中遇到这样一个HTTP请求错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;okhttp too many follow-up requests: 21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看到&lt;code&gt;okhttp&lt;/code&gt;反应过来是底层请求出现问题了，以前从来没有遇到过，很好奇。在github上面&lt;a href=&quot;https://github.com/square/okhttp&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;okhttp&lt;/a&gt;库搜索了一下上面的关键字，找到下面的代码：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/05/okhttp_too_many_follow_up_requests.png&quot; alt=&quot;too many follow-up requests exception&quot;&gt;&lt;/p&gt;
&lt;p&gt;其中&lt;code&gt;MAX_FOLLOW_UPS&lt;/code&gt;常量的值为&lt;code&gt;20&lt;/code&gt;，代码如下所示，并且还有注释说明：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * How many redirects and auth challenges should we attempt? Chrome follows 21 redirects; Firefox,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * curl, and wget follow 20; Safari follows 16; and HTTP/1.0 recommends 5.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;private static final int MAX_FOLLOW_UPS = 20;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面描述各种浏览器重定向次数说明，&lt;code&gt;okhttp&lt;/code&gt;里面使用的是最多允许20次。&lt;/p&gt;
&lt;p&gt;google上搜索发现有人说是&lt;code&gt;okhttp&lt;/code&gt;的bug，低版本会出现这个bug，高版本已经修复，一看自己的版本，已经是最新版本。&lt;/p&gt;
&lt;p&gt;用&lt;code&gt;Fiddler&lt;/code&gt;抓了下包，看到如下请求：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/05/http_dead_recycle.png&quot; alt=&quot;循环302请求&quot;&gt;&lt;/p&gt;
&lt;p&gt;一直302跳转，每三个一循环，也就是说客户端&lt;code&gt;okhttp&lt;/code&gt;请求302跳转超过20次就抛出异常，如果不是&lt;code&gt;okhttp&lt;/code&gt;异常处理，估计是死循环了。&lt;/p&gt;
&lt;p&gt;问服务器端开发，说要先调用一次授权接口，最近才加的功能。&lt;/p&gt;
&lt;p&gt;话说出现这种问题不是服务器端逻辑有问题？一直允许这个死循环的302跳转？如果把okhttp的源码修改一下，无限循环下去，不会造成安全性问题？跟服务器端沟通，无果。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;博客好长时间没有更新了，因为年底和年初，你懂的，希望以后进入轨。&lt;/p&gt;
&lt;p&gt;前几天在开发过程中遇到这样一个HTTP请求错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;okhttp too many follow-up requests: 21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看到&lt;code&gt;okhttp&lt;/code&gt;反应过来是底层请求出现问题了，以前从来没有遇到过，很好奇。在github上面&lt;a href=&quot;https://github.com/square/okhttp&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;okhttp&lt;/a&gt;库搜索了一下上面的关键字，找到下面的代码：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="okhttp" scheme="http://www.jacpy.com/tags/okhttp/"/>
    
  </entry>
  
  <entry>
    <title>android使用相机扫描出现内存溢出解决过程</title>
    <link href="http://www.jacpy.com/2018/02/28/android-camera-out-of-memory-solution.html"/>
    <id>http://www.jacpy.com/2018/02/28/android-camera-out-of-memory-solution.html</id>
    <published>2018-02-28T00:39:15.000Z</published>
    <updated>2018-05-18T09:55:13.824Z</updated>
    
    <content type="html">&lt;p&gt;博客好长时间没有更新了，由于前段时间疯狂赶项目，有些问题没有来得及时整理，后面慢慢总结一下。&lt;/p&gt;
&lt;p&gt;前段时间在优化相机扫描二维码时，遇到了一个内存溢出问题，内存被用完了，日志中出现&lt;code&gt;E/dalvikvm-heap: Out of memory on a 2366828-byte allocation&lt;/code&gt;错误提示，App也没有崩溃，只是相机不再输出拍摄到的内容。使用&lt;code&gt;Zxing&lt;/code&gt;做过二维码扫描的同学都知道，被扫描到的内容会不停的被处理，并识别出二维码内容，如果有。而此时内存被用完了的现象是：相应的回调处理识别二维码内容的方法没有被调用。于是展开了排查。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;首先打开了ADM（Android Device Monitor），如果是AS 3.0以下，可以直接打开&lt;code&gt;Android Monitor&lt;/code&gt;，点击&lt;code&gt;Dump Java Heap&lt;/code&gt;按钮保存即可。然后启动App，选中当前App的进程，点击上面工具栏中的&lt;code&gt;Update Heap&lt;/code&gt;按钮，在右侧的&lt;code&gt;Heap&lt;/code&gt;Tab页中就可以看到当前App的内存使用情况。如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/02/memory_analysis_1.png&quot; alt=&quot;App内存分析&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Update Heap&lt;/code&gt;按钮即为上图中标记为&lt;code&gt;1&lt;/code&gt;的位置。&lt;/p&gt;
&lt;p&gt;从上图中可以看出，&lt;code&gt;byte[]&lt;/code&gt;对象占用内存较多，而内存一直增长的时候也就是这里的内存在增长。如图中标记为3的位置。&lt;code&gt;byte[]&lt;/code&gt;对象一般是Bitmap对象，这个要看内存中的&lt;code&gt;Depth&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;当App被限制的内存快要被使用完时（一般手机都会对单个App的内存使用限制，当App内无法再分配足够内存时，就会出现OOM），如图中标记为2的位置，点击右边的&lt;code&gt;Dump HPROF file&lt;/code&gt;按钮，即可将内存信息保存为&lt;code&gt;hprof&lt;/code&gt;文件。&lt;/p&gt;
&lt;p&gt;再在&lt;code&gt;Android Studio&lt;/code&gt;中Open保存的hprof文件，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2018/02/memory_analysis_2.png&quot; alt=&quot;App内存使用情况&quot;&gt;&lt;/p&gt;
&lt;p&gt;在左侧点击&lt;code&gt;byte[]&lt;/code&gt;行，可以在右侧看到对应的内存中的对象，发现&lt;code&gt;byte[1382400]&lt;/code&gt;对象比较多，每个占用内存空间1M多。看到这个对象就反应过来了，扫描处理的对象是一个byte数组，而且长度是1382400。于是想到是不是JNI中内存没有释放。&lt;/p&gt;
&lt;p&gt;到C++代码中排查了一下，byte数组从java层传到C++层时，使用&lt;code&gt;GetByteArrayElements&lt;/code&gt;获取操作的数组后，并没有调用&lt;code&gt;ReleaseByteArrayElements&lt;/code&gt;释放。修改代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JNIEXPORT jbyteArray JNICALL Java_zxing_utils_ImageUtils_demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(JNIEnv *env, jclass jcls, jbyteArray jba, jint jlength) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   jbyte* raw = env-&amp;gt;GetByteArrayElements(jba, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 操作raw代码省略...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 增加释放内存代码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   env-&amp;gt;ReleaseByteArrayElements(jba, raw, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再编译运行，没有出现OOM了，问题解决。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;博客好长时间没有更新了，由于前段时间疯狂赶项目，有些问题没有来得及时整理，后面慢慢总结一下。&lt;/p&gt;
&lt;p&gt;前段时间在优化相机扫描二维码时，遇到了一个内存溢出问题，内存被用完了，日志中出现&lt;code&gt;E/dalvikvm-heap: Out of memory on a 2366828-byte allocation&lt;/code&gt;错误提示，App也没有崩溃，只是相机不再输出拍摄到的内容。使用&lt;code&gt;Zxing&lt;/code&gt;做过二维码扫描的同学都知道，被扫描到的内容会不停的被处理，并识别出二维码内容，如果有。而此时内存被用完了的现象是：相应的回调处理识别二维码内容的方法没有被调用。于是展开了排查。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="Out Of Memory" scheme="http://www.jacpy.com/tags/Out-Of-Memory/"/>
    
  </entry>
  
  <entry>
    <title>boost编译和CLion配置</title>
    <link href="http://www.jacpy.com/2017/11/11/boost-compile-and-clion-config.html"/>
    <id>http://www.jacpy.com/2017/11/11/boost-compile-and-clion-config.html</id>
    <published>2017-11-11T14:54:44.000Z</published>
    <updated>2017-11-21T05:26:05.738Z</updated>
    
    <content type="html">&lt;p&gt;前几天编译&lt;code&gt;boost&lt;/code&gt;库&lt;code&gt;1.65.1&lt;/code&gt;版本，遇到一些问题，主要是与环境和版本有关系，如果不知道这些细节，很难找出问题。这里记录一下。&lt;/p&gt;
&lt;h2 id=&quot;一、boost库编译&quot;&gt;&lt;a href=&quot;#一、boost库编译&quot; class=&quot;headerlink&quot; title=&quot;一、boost库编译&quot;&gt;&lt;/a&gt;一、boost库编译&lt;/h2&gt;&lt;p&gt;在windows下编译&lt;code&gt;boost&lt;/code&gt;库可以参照这里：&lt;a href=&quot;https://gist.github.com/sim642/29caef3cc8afaa273ce6&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://gist.github.com/sim642/29caef3cc8afaa273ce6&lt;/a&gt; ，整个过程配置都可以按照上面来，但是要注意下最新版本的&lt;code&gt;MinGW&lt;/code&gt;，同时还要注意是64位的还是32位的。&lt;/p&gt;
&lt;p&gt;因使用的&lt;code&gt;boost&lt;/code&gt;版本是目前最新版本的，所以要求内置&lt;code&gt;gcc&lt;/code&gt;编译器的&lt;code&gt;MinGW&lt;/code&gt;也要是最新版本的，否则在执行&lt;code&gt;b2&lt;/code&gt;命令设置&lt;code&gt;toolset=gcc&lt;/code&gt;时，会提示找不到&lt;code&gt;gcc&lt;/code&gt;。另外还要注意系统是32位还是64位，对应的gcc也要相同的版本。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;如果中间编译遇到如下问题：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;For MinGW make to work correctly sh.exe must NOT be in your path.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;解决办法是，先保证&lt;code&gt;MinGW&lt;/code&gt;的环境变量配置正确，然后关闭命令行，重新执行编译命令。如果还提示这个错误，找到环境变量中&lt;code&gt;Git&lt;/code&gt;的bin目录，把这个环境配置删除。原因是&lt;code&gt;Git&lt;/code&gt;配置的环境变量中的&lt;code&gt;sh.exe&lt;/code&gt;与&lt;code&gt;MinGW&lt;/code&gt;中的&lt;code&gt;sh.exe&lt;/code&gt;冲突，去掉&lt;code&gt;Git&lt;/code&gt;的即可。&lt;/p&gt;
&lt;h2 id=&quot;二、CLion配置&quot;&gt;&lt;a href=&quot;#二、CLion配置&quot; class=&quot;headerlink&quot; title=&quot;二、CLion配置&quot;&gt;&lt;/a&gt;二、CLion配置&lt;/h2&gt;&lt;p&gt;因为&lt;code&gt;CLion&lt;/code&gt;使用的是&lt;code&gt;CMake&lt;/code&gt;编译，所以需要配置&lt;code&gt;CMakeList.txt&lt;/code&gt;文件。使用目前最新版本&lt;code&gt;2017.2&lt;/code&gt;版本时，默认使用的&lt;code&gt;CMake&lt;/code&gt;版本是&lt;code&gt;3.8&lt;/code&gt;，而&lt;code&gt;CMake&lt;/code&gt;的官方网站上最新的版本已经是&lt;code&gt;3.10&lt;/code&gt;了。这段文字一直在强调一个–&lt;code&gt;版本&lt;/code&gt;，所以这里的版本很重要，原因是如果配置都OK，会提示下面的错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Imported targets not available for Boost version&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个时候就要考虑换&lt;code&gt;CMake&lt;/code&gt;版本了，下面是在&lt;code&gt;stackoverflow&lt;/code&gt;上面找到的&lt;code&gt;boost&lt;/code&gt;库与&lt;code&gt;CMake&lt;/code&gt;版本的对应关系：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Boost 1.63 requires CMake 3.7 or newer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Boost 1.64 requires CMake 3.8 or newer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Boost 1.65 and 1.65.1 require CMake 3.9.3 or newer&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;参见这里：&lt;a href=&quot;https://stackoverflow.com/questions/42123509/cmake-finds-boost-but-the-imported-targets-not-available-for-boost-version&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://stackoverflow.com/questions/42123509/cmake-finds-boost-but-the-imported-targets-not-available-for-boost-version&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;所以需要修改&lt;code&gt;CLion&lt;/code&gt;的默认&lt;code&gt;CMake&lt;/code&gt;的版本，从&lt;code&gt;CMake&lt;/code&gt;的官网上下载最新的&lt;code&gt;CMake&lt;/code&gt;，然后安装，然后在设置的&lt;code&gt;Build, Excutation, Deployment&lt;/code&gt;中的第一个&lt;code&gt;ToolChains&lt;/code&gt;中设置&lt;code&gt;CMake&lt;/code&gt;的版本。但是，但是使用&lt;code&gt;CMake executable&lt;/code&gt;的&lt;code&gt;Custom&lt;/code&gt;选择最新版本的&lt;code&gt;CMake&lt;/code&gt;路径无效。下面的&lt;code&gt;CMake&lt;/code&gt;不提示版本，显示无效。目测是&lt;code&gt;CLion&lt;/code&gt;的bug，解决办法是找到&lt;code&gt;CLion&lt;/code&gt;的安装目录，然后将&lt;code&gt;cmake&lt;/code&gt;目录下面的内容复制一份备份，然后把最新&lt;code&gt;CMake&lt;/code&gt;安装目录下面的对应内容替换&lt;code&gt;CLion&lt;/code&gt;安装目录下面的&lt;code&gt;cmake&lt;/code&gt;里面的内容。然后再切回&lt;code&gt;Bundled Cmake&lt;/code&gt;就可以使用最新版本了。&lt;/p&gt;
&lt;p&gt;下面附一份&lt;code&gt;CMakeList.txt&lt;/code&gt;的配置：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cmake_minimum_required(VERSION 3.9)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;project(cppDemo)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set(CMAKE_CXX_FLAGS &amp;quot;$&amp;#123;CMAKE_CXX_FLAGS&amp;#125; -std=c++14 -static-libgcc -static-libstdc++&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set(SOURCE_FILES main.cpp digital_converter.h digital_converter.cpp)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;add_executable(cppDemo $&amp;#123;SOURCE_FILES&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;if (WIN32)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set(BOOST_ROOT &amp;quot;D:/programs/boost_1_65_1/boost&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set(Boost_INCLUDE_DIR, $&amp;#123;BOOST_ROOT&amp;#125;/include/boost-1_65_1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set(BOOST_LIBRARYDIR $&amp;#123;BOOST_ROOT&amp;#125;/lib)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set(Boost_USE_STATIC_LIBS ON)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set(Boost_MULTITHREADED ON)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set(Boost_USE_STATIC_RUNTIME OFF)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set(Boost_VERSION 106501)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set(Boost_COMPILER &amp;quot;-mgw72&amp;quot;) # 注意这里是编译后的boost库中包含的字符串，72是MinGW的版本号，根据自己的版本修改，看下自己编译出来的库的名称就知道了&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    MESSAGE(STATUS &amp;quot;boost root dir: &amp;quot; : $&amp;#123;BOOST_LIBRARYDIR&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    find_package(Boost 1.65.1 REQUIRED COMPONENTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            filesystem) # 注意windows下面编译出来的boost库名称中间都有-mgw72，所以需要在前面指定，不然这里提示找不到filesystem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    add_definitions($&amp;#123;Boost_LIB_DIAGNOSTIC_DEFINITIONS&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    include_directories($&amp;#123;Boost_INCLUDE_DIR&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    target_link_libraries(cppDemo $&amp;#123;Boost_LIBRARIES&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;endif (WIN32)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看来C++使用&lt;code&gt;CLion&lt;/code&gt;工具的人比较少，估计都是在windows下面用&lt;code&gt;VC&lt;/code&gt;了。但感觉&lt;code&gt;VS&lt;/code&gt;太大了，不想装，所以选择&lt;code&gt;CLion&lt;/code&gt;。用这些小众的工具，遇到问题都不好查资料，需要自己一点点的摸索，以后还不知道会遇到什么问题。&lt;/p&gt;
&lt;p&gt;以上。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天编译&lt;code&gt;boost&lt;/code&gt;库&lt;code&gt;1.65.1&lt;/code&gt;版本，遇到一些问题，主要是与环境和版本有关系，如果不知道这些细节，很难找出问题。这里记录一下。&lt;/p&gt;
&lt;h2 id=&quot;一、boost库编译&quot;&gt;&lt;a href=&quot;#一、boost库编译&quot; class=&quot;headerlink&quot; title=&quot;一、boost库编译&quot;&gt;&lt;/a&gt;一、boost库编译&lt;/h2&gt;&lt;p&gt;在windows下编译&lt;code&gt;boost&lt;/code&gt;库可以参照这里：&lt;a href=&quot;https://gist.github.com/sim642/29caef3cc8afaa273ce6&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://gist.github.com/sim642/29caef3cc8afaa273ce6&lt;/a&gt; ，整个过程配置都可以按照上面来，但是要注意下最新版本的&lt;code&gt;MinGW&lt;/code&gt;，同时还要注意是64位的还是32位的。&lt;/p&gt;
&lt;p&gt;因使用的&lt;code&gt;boost&lt;/code&gt;版本是目前最新版本的，所以要求内置&lt;code&gt;gcc&lt;/code&gt;编译器的&lt;code&gt;MinGW&lt;/code&gt;也要是最新版本的，否则在执行&lt;code&gt;b2&lt;/code&gt;命令设置&lt;code&gt;toolset=gcc&lt;/code&gt;时，会提示找不到&lt;code&gt;gcc&lt;/code&gt;。另外还要注意系统是32位还是64位，对应的gcc也要相同的版本。&lt;/p&gt;
    
    </summary>
    
      <category term="Cpp" scheme="http://www.jacpy.com/categories/Cpp/"/>
    
    
      <category term="boost clion" scheme="http://www.jacpy.com/tags/boost-clion/"/>
    
  </entry>
  
  <entry>
    <title>android InvocationTargetException异常浅析</title>
    <link href="http://www.jacpy.com/2017/10/27/android-InvocationTargetException-real.html"/>
    <id>http://www.jacpy.com/2017/10/27/android-InvocationTargetException-real.html</id>
    <published>2017-10-27T15:01:11.000Z</published>
    <updated>2017-10-27T15:52:10.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天处理一个很奇葩的问题，解决过程可谓一波三折啊，处理起来却很有意思，这里记录一下。&lt;/p&gt;
&lt;p&gt;事情的起因是同事写了一个在android系统调用系统相机的拍照的功能，将路径通过Intent传过去，照片拍好后保存到路径，通过路径取这张照片。&lt;/p&gt;
&lt;p&gt;突然有一天点这拍照功能无效了，直接crash。一看异常日志，发现抛出的是&lt;code&gt;ActivityNotFoundException&lt;/code&gt;。第一反应是以为是Activity没有注册或者打包出现问题了，于是把Apk反编译，在AndroidManifest.xml中检查了下注册，在dex文件中也找了下相关的类，结果发现都没有问题。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;再细看日志，发现和项目中的插件框有关，报错是跟插件框架中的一个启动Activity的方法有关。因为Hook了系统的&lt;code&gt;Instrumention&lt;/code&gt;，所以执行启动Activity时，是由框架中这个Hook来接管Activity的启动。于是找到源码，看了下代码实现，部分代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Method method = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Class&amp;lt;Instrumentation&amp;gt; cl = (Class&amp;lt;Instrumentation&amp;gt;) &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.getClass()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .getClassLoader().loadClass(&lt;span class=&quot;string&quot;&gt;&quot;android.app.Instrumentation&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  method = cl.getDeclaredMethod(&lt;span class=&quot;string&quot;&gt;&quot;execStartActivity&quot;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Class[] &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Context.class, IBinder.class, IBinder.class, Activity.class,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Intent.class, Integer.TYPE, android.os.Bundle.class &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  method.setAccessible(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ActivityResult r = (ActivityResult) method.invoke(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      originalInstrumentation, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Object[] &amp;#123; who, contextThread, token,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          target, intent, requestCode, aBundle &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; r;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (NoSuchMethodException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (ClassNotFoundException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IllegalArgumentException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IllegalAccessException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (InvocationTargetException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ActivityNotFoundException();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (Exception e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;异常是由&lt;code&gt;throw new ActivityNotFoundException();&lt;/code&gt;这行代码抛出来的，抛出的原因是执行&lt;code&gt;method.invoke()&lt;/code&gt;方法失败了。抱着怀疑的态度验证了下，在抛出异常之前加了LOG输出，果然有LOG输出，确认是这里出现了问题。没有弄明白写这个框架的人为什么要使用这样的障眼法不让&lt;code&gt;InvocationTargetException&lt;/code&gt;的异常信息直接输出，而是抛出一个&lt;code&gt;ActivityNotFoundException&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;最后网上查了下这个异常类，发现这个异常类是一个包装的异常类，通过查看其源码也可以看得到，其内部有一个真实的异常。这也不难理解，因为执行反射的方法，可能会抛出各种异常。按照异常尽可能具体的原则，不能直接抛出一个Exception了事，所以就有了这个包装一个异常的&lt;code&gt;InvocationTargetException&lt;/code&gt;类。要输出这个真实的异常，可以直接调用该类的&lt;code&gt;getTargetException().printStackTrace();&lt;/code&gt;即可输出真实的异常信息。&lt;/p&gt;
&lt;p&gt;输出的异常信息如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;android.os.FileUriExposedException: file:///sdcard/tmp exposed beyond app through ClipData.Item.getUri()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.os.StrictMode.onFileUriExposed(StrictMode.java:1799)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.net.Uri.checkFileUriExposed(Uri.java:2346)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.content.ClipData.prepareToLeaveProcess(ClipData.java:845)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.content.Intent.prepareToLeaveProcess(Intent.java:8957)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.content.Intent.prepareToLeaveProcess(Intent.java:8942)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.app.Instrumentation.execStartActivity(Instrumentation.java:1519)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at java.lang.reflect.Method.invoke(Native Method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.view.View.performClick(View.java:5639)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.view.View$PerformClick.run(View.java:22446)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.os.Handler.handleCallback(Handler.java:754)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.os.Looper.loop(Looper.java:160)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.app.ActivityThread.main(ActivityThread.java:6252)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at java.lang.reflect.Method.invoke(Native Method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:895)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:785)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; java.lang.reflect.InvocationTargetException&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at java.lang.reflect.Method.invoke(Native Method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.view.View.performClick(View.java:5639)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.view.View$PerformClick.run(View.java:22446)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.os.Handler.handleCallback(Handler.java:754)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.os.Handler.dispatchMessage(Handler.java:95)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.os.Looper.loop(Looper.java:160)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.app.ActivityThread.main(ActivityThread.java:6252)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at java.lang.reflect.Method.invoke(Native Method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:895)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:785)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Caused by: android.os.FileUriExposedException: file:///sdcard/tmp exposed beyond app through ClipData.Item.getUri()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.os.StrictMode.onFileUriExposed(StrictMode.java:1799)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.net.Uri.checkFileUriExposed(Uri.java:2346)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.content.ClipData.prepareToLeaveProcess(ClipData.java:845)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.content.Intent.prepareToLeaveProcess(Intent.java:8957)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.content.Intent.prepareToLeaveProcess(Intent.java:8942)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     at android.app.Instrumentation.execStartActivity(Instrumentation.java:1519)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ... 20 more&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;FileUriExposedException&lt;/code&gt;这个异常还是头一次遇到，于是又查了下，在&lt;code&gt;stackoverflow&lt;/code&gt;上看到别个的回答：&lt;a href=&quot;https://stackoverflow.com/questions/38200282/android-os-fileuriexposedexception-file-storage-emulated-0-test-txt-exposed。&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://stackoverflow.com/questions/38200282/android-os-fileuriexposedexception-file-storage-emulated-0-test-txt-exposed。&lt;/a&gt;&lt;br&gt;遇到这个问题的人还真不少，出现这样的问题是由于android 7.0的系统机制问题，为了安全起见，一个&lt;code&gt;App&lt;/code&gt;要访问另外一个&lt;code&gt;App&lt;/code&gt;的外部存储目录，需要被访问的&lt;code&gt;App&lt;/code&gt;来授权读写权限，所以需要进行版本适配。&lt;/p&gt;
&lt;p&gt;在定位问题的时候中间发生一个插曲，写拍照功能的同事用他写的库在demo里面了跑了一下，发现正常，没有任何异常出现。而在项目的App中却出现了问题，所以就说不是他的问题，怀疑是插件框架的问题。因为是我接手了插件框架，所以就开始排查这个问题。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;stackoverflow&lt;/code&gt;上面有人回答也说了，如果把编译的&lt;code&gt;targetVersion&lt;/code&gt;改成24或以上，遇到这种场景就会报错，也给了解决方法，官方的说明和解决方案参照这里：&lt;a href=&quot;https://developer.android.google.cn/reference/android/support/v4/content/FileProvider.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://developer.android.google.cn/reference/android/support/v4/content/FileProvider.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;找到原因后，叫写这个拍照功能的同事把&lt;code&gt;targetVersion&lt;/code&gt;修改一下，果然，demo中问题就出现了。&lt;/p&gt;
&lt;p&gt;中间还发生一个插曲，传的路径是使用&lt;code&gt;Uri&lt;/code&gt;传过去的，如果使用&lt;code&gt;Uri.parse(String)&lt;/code&gt;这个方法将路径字符串直接传过去就不会报错；如果使用&lt;code&gt;Uri.parseFile(File)&lt;/code&gt;就会出现crash，android 7.0系统的安全机制是识别&lt;code&gt;file://&lt;/code&gt;这样的schema，而对普通的路径直接放行。检查的系统源码如下所示：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;android.net.Uri.java&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; * If this is a &amp;#123;&lt;span class=&quot;doctag&quot;&gt;@code&lt;/span&gt; file://&amp;#125; Uri, it will be reported to&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; * &amp;#123;&lt;span class=&quot;doctag&quot;&gt;@link&lt;/span&gt; StrictMode&amp;#125;.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; *&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@hide&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkFileUriExposed&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String location)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;string&quot;&gt;&quot;file&quot;&lt;/span&gt;.equals(getScheme()) &amp;amp;&amp;amp; !getPath().startsWith(&lt;span class=&quot;string&quot;&gt;&quot;/system/&quot;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        StrictMode.onFileUriExposed(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;, location);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天处理一个很奇葩的问题，解决过程可谓一波三折啊，处理起来却很有意思，这里记录一下。&lt;/p&gt;
&lt;p&gt;事情的起因是同事写了一个在android系统调用系统相机的拍照的功能，将路径通过Intent传过去，照片拍好后保存到路径，通过路径取这张照片。&lt;/p&gt;
&lt;p&gt;突然有一天点这拍照功能无效了，直接crash。一看异常日志，发现抛出的是&lt;code&gt;ActivityNotFoundException&lt;/code&gt;。第一反应是以为是Activity没有注册或者打包出现问题了，于是把Apk反编译，在AndroidManifest.xml中检查了下注册，在dex文件中也找了下相关的类，结果发现都没有问题。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="InvocationTargetException ActivityNotFoundException android.os.FileUriExposedException" scheme="http://www.jacpy.com/tags/InvocationTargetException-ActivityNotFoundException-android-os-FileUriExposedException/"/>
    
  </entry>
  
  <entry>
    <title>golang中append函数和copy函数操作slice的不同用法</title>
    <link href="http://www.jacpy.com/2017/10/26/golang-difference-between-append-and-copy-function.html"/>
    <id>http://www.jacpy.com/2017/10/26/golang-difference-between-append-and-copy-function.html</id>
    <published>2017-10-26T04:50:00.000Z</published>
    <updated>2017-10-26T15:39:31.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天使用&lt;code&gt;golang&lt;/code&gt;时，遇到一个很奇怪的问题，原因是对&lt;code&gt;golang&lt;/code&gt;不熟悉，所以记录一下。&lt;/p&gt;
&lt;p&gt;在使用&lt;code&gt;append()&lt;/code&gt;函数给&lt;code&gt;slice&lt;/code&gt;中添加元素时，&lt;code&gt;slice&lt;/code&gt;的初始大小可以为0，也就是&lt;code&gt;len&lt;/code&gt;可以为0。每次向&lt;code&gt;slice&lt;/code&gt;中&lt;code&gt;append&lt;/code&gt;的时候，如果容量&lt;code&gt;cap&lt;/code&gt;不够，会自动对&lt;code&gt;slice&lt;/code&gt;进行扩容，也就是改变&lt;code&gt;slice&lt;/code&gt;的&lt;code&gt;cap&lt;/code&gt;的大小。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;而在使用&lt;code&gt;copy()&lt;/code&gt;函数操作&lt;code&gt;slice&lt;/code&gt;时，如果&lt;code&gt;slice&lt;/code&gt;的大小为0时，会不添加任何元素，不会自动增加&lt;code&gt;slice&lt;/code&gt;的容量大小。这里要注意。&lt;/p&gt;
&lt;p&gt;下面是从golang官网源码库中看到的实现代码，如下所示：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;runtime/slice.go&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;slicecopy&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(to, fm slice, width &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;int&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; fm.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || to.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    n := fm.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; to.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt; &amp;lt; n &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        n = to.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; width == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; n&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; raceenabled &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        callerpc := getcallerpc(unsafe.Pointer(&amp;amp;to))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pc := funcPC(slicecopy)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        racewriterangepc(to.array, &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(width)), callerpc, pc)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        racereadrangepc(fm.array, &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(width)), callerpc, pc)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; msanenabled &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        msanwrite(to.array, &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(width)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        msanread(fm.array, &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(width)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    size := &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;(n) * width&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; size == &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &amp;#123; &lt;span class=&quot;comment&quot;&gt;// common case worth about 2x to do here&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// &lt;span class=&quot;doctag&quot;&gt;TODO:&lt;/span&gt; is this still worth it with new memmove impl?&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        *(*&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;)(to.array) = *(*&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;)(fm.array) &lt;span class=&quot;comment&quot;&gt;// known to be a byte pointer&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        memmove(to.array, fm.array, size)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; n&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从上面的代码可以看出来，如果&lt;code&gt;slice&lt;/code&gt;的&lt;code&gt;len&lt;/code&gt;值为0，则直接&lt;code&gt;return&lt;/code&gt;，不会进行复制操作。&lt;/p&gt;
&lt;p&gt;下面是示例代码，验证一下：&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;regexp&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;log&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;unsafe&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.SetFlags(log.Lshortfile|log.LstdFlags)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sliceTest&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(list []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(list) &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log.Println(&lt;span class=&quot;string&quot;&gt;&quot;func pos 0:&quot;&lt;/span&gt;, &amp;amp;list[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;func pointer:&quot;&lt;/span&gt;, unsafe.Pointer(&amp;amp;list))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;------&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;copyTest&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    list := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pointer:&quot;&lt;/span&gt;, unsafe.Pointer(&amp;amp;list))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sliceTest(list)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;++++++++++++++&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    list = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(list, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pos 0:&quot;&lt;/span&gt;, &amp;amp;list[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pointer:&quot;&lt;/span&gt;, unsafe.Pointer(&amp;amp;list))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sliceTest(list)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;++++++++++++++&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    list = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(list, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pos 0:&quot;&lt;/span&gt;, &amp;amp;list[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;pointer:&quot;&lt;/span&gt;, unsafe.Pointer(&amp;amp;list))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sliceTest(list)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;++++++++++++++&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    copy1 := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;copy&lt;/span&gt;(copy1, list)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;copy1:&quot;&lt;/span&gt;, copy1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    copy2 := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;copy&lt;/span&gt;(copy2, list)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;copy2:&quot;&lt;/span&gt;, copy2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    copy3 := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;copy&lt;/span&gt;(copy3, list)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;copy3:&quot;&lt;/span&gt;, copy3)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    copyTest()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pointer: 0xc42000a060&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;func pointer: 0xc42000a080&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;++++++++++++++&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pos 0: 0xc4200160d0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pointer: 0xc42000a060&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;func pos 0: 0xc4200160d0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;func pointer: 0xc42000a0a0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;++++++++++++++&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pos 0: 0xc4200160f0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pointer: 0xc42000a060&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;func pos 0: 0xc4200160f0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;func pointer: 0xc42000a0c0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;++++++++++++++&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;copy1: []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;copy2: [1 2]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;copy3: []&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;从上面的日志可以看出来，copy1和copy3都是空，没有进行复制操作；每次进行扩容的时候，&lt;code&gt;pos 0:&lt;/code&gt;的地址都会发生变化。另外还可以看出来，当把&lt;code&gt;slice&lt;/code&gt;传给一个函数时，对&lt;code&gt;slice&lt;/code&gt;的结构体发生的值传递，而&lt;code&gt;slice&lt;/code&gt;中指向数据内容的地址没有变，即上面&lt;code&gt;pos 0:&lt;/code&gt;和&lt;code&gt;func pos 0:&lt;/code&gt;输出的地址是一致。&lt;/p&gt;
&lt;p&gt;同样可以在&lt;code&gt;runtime/slice.go&lt;/code&gt;源码中的&lt;code&gt;makeslice()&lt;/code&gt;函数中可以看到创建的&lt;code&gt;slice&lt;/code&gt;结构体，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; slice &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    array unsafe.Pointer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;   &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;   &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;也就是说当把&lt;code&gt;slice&lt;/code&gt;直接传给函数时，会对这个&lt;code&gt;slice&lt;/code&gt;结构体内容进行复制，而&lt;code&gt;array&lt;/code&gt;的地址不会变，始终指向数组内容的首元素地址。&lt;/p&gt;
&lt;p&gt;另外看这个&lt;code&gt;runtime/slice.go&lt;/code&gt;的源码时，还发现一个有趣的细节，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;growslice&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(et *_type, old slice, &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;slice&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    newcap := old.&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    doublecap := newcap + newcap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt; &amp;gt; doublecap &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        newcap = &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; old.&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt; &amp;lt; &lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            newcap = doublecap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; newcap &amp;lt; &lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                newcap += newcap / &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在&lt;code&gt;slice&lt;/code&gt;进行扩容的时候，如果其容量小于&lt;code&gt;1024&lt;/code&gt;，则容量增加一倍；否则容量以&lt;code&gt;1.25&lt;/code&gt;倍的数量增加。&lt;/p&gt;
&lt;p&gt;以上golang源码是基于1.9.1版本。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天使用&lt;code&gt;golang&lt;/code&gt;时，遇到一个很奇怪的问题，原因是对&lt;code&gt;golang&lt;/code&gt;不熟悉，所以记录一下。&lt;/p&gt;
&lt;p&gt;在使用&lt;code&gt;append()&lt;/code&gt;函数给&lt;code&gt;slice&lt;/code&gt;中添加元素时，&lt;code&gt;slice&lt;/code&gt;的初始大小可以为0，也就是&lt;code&gt;len&lt;/code&gt;可以为0。每次向&lt;code&gt;slice&lt;/code&gt;中&lt;code&gt;append&lt;/code&gt;的时候，如果容量&lt;code&gt;cap&lt;/code&gt;不够，会自动对&lt;code&gt;slice&lt;/code&gt;进行扩容，也就是改变&lt;code&gt;slice&lt;/code&gt;的&lt;code&gt;cap&lt;/code&gt;的大小。&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://www.jacpy.com/categories/go/"/>
    
    
      <category term="append copy slice" scheme="http://www.jacpy.com/tags/append-copy-slice/"/>
    
  </entry>
  
  <entry>
    <title>Okhttp使用注意事项</title>
    <link href="http://www.jacpy.com/2017/09/28/okhttp-used-attentions.html"/>
    <id>http://www.jacpy.com/2017/09/28/okhttp-used-attentions.html</id>
    <published>2017-09-28T07:10:42.000Z</published>
    <updated>2017-10-15T03:30:22.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在使用&lt;code&gt;Okhttp&lt;/code&gt;时遇到两个坑，这里记录一下。一个是在请求头中不需要设置&lt;code&gt;Accept-Encoding&lt;/code&gt;为&lt;code&gt;gzip&lt;/code&gt;，使用&lt;code&gt;Okhttp&lt;/code&gt;默认的就好；第二个是添加到&lt;code&gt;Okhttp&lt;/code&gt;请求头里面的键值对不能为空。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;默认不需要设置Accept-Encoding为gzip&quot;&gt;&lt;a href=&quot;#默认不需要设置Accept-Encoding为gzip&quot; class=&quot;headerlink&quot; title=&quot;默认不需要设置Accept-Encoding为gzip&quot;&gt;&lt;/a&gt;默认不需要设置Accept-Encoding为gzip&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Okhttp&lt;/code&gt;中如果外部请求没有在请求里面设置&lt;code&gt;Accept-Encoding&lt;/code&gt;值和&lt;code&gt;Range&lt;/code&gt;值时，会在请求头里增加设置&lt;code&gt;Accept-Encoding: gzip&lt;/code&gt;，如果外部设置这个&lt;code&gt;Accept-Encoding&lt;/code&gt;参数，则不会设置。如果是&lt;code&gt;Okhttp&lt;/code&gt;自己设置的参数，并且服务器端响应的头里包含有&lt;code&gt;Content-Encoding&lt;/code&gt;值为&lt;code&gt;gzip&lt;/code&gt;，则会使用&lt;code&gt;Gzip&lt;/code&gt;解压。如果是外部设置的，即使服务器端响应头里面包含有&lt;code&gt;Content-Encoding&lt;/code&gt;值为&lt;code&gt;gzip&lt;/code&gt;，也不会使用&lt;code&gt;Gzip&lt;/code&gt;解压，需要自己去解压。&lt;/p&gt;
&lt;p&gt;下面是官方代码，在&lt;code&gt;okhttp3.internal.http.BridgeInterceptor#intercept(Chain chain)&lt;/code&gt;方法中：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// If we add an &quot;Accept-Encoding: gzip&quot; header field we&#39;re responsible for also decompressing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// the transfer stream.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; transparentGzip = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (userRequest.header(&lt;span class=&quot;string&quot;&gt;&quot;Accept-Encoding&quot;&lt;/span&gt;) == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; userRequest.header(&lt;span class=&quot;string&quot;&gt;&quot;Range&quot;&lt;/span&gt;) == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      transparentGzip = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      requestBuilder.header(&lt;span class=&quot;string&quot;&gt;&quot;Accept-Encoding&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;gzip&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    List&amp;lt;Cookie&amp;gt; cookies = cookieJar.loadForRequest(userRequest.url());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!cookies.isEmpty()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      requestBuilder.header(&lt;span class=&quot;string&quot;&gt;&quot;Cookie&quot;&lt;/span&gt;, cookieHeader(cookies));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (userRequest.header(&lt;span class=&quot;string&quot;&gt;&quot;User-Agent&quot;&lt;/span&gt;) == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      requestBuilder.header(&lt;span class=&quot;string&quot;&gt;&quot;User-Agent&quot;&lt;/span&gt;, Version.userAgent());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Response networkResponse = chain.proceed(requestBuilder.build());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    HttpHeaders.receiveHeaders(cookieJar, userRequest.url(), networkResponse.headers());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Response.Builder responseBuilder = networkResponse.newBuilder()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        .request(userRequest);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (transparentGzip&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;amp;&amp;amp; &lt;span class=&quot;string&quot;&gt;&quot;gzip&quot;&lt;/span&gt;.equalsIgnoreCase(networkResponse.header(&lt;span class=&quot;string&quot;&gt;&quot;Content-Encoding&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;amp;&amp;amp; HttpHeaders.hasBody(networkResponse)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      GzipSource responseBody = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; GzipSource(networkResponse.body().source());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Headers strippedHeaders = networkResponse.headers().newBuilder()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          .removeAll(&lt;span class=&quot;string&quot;&gt;&quot;Content-Encoding&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          .removeAll(&lt;span class=&quot;string&quot;&gt;&quot;Content-Length&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          .build();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      responseBuilder.headers(strippedHeaders);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      responseBuilder.body(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RealResponseBody(strippedHeaders, Okio.buffer(responseBody)));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意整个逻辑是由&lt;code&gt;transparentGzip&lt;/code&gt;变量来控制的。刚开始不知道有这种逻辑，使用了&lt;code&gt;Okhttp&lt;/code&gt;做请求，然后在请求头里设置了&lt;code&gt;Accept-Encoding&lt;/code&gt;值为&lt;code&gt;gzip&lt;/code&gt;，于是使用&lt;code&gt;okhttp3.ResponseBody#string()&lt;/code&gt;方法来获取服务器端的响应字符串时，结果是乱码。去排查原因时发现上面这段逻辑。&lt;/p&gt;
&lt;h2 id=&quot;设置请求头信息时，值不能为空&quot;&gt;&lt;a href=&quot;#设置请求头信息时，值不能为空&quot; class=&quot;headerlink&quot; title=&quot;设置请求头信息时，值不能为空&quot;&gt;&lt;/a&gt;设置请求头信息时，值不能为空&lt;/h2&gt;&lt;p&gt;在使用&lt;code&gt;Okhttp&lt;/code&gt;请求时，由于设置请求的值为null值，所以App直接闪退，一看错误日志，发现了原因。原来源码里面有拦截操作，具体代码在&lt;code&gt;okhttp3.Headers#checkNameAndValue(String name, String value)&lt;/code&gt;方法中，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkNameAndValue&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String name, String value)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (name == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; NullPointerException(&lt;span class=&quot;string&quot;&gt;&quot;name == null&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (name.isEmpty()) &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;string&quot;&gt;&quot;name is empty&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, length = name.length(); i &amp;lt; length; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; c = name.charAt(i);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (c &amp;lt;= &lt;span class=&quot;string&quot;&gt;&#39;\u0020&#39;&lt;/span&gt; || c &amp;gt;= &lt;span class=&quot;string&quot;&gt;&#39;\u007f&#39;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(Util.format(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;Unexpected char %#04x at %d in header name: %s&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) c, i, name));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (value == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; NullPointerException(&lt;span class=&quot;string&quot;&gt;&quot;value for name &quot;&lt;/span&gt; + name + &lt;span class=&quot;string&quot;&gt;&quot; == null&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, length = value.length(); i &amp;lt; length; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; c = value.charAt(i);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((c &amp;lt;= &lt;span class=&quot;string&quot;&gt;&#39;\u001f&#39;&lt;/span&gt; &amp;amp;&amp;amp; c != &lt;span class=&quot;string&quot;&gt;&#39;\t&#39;&lt;/span&gt;) || c &amp;gt;= &lt;span class=&quot;string&quot;&gt;&#39;\u007f&#39;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(Util.format(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;Unexpected char %#04x at %d in %s value: %s&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;) c, i, name, value));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果添加请求的键或值为&lt;code&gt;null&lt;/code&gt;，都会抛出异常，而且还要求键的长度不能为0，值的要求是可见字符，可以是&lt;code&gt;\t&lt;/code&gt;。否则都会抛出异常。&lt;/p&gt;
&lt;p&gt;解决方法是对请求时添加到头里面的内容过滤下就可以了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在使用&lt;code&gt;Okhttp&lt;/code&gt;时遇到两个坑，这里记录一下。一个是在请求头中不需要设置&lt;code&gt;Accept-Encoding&lt;/code&gt;为&lt;code&gt;gzip&lt;/code&gt;，使用&lt;code&gt;Okhttp&lt;/code&gt;默认的就好；第二个是添加到&lt;code&gt;Okhttp&lt;/code&gt;请求头里面的键值对不能为空。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="okhttp" scheme="http://www.jacpy.com/tags/okhttp/"/>
    
  </entry>
  
  <entry>
    <title>Fresco使用HttpURLConnection支持加载https链接图片</title>
    <link href="http://www.jacpy.com/2017/09/28/fresco-used-httpurlconnection-support-https-image-loader.html"/>
    <id>http://www.jacpy.com/2017/09/28/fresco-used-httpurlconnection-support-https-image-loader.html</id>
    <published>2017-09-28T07:09:41.000Z</published>
    <updated>2017-09-30T16:38:03.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天使用&lt;code&gt;Fresco&lt;/code&gt;加载图片时遇到图片加载不出来的问题，然后调试了一下，发现出现如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;javax.net.ssl.SSLException: Connection closed by peer&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;debug时的截图如下图所示：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/09/javax_net_ssl_sslexception.png&quot; alt=&quot;SSLException截图&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;查找原因&quot;&gt;&lt;a href=&quot;#查找原因&quot; class=&quot;headerlink&quot; title=&quot;查找原因&quot;&gt;&lt;/a&gt;查找原因&lt;/h2&gt;&lt;p&gt;上面的截图是在给&lt;code&gt;Fresco&lt;/code&gt;中的展示图片的类&lt;code&gt;SimpleDraweeView&lt;/code&gt;调用如下代码时出现的：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// SimpileDraweeView sdv = ...;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sdv.setController(Fresco.newDraweeControllerBuilder().setControllerListener(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BaseControllerListener&amp;lt;ImageInfo&amp;gt;() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFinalImageSet&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, ImageInfo imageInfo, Animatable animatable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            File file = getCacheFile(request);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (file != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                callback.onImageLoadFinish(file);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFailure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, Throwable throwable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// 这里throwable就是javax.net.ssl.SSLException: Connection closed by peer&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onFailure(id, throwable);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (callback != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                callback.onFailure(uri, throwable);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .setImageRequest(request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .build());&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看到上面的错误提示，马上反应是不是因为&lt;code&gt;https&lt;/code&gt;证书的原因？原来请求的图片链接是&lt;code&gt;https&lt;/code&gt;地址。到网上一搜，果然，&lt;code&gt;Fresco&lt;/code&gt;默认不支持&lt;code&gt;https&lt;/code&gt;，需要自己设置。一看网上的解决方法，都是使用&lt;code&gt;Okhttp&lt;/code&gt;库来解决的，由于项目比较老，还没有使用&lt;code&gt;Okhttp&lt;/code&gt;库，总不能为了解决这个问题而引入一个库吧？感觉代价太大了。所以跑去看了一下&lt;code&gt;Okhttp&lt;/code&gt;默认请求加载图片的实现。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Okhttp&lt;/code&gt;库加载图片的网络请求处理在这个类&lt;code&gt;com.facebook.imagepipeline.producers.HttpUrlConnectionNetworkFetcher&lt;/code&gt;中，关键的请求处理是在&lt;code&gt;downloadFrom(Uri uri, int maxRedirects)&lt;/code&gt;这个方法中，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; HttpURLConnection &lt;span class=&quot;title&quot;&gt;downloadFrom&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Uri uri, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; maxRedirects)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  HttpURLConnection connection = openConnectionTo(uri);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; responseCode = connection.getResponseCode(); &lt;span class=&quot;comment&quot;&gt;// 请求是在这一步发出的，在这之前设置HTTPS即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isHttpSuccess(responseCode)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; connection;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isHttpRedirect(responseCode)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      String nextUriString = connection.getHeaderField(&lt;span class=&quot;string&quot;&gt;&quot;Location&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      connection.disconnect();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      Uri nextUri = (nextUriString == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) ? &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; : Uri.parse(nextUriString);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      String originalScheme = uri.getScheme();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (maxRedirects &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; nextUri != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !nextUri.getScheme().equals(originalScheme)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; downloadFrom(nextUri, maxRedirects - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String message = maxRedirects == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ? error(&lt;span class=&quot;string&quot;&gt;&quot;URL %s follows too many redirects&quot;&lt;/span&gt;, uri.toString())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            : error(&lt;span class=&quot;string&quot;&gt;&quot;URL %s returned %d without a valid redirect&quot;&lt;/span&gt;, uri.toString(), responseCode);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IOException(message);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      connection.disconnect();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IOException(String&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          .format(&lt;span class=&quot;string&quot;&gt;&quot;Image URL %s returned HTTP code %d&quot;&lt;/span&gt;, uri.toString(), responseCode));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@VisibleForTesting&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; HttpURLConnection &lt;span class=&quot;title&quot;&gt;openConnectionTo&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Uri uri)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  URL url = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; URL(uri.toString());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; (HttpURLConnection) url.openConnection();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;解决方法&quot;&gt;&lt;a href=&quot;#解决方法&quot; class=&quot;headerlink&quot; title=&quot;解决方法&quot;&gt;&lt;/a&gt;解决方法&lt;/h2&gt;&lt;p&gt;从上面的代码可以看出来，请求是从&lt;code&gt;int responseCode = connection.getResponseCode();&lt;/code&gt;这行代码发出去的，但是又没有对&lt;code&gt;https&lt;/code&gt;的证书进行处理，所以在这之前增加处理即可。于是想到继承这个类来扩展处理&lt;code&gt;https&lt;/code&gt;的情况，结果从上面的代码来看，想从继承的角度增加&lt;code&gt;https&lt;/code&gt;的处理是不可能的。干脆把整个类的代码复制一份，修改类名为&lt;code&gt;HttpsUrlConnectionNetworkFetcher&lt;/code&gt;，修改&lt;code&gt;downloadFrom&lt;/code&gt;这个方法，增加&lt;code&gt;https&lt;/code&gt;证书处理，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HttpsUrlConnectionNetworkFetcher&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BaseNetworkFetcher&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;FetchState&lt;/span&gt;&amp;gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 中间代码忽略...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; HttpURLConnection &lt;span class=&quot;title&quot;&gt;downloadFrom&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Uri uri, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; maxRedirects)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        HttpURLConnection connection = openConnectionTo(uri);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 增加https支持&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String scheme = uri.getScheme();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;string&quot;&gt;&quot;https&quot;&lt;/span&gt;.equals(scheme)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            HttpsURLConnection httpsURLConnection = (HttpsURLConnection) connection;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            SSLContext sslContext = SSLContextUtils.getSSLContext();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (sslContext != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                SSLSocketFactory sslSocketFactory = sslContext.getSocketFactory();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                httpsURLConnection.setSSLSocketFactory(sslSocketFactory);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                httpsURLConnection.setHostnameVerifier(SSLContextUtils.getHostnameVerifier());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; responseCode = connection.getResponseCode(); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 其它代码忽略...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;SSLContextUtils&lt;/code&gt;类中忽略对证书的处理，信任所有证书，这种做法很不安全，仅供参考。代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; android.util.Log;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.security.SecureRandom;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.security.cert.X509Certificate;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.HostnameVerifier;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.SSLContext;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.SSLSession;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.TrustManager;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.net.ssl.X509TrustManager;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; * SSL工具类&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SSLContextUtils&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; HostnameVerifier hostnameVerifier = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HostnameVerifier() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;verify&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String hostname, SSLSession session)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; HostnameVerifier &lt;span class=&quot;title&quot;&gt;getHostnameVerifier&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; hostnameVerifier;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; SSLContext &lt;span class=&quot;title&quot;&gt;getSSLContext&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        SSLContext sslContext = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            sslContext = SSLContext.getInstance(&lt;span class=&quot;string&quot;&gt;&quot;TLS&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            sslContext.init(&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; TrustManager[]&amp;#123;&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; X509TrustManager() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkClientTrusted&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(X509Certificate[] chain, String authType)&lt;/span&gt;  &lt;/span&gt;&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkServerTrusted&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(X509Certificate[] chain, String authType)&lt;/span&gt; &lt;/span&gt;&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; X509Certificate[] getAcceptedIssuers() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; X509Certificate[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&amp;#125;, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; SecureRandom());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (Exception e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Log.e(&lt;span class=&quot;string&quot;&gt;&quot;SSLContextUtils&quot;&lt;/span&gt;, e.getMessage(), e);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; sslContext;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最后需要把这个自定义的类的通过调用&lt;code&gt;ImagePipelineConfig.Builder#setNetworkFetcher()&lt;/code&gt;方法设置进来，指定加载图片时使用新的网络请求策略。具体代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ImagePipelineConfig config = ImagePipelineConfig.newBuilder(context)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        .setDownsampleEnabled(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        .setNetworkFetcher(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HttpsUrlConnectionNetworkFetcher()) &lt;span class=&quot;comment&quot;&gt;// 这里设置自定义类&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        .build();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Fresco.initialize(context, config);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再重新运行App，图片加载出来了，问题解决。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天使用&lt;code&gt;Fresco&lt;/code&gt;加载图片时遇到图片加载不出来的问题，然后调试了一下，发现出现如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;javax.net.ssl.SSLException: Connection closed by peer&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;debug时的截图如下图所示：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="fresco HttpURLConnection" scheme="http://www.jacpy.com/tags/fresco-HttpURLConnection/"/>
    
  </entry>
  
  <entry>
    <title>sublime使用markdownEdit设置</title>
    <link href="http://www.jacpy.com/2017/09/22/config-4-sublime-markdownedit.html"/>
    <id>http://www.jacpy.com/2017/09/22/config-4-sublime-markdownedit.html</id>
    <published>2017-09-22T11:12:12.000Z</published>
    <updated>2017-09-22T12:13:31.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天&lt;code&gt;sublime&lt;/code&gt;发布正式版本，mac下面一直没有发现跟windows下的&lt;code&gt;notepad++&lt;/code&gt;相媲美的工具，于是装了下&lt;code&gt;sublime&lt;/code&gt;玩玩，也试了下&lt;code&gt;markdown&lt;/code&gt;插件，结果发现太坑爹了，于是走上了不归路。&lt;/p&gt;
&lt;p&gt;装完&lt;code&gt;markdown&lt;/code&gt;插件后，打开&lt;code&gt;md&lt;/code&gt;文件，发现界面很丑，MD风格都被吓跑了。如下图所示：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/09/sublime_markdown_pre.png&quot; alt=&quot;配置前的样式&quot;&gt;&lt;/p&gt;
&lt;p&gt;经过一翻折腾，MD终于又回来了，结果图如下所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/09/sublime_markdown_post.png&quot; alt=&quot;配置后的样式&quot;&gt;&lt;/p&gt;
&lt;p&gt;修改的配置如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;color_scheme&amp;quot;: &amp;quot;Packages/Material Theme/schemes/Material-Theme-Darker.tmTheme&amp;quot;, // 修改主题为MD主题，此时发现背景色会改变，不再是白色&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;line_numbers&amp;quot;: true, // 显示行号&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;highlight_line&amp;quot;: true, // 光标所在行高亮&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;wrap_width&amp;quot;: 0, // 默认是80个字符就换行，这里改成0，使用默认值，sublime默认的配置就是这个值&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;draw_centered&amp;quot;: false, // 不自动居中，如果发现一行中内容不多，就会出现上面截图中左侧到行号之前有大面积空白&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;怎么修改配置呢？&lt;/p&gt;
&lt;p&gt;先注意&lt;code&gt;sublime&lt;/code&gt;的右下角有一个&lt;code&gt;Markdown GFM&lt;/code&gt;标识，然后依次&lt;code&gt;Preference&lt;/code&gt;-&amp;gt;&lt;code&gt;Package Settings&lt;/code&gt;-&amp;gt;&lt;code&gt;Markdown Edting&lt;/code&gt;-&amp;gt;&lt;code&gt;Markdown GFM Settings-User&lt;/code&gt;，操作如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/09/sublime_markdown_preference.png&quot; alt=&quot;配置后的样式&quot;&gt;&lt;/p&gt;
&lt;p&gt;会打开一个标题为&lt;code&gt;Markdown.sublime-settings--MarkdownEditing&lt;/code&gt;文件，把上面的配置内容复制进去，保存后重启&lt;code&gt;sublime&lt;/code&gt;，再打开md文件样式就已经改变了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天&lt;code&gt;sublime&lt;/code&gt;发布正式版本，mac下面一直没有发现跟windows下的&lt;code&gt;notepad++&lt;/code&gt;相媲美的工具，于是装了下&lt;code&gt;sublime&lt;/code&gt;玩玩，也试了下&lt;code&gt;markdown&lt;/code&gt;插件，结果发现太坑爹了，于是走上了不归路。&lt;/p&gt;
&lt;p&gt;装完&lt;code&gt;markdown&lt;/code&gt;插件后，打开&lt;code&gt;md&lt;/code&gt;文件，发现界面很丑，MD风格都被吓跑了。如下图所示：&lt;/p&gt;
    
    </summary>
    
      <category term="sublime" scheme="http://www.jacpy.com/categories/sublime/"/>
    
    
      <category term="markdown设置 sublime" scheme="http://www.jacpy.com/tags/markdown%E8%AE%BE%E7%BD%AE-sublime/"/>
    
  </entry>
  
  <entry>
    <title>android installation failed with message INSTALL_FAILED_TEST_ONLY</title>
    <link href="http://www.jacpy.com/2017/09/21/android-installation-failed-with-message-INSTALL-FAILED-TEST-ONLY-md.html"/>
    <id>http://www.jacpy.com/2017/09/21/android-installation-failed-with-message-INSTALL-FAILED-TEST-ONLY-md.html</id>
    <published>2017-09-21T05:28:12.000Z</published>
    <updated>2017-09-22T12:24:10.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天一直在试用Android Studio Beta版本，在给6.0的手机安装调试包是遇到了下面的问题，一运行AS就弹出&lt;code&gt;INSTALL_FAILED_TEST_ONLY&lt;/code&gt;对话框提示，然后点&lt;code&gt;OK&lt;/code&gt;，在6.0手机上提示&lt;code&gt;应用程序未安装&lt;/code&gt;，但是在4.4手机上运行却没有对话框提示，可以正常运行，奇了怪了，跑去搜索了一下。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Installation failed with message INSTALL_FAILED_TEST_ONLY.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;It is possible that this issue is resolved by uninstalling an existing version of the apk if it is present, and then re-installing.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;WARNING: Uninstalling will remove the application data!&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Do you want to uninstall the existing application?&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;结果找到了这篇文章&lt;code&gt;http://www.cnblogs.com/bluestorm/p/6934433.html&lt;/code&gt;，上面说&lt;code&gt;classpath&lt;/code&gt;与&lt;code&gt;distributionUrl&lt;/code&gt;要一一对应：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;在AS 2.3上面：&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;classpath &amp;apos;com.android.tools.build:gradle:2.3.2&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;对应：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;distributionUrl=https\://services.gradle.org/distributions/gradle-3.3-all.zip&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;在AS 3.0上面：&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;classpath &amp;apos;com.android.tools.build:gradle:3.0.0-alpha2`&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;对应：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;distributionUrl=https\://services.gradle.org/distributions/gradle-4.0-milestone-1-all.zip&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;由于自己当前使用的是AS 3.0 beta5版本，&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;classpath: &amp;apos;com.android.tools.build:gradle:3.0.0-beta5&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;distributionUrl=https\://services.gradle.org/distributions/gradle-4.1-all.zip&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;所以认为也是对的，按照上面的文章所说的对应关系。&lt;/p&gt;
&lt;p&gt;发现没有解决问题，在&lt;code&gt;stackoverflow&lt;/code&gt;上面找到这个链接&lt;code&gt;https://stackoverflow.com/questions/25274296/adb-install-fails-with-install-failed-test-only&lt;/code&gt;，说是在启动的时候加上&lt;code&gt;-t&lt;/code&gt;参数，结果试了下，发现还是弹框提示，问题没有解决。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;思路又回到之前的解决方案上面，难道是对应关系问题？于是改成以下对应关系：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;classpath &amp;apos;com.android.tools.build:gradle:2.3.3&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;distributionUrl=https\://services.gradle.org/distributions/gradle-4.1-all.zip&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;一运行，没弹框了，问题解决了。果真是对应关系问题。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天一直在试用Android Studio Beta版本，在给6.0的手机安装调试包是遇到了下面的问题，一运行AS就弹出&lt;code&gt;INSTALL_FAILED_TEST_ONLY&lt;/code&gt;对话框提示，然后点&lt;code&gt;OK&lt;/code&gt;，在6.0手机上提示&lt;code&gt;应用程序未安装&lt;/code&gt;，但是在4.4手机上运行却没有对话框提示，可以正常运行，奇了怪了，跑去搜索了一下。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="INSTALL_FAILED_TEST_ONLY" scheme="http://www.jacpy.com/tags/INSTALL-FAILED-TEST-ONLY/"/>
    
  </entry>
  
  <entry>
    <title>Android命令行安装APK时报错：INSTALL_FAILED_UID_CHANGED</title>
    <link href="http://www.jacpy.com/2017/09/07/android-install-apk-INSTALL-FAILED-UID-CHANGED.html"/>
    <id>http://www.jacpy.com/2017/09/07/android-install-apk-INSTALL-FAILED-UID-CHANGED.html</id>
    <published>2017-09-07T05:13:24.000Z</published>
    <updated>2017-09-07T06:29:02.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天使用命令行&lt;code&gt;adb install&lt;/code&gt;安装APK文件时，安装失败，遇到了这个错误提示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;INSTALL_FAILED_UID_CHANGED&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;突然反应过来了，刚刚使用手机的&lt;code&gt;root&lt;/code&gt;权限看app的缓存数据，命令行还在那个&lt;code&gt;/data/data/com.xxx.app&lt;/code&gt;目录下，由于命令行的占用，所以这个包名路径没有被删除掉。赶紧退出到&lt;code&gt;/data/data/&lt;/code&gt;目录下面，&lt;code&gt;ls&lt;/code&gt;一看，这个包名路径还存在，用&lt;code&gt;rm -rf&lt;/code&gt;一删除，再安装试下，成功了。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;回想之前调试微信支付功能，调的头大，经常卸载安装微信。结果有一次就安装失败了，提示&lt;code&gt;应用已经安装&lt;/code&gt;，结果同样去&lt;code&gt;/data/data&lt;/code&gt;目录下面一看，结果微信的包名路径还在。然后执行&lt;code&gt;rm -rf&lt;/code&gt;删除，删除失败，跑去删除子目录，都能删除，最后有一个目录删除不了。心想这跟U盘一样，出现坏道了？微信不可能创建一个目录还不让删除的。结果一直提示删除失败，这&lt;code&gt;root&lt;/code&gt;权限都使不上劲。最后没办法了，只好换台手机调试。&lt;/p&gt;
&lt;p&gt;自己的测试手机上装不了微信，这个事一直挂在心上。只要能把包名路径给删除了，就可以装微信了，想着怎么删除。突然有一天，想到看能不能把这个目录移出去，然后再来删除包名路径。于是使用&lt;code&gt;mv&lt;/code&gt;命令将这个目录移走，然后再删除包名，删除成功了，再删除那个目录，还是删除不掉，算了，不管了。一安装微信，装成功了。大喜！终于又可以装上微信了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天使用命令行&lt;code&gt;adb install&lt;/code&gt;安装APK文件时，安装失败，遇到了这个错误提示：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;INSTALL_FAILED_UID_CHANGED&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;突然反应过来了，刚刚使用手机的&lt;code&gt;root&lt;/code&gt;权限看app的缓存数据，命令行还在那个&lt;code&gt;/data/data/com.xxx.app&lt;/code&gt;目录下，由于命令行的占用，所以这个包名路径没有被删除掉。赶紧退出到&lt;code&gt;/data/data/&lt;/code&gt;目录下面，&lt;code&gt;ls&lt;/code&gt;一看，这个包名路径还存在，用&lt;code&gt;rm -rf&lt;/code&gt;一删除，再安装试下，成功了。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="install apk INSTALL_FAILED_UID_CHANGED" scheme="http://www.jacpy.com/tags/install-apk-INSTALL-FAILED-UID-CHANGED/"/>
    
  </entry>
  
  <entry>
    <title>gradle failed to create MD5 hash for file</title>
    <link href="http://www.jacpy.com/2017/09/07/gradle-failed-to-create-md5-hash-for-file.html"/>
    <id>http://www.jacpy.com/2017/09/07/gradle-failed-to-create-md5-hash-for-file.html</id>
    <published>2017-09-07T05:03:59.000Z</published>
    <updated>2017-09-07T06:29:17.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在使用gradle编译项目插件，突然遇到这个错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;FAILURE: Build failed with an exception.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* What went wrong:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Execution failed for task &amp;apos;:compileReleaseJavaWithJavac&amp;apos;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;gt; Failed to create MD5 hash for file &amp;apos;E:\workspace\as\app\libs\xxx.jar&amp;apos;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* Try:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BUILD FAILED&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;然后在对应目录找了下这个文件，发现没有这个&lt;code&gt;jar&lt;/code&gt;文件。于是去&lt;code&gt;build.gradle&lt;/code&gt;文件中的&lt;code&gt;depenencies&lt;/code&gt;下面找到了这个&lt;code&gt;provided files&lt;/code&gt;依赖，然后把这个&lt;code&gt;provided files&lt;/code&gt;行删除，然后重新编译就OK了。&lt;/p&gt;
&lt;p&gt;发现使用&lt;code&gt;compile files&lt;/code&gt;和&lt;code&gt;provided files&lt;/code&gt;引用文件时，如果引用的文件不存，都会报这个错误。删除就好了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在使用gradle编译项目插件，突然遇到这个错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;FAILURE: Build failed with an exception.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* What went wrong:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Execution failed for task &amp;apos;:compileReleaseJavaWithJavac&amp;apos;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;gt; Failed to create MD5 hash for file &amp;apos;E:\workspace\as\app\libs\xxx.jar&amp;apos;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* Try:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BUILD FAILED&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="gradle" scheme="http://www.jacpy.com/categories/gradle/"/>
    
    
      <category term="failed to create MD5 hash for file" scheme="http://www.jacpy.com/tags/failed-to-create-MD5-hash-for-file/"/>
    
  </entry>
  
  <entry>
    <title>android听云升级后编译报错</title>
    <link href="http://www.jacpy.com/2017/08/03/network-bench-update-compile-error-md.html"/>
    <id>http://www.jacpy.com/2017/08/03/network-bench-update-compile-error-md.html</id>
    <published>2017-08-03T01:00:09.000Z</published>
    <updated>2017-08-07T05:16:41.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;升级遇到的问题&quot;&gt;&lt;a href=&quot;#升级遇到的问题&quot; class=&quot;headerlink&quot; title=&quot;升级遇到的问题&quot;&gt;&lt;/a&gt;升级遇到的问题&lt;/h2&gt;&lt;p&gt;项目中由于需要，集成了听云的SDK，最近把听云的SDK版本从&lt;code&gt;2.4.4&lt;/code&gt;升级到&lt;code&gt;2.5.7&lt;/code&gt;，重新运行时，在编译过程中报了如下错误：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[NBSAgent.error] Error:com.networkbench.agent.compile.a: NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java.lang.RuntimeException: com.networkbench.agent.compile.a: NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.a(SourceFile:517)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.a(SourceFile:296)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e$1$1.invoke(SourceFile:328)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.invoke(SourceFile:425)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processClass(Main.java)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processFileBytes(Main.java:723)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.access$1200(Main.java:85)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main$FileBytesConsumer.processFileBytes(Main.java:1653)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.cf.direct.ClassPathOpener.processArchive(ClassPathOpener.java:284)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:166)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.cf.direct.ClassPathOpener.process(ClassPathOpener.java:144)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processOne(Main.java:677)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.processAllFiles(Main.java:569)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.runMultiDex(Main.java:366)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.run(Main.java:275)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.dexer.Main.main(Main.java:245)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.android.dx.command.Main.main(Main.java:106)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Caused by: com.networkbench.agent.compile.a: NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.a.e.a(SourceFile:91)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.a.h.a(SourceFile:43)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.b.f.a(SourceFile:644)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.b.f.a(SourceFile:439)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at com.networkbench.agent.compile.NBSStubPreMain$e.a(SourceFile:479)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ... 16 more&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Dex: Error converting bytecode to dex:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Cause: java.lang.RuntimeException: Exception parsing classes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    UNEXPECTED TOP-LEVEL EXCEPTION:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    java.lang.RuntimeException: Exception parsing classes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processClass(Main.java:760)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processFileBytes(Main.java:723)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.access$1200(Main.java:85)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main$FileBytesConsumer.processFileBytes(Main.java:1653)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.processArchive(ClassPathOpener.java:284)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.processOne(ClassPathOpener.java:166)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.ClassPathOpener.process(ClassPathOpener.java:144)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processOne(Main.java:677)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processAllFiles(Main.java:569)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.runMultiDex(Main.java:366)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.run(Main.java:275)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.main(Main.java:245)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.Main.main(Main.java:106)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Caused by: java.lang.NullPointerException&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.util.ByteArray.&amp;lt;init&amp;gt;(ByteArray.java:76)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.cf.direct.DirectClassFile.&amp;lt;init&amp;gt;(DirectClassFile.java:206)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.parseClass(Main.java:769)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.access$1500(Main.java:85)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main$ClassParserTask.call(Main.java:1700)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at com.android.dx.command.dexer.Main.processClass(Main.java:755)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ... 12 more&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1 error; aborting&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;:app:transformClassesWithDexForDebug FAILED&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;:app:networkBenchNewLensDeinstrumentTask&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[NBSAgent.debug] NetworkBench begin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FAILURE: Build failed with an exception.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* What went wrong:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Execution failed for task &amp;apos;:app:transformClassesWithDexForDebug&amp;apos;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;gt; com.android.build.api.transform.TransformException: com.android.ide.common.process.ProcessException: java.util.concurrent.ExecutionException: com.android.ide.common.process.ProcessException: Error while executing java process with main class com.android.dx.command.Main with arguments &amp;#123;--dex --num-threads=4 --multi-dex --main-dex-list /data/jenkins/workspace/app/build/intermediates/multi-dex/debug/maindexlist.txt --output /data/jenkins/workspace/app/build/intermediates/transforms/dex/debug/folders/1000/1f/main /data/jenkins/workspace/app/build/intermediates/transforms/jarMerging/debug/jars/1/1f/combined.jar&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* Try:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BUILD FAILED&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;解决问题&quot;&gt;&lt;a href=&quot;#解决问题&quot; class=&quot;headerlink&quot; title=&quot;解决问题&quot;&gt;&lt;/a&gt;解决问题&lt;/h2&gt;&lt;p&gt;遇到了上面的编译错误问题，先google了一下，没有人提出了这样的错误，也没有解决方案，而且从搜索的结果来看，用的人也不多。这问题只能是自己解决了，从上面的错误提示来看，这个错误是听云中抛出来的。也就是听云干预了编译过程。从这个&lt;code&gt;NetworkBench NewLens Android Agent Error: Your agent and class rewriter versions do not match: agent = 2.4.4 class rewriter = 2.5.7.  You probably need to update one of these components.&lt;/code&gt;错误提示上来看，说是版本没有对应起来。的确，听云在&lt;code&gt;project&lt;/code&gt;下面的&lt;code&gt;build.gradle&lt;/code&gt;中的&lt;code&gt;dependencies&lt;/code&gt;块中的&lt;code&gt;classpath&lt;/code&gt;中和&lt;code&gt;module&lt;/code&gt;下面的&lt;code&gt;build.gradle&lt;/code&gt;中的&lt;code&gt;dependencies&lt;/code&gt;块中的&lt;code&gt;compile&lt;/code&gt;两个地方都要指定一个版本SDK。一个是用来干预编译过程，植入代码；一个则是要植入的代码。&lt;/p&gt;
&lt;p&gt;引入方式如下代码所示：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;project&lt;/code&gt;目录下面的&lt;code&gt;build.gradle&lt;/code&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    classpath &amp;apos;com.networkbench.newlens.agent.android:agent-gradle-plugin:2.5.7&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;app&lt;/code&gt;目录下面的&lt;code&gt;build.gradle&lt;/code&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   	compile &amp;apos;com.networkbench.newlens.agent.android:nbs.newlens.agent:2.5.7&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;那为什么会有上面有错误？按道理说两者都具备就可以了，猜是听云的版本兼容性问题，也就是&lt;code&gt;2.5.7&lt;/code&gt;不兼容&lt;code&gt;2.4.4&lt;/code&gt;版本。也就是上面说的&lt;code&gt;classpath&lt;/code&gt;与&lt;code&gt;compile&lt;/code&gt;版本要一一对应，版本号必须保持一致。但修改时的版本号是保持一致的呀？问题出在哪儿？缓存问题？&lt;/p&gt;
&lt;p&gt;于是先&lt;code&gt;clean&lt;/code&gt;，然后再重新&lt;code&gt;build了&lt;/code&gt;一下，再运行时，发现问题依旧。没折了，我把版本号改回去&lt;code&gt;2.4.4&lt;/code&gt;总行吧？结果还是编译报错，无语了，试了几次，还是这样，现在感觉到自己进入到进退两难的地步了。最后重新启动&lt;code&gt;AS&lt;/code&gt;，再重新运行了，问题解决了，编译时不报错了，真是太惊喜，太意外了。&lt;/p&gt;
&lt;p&gt;OK，本地问题解决了，服务器的自动构建上又出现问题。按照解决本地问题的思路，不可能重启服务器吧？仔细一想，还是缓存问题？问了运维，说每次构建都会自动清除&lt;code&gt;build&lt;/code&gt;目录中的内容。但心想，与&lt;code&gt;build&lt;/code&gt;目录的内容无关，自己解决问题时都删了好几次，问题依旧没有解决。突然想起平时经常被&lt;code&gt;kill&lt;/code&gt;的&lt;code&gt;java.exe&lt;/code&gt;进程，这个进程里面会缓存一些东西，编译时经常会看到&lt;code&gt;Starting a Gradle Daemon&lt;/code&gt;这样的提示，&lt;code&gt;AS&lt;/code&gt;要提高编译速度，肯定会在这个进程里面缓存一些东西，不然这个&lt;code&gt;java.exe&lt;/code&gt;进程内存占用会有几百M甚至超过1个G？&lt;/p&gt;
&lt;p&gt;跑去跟运维说，你把这个&lt;code&gt;java&lt;/code&gt;进程先&lt;code&gt;kill&lt;/code&gt;，然后再重新构建。果然，&lt;code&gt;kill&lt;/code&gt;进程之后再重新自动构建就OK了。后来想了一下，自己本地重启&lt;code&gt;AS&lt;/code&gt;也是重新启动这个&lt;code&gt;java&lt;/code&gt;进程。&lt;/p&gt;
&lt;h2 id=&quot;为什么要用听云&quot;&gt;&lt;a href=&quot;#为什么要用听云&quot; class=&quot;headerlink&quot; title=&quot;为什么要用听云&quot;&gt;&lt;/a&gt;为什么要用听云&lt;/h2&gt;&lt;p&gt;听云是收费的，但也有免费的版本，免费的版本最多只能看三天的数据。我看重听云的最大一个好处是可以监控网络情况，比如说哪些接口失败率比较高、请求耗时等，这样可以做一些优化。&lt;/p&gt;
&lt;p&gt;但听云有一个不好的地方是，对代码进行侵入，有时候在报错的堆栈中看到了听云的堆栈信息。如果项目结构设计不好，用的第三方库太多，估计听云的代码会插入的到处都是，这里没有整理出数据来。&lt;/p&gt;
&lt;p&gt;另外听去的另外一个ANR日志收集的功能没有做好，把&lt;code&gt;traces.txt&lt;/code&gt;日志文件中的有用的信息基本都过虑掉了，只留下一些堆栈信息。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;升级遇到的问题&quot;&gt;&lt;a href=&quot;#升级遇到的问题&quot; class=&quot;headerlink&quot; title=&quot;升级遇到的问题&quot;&gt;&lt;/a&gt;升级遇到的问题&lt;/h2&gt;&lt;p&gt;项目中由于需要，集成了听云的SDK，最近把听云的SDK版本从&lt;code&gt;2.4.4&lt;/code&gt;升级到&lt;code&gt;2.5.7&lt;/code&gt;，重新运行时，在编译过程中报了如下错误：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="听云" scheme="http://www.jacpy.com/tags/%E5%90%AC%E4%BA%91/"/>
    
  </entry>
  
  <entry>
    <title>sqlite cant open database exception unknow error code 14</title>
    <link href="http://www.jacpy.com/2017/08/03/sqlite-cant-open-database-exception-unknow-error-code-14-md.html"/>
    <id>http://www.jacpy.com/2017/08/03/sqlite-cant-open-database-exception-unknow-error-code-14-md.html</id>
    <published>2017-08-03T00:59:05.000Z</published>
    <updated>2017-08-07T07:44:03.000Z</updated>
    
    <content type="html">&lt;p&gt;这几天在解决客户的一个问题，说用了发给我的sqlite的数据库文件会发生数据上传失败问题，于是结合发过来的数据库文件准备看一下。&lt;/p&gt;
&lt;p&gt;先是通过&lt;code&gt;adb push&lt;/code&gt;命令把文件copy到手机，然后cp到应用的缓存目录（需要root权限），覆盖原来的数据库文件。结果应用一运行就报了如下的错误：&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;E/SQLiteLog: (14) cannot open file at line 30191 of [00bb9c9ce4]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;E/SQLiteLog: (14) os_unix.c:30191: (13) open(/data/data/com.xxx/databases/xxx) - &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;E/SQLiteDatabase: Failed to open database &amp;apos;/data/data/xxx/databases/xxxx&amp;apos;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;android.database.sqlite.SQLiteCantOpenDatabaseException: &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;unknown error (code 14): Could not open database&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看提示说是读了多少行后报错，第一反应是数据库文件有问题？在PC端用工具打开那个文件，发现能正常打开，而且执行了SQL都是正常看到数据。奇了怪了，那个&lt;code&gt;line&lt;/code&gt;是代码的行数？直接搜索上面的错误，在&lt;code&gt;stackoverflow&lt;/code&gt;上面看别人各种回答。有的说是权限问题，要先申请权限，有的说是6.0上面的问题，要动态权限等等。结合自己的情况，发现都不是。接着往下看，发现有人提到了&lt;code&gt;SELinux security&lt;/code&gt;，突然想到了是不是权限问题？马上命令一看，果然只有root权限，执行&lt;code&gt;chomd 777 xxxx&lt;/code&gt;，然后再一运行app，OK了。&lt;/p&gt;
&lt;p&gt;运气太好了，这样就解决问题了，还想说报那个&lt;code&gt;code 14&lt;/code&gt;是什么错误呢。后来到sqlite源码里面找了一下，找到这个的一个宏定义&lt;code&gt;#define SQLITE_CANTOPEN    14   /* Unable to open the database file */&lt;/code&gt;，这个提示对解决问题并没有什么帮助，很佩服自己当时的反应。网上也有人说这里有一个bug，没有去深究，问题已解决，后面的事情还没有做呢！&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这几天在解决客户的一个问题，说用了发给我的sqlite的数据库文件会发生数据上传失败问题，于是结合发过来的数据库文件准备看一下。&lt;/p&gt;
&lt;p&gt;先是通过&lt;code&gt;adb push&lt;/code&gt;命令把文件copy到手机，然后cp到应用的缓存目录（需要root权限），覆盖原来的数据库文件。结果应用一运行就报了如下的错误：&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="sqlite error code 14" scheme="http://www.jacpy.com/tags/sqlite-error-code-14/"/>
    
  </entry>
  
  <entry>
    <title>android device or resource busy</title>
    <link href="http://www.jacpy.com/2017/05/03/android-device-or-resource-busy.html"/>
    <id>http://www.jacpy.com/2017/05/03/android-device-or-resource-busy.html</id>
    <published>2017-05-03T09:28:14.000Z</published>
    <updated>2017-08-02T05:12:12.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在项目开发中遇到一个很奇葩的问题，在应用中做了一个清除应用缓存功能，将缓存目录文件中所有的文件都删除，然后再重新初始化的时候，这个目录就不能创建文件和目录了。在红米手机和魅族手机上试了，都会出现这个问题，华为手机上却没有这个问题，我的MOTO手机上也有这个问题。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;于是在命令行进入&lt;code&gt;shell&lt;/code&gt;，然后&lt;code&gt;cd&lt;/code&gt;到这个目录提示&lt;code&gt;tmp-mksh:  Device or resource busy&lt;/code&gt;错误。用手机中的文件管理器删除这个目录提示删除失败。最后把应用卸载了，然后再删除，又可以删除这个目录。&lt;/p&gt;
&lt;p&gt;这就奇了怪了，到底是怎么回事？在这个目录用执行&lt;code&gt;new File(path).mkdirs()&lt;/code&gt;方法时，返回false，创建目录失败。导致应用没有办法在这个目录创建缓存数据，导致整个应用都没有办法正常进行，如果处理这种失败情况，很多地方都得改。但有些地方是分裂式的，这一个地方失败，会影响其他N多地方。但是之前用这个功能都没有问题，只是近期出现了这个问题。&lt;/p&gt;
&lt;p&gt;不行，得找出原因。于是把清除缓存目录下面的文件路径都用日志输出了一遍，结果突然发现一些个奇怪的文件–&lt;code&gt;mmap&lt;/code&gt;文件。这些文件是在使用腾讯&lt;code&gt;mars&lt;/code&gt;开源库中的&lt;code&gt;xlog&lt;/code&gt;组件产生的内核映射文件，用来同步缓存日志，防止日志因为应用出现意外而丢失。按照&lt;code&gt;xlog&lt;/code&gt;的官方demo中的使用方法，&lt;code&gt;xlog&lt;/code&gt;的初始化和关闭都是在&lt;code&gt;Application&lt;/code&gt;中。删除缓存目录下面的日志文件时并没有关闭&lt;code&gt;xlog&lt;/code&gt;，&lt;code&gt;mmap&lt;/code&gt;文件直接被删除，所以才导致上面说的奇葩问题。&lt;/p&gt;
&lt;p&gt;目测是原因找到了，于是在删除缓存时，日志目录下面的日志文件都不删除，最后问题解决。至于是什么原因导致删除&lt;code&gt;mmap&lt;/code&gt;文件出现上面的问题就不得而知，但是感觉整个目录被锁死了，直到删除应用才释放，强制停止应用都不起作用。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在项目开发中遇到一个很奇葩的问题，在应用中做了一个清除应用缓存功能，将缓存目录文件中所有的文件都删除，然后再重新初始化的时候，这个目录就不能创建文件和目录了。在红米手机和魅族手机上试了，都会出现这个问题，华为手机上却没有这个问题，我的MOTO手机上也有这个问题。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="Device or resource busy" scheme="http://www.jacpy.com/tags/Device-or-resource-busy/"/>
    
  </entry>
  
  <entry>
    <title>关于android fresco初始化的一个坑</title>
    <link href="http://www.jacpy.com/2017/05/02/android-fresco-init.html"/>
    <id>http://www.jacpy.com/2017/05/02/android-fresco-init.html</id>
    <published>2017-05-02T13:42:22.000Z</published>
    <updated>2017-08-02T05:21:45.000Z</updated>
    
    <content type="html">&lt;p&gt;之前有写文章说别人对网上文章的看法，这次写的是我对网上文章的看法。一直以来对网上的文章的说法都抱有怀疑态度，一般都是把网上的东西作为参考，找准关键的地方，他的说法与自己写的有什么区别？一对比就知道哪些地方有欠缺，是什么原因。而不是直接copy过来使用。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;blockquote&gt;
&lt;p&gt;以下这段内容可以选择忽略。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;举个前几天在项目中遇到的例子。在&lt;code&gt;android中捕获崩溃日志&lt;/code&gt;看到了将Throwable对象转换成字符串，写了很大一串。心想这段代码肯定来自网络，写这篇文章的时候去搜索了一下，果然。因为系统已经提供了将Throwable对象转换为字符串的方法，只需要调用就行，一行代码就可以搞定，有的甚至把&lt;code&gt;android.util.Log&lt;/code&gt;输出Throwable对象的方式重新再写了一遍，解决问题的思路很赞。但如果再多看一眼，&lt;code&gt;Log&lt;/code&gt;类中提供了&lt;code&gt;getStackTraceString(Throwable)&lt;/code&gt;静态方法，方便处理这种事情，而且这个方法是从&lt;code&gt;API Level 1&lt;/code&gt;开始就有。&lt;/p&gt;
&lt;p&gt;OK，回到主题上来。事情的起因是项目中的一个bug。&lt;/p&gt;
&lt;p&gt;项目中有一个滚动的Gallery查看大图，还有一个将图片保存到本地功能。但保存图片时会概率性失败，这个问题是测试反馈的，而且概率很高。自己测试发现进这个界面保存当前看到的这张图片能成功，后面每次保存都失败。&lt;/p&gt;
&lt;p&gt;跟踪代码发现失败的原因是从SD卡中&lt;code&gt;Fresco&lt;/code&gt;库缓存取图片时，图片不存在，所以保存失败。那为什么保存当前图片成功？&lt;/p&gt;
&lt;p&gt;于是将缓存目录下面的内容都用日志打了出来。以下代码在每次图片加载完后就会把缓存内容都以LOG方式输出。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PhotoDraweeView photoDraweeView = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; PhotoDraweeView(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; PipelineDraweeControllerBuilder controller = Fresco.newDraweeControllerBuilder();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;controller.setUri(uri); &lt;span class=&quot;comment&quot;&gt;// 图片请求的URL地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;controller.setAutoPlayAnimations(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;controller.setOldController(photoDraweeView.getController());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;controller.setControllerListener(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BaseControllerListener&amp;lt;ImageInfo&amp;gt;() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFinalImageSet&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, ImageInfo imageInfo, Animatable animatable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;.onFinalImageSet(id, imageInfo, animatable);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (imageInfo == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        FileBinaryResource resource = (FileBinaryResource) ImagePipelineFactory.getInstance().getMainFileCache().getResource(DefaultCacheKeyFactory.getInstance().getEncodedCacheKey(controller.getImageRequest(), &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (BuildConfig.DEBUG) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;resource: &quot;&lt;/span&gt; + resource);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            List&amp;lt;DiskStorage.DiskDumpInfoEntry&amp;gt; list = Fresco.getImagePipelineFactory().getMainFileCache().getDumpInfo().entries;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (list != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !list.isEmpty()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (DiskStorage.DiskDumpInfoEntry info : list) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    Log.d(&lt;span class=&quot;string&quot;&gt;&quot;may&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;size: &quot;&lt;/span&gt; + info.size + &lt;span class=&quot;string&quot;&gt;&quot;, type: &quot;&lt;/span&gt; + info.type + &lt;span class=&quot;string&quot;&gt;&quot;, path: &quot;&lt;/span&gt; + info.path + &lt;span class=&quot;string&quot;&gt;&quot;, fb: &quot;&lt;/span&gt; + info.firstBits);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IOException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onIntermediateImageSet&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, ImageInfo imageInfo)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onFailure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String id, Throwable throwable)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以下是输出的LOG，&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@2f8cf0a9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1580616.0, type: jpg, path: imgcache/v2.ols100.1/3/3qC9ts9ad_tJcsN1ot7Ort5YQ9A.cnt, fb: &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@411bafa9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1.0461388E7, type: jpg, path: imgcache/v2.ols100.1/24/r0c37nN9TT6P-HU0hoYwm_ZU5K4.cnt, fb: &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@6d7fddcf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1622679.0, type: jpg, path: imgcache/v2.ols100.1/1/BYrt44bfrnqXpdkx5x4p1W_RsTY.cnt, fb: &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[onFinalImageSet, 314]:resource: com.facebook.binaryresource.FileBinaryResource@bfbbc062&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[onFinalImageSet, 321]:size: 1127054.0, type: jpg, path: imgcache/v2.ols100.1/96/mhZk2iyqbM0iKt2RmDV0aKT0o5Q.cnt, fb:&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从上面的日志中看出图片都缓存到了指定的路径，但是从文件管理器中去查看&lt;code&gt;v2.ols100.1&lt;/code&gt;目录下面的对应目录基本都为空，只有一个目录中有缓存图片，整个目录大小只有几百KB。感觉图片只缓存了一张，其它的都没有缓存到外部存储空间上来。&lt;/p&gt;
&lt;p&gt;看了一下存储空间，还有几个G，不存在空间不足。与图片大小有关系？换了大图试试，也还是这样。开始怀疑与Fresco相关的代码，于是找到了Fresco初始化代码，如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DiskCacheConfig.Builder builder = DiskCacheConfig.newBuilder(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setMaxCacheSize(&lt;span class=&quot;number&quot;&gt;150&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnLowDiskSpace(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnVeryLowDiskSpace(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * ByteConstants.MB);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setVersion(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setBaseDirectoryName(&lt;span class=&quot;string&quot;&gt;&quot;imgcache&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setBaseDirectoryPath(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; File(FileUtils.getUserWorkingFolder()));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DiskCacheConfig diskCacheConfig = builder.build();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ImagePipelineConfig config = ImagePipelineConfig.newBuilder(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        .setMainDiskCacheConfig(diskCacheConfig)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        .build();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Fresco.initialize(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt; , config);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;想知道这几个参数值表示的是什么意思，是怎么使用的。于是就查看了源码，发现这个参数初始化代码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; mMaxCacheSize = &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt; * ByteConstants.MB;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; mMaxCacheSizeOnLowDiskSpace = &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; * ByteConstants.MB;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; mMaxCacheSizeOnVeryLowDiskSpace = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; * ByteConstants.MB;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Builder &lt;span class=&quot;title&quot;&gt;setMaxCacheSize&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; maxCacheSize)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mMaxCacheSize = maxCacheSize;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Builder &lt;span class=&quot;title&quot;&gt;setMaxCacheSizeOnLowDiskSpace&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; maxCacheSizeOnLowDiskSpace)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mMaxCacheSizeOnLowDiskSpace = maxCacheSizeOnLowDiskSpace;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Builder &lt;span class=&quot;title&quot;&gt;setMaxCacheSizeOnVeryLowDiskSpace&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; maxCacheSizeOnVeryLowDiskSpace)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mMaxCacheSizeOnVeryLowDiskSpace = maxCacheSizeOnVeryLowDiskSpace;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看到这个代码就立马反应过来了，少了一个常量&lt;code&gt;ByteConstants.MB&lt;/code&gt;？把项目中的初始化代码修改了一下，加上了这个常量，代码如下所示：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DiskCacheConfig.Builder builder = DiskCacheConfig.newBuilder(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setMaxCacheSize(&lt;span class=&quot;number&quot;&gt;150&lt;/span&gt; * ByteConstants.MB);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnLowDiskSpace(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt; * ByteConstants.MB);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setMaxCacheSizeOnVeryLowDiskSpace(&lt;span class=&quot;number&quot;&gt;30&lt;/span&gt; * ByteConstants.MB);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再来测试时，发现问题解决了，不会出现保存失败的情况。&lt;code&gt;v2.ols100.1&lt;/code&gt;这个目录下缓存了很多文件，文件大小一下子就几M了。&lt;/p&gt;
&lt;p&gt;然后用上面代码中的关键字在google上搜索了一下，发现代码是copy过来的，参数值全部都一样。好吧，我认栽。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;之前有写文章说别人对网上文章的看法，这次写的是我对网上文章的看法。一直以来对网上的文章的说法都抱有怀疑态度，一般都是把网上的东西作为参考，找准关键的地方，他的说法与自己写的有什么区别？一对比就知道哪些地方有欠缺，是什么原因。而不是直接copy过来使用。&lt;/p&gt;
    
    </summary>
    
      <category term="android" scheme="http://www.jacpy.com/categories/android/"/>
    
    
      <category term="fresco初始化设置" scheme="http://www.jacpy.com/tags/fresco%E5%88%9D%E5%A7%8B%E5%8C%96%E8%AE%BE%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>windows 7 驱动安装成功后无法启动</title>
    <link href="http://www.jacpy.com/2017/04/28/windows-driver-donot-install.html"/>
    <id>http://www.jacpy.com/2017/04/28/windows-driver-donot-install.html</id>
    <published>2017-04-28T00:27:57.000Z</published>
    <updated>2017-08-02T05:16:26.000Z</updated>
    
    <content type="html">&lt;p&gt;前几天在PC上安装无线网卡，可以将PC的网络通用Wi-Fi的形式让手机可以连接。由于系统限制，驱动安装成功，但是加载驱动却失败，于是开始找原因，就有了下文。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;首先驱动可以安装成功，但不能被系统加载，出现的情况下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/device.png&quot; alt=&quot;驱动未被加载&quot;&gt;&lt;/p&gt;
&lt;p&gt;然后选中黄色警告项，右键选择“更新驱动”，然后选择驱动安装目录，然后下一步，结果提示&lt;code&gt;系统策略禁止安装此设备，请与系统管理员联系&lt;/code&gt;，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/system_forbidden_install_driver_call_admin.jpg&quot; alt=&quot;系统策略禁止安装此设备，请与系统管理员联系&quot;&gt;&lt;/p&gt;
&lt;p&gt;于是打开组策略，开始找是哪项设置的。&lt;/p&gt;
&lt;p&gt;打开组策略后，先选中其中一个模板，比如&lt;code&gt;管理模板&lt;/code&gt;，然后点击&lt;code&gt;操作&lt;/code&gt;菜单中的&lt;code&gt;筛选器选项...&lt;/code&gt;项，如图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/gpedit_msc_drive_menu.png&quot; alt=&quot;筛选器选项菜单&quot;&gt;&lt;/p&gt;
&lt;p&gt;在弹出的窗口中什么都不用选，如下图所示，然后单击确定按钮：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/gpedit_msc_drive_dialog.png&quot; alt=&quot;筛选器选项&quot;&gt;&lt;/p&gt;
&lt;p&gt;最后发现什么都没有搜索出来，因为这些项都是未配置。心想，这里没有被人修改过，全都是系统默认的，现在怎么知道是哪项产生的影响？&lt;/p&gt;
&lt;p&gt;最后没办法，只得挨个找，最后还是被找到设置的位置。在&lt;code&gt;计算机配置&lt;/code&gt;-&amp;gt;&lt;code&gt;管理模板&lt;/code&gt;-&amp;gt;&lt;code&gt;系统&lt;/code&gt;-&amp;gt;&lt;code&gt;设备安装&lt;/code&gt;-&amp;gt;&lt;code&gt;设备安装限制&lt;/code&gt;的右侧面板中，分别修改&lt;code&gt;允许管理员忽略设备安装限制策略&lt;/code&gt;和&lt;code&gt;禁止安装未由其他策略设备描述的设备&lt;/code&gt;，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2017/04/gpedit_msc_drive.png&quot; alt=&quot;设备安装限制&quot;&gt;&lt;/p&gt;
&lt;p&gt;设置后，再去更新驱动，OK了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前几天在PC上安装无线网卡，可以将PC的网络通用Wi-Fi的形式让手机可以连接。由于系统限制，驱动安装成功，但是加载驱动却失败，于是开始找原因，就有了下文。&lt;/p&gt;
    
    </summary>
    
      <category term="windows" scheme="http://www.jacpy.com/categories/windows/"/>
    
    
      <category term="windows 7 驱动安装成功后无法启动" scheme="http://www.jacpy.com/tags/windows-7-%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F%E5%90%8E%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8/"/>
    
  </entry>
  
</feed>
